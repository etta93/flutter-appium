"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.WebInspectorService = exports.WEB_INSPECTOR_SERVICE_NAME = void 0;

require("source-map-support/register");

var _webinspectorDecoder = _interopRequireDefault(require("./transformer/webinspector-decoder"));

var _webinspectorEncoder = _interopRequireDefault(require("./transformer/webinspector-encoder"));

var _plistServiceDecoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-decoder"));

var _plistServiceEncoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-encoder"));

var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));

var _streamLogger = _interopRequireDefault(require("../util/transformer/stream-logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _support = require("@appium/support");

var _constants = require("../constants");

var _logger = _interopRequireDefault(require("../logger"));

var _baseService = require("../base-service");

const WEB_INSPECTOR_SERVICE_NAME = 'com.apple.webinspector';
exports.WEB_INSPECTOR_SERVICE_NAME = WEB_INSPECTOR_SERVICE_NAME;
const MAX_FRAME_SIZE = 20 * _constants.MB;
const PARTIAL_MESSAGE_SUPPORT_DEPRECATION_VERSION = 11;

class WebInspectorService extends _baseService.BaseServiceSocket {
  constructor(opts = {}) {
    const {
      majorOsVersion,
      isSimulator = false,
      socketChunkSize,
      verbose = false,
      verboseHexDump = false,
      socketClient,
      maxFrameLength = MAX_FRAME_SIZE
    } = opts;
    super(socketClient);

    if (_lodash.default.isFunction(socketClient.setMaxSendFragment) && !_lodash.default.isNil(socketChunkSize) && socketChunkSize > 0) {
      if (socketClient.setMaxSendFragment(socketChunkSize)) {
        _logger.default.debug(`Maximum TLS fragment size set to '${socketChunkSize}'`);
      } else {
        _logger.default.warn(`Unable to set TLS fragment size to '${socketChunkSize}'`);
      }
    }

    this._verbose = verbose;
    this._isSimulator = isSimulator;
    this._majorOsVersion = majorOsVersion;

    if (!isSimulator && majorOsVersion < PARTIAL_MESSAGE_SUPPORT_DEPRECATION_VERSION) {
      this._initializePartialMessageSupport(verboseHexDump, maxFrameLength);
    } else {
      this._initializeFullMessageSupport(verboseHexDump, maxFrameLength);
    }
  }

  _initializeFullMessageSupport(verbose, maxFrameLength) {
    this._decoder = new _plistServiceDecoder.default();

    this._socketClient.pipe(new _streamLogger.default(_streamLogger.default.RECEIVE, verbose)).pipe(this._splitter = new _lengthBasedSplitter.default({
      readableStream: this._socketClient,
      littleEndian: false,
      maxFrameLength,
      lengthFieldOffset: 0,
      lengthFieldLength: 4,
      lengthAdjustment: 4
    })).pipe(this._decoder);

    this._encoder = new _plistServiceEncoder.default();

    this._encoder.pipe(new _streamLogger.default(_streamLogger.default.SEND, verbose)).pipe(this._socketClient);
  }

  _initializePartialMessageSupport(verbose, maxFrameLength) {
    this._decoder = new _webinspectorDecoder.default(_constants.MB);

    this._socketClient.pipe(new _streamLogger.default(_streamLogger.default.RECEIVE, verbose)).pipe(this._splitter = new _lengthBasedSplitter.default({
      readableStream: this._socketClient,
      littleEndian: false,
      maxFrameLength,
      lengthFieldOffset: 0,
      lengthFieldLength: 4,
      lengthAdjustment: 4
    })).pipe(new _plistServiceDecoder.default()).pipe(this._decoder);

    this._encoder = new _webinspectorEncoder.default();

    this._encoder.pipe(new _plistServiceEncoder.default()).pipe(new _streamLogger.default(_streamLogger.default.SEND, verbose)).pipe(this._socketClient);
  }

  sendMessage(rpcObject) {
    if (_lodash.default.isNil(rpcObject)) {
      throw new Error('Cannot send a null object');
    }

    if (this._verbose) {
      _logger.default.debug('Sending message to Web Inspector:');

      _logger.default.debug(_support.util.jsonStringify(rpcObject));
    }

    this._encoder.write(rpcObject);

    if (!this._isSimulator && this._majorOsVersion >= PARTIAL_MESSAGE_SUPPORT_DEPRECATION_VERSION) {
      this._encoder.write(' ');
    }
  }

  listenMessage(onData) {
    this._decoder.on('data', data => {
      if (this._verbose) {
        _logger.default.debug('Received message from Web Inspector:');

        _logger.default.debug(_support.util.jsonStringify(data));
      }

      onData(data);
    });
  }

}

exports.WebInspectorService = WebInspectorService;
var _default = WebInspectorService;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJpbnNwZWN0b3IvaW5kZXguanMiXSwibmFtZXMiOlsiV0VCX0lOU1BFQ1RPUl9TRVJWSUNFX05BTUUiLCJNQVhfRlJBTUVfU0laRSIsIk1CIiwiUEFSVElBTF9NRVNTQUdFX1NVUFBPUlRfREVQUkVDQVRJT05fVkVSU0lPTiIsIldlYkluc3BlY3RvclNlcnZpY2UiLCJCYXNlU2VydmljZVNvY2tldCIsImNvbnN0cnVjdG9yIiwib3B0cyIsIm1ham9yT3NWZXJzaW9uIiwiaXNTaW11bGF0b3IiLCJzb2NrZXRDaHVua1NpemUiLCJ2ZXJib3NlIiwidmVyYm9zZUhleER1bXAiLCJzb2NrZXRDbGllbnQiLCJtYXhGcmFtZUxlbmd0aCIsIl8iLCJpc0Z1bmN0aW9uIiwic2V0TWF4U2VuZEZyYWdtZW50IiwiaXNOaWwiLCJsb2ciLCJkZWJ1ZyIsIndhcm4iLCJfdmVyYm9zZSIsIl9pc1NpbXVsYXRvciIsIl9tYWpvck9zVmVyc2lvbiIsIl9pbml0aWFsaXplUGFydGlhbE1lc3NhZ2VTdXBwb3J0IiwiX2luaXRpYWxpemVGdWxsTWVzc2FnZVN1cHBvcnQiLCJfZGVjb2RlciIsIlBsaXN0U2VydmljZURlY29kZXIiLCJfc29ja2V0Q2xpZW50IiwicGlwZSIsIlN0cmVhbUxvZ2dlciIsIlJFQ0VJVkUiLCJfc3BsaXR0ZXIiLCJMZW5ndGhCYXNlZFNwbGl0dGVyIiwicmVhZGFibGVTdHJlYW0iLCJsaXR0bGVFbmRpYW4iLCJsZW5ndGhGaWVsZE9mZnNldCIsImxlbmd0aEZpZWxkTGVuZ3RoIiwibGVuZ3RoQWRqdXN0bWVudCIsIl9lbmNvZGVyIiwiUGxpc3RTZXJ2aWNlRW5jb2RlciIsIlNFTkQiLCJXZWJJbnNwZWN0b3JEZWNvZGVyIiwiV2ViSW5zcGVjdG9yRW5jb2RlciIsInNlbmRNZXNzYWdlIiwicnBjT2JqZWN0IiwiRXJyb3IiLCJ1dGlsIiwianNvblN0cmluZ2lmeSIsIndyaXRlIiwibGlzdGVuTWVzc2FnZSIsIm9uRGF0YSIsIm9uIiwiZGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSwwQkFBMEIsR0FBRyx3QkFBbkM7O0FBQ0EsTUFBTUMsY0FBYyxHQUFHLEtBQUtDLGFBQTVCO0FBRUEsTUFBTUMsMkNBQTJDLEdBQUcsRUFBcEQ7O0FBb0JBLE1BQU1DLG1CQUFOLFNBQWtDQyw4QkFBbEMsQ0FBb0Q7QUFNbERDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBSSxHQUFHLEVBQVQsRUFBYTtBQUN0QixVQUFNO0FBQ0pDLE1BQUFBLGNBREk7QUFFSkMsTUFBQUEsV0FBVyxHQUFHLEtBRlY7QUFHSkMsTUFBQUEsZUFISTtBQUlKQyxNQUFBQSxPQUFPLEdBQUcsS0FKTjtBQUtKQyxNQUFBQSxjQUFjLEdBQUcsS0FMYjtBQU1KQyxNQUFBQSxZQU5JO0FBT0pDLE1BQUFBLGNBQWMsR0FBR2I7QUFQYixRQVFGTSxJQVJKO0FBVUEsVUFBTU0sWUFBTjs7QUFHQSxRQUFJRSxnQkFBRUMsVUFBRixDQUFhSCxZQUFZLENBQUNJLGtCQUExQixLQUFpRCxDQUFDRixnQkFBRUcsS0FBRixDQUFRUixlQUFSLENBQWxELElBQThFQSxlQUFlLEdBQUcsQ0FBcEcsRUFBdUc7QUFDckcsVUFBSUcsWUFBWSxDQUFDSSxrQkFBYixDQUFnQ1AsZUFBaEMsQ0FBSixFQUFzRDtBQUNwRFMsd0JBQUlDLEtBQUosQ0FBVyxxQ0FBb0NWLGVBQWdCLEdBQS9EO0FBQ0QsT0FGRCxNQUVPO0FBRUxTLHdCQUFJRSxJQUFKLENBQVUsdUNBQXNDWCxlQUFnQixHQUFoRTtBQUNEO0FBQ0Y7O0FBRUQsU0FBS1ksUUFBTCxHQUFnQlgsT0FBaEI7QUFDQSxTQUFLWSxZQUFMLEdBQW9CZCxXQUFwQjtBQUNBLFNBQUtlLGVBQUwsR0FBdUJoQixjQUF2Qjs7QUFFQSxRQUFJLENBQUNDLFdBQUQsSUFBZ0JELGNBQWMsR0FBR0wsMkNBQXJDLEVBQWtGO0FBQ2hGLFdBQUtzQixnQ0FBTCxDQUFzQ2IsY0FBdEMsRUFBc0RFLGNBQXREO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsV0FBS1ksNkJBQUwsQ0FBbUNkLGNBQW5DLEVBQW1ERSxjQUFuRDtBQUNEO0FBQ0Y7O0FBU0RZLEVBQUFBLDZCQUE2QixDQUFFZixPQUFGLEVBQVdHLGNBQVgsRUFBMkI7QUFDdEQsU0FBS2EsUUFBTCxHQUFnQixJQUFJQyw0QkFBSixFQUFoQjs7QUFDQSxTQUFLQyxhQUFMLENBRUdDLElBRkgsQ0FFUSxJQUFJQyxxQkFBSixDQUFpQkEsc0JBQWFDLE9BQTlCLEVBQXVDckIsT0FBdkMsQ0FGUixFQUdHbUIsSUFISCxDQUdRLEtBQUtHLFNBQUwsR0FBaUIsSUFBSUMsNEJBQUosQ0FBd0I7QUFDN0NDLE1BQUFBLGNBQWMsRUFBRSxLQUFLTixhQUR3QjtBQUU3Q08sTUFBQUEsWUFBWSxFQUFFLEtBRitCO0FBRzdDdEIsTUFBQUEsY0FINkM7QUFJN0N1QixNQUFBQSxpQkFBaUIsRUFBRSxDQUowQjtBQUs3Q0MsTUFBQUEsaUJBQWlCLEVBQUUsQ0FMMEI7QUFNN0NDLE1BQUFBLGdCQUFnQixFQUFFO0FBTjJCLEtBQXhCLENBSHpCLEVBV0dULElBWEgsQ0FXUSxLQUFLSCxRQVhiOztBQWFBLFNBQUthLFFBQUwsR0FBZ0IsSUFBSUMsNEJBQUosRUFBaEI7O0FBQ0EsU0FBS0QsUUFBTCxDQUNHVixJQURILENBQ1EsSUFBSUMscUJBQUosQ0FBaUJBLHNCQUFhVyxJQUE5QixFQUFvQy9CLE9BQXBDLENBRFIsRUFFR21CLElBRkgsQ0FFUSxLQUFLRCxhQUZiO0FBR0Q7O0FBVURKLEVBQUFBLGdDQUFnQyxDQUFFZCxPQUFGLEVBQVdHLGNBQVgsRUFBMkI7QUFFekQsU0FBS2EsUUFBTCxHQUFnQixJQUFJZ0IsNEJBQUosQ0FBd0J6QyxhQUF4QixDQUFoQjs7QUFDQSxTQUFLMkIsYUFBTCxDQUVHQyxJQUZILENBRVEsSUFBSUMscUJBQUosQ0FBaUJBLHNCQUFhQyxPQUE5QixFQUF1Q3JCLE9BQXZDLENBRlIsRUFHR21CLElBSEgsQ0FHUSxLQUFLRyxTQUFMLEdBQWlCLElBQUlDLDRCQUFKLENBQXdCO0FBQzdDQyxNQUFBQSxjQUFjLEVBQUUsS0FBS04sYUFEd0I7QUFFN0NPLE1BQUFBLFlBQVksRUFBRSxLQUYrQjtBQUc3Q3RCLE1BQUFBLGNBSDZDO0FBSTdDdUIsTUFBQUEsaUJBQWlCLEVBQUUsQ0FKMEI7QUFLN0NDLE1BQUFBLGlCQUFpQixFQUFFLENBTDBCO0FBTTdDQyxNQUFBQSxnQkFBZ0IsRUFBRTtBQU4yQixLQUF4QixDQUh6QixFQVdHVCxJQVhILENBV1EsSUFBSUYsNEJBQUosRUFYUixFQVlHRSxJQVpILENBWVEsS0FBS0gsUUFaYjs7QUFjQSxTQUFLYSxRQUFMLEdBQWdCLElBQUlJLDRCQUFKLEVBQWhCOztBQUNBLFNBQUtKLFFBQUwsQ0FDR1YsSUFESCxDQUNRLElBQUlXLDRCQUFKLEVBRFIsRUFFR1gsSUFGSCxDQUVRLElBQUlDLHFCQUFKLENBQWlCQSxzQkFBYVcsSUFBOUIsRUFBb0MvQixPQUFwQyxDQUZSLEVBR0dtQixJQUhILENBR1EsS0FBS0QsYUFIYjtBQUlEOztBQU9EZ0IsRUFBQUEsV0FBVyxDQUFFQyxTQUFGLEVBQWE7QUFDdEIsUUFBSS9CLGdCQUFFRyxLQUFGLENBQVE0QixTQUFSLENBQUosRUFBd0I7QUFDdEIsWUFBTSxJQUFJQyxLQUFKLENBQVUsMkJBQVYsQ0FBTjtBQUNEOztBQUVELFFBQUksS0FBS3pCLFFBQVQsRUFBbUI7QUFDakJILHNCQUFJQyxLQUFKLENBQVUsbUNBQVY7O0FBQ0FELHNCQUFJQyxLQUFKLENBQVU0QixjQUFLQyxhQUFMLENBQW1CSCxTQUFuQixDQUFWO0FBQ0Q7O0FBRUQsU0FBS04sUUFBTCxDQUFjVSxLQUFkLENBQW9CSixTQUFwQjs7QUFNQSxRQUFJLENBQUMsS0FBS3ZCLFlBQU4sSUFBc0IsS0FBS0MsZUFBTCxJQUF3QnJCLDJDQUFsRCxFQUErRjtBQUM3RixXQUFLcUMsUUFBTCxDQUFjVSxLQUFkLENBQW9CLEdBQXBCO0FBQ0Q7QUFDRjs7QUFZREMsRUFBQUEsYUFBYSxDQUFFQyxNQUFGLEVBQVU7QUFDckIsU0FBS3pCLFFBQUwsQ0FBYzBCLEVBQWQsQ0FBaUIsTUFBakIsRUFBMEJDLElBQUQsSUFBVTtBQUNqQyxVQUFJLEtBQUtoQyxRQUFULEVBQW1CO0FBQ2pCSCx3QkFBSUMsS0FBSixDQUFVLHNDQUFWOztBQUNBRCx3QkFBSUMsS0FBSixDQUFVNEIsY0FBS0MsYUFBTCxDQUFtQkssSUFBbkIsQ0FBVjtBQUNEOztBQUNERixNQUFBQSxNQUFNLENBQUNFLElBQUQsQ0FBTjtBQUNELEtBTkQ7QUFPRDs7QUFoSmlEOzs7ZUFvSnJDbEQsbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgV2ViSW5zcGVjdG9yRGVjb2RlciBmcm9tICcuL3RyYW5zZm9ybWVyL3dlYmluc3BlY3Rvci1kZWNvZGVyJztcbmltcG9ydCBXZWJJbnNwZWN0b3JFbmNvZGVyIGZyb20gJy4vdHJhbnNmb3JtZXIvd2ViaW5zcGVjdG9yLWVuY29kZXInO1xuaW1wb3J0IFBsaXN0U2VydmljZURlY29kZXIgZnJvbSAnLi4vcGxpc3Qtc2VydmljZS90cmFuc2Zvcm1lci9wbGlzdC1zZXJ2aWNlLWRlY29kZXInO1xuaW1wb3J0IFBsaXN0U2VydmljZUVuY29kZXIgZnJvbSAnLi4vcGxpc3Qtc2VydmljZS90cmFuc2Zvcm1lci9wbGlzdC1zZXJ2aWNlLWVuY29kZXInO1xuaW1wb3J0IExlbmd0aEJhc2VkU3BsaXR0ZXIgZnJvbSAnLi4vdXRpbC90cmFuc2Zvcm1lci9sZW5ndGgtYmFzZWQtc3BsaXR0ZXInO1xuaW1wb3J0IFN0cmVhbUxvZ2dlciBmcm9tICcuLi91dGlsL3RyYW5zZm9ybWVyL3N0cmVhbS1sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHsgTUIgfSBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgQmFzZVNlcnZpY2VTb2NrZXQgfSBmcm9tICcuLi9iYXNlLXNlcnZpY2UnO1xuXG5cbmNvbnN0IFdFQl9JTlNQRUNUT1JfU0VSVklDRV9OQU1FID0gJ2NvbS5hcHBsZS53ZWJpbnNwZWN0b3InO1xuY29uc3QgTUFYX0ZSQU1FX1NJWkUgPSAyMCAqIE1CO1xuXG5jb25zdCBQQVJUSUFMX01FU1NBR0VfU1VQUE9SVF9ERVBSRUNBVElPTl9WRVJTSU9OID0gMTE7XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gV2ViSW5zcGVjdG9yU2VydmljZU9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkge251bWJlcn0gbWFqb3JPc1ZlcnNpb24gVGhlIG1ham9yIHZlcnNpb24gb2YgdGhlIG9zIHZlcnNpb25cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNTaW11bGF0b3IgV2hldGhlciB0aGUgZGV2aWNlIGlzIGEgc2ltdWxhdG9yXG4gKiBAcHJvcGVydHkgez9udW1iZXJ9IHNvY2tldENodW5rU2l6ZSBTaXplLCBpbiBieXRlcyBvZiB0aGUgY2h1bmtzIHRvIHNlbmQgdG9cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWwgZGV2aWNlIChvbmx5IGlPUyAxMSspLiBEZWZhdWx0cyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMTYzODQgYnl0ZXMgKHRoZSBUTFNTb2NrZXQgbWF4KS5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmVyYm9zZSBUdXJuIG9uIGxvZ2dpbmcgb2YgZWFjaCBtZXNzYWdlIHNlbnQgb3IgcmVjZWl2ZWQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdHMgdG8gZmFsc2VcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmVyYm9zZUhleER1bXAgVHVybiBvbiBsb2dnaW5nIG9mIF9hbGxfIGNvbW11bmljYXRpb24gYXNcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGV4IGR1bXAuIERlZmF1bHRzIHRvIGZhbHNlXG4gKiBAcHJvcGVydHkgeyp9IHNvY2tldENsaWVudCBUaGUgc29ja2V0IGNsaWVudCB3aGVyZSB0aGUgY29tbXVuaWNhdGlvbiB3aWxsIGhhcHBlblxuICogQHByb3BlcnR5IHtudW1iZXJ9IG1heEZyYW1lTGVuZ3RoIFsyMCAqIDEwMjQgKiAxMDI0XSAtIFRoZSBtYXhpbXVtIHNpemVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbiBieXRlcyBvZiBhIHNpbmdsZSBkYXRhIGZyYW1lXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW4gdGhlIGRldmljZSBjb21tdW5pY2F0aW9uIHByb3RvY29sXG4gKi9cblxuY2xhc3MgV2ViSW5zcGVjdG9yU2VydmljZSBleHRlbmRzIEJhc2VTZXJ2aWNlU29ja2V0IHtcbiAgLyoqXG4gICAqIFRoZSBtYWluIHNlcnZpY2UgZm9yIGNvbW11bmljYXRpb24gd2l0aCB0aGUgd2ViaW5zcGVjdG9yZFxuICAgKlxuICAgKiBAcGFyYW0ge1dlYkluc3BlY3RvclNlcnZpY2VPcHRpb25zfVxuICAgKi9cbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGNvbnN0IHtcbiAgICAgIG1ham9yT3NWZXJzaW9uLFxuICAgICAgaXNTaW11bGF0b3IgPSBmYWxzZSxcbiAgICAgIHNvY2tldENodW5rU2l6ZSxcbiAgICAgIHZlcmJvc2UgPSBmYWxzZSxcbiAgICAgIHZlcmJvc2VIZXhEdW1wID0gZmFsc2UsXG4gICAgICBzb2NrZXRDbGllbnQsXG4gICAgICBtYXhGcmFtZUxlbmd0aCA9IE1BWF9GUkFNRV9TSVpFLFxuICAgIH0gPSBvcHRzO1xuXG4gICAgc3VwZXIoc29ja2V0Q2xpZW50KTtcblxuICAgIC8vIHNldCB0aGUgbGFyZ2VzdCBmcmFnbWVudCBzaXplIGZvciB0aGUgc29ja2V0LCBpZiB0aGUgb3B0aW9uIGlzIHRoZXJlXG4gICAgaWYgKF8uaXNGdW5jdGlvbihzb2NrZXRDbGllbnQuc2V0TWF4U2VuZEZyYWdtZW50KSAmJiAhXy5pc05pbChzb2NrZXRDaHVua1NpemUpICYmIHNvY2tldENodW5rU2l6ZSA+IDApIHtcbiAgICAgIGlmIChzb2NrZXRDbGllbnQuc2V0TWF4U2VuZEZyYWdtZW50KHNvY2tldENodW5rU2l6ZSkpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBNYXhpbXVtIFRMUyBmcmFnbWVudCBzaXplIHNldCB0byAnJHtzb2NrZXRDaHVua1NpemV9J2ApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gYW55dGhpbmcgb3ZlciB0aGUgX2FjdHVhbF8gbWF4aW11bSB3aWxsIGZhaWwsIGFuZCB0aGluZ3Mgd2lsbCByZW1haW4gdGhlIHNhbWVcbiAgICAgICAgbG9nLndhcm4oYFVuYWJsZSB0byBzZXQgVExTIGZyYWdtZW50IHNpemUgdG8gJyR7c29ja2V0Q2h1bmtTaXplfSdgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLl92ZXJib3NlID0gdmVyYm9zZTtcbiAgICB0aGlzLl9pc1NpbXVsYXRvciA9IGlzU2ltdWxhdG9yO1xuICAgIHRoaXMuX21ham9yT3NWZXJzaW9uID0gbWFqb3JPc1ZlcnNpb247XG5cbiAgICBpZiAoIWlzU2ltdWxhdG9yICYmIG1ham9yT3NWZXJzaW9uIDwgUEFSVElBTF9NRVNTQUdFX1NVUFBPUlRfREVQUkVDQVRJT05fVkVSU0lPTikge1xuICAgICAgdGhpcy5faW5pdGlhbGl6ZVBhcnRpYWxNZXNzYWdlU3VwcG9ydCh2ZXJib3NlSGV4RHVtcCwgbWF4RnJhbWVMZW5ndGgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9pbml0aWFsaXplRnVsbE1lc3NhZ2VTdXBwb3J0KHZlcmJvc2VIZXhEdW1wLCBtYXhGcmFtZUxlbmd0aCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEludGlhbGl6ZXMgdGhlIGRhdGEgZmxvdyBmb3IgaU9TIDExKy5cbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSB2ZXJib3NlIC0gd2hldGhlciB0byBwcmludCBvdXQgdGhlIGhleCBkdW1wIGZvciBjb21tdW5pY2F0aW9uXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhGcmFtZUxlbmd0aCAtIFRoZSBtYXhpbXVtIHNpemUgaW4gYnl0ZXMgb2YgYSBzaW5nbGUgZGF0YSBmcmFtZVxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbiB0aGUgZGV2aWNlIGNvbW11bmljYXRpb24gcHJvdG9jb2xcbiAgICovXG4gIF9pbml0aWFsaXplRnVsbE1lc3NhZ2VTdXBwb3J0ICh2ZXJib3NlLCBtYXhGcmFtZUxlbmd0aCkge1xuICAgIHRoaXMuX2RlY29kZXIgPSBuZXcgUGxpc3RTZXJ2aWNlRGVjb2RlcigpO1xuICAgIHRoaXMuX3NvY2tldENsaWVudFxuICAgICAgLy8gbG9nIGZpcnN0LCBpbiBjYXNlIHRoZXJlIGlzIGEgcHJvYmxlbSBpbiBwcm9jZXNzaW5nXG4gICAgICAucGlwZShuZXcgU3RyZWFtTG9nZ2VyKFN0cmVhbUxvZ2dlci5SRUNFSVZFLCB2ZXJib3NlKSlcbiAgICAgIC5waXBlKHRoaXMuX3NwbGl0dGVyID0gbmV3IExlbmd0aEJhc2VkU3BsaXR0ZXIoe1xuICAgICAgICByZWFkYWJsZVN0cmVhbTogdGhpcy5fc29ja2V0Q2xpZW50LFxuICAgICAgICBsaXR0bGVFbmRpYW46IGZhbHNlLFxuICAgICAgICBtYXhGcmFtZUxlbmd0aCxcbiAgICAgICAgbGVuZ3RoRmllbGRPZmZzZXQ6IDAsXG4gICAgICAgIGxlbmd0aEZpZWxkTGVuZ3RoOiA0LFxuICAgICAgICBsZW5ndGhBZGp1c3RtZW50OiA0LFxuICAgICAgfSkpXG4gICAgICAucGlwZSh0aGlzLl9kZWNvZGVyKTtcblxuICAgIHRoaXMuX2VuY29kZXIgPSBuZXcgUGxpc3RTZXJ2aWNlRW5jb2RlcigpO1xuICAgIHRoaXMuX2VuY29kZXJcbiAgICAgIC5waXBlKG5ldyBTdHJlYW1Mb2dnZXIoU3RyZWFtTG9nZ2VyLlNFTkQsIHZlcmJvc2UpKVxuICAgICAgLnBpcGUodGhpcy5fc29ja2V0Q2xpZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnRpYWxpemVzIHRoZSBkYXRhIGZsb3cgZm9yIGlPUyA8IDExLCB3aGVyZSBkYXRhIGlzIHNlcGFyYXRlZCBpbnRvIHBhcnRpYWxcbiAgICogbWVzc2FnZXMgYmVmb3JlIHNlbmRpbmcuXG4gICAqXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gdmVyYm9zZSAtIHdoZXRoZXIgdG8gcHJpbnQgb3V0IHRoZSBoZXggZHVtcCBmb3IgY29tbXVuaWNhdGlvblxuICAgKiBAcGFyYW0ge251bWJlcn0gbWF4RnJhbWVMZW5ndGggLSBUaGUgbWF4aW11bSBzaXplIGluIGJ5dGVzIG9mIGEgc2luZ2xlIGRhdGEgZnJhbWVcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW4gdGhlIGRldmljZSBjb21tdW5pY2F0aW9uIHByb3RvY29sXG4gICAqL1xuICBfaW5pdGlhbGl6ZVBhcnRpYWxNZXNzYWdlU3VwcG9ydCAodmVyYm9zZSwgbWF4RnJhbWVMZW5ndGgpIHtcbiAgICAvLyAxTUIgYXMgYnVmZmVyIGZvciBidWxkaW5nIHdlYmluc3BlY3RvciBmdWxsIG1lc3NhZ2VzLiBXZSBjYW4gaW5jcmVhc2UgdGhlIHZhbHVlIGlmIG1vcmUgYnVmZmVyIGlzIG5lZWRlZFxuICAgIHRoaXMuX2RlY29kZXIgPSBuZXcgV2ViSW5zcGVjdG9yRGVjb2RlcihNQik7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50XG4gICAgICAvLyBsb2cgZmlyc3QsIGluIGNhc2UgdGhlcmUgaXMgYSBwcm9ibGVtIGluIHByb2Nlc3NpbmdcbiAgICAgIC5waXBlKG5ldyBTdHJlYW1Mb2dnZXIoU3RyZWFtTG9nZ2VyLlJFQ0VJVkUsIHZlcmJvc2UpKVxuICAgICAgLnBpcGUodGhpcy5fc3BsaXR0ZXIgPSBuZXcgTGVuZ3RoQmFzZWRTcGxpdHRlcih7XG4gICAgICAgIHJlYWRhYmxlU3RyZWFtOiB0aGlzLl9zb2NrZXRDbGllbnQsXG4gICAgICAgIGxpdHRsZUVuZGlhbjogZmFsc2UsXG4gICAgICAgIG1heEZyYW1lTGVuZ3RoLFxuICAgICAgICBsZW5ndGhGaWVsZE9mZnNldDogMCxcbiAgICAgICAgbGVuZ3RoRmllbGRMZW5ndGg6IDQsXG4gICAgICAgIGxlbmd0aEFkanVzdG1lbnQ6IDQsXG4gICAgICB9KSlcbiAgICAgIC5waXBlKG5ldyBQbGlzdFNlcnZpY2VEZWNvZGVyKCkpXG4gICAgICAucGlwZSh0aGlzLl9kZWNvZGVyKTtcblxuICAgIHRoaXMuX2VuY29kZXIgPSBuZXcgV2ViSW5zcGVjdG9yRW5jb2RlcigpO1xuICAgIHRoaXMuX2VuY29kZXJcbiAgICAgIC5waXBlKG5ldyBQbGlzdFNlcnZpY2VFbmNvZGVyKCkpXG4gICAgICAucGlwZShuZXcgU3RyZWFtTG9nZ2VyKFN0cmVhbUxvZ2dlci5TRU5ELCB2ZXJib3NlKSlcbiAgICAgIC5waXBlKHRoaXMuX3NvY2tldENsaWVudCk7XG4gIH1cblxuICAvKipcbiAgICogU2VuZHMgYW4gb2JqZWN0IHRvIHRoZSB3ZWJpbnNwZWN0b3JkIHNvY2tldFxuICAgKiBAcGFyYW0ge09iamVjdH0gcnBjT2JqZWN0IFRoZSBvYmplY3QgdGhhdCB3aWxsIGJlIHNlbnRcbiAgICogQHRocm93cyBXaWxsIHRocm93IGFuIGVycm9yIHdoZW4gdGhlIG9iamVjdCBpcyBudWxsIG9yIHVuZGVmaW5lZFxuICAgKi9cbiAgc2VuZE1lc3NhZ2UgKHJwY09iamVjdCkge1xuICAgIGlmIChfLmlzTmlsKHJwY09iamVjdCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNlbmQgYSBudWxsIG9iamVjdCcpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLl92ZXJib3NlKSB7XG4gICAgICBsb2cuZGVidWcoJ1NlbmRpbmcgbWVzc2FnZSB0byBXZWIgSW5zcGVjdG9yOicpO1xuICAgICAgbG9nLmRlYnVnKHV0aWwuanNvblN0cmluZ2lmeShycGNPYmplY3QpKTtcbiAgICB9XG5cbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKHJwY09iamVjdCk7XG5cbiAgICAvLyB3cml0ZSBhbiBlbXB0eSBtZXNzYWdlLCB3aGljaCBvbiByZWFsIGRldmljZXMgZW5zdXJlcyB0aGUgYWN0dWFsIG1lc3NhZ2VcbiAgICAvLyBnZXRzIHNlbnQgdG8gdGhlIGRldmljZS4gd2l0aG91dCB0aGlzIGl0IHdpbGwgcGVyaW9kaWNhbGx5IGhhbmcgd2l0aFxuICAgIC8vIG5vdGhpbmcgc2VudFxuICAgIC8vIGhvd2V2ZXIsIHRoaXMgY2F1c2VzIHdlYmluc3BlY3RvcmQgdG8gY3Jhc2ggb24gZGV2aWNlcyBydW5uaW5nIGlPUyAxMFxuICAgIGlmICghdGhpcy5faXNTaW11bGF0b3IgJiYgdGhpcy5fbWFqb3JPc1ZlcnNpb24gPj0gUEFSVElBTF9NRVNTQUdFX1NVUFBPUlRfREVQUkVDQVRJT05fVkVSU0lPTikge1xuICAgICAgdGhpcy5fZW5jb2Rlci53cml0ZSgnICcpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gd2hpY2ggd2lsbCBiZSBjYWxsZWQgZHVyaW5nIG1lc3NhZ2UgbGlzdGVuaW5nXG4gICAqIEBuYW1lIE1lc3NhZ2VDYWxsYmFja1xuICAgKiBAZnVuY3Rpb25cbiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgcnBjIG9iamVjdCB0aGF0IGlzIHNlbnQgZnJvbSB0aGUgd2ViaW5zcGVjdG9yZFxuICAqL1xuXG4gIC8qKlxuICAgKiBMaXN0ZW4gdG8gbWVzc2FnZXMgY29taW5nIGZyb20gd2ViaW5zcGVjdG9yZFxuICAgKiBAcGFyYW0ge01lc3NhZ2VDYWxsYmFja30gY2FsbGJhY2tcbiAgICovXG4gIGxpc3Rlbk1lc3NhZ2UgKG9uRGF0YSkge1xuICAgIHRoaXMuX2RlY29kZXIub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgaWYgKHRoaXMuX3ZlcmJvc2UpIHtcbiAgICAgICAgbG9nLmRlYnVnKCdSZWNlaXZlZCBtZXNzYWdlIGZyb20gV2ViIEluc3BlY3RvcjonKTtcbiAgICAgICAgbG9nLmRlYnVnKHV0aWwuanNvblN0cmluZ2lmeShkYXRhKSk7XG4gICAgICB9XG4gICAgICBvbkRhdGEoZGF0YSk7XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IHsgV2ViSW5zcGVjdG9yU2VydmljZSwgV0VCX0lOU1BFQ1RPUl9TRVJWSUNFX05BTUUgfTtcbmV4cG9ydCBkZWZhdWx0IFdlYkluc3BlY3RvclNlcnZpY2U7XG4iXSwiZmlsZSI6ImxpYi93ZWJpbnNwZWN0b3IvaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==

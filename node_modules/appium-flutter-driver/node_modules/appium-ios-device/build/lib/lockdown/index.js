"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Lockdown = exports.LOCKDOWN_PORT = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _baseService = require("../base-service");

const LOCKDOWN_PORT = 62078;
exports.LOCKDOWN_PORT = LOCKDOWN_PORT;
const LABEL = 'usbmuxd';
const PROTOCOL_VERSION = 2;

class Lockdown extends _baseService.BaseServicePlist {
  async queryType(timeout = 5000) {
    const data = await this._plistService.sendPlistAndReceive({
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'QueryType'
    }, timeout);

    if (data.Request === 'QueryType' && data.Type === 'com.apple.mobile.lockdown') {
      return data;
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  async startSession(hostID, systemBUID, timeout = 5000) {
    const data = await this._plistService.sendPlistAndReceive({
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'StartSession',
      HostID: hostID,
      SystemBUID: systemBUID
    }, timeout);

    if (data.Request === 'StartSession' && data.SessionID) {
      return {
        sessionID: data.SessionID,
        enableSessionSSL: data.EnableSessionSSL
      };
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  enableSessionSSL(hostPrivateKey, hostCertificate) {
    this._plistService.enableSessionSSL(hostPrivateKey, hostCertificate);
  }

  async getValue(query = {}, timeout = 5000) {
    const plist = Object.assign({
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'GetValue'
    }, query);
    const data = await this._plistService.sendPlistAndReceive(plist, timeout);

    if ((data === null || data === void 0 ? void 0 : data.Request) === 'GetValue' && !_lodash.default.isNil(data === null || data === void 0 ? void 0 : data.Value)) {
      return data.Value;
    }

    throw new Error(`Unexpected data received for ${JSON.stringify(query)} request: ` + JSON.stringify(data));
  }

  async startService(serviceName, timeout = 5000) {
    const data = await this._plistService.sendPlistAndReceive({
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'StartService',
      Service: serviceName
    }, timeout);

    if (data.Error) {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    } else {
      return data;
    }
  }

}

exports.Lockdown = Lockdown;
var _default = Lockdown;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9sb2NrZG93bi9pbmRleC5qcyJdLCJuYW1lcyI6WyJMT0NLRE9XTl9QT1JUIiwiTEFCRUwiLCJQUk9UT0NPTF9WRVJTSU9OIiwiTG9ja2Rvd24iLCJCYXNlU2VydmljZVBsaXN0IiwicXVlcnlUeXBlIiwidGltZW91dCIsImRhdGEiLCJfcGxpc3RTZXJ2aWNlIiwic2VuZFBsaXN0QW5kUmVjZWl2ZSIsIkxhYmVsIiwiUHJvdG9jb2xWZXJzaW9uIiwiUmVxdWVzdCIsIlR5cGUiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJzdGFydFNlc3Npb24iLCJob3N0SUQiLCJzeXN0ZW1CVUlEIiwiSG9zdElEIiwiU3lzdGVtQlVJRCIsIlNlc3Npb25JRCIsInNlc3Npb25JRCIsImVuYWJsZVNlc3Npb25TU0wiLCJFbmFibGVTZXNzaW9uU1NMIiwiaG9zdFByaXZhdGVLZXkiLCJob3N0Q2VydGlmaWNhdGUiLCJnZXRWYWx1ZSIsInF1ZXJ5IiwicGxpc3QiLCJPYmplY3QiLCJhc3NpZ24iLCJfIiwiaXNOaWwiLCJWYWx1ZSIsInN0YXJ0U2VydmljZSIsInNlcnZpY2VOYW1lIiwiU2VydmljZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFHQSxNQUFNQSxhQUFhLEdBQUcsS0FBdEI7O0FBQ0EsTUFBTUMsS0FBSyxHQUFHLFNBQWQ7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxDQUF6Qjs7QUFFQSxNQUFNQyxRQUFOLFNBQXVCQyw2QkFBdkIsQ0FBd0M7QUFNdkIsUUFBVEMsU0FBUyxDQUFFQyxPQUFPLEdBQUcsSUFBWixFQUFrQjtBQUMvQixVQUFNQyxJQUFJLEdBQUcsTUFBTSxLQUFLQyxhQUFMLENBQW1CQyxtQkFBbkIsQ0FBdUM7QUFDeERDLE1BQUFBLEtBQUssRUFBRVQsS0FEaUQ7QUFFeERVLE1BQUFBLGVBQWUsRUFBRVQsZ0JBRnVDO0FBR3hEVSxNQUFBQSxPQUFPLEVBQUU7QUFIK0MsS0FBdkMsRUFJaEJOLE9BSmdCLENBQW5C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SUFBSSxDQUFDTyxLQUFULEVBQWdCO0FBQ2QsWUFBTSxJQUFJQSxLQUFKLENBQVcsb0JBQW1CQyxJQUFJLENBQUNDLFNBQUwsQ0FBZVQsSUFBZixDQUFxQixFQUFuRCxDQUFOO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsYUFBT0EsSUFBUDtBQUNEO0FBQ0Y7O0FBbkdxQzs7O2VBdUd6QkosUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBCYXNlU2VydmljZVBsaXN0IH0gZnJvbSAnLi4vYmFzZS1zZXJ2aWNlJztcblxuXG5jb25zdCBMT0NLRE9XTl9QT1JUID0gNjIwNzg7XG5jb25zdCBMQUJFTCA9ICd1c2JtdXhkJztcbmNvbnN0IFBST1RPQ09MX1ZFUlNJT04gPSAyO1xuXG5jbGFzcyBMb2NrZG93biBleHRlbmRzIEJhc2VTZXJ2aWNlUGxpc3Qge1xuICAvKipcbiAgICogTWFrZXMgYSBxdWVyeSB0eXBlIHJlcXVlc3QgdG8gbG9ja2Rvd25cbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0PTUwMDBdIHRoZSB0aW1lb3V0IG9mIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gbG9ja2Rvd25kXG4gICAqIEByZXR1cm5zIHtPYmplY3R9XG4gICAqL1xuICBhc3luYyBxdWVyeVR5cGUgKHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuX3BsaXN0U2VydmljZS5zZW5kUGxpc3RBbmRSZWNlaXZlKHtcbiAgICAgIExhYmVsOiBMQUJFTCxcbiAgICAgIFByb3RvY29sVmVyc2lvbjogUFJPVE9DT0xfVkVSU0lPTixcbiAgICAgIFJlcXVlc3Q6ICdRdWVyeVR5cGUnXG4gICAgfSwgdGltZW91dCk7XG4gICAgaWYgKGRhdGEuUmVxdWVzdCA9PT0gJ1F1ZXJ5VHlwZScgJiYgZGF0YS5UeXBlID09PSAnY29tLmFwcGxlLm1vYmlsZS5sb2NrZG93bicpIHtcbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3RhcnRzIGEgbG9ja2Rvd24gc2Vzc2lvbiB3aGljaCBhbGxvd3MgdG8gdXNlIGNlcnRhaW4gYXBpc1xuICAgKiBAcGFyYW0ge3N0cmluZ30gaG9zdElEIHRoZSBob3N0IGlkIHdoaWNoIGNhbiBiZSByZXRyaWV2ZWQgZnJvbSB0aGUgcGFpciByZWNvcmRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN5c3RlbUJVSUQgdGhlIGhvc3QgQlVJRCB3aGljaCBjYW4gYmUgcmV0cmlldmVkIGZyb20gdGhlIHBhaXIgcmVjb3JkXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIGxvY2tkb3duZFxuICAgKiBAcmV0dXJucyB7T2JqZWN0fVxuICAgKi9cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChob3N0SUQsIHN5c3RlbUJVSUQsIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuX3BsaXN0U2VydmljZS5zZW5kUGxpc3RBbmRSZWNlaXZlKHtcbiAgICAgIExhYmVsOiBMQUJFTCxcbiAgICAgIFByb3RvY29sVmVyc2lvbjogUFJPVE9DT0xfVkVSU0lPTixcbiAgICAgIFJlcXVlc3Q6ICdTdGFydFNlc3Npb24nLFxuICAgICAgSG9zdElEOiBob3N0SUQsXG4gICAgICBTeXN0ZW1CVUlEOiBzeXN0ZW1CVUlEXG4gICAgfSwgdGltZW91dCk7XG5cbiAgICBpZiAoZGF0YS5SZXF1ZXN0ID09PSAnU3RhcnRTZXNzaW9uJyAmJiBkYXRhLlNlc3Npb25JRCkge1xuICAgICAgcmV0dXJuIHsgc2Vzc2lvbklEOiBkYXRhLlNlc3Npb25JRCwgZW5hYmxlU2Vzc2lvblNTTDogZGF0YS5FbmFibGVTZXNzaW9uU1NMIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFbmFibGVzIHNzbCBpbiB0aGUgdW5kZXJseWluZyBzb2NrZXQgc29ja2V0IGNvbm5lY3Rpb25cbiAgICogQHBhcmFtIHtCdWZmZXJ9IGhvc3RQcml2YXRlS2V5IHRoZSBwcml2YXRlIGtleSB3aGljaCBjYW4gYmUgcmV0cmlldmVkIGZyb20gdGhlIHBhaXIgcmVjb3JkXG4gICAqIEBwYXJhbSB7QnVmZmVyfSBob3N0Q2VydGlmaWNhdGUgdGhlIGNlcnRpZmljYXRlIHdoaWNoIGNhbiBiZSByZXRyaWV2ZWQgZnJvbSB0aGUgcGFpciByZWNvcmRcbiAgICovXG4gIGVuYWJsZVNlc3Npb25TU0wgKGhvc3RQcml2YXRlS2V5LCBob3N0Q2VydGlmaWNhdGUpIHtcbiAgICB0aGlzLl9wbGlzdFNlcnZpY2UuZW5hYmxlU2Vzc2lvblNTTChob3N0UHJpdmF0ZUtleSwgaG9zdENlcnRpZmljYXRlKTtcbiAgfVxuXG4gIC8qKlxuICAqIEB0eXBlZGVmIHtPYmplY3R9IFF1ZXJ5XG4gICpcbiAgKiBAcHJvcGVydHkgez9zdHJpbmd9IGtleSBUaGUga2V5IHdlIHdhbnQgdG8gYWNjZXNzXG4gICogQHByb3BlcnR5IHs/c3RyaW5nfSBkb21haW4gVGhlIGRvbWFpbiB3aGVyZSB3ZSB3YW50IHRvIGFjY2Vzc1xuICAqL1xuXG4gIC8qKlxuICAgKiBHZXRzIHZhbHVlcyBmcm9tIHRoZSBkZXZpY2UgYWNjb3JkaW5nIHRvIHRoZSBxdWVyeSBwYXNzZWRcbiAgICpcbiAgICogQHBhcmFtIHtRdWVyeX0gcXVlcnkgdGhlIHF1ZXJ5IHdlIHdhbnQgdG8gc2VuZCB0byBsb2NrZG93bmRcbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0PTUwMDBdIHRoZSB0aW1lb3V0IG9mIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gbG9ja2Rvd25kXG4gICAqIEByZXR1cm5zIHsqfSBUaGUgYWN0dWFsIHJlc3BvbnNlIHZhbHVlLiBJdCBzaG91bGQgbmV2ZXIgYmUgYG51bGxgIG9yIGB1bmRlZmluZWRgXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiBhbiB1bmV4cGVjdGVkIHJlc3BvbnNlIGlzIHJlY2VpdmVkIGZyb20gbG9ja2Rvd25kXG4gICAqL1xuICBhc3luYyBnZXRWYWx1ZSAocXVlcnkgPSB7fSwgdGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCBwbGlzdCA9IE9iamVjdC5hc3NpZ24oe1xuICAgICAgTGFiZWw6IExBQkVMLFxuICAgICAgUHJvdG9jb2xWZXJzaW9uOiBQUk9UT0NPTF9WRVJTSU9OLFxuICAgICAgUmVxdWVzdDogJ0dldFZhbHVlJ1xuICAgIH0sIHF1ZXJ5KTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5fcGxpc3RTZXJ2aWNlLnNlbmRQbGlzdEFuZFJlY2VpdmUocGxpc3QsIHRpbWVvdXQpO1xuICAgIGlmIChkYXRhPy5SZXF1ZXN0ID09PSAnR2V0VmFsdWUnICYmICFfLmlzTmlsKGRhdGE/LlZhbHVlKSkge1xuICAgICAgcmV0dXJuIGRhdGEuVmFsdWU7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhIHJlY2VpdmVkIGZvciAke0pTT04uc3RyaW5naWZ5KHF1ZXJ5KX0gcmVxdWVzdDogYCArXG4gICAgICBKU09OLnN0cmluZ2lmeShkYXRhKSk7XG4gIH1cblxuICAvKipcbiAgICogU3RhcnRzIGEgc2VydmljZSBvbiB0aGUgcGhvbmUgY29ycmVzcG9uZGluZyB0byB0aGUgbmFtZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gc2VydmljZU5hbWUgdGhlIG5hbWUgb2YgdGhlIHNlcnZpY2Ugd2hpY2ggd2Ugd2FudCB0byBzdGFydFxuICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXQ9NTAwMF0gdGhlIHRpbWVvdXQgb2YgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSBsb2NrZG93bmRcbiAgICogQHJldHVybnMge09iamVjdH1cbiAgICovXG4gIGFzeW5jIHN0YXJ0U2VydmljZSAoc2VydmljZU5hbWUsIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuX3BsaXN0U2VydmljZS5zZW5kUGxpc3RBbmRSZWNlaXZlKHtcbiAgICAgIExhYmVsOiBMQUJFTCxcbiAgICAgIFByb3RvY29sVmVyc2lvbjogUFJPVE9DT0xfVkVSU0lPTixcbiAgICAgIFJlcXVlc3Q6ICdTdGFydFNlcnZpY2UnLFxuICAgICAgU2VydmljZTogc2VydmljZU5hbWUsXG4gICAgfSwgdGltZW91dCk7XG5cbiAgICBpZiAoZGF0YS5FcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBMb2NrZG93biwgTE9DS0RPV05fUE9SVCB9O1xuZXhwb3J0IGRlZmF1bHQgTG9ja2Rvd247XG4iXSwiZmlsZSI6ImxpYi9sb2NrZG93bi9pbmRleC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9

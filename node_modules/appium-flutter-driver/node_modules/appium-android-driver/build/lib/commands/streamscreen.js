"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _support = require("@appium/support");

var _logger = _interopRequireDefault(require("../logger"));

var _teen_process = require("teen_process");

var _portscanner = require("portscanner");

var _http = _interopRequireDefault(require("http"));

var _net = _interopRequireDefault(require("net"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _asyncbox = require("asyncbox");

var _child_process = require("child_process");

var _url = _interopRequireDefault(require("url"));

const commands = {};
const RECORDING_INTERVAL_SEC = 5;
const STREAMING_STARTUP_TIMEOUT_MS = 5000;
const GSTREAMER_BINARY = `gst-launch-1.0${_support.system.isWindows() ? '.exe' : ''}`;
const GST_INSPECT_BINARY = `gst-inspect-1.0${_support.system.isWindows() ? '.exe' : ''}`;
const REQUIRED_GST_PLUGINS = {
  avdec_h264: 'gst-libav',
  h264parse: 'gst-plugins-bad',
  jpegenc: 'gst-plugins-good',
  tcpserversink: 'gst-plugins-base',
  multipartmux: 'gst-plugins-good'
};
const SCREENRECORD_BINARY = 'screenrecord';
const GST_TUTORIAL_URL = 'https://gstreamer.freedesktop.org/documentation/installing/index.html';
const DEFAULT_HOST = '127.0.0.1';
const TCP_HOST = '127.0.0.1';
const DEFAULT_PORT = 8093;
const DEFAULT_QUALITY = 70;
const DEFAULT_BITRATE = 4000000;
const BOUNDARY_STRING = '--2ae9746887f170b8cf7c271047ce314c';
const ADB_SCREEN_STREAMING_FEATURE = 'adb_screen_streaming';

function createStreamingLogger(streamName, udid) {
  return _support.logger.getLogger(`${streamName}@` + _lodash.default.truncate(udid, {
    length: 8,
    omission: ''
  }));
}

async function verifyStreamingRequirements(adb) {
  if (!_lodash.default.trim(await adb.shell(['which', SCREENRECORD_BINARY]))) {
    throw new Error(`The required '${SCREENRECORD_BINARY}' binary is not available on the device under test`);
  }

  const gstreamerCheckPromises = [];

  for (const binaryName of [GSTREAMER_BINARY, GST_INSPECT_BINARY]) {
    gstreamerCheckPromises.push((async () => {
      try {
        await _support.fs.which(binaryName);
      } catch (e) {
        throw new Error(`The '${binaryName}' binary is not available in the PATH on the host system. ` + `See ${GST_TUTORIAL_URL} for more details on how to install it.`);
      }
    })());
  }

  await _bluebird.default.all(gstreamerCheckPromises);
  const moduleCheckPromises = [];

  for (const [name, modName] of _lodash.default.toPairs(REQUIRED_GST_PLUGINS)) {
    moduleCheckPromises.push((async () => {
      const {
        stdout
      } = await (0, _teen_process.exec)(GST_INSPECT_BINARY, [name]);

      if (!_lodash.default.includes(stdout, modName)) {
        throw new Error(`The required GStreamer plugin '${name}' from '${modName}' module is not installed. ` + `See ${GST_TUTORIAL_URL} for more details on how to install it.`);
      }
    })());
  }

  await _bluebird.default.all(moduleCheckPromises);
}

async function getDeviceInfo(adb) {
  const output = await adb.shell(['dumpsys', 'display']);
  const result = {};

  for (const [key, pattern] of [['width', /\bdeviceWidth=(\d+)/], ['height', /\bdeviceHeight=(\d+)/], ['fps', /\bfps=(\d+)/]]) {
    const match = pattern.exec(output);

    if (!match) {
      _logger.default.debug(output);

      throw new Error(`Cannot parse the device ${key} from the adb command output. ` + `Check the server log for more details.`);
    }

    result[key] = parseInt(match[1], 10);
  }

  result.udid = adb.curDeviceId;
  return result;
}

async function initDeviceStreamingProc(adb, deviceInfo, opts = {}) {
  const {
    width,
    height,
    bitRate
  } = opts;
  const adjustedWidth = parseInt(width, 10) || deviceInfo.width;
  const adjustedHeight = parseInt(height, 10) || deviceInfo.height;
  const adjustedBitrate = parseInt(bitRate, 10) || DEFAULT_BITRATE;
  let screenRecordCmd = SCREENRECORD_BINARY + ` --output-format=h264` + ` --time-limit=${RECORDING_INTERVAL_SEC}`;

  if (width || height) {
    screenRecordCmd += ` --size=${adjustedWidth}x${adjustedHeight}`;
  }

  if (bitRate) {
    screenRecordCmd += ` --bit-rate=${adjustedBitrate}`;
  }

  const adbArgs = [...adb.executable.defaultArgs, 'exec-out', `while true; do ${screenRecordCmd} -; done`];
  const deviceStreaming = (0, _child_process.spawn)(adb.executable.path, adbArgs);
  deviceStreaming.on('exit', (code, signal) => {
    _logger.default.debug(`Device streaming process exited with code ${code}, signal ${signal}`);
  });
  let isStarted = false;
  const deviceStreamingLogger = createStreamingLogger(SCREENRECORD_BINARY, deviceInfo.udid);

  const errorsListener = chunk => {
    const stderr = chunk.toString();

    if (_lodash.default.trim(stderr)) {
      deviceStreamingLogger.debug(stderr);
    }
  };

  deviceStreaming.stderr.on('data', errorsListener);

  const startupListener = chunk => {
    if (!isStarted) {
      isStarted = !_lodash.default.isEmpty(chunk);
    }
  };

  deviceStreaming.stdout.on('data', startupListener);

  try {
    _logger.default.info(`Starting device streaming: ${_support.util.quote([adb.executable.path, ...adbArgs])}`);

    await (0, _asyncbox.waitForCondition)(() => isStarted, {
      waitMs: STREAMING_STARTUP_TIMEOUT_MS,
      intervalMs: 300
    });
  } catch (e) {
    _logger.default.errorAndThrow(`Cannot start the screen streaming process. Original error: ${e.message}`);
  } finally {
    deviceStreaming.stderr.removeListener('data', errorsListener);
    deviceStreaming.stdout.removeListener('data', startupListener);
  }

  return deviceStreaming;
}

async function initGstreamerPipeline(deviceStreamingProc, deviceInfo, opts = {}) {
  const {
    width,
    height,
    quality,
    tcpPort,
    considerRotation,
    logPipelineDetails
  } = opts;
  const adjustedWidth = parseInt(width, 10) || deviceInfo.width;
  const adjustedHeight = parseInt(height, 10) || deviceInfo.height;
  const gstreamerPipeline = new _teen_process.SubProcess(GSTREAMER_BINARY, ['-v', 'fdsrc', 'fd=0', '!', 'video/x-h264,' + `width=${considerRotation ? Math.max(adjustedWidth, adjustedHeight) : adjustedWidth},` + `height=${considerRotation ? Math.max(adjustedWidth, adjustedHeight) : adjustedHeight},` + `framerate=${deviceInfo.fps}/1,` + 'byte-stream=true', '!', 'h264parse', '!', 'queue', 'leaky=downstream', '!', 'avdec_h264', '!', 'queue', 'leaky=downstream', '!', 'jpegenc', `quality=${quality}`, '!', 'multipartmux', `boundary=${BOUNDARY_STRING}`, '!', 'tcpserversink', `host=${TCP_HOST}`, `port=${tcpPort}`], {
    stdio: [deviceStreamingProc.stdout, 'pipe', 'pipe']
  });
  gstreamerPipeline.on('exit', (code, signal) => {
    _logger.default.debug(`Pipeline streaming process exited with code ${code}, signal ${signal}`);
  });
  const gstreamerLogger = createStreamingLogger('gst', deviceInfo.udid);

  const gstOutputListener = (stdout, stderr) => {
    if (_lodash.default.trim(stderr || stdout)) {
      gstreamerLogger.debug(stderr || stdout);
    }
  };

  gstreamerPipeline.on('output', gstOutputListener);
  let didFail = false;

  try {
    _logger.default.info(`Starting GStreamer pipeline: ${gstreamerPipeline.rep}`);

    await gstreamerPipeline.start(0);
    await (0, _asyncbox.waitForCondition)(async () => {
      try {
        return (await (0, _portscanner.checkPortStatus)(tcpPort, TCP_HOST)) === 'open';
      } catch (ign) {
        return false;
      }
    }, {
      waitMs: STREAMING_STARTUP_TIMEOUT_MS,
      intervalMs: 300
    });
  } catch (e) {
    didFail = true;

    _logger.default.errorAndThrow(`Cannot start the screen streaming pipeline. Original error: ${e.message}`);
  } finally {
    if (!logPipelineDetails || didFail) {
      gstreamerPipeline.removeListener('output', gstOutputListener);
    }
  }

  return gstreamerPipeline;
}

function extractRemoteAddress(req) {
  return req.headers['x-forwarded-for'] || req.socket.remoteAddress || req.connection.remoteAddress || req.connection.socket.remoteAddress;
}

commands.mobileStartScreenStreaming = async function mobileStartScreenStreaming(options = {}) {
  this.ensureFeatureEnabled(ADB_SCREEN_STREAMING_FEATURE);
  const {
    width,
    height,
    bitRate,
    host = DEFAULT_HOST,
    port = DEFAULT_PORT,
    pathname,
    tcpPort = DEFAULT_PORT + 1,
    quality = DEFAULT_QUALITY,
    considerRotation = false,
    logPipelineDetails = false
  } = options;

  if (_lodash.default.isUndefined(this._screenStreamingProps)) {
    await verifyStreamingRequirements(this.adb);
  }

  if (!_lodash.default.isEmpty(this._screenStreamingProps)) {
    _logger.default.info(`The screen streaming session is already running. ` + `Stop it first in order to start a new one.`);

    return;
  }

  if ((await (0, _portscanner.checkPortStatus)(port, host)) === 'open') {
    _logger.default.info(`The port #${port} at ${host} is busy. ` + `Assuming the screen streaming is already running`);

    return;
  }

  if ((await (0, _portscanner.checkPortStatus)(tcpPort, TCP_HOST)) === 'open') {
    _logger.default.errorAndThrow(`The port #${tcpPort} at ${TCP_HOST} is busy. ` + `Make sure there are no leftovers from previous sessions.`);
  }

  this._screenStreamingProps = null;
  const deviceInfo = await getDeviceInfo(this.adb);
  const deviceStreamingProc = await initDeviceStreamingProc(this.adb, deviceInfo, {
    width,
    height,
    bitRate
  });
  let gstreamerPipeline;

  try {
    gstreamerPipeline = await initGstreamerPipeline(deviceStreamingProc, deviceInfo, {
      width,
      height,
      quality,
      tcpPort,
      considerRotation,
      logPipelineDetails
    });
  } catch (e) {
    if (deviceStreamingProc.kill(0)) {
      deviceStreamingProc.kill();
    }

    throw e;
  }

  let mjpegSocket;
  let mjpegServer;

  try {
    await new _bluebird.default((resolve, reject) => {
      mjpegSocket = _net.default.createConnection(tcpPort, TCP_HOST, () => {
        _logger.default.info(`Successfully connected to MJPEG stream at tcp://${TCP_HOST}:${tcpPort}`);

        mjpegServer = _http.default.createServer((req, res) => {
          const remoteAddress = extractRemoteAddress(req);

          const currentPathname = _url.default.parse(req.url).pathname;

          _logger.default.info(`Got an incoming screen bradcasting request from ${remoteAddress} ` + `(${req.headers['user-agent'] || 'User Agent unknown'}) at ${currentPathname}`);

          if (pathname && currentPathname !== pathname) {
            _logger.default.info('Rejecting the broadcast request since it does not match the given pathname');

            res.writeHead(404, {
              Connection: 'close',
              'Content-Type': 'text/plain; charset=utf-8'
            });
            res.write(`'${currentPathname}' did not match any known endpoints`);
            res.end();
            return;
          }

          _logger.default.info('Starting MJPEG broadcast');

          res.writeHead(200, {
            'Cache-Control': 'no-store, no-cache, must-revalidate, pre-check=0, post-check=0, max-age=0',
            Pragma: 'no-cache',
            Connection: 'close',
            'Content-Type': `multipart/x-mixed-replace; boundary=${BOUNDARY_STRING}`
          });
          mjpegSocket.pipe(res);
        });
        mjpegServer.on('error', e => {
          _logger.default.warn(e);

          reject(e);
        });
        mjpegServer.on('close', () => {
          _logger.default.debug(`MJPEG server at http://${host}:${port} has been closed`);
        });
        mjpegServer.on('listening', () => {
          _logger.default.info(`Successfully started MJPEG server at http://${host}:${port}`);

          resolve();
        });
        mjpegServer.listen(port, host);
      });
      mjpegSocket.on('error', e => {
        _logger.default.error(e);

        reject(e);
      });
    }).timeout(STREAMING_STARTUP_TIMEOUT_MS, `Cannot connect to the streaming server within ${STREAMING_STARTUP_TIMEOUT_MS}ms`);
  } catch (e) {
    if (deviceStreamingProc.kill(0)) {
      deviceStreamingProc.kill();
    }

    if (gstreamerPipeline.isRunning) {
      await gstreamerPipeline.stop();
    }

    if (mjpegSocket) {
      mjpegSocket.destroy();
    }

    if (mjpegServer && mjpegServer.listening) {
      mjpegServer.close();
    }

    throw e;
  }

  this._screenStreamingProps = {
    deviceStreamingProc,
    gstreamerPipeline,
    mjpegSocket,
    mjpegServer
  };
};

commands.mobileStopScreenStreaming = async function mobileStopScreenStreaming() {
  if (_lodash.default.isEmpty(this._screenStreamingProps)) {
    if (!_lodash.default.isUndefined(this._screenStreamingProps)) {
      _logger.default.debug(`Screen streaming is not running. There is nothing to stop`);
    }

    return;
  }

  const {
    deviceStreamingProc,
    gstreamerPipeline,
    mjpegSocket,
    mjpegServer
  } = this._screenStreamingProps;

  try {
    mjpegSocket.end();

    if (mjpegServer.listening) {
      mjpegServer.close();
    }

    if (deviceStreamingProc.kill(0)) {
      deviceStreamingProc.kill('SIGINT');
    }

    if (gstreamerPipeline.isRunning) {
      try {
        await gstreamerPipeline.stop('SIGINT');
      } catch (e) {
        _logger.default.warn(e);

        try {
          await gstreamerPipeline.stop('SIGKILL');
        } catch (e1) {
          _logger.default.error(e1);
        }
      }
    }

    _logger.default.info(`Successfully terminated the screen streaming MJPEG server`);
  } finally {
    this._screenStreamingProps = null;
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9zdHJlYW1zY3JlZW4uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJSRUNPUkRJTkdfSU5URVJWQUxfU0VDIiwiU1RSRUFNSU5HX1NUQVJUVVBfVElNRU9VVF9NUyIsIkdTVFJFQU1FUl9CSU5BUlkiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJHU1RfSU5TUEVDVF9CSU5BUlkiLCJSRVFVSVJFRF9HU1RfUExVR0lOUyIsImF2ZGVjX2gyNjQiLCJoMjY0cGFyc2UiLCJqcGVnZW5jIiwidGNwc2VydmVyc2luayIsIm11bHRpcGFydG11eCIsIlNDUkVFTlJFQ09SRF9CSU5BUlkiLCJHU1RfVFVUT1JJQUxfVVJMIiwiREVGQVVMVF9IT1NUIiwiVENQX0hPU1QiLCJERUZBVUxUX1BPUlQiLCJERUZBVUxUX1FVQUxJVFkiLCJERUZBVUxUX0JJVFJBVEUiLCJCT1VOREFSWV9TVFJJTkciLCJBREJfU0NSRUVOX1NUUkVBTUlOR19GRUFUVVJFIiwiY3JlYXRlU3RyZWFtaW5nTG9nZ2VyIiwic3RyZWFtTmFtZSIsInVkaWQiLCJsb2dnZXIiLCJnZXRMb2dnZXIiLCJfIiwidHJ1bmNhdGUiLCJsZW5ndGgiLCJvbWlzc2lvbiIsInZlcmlmeVN0cmVhbWluZ1JlcXVpcmVtZW50cyIsImFkYiIsInRyaW0iLCJzaGVsbCIsIkVycm9yIiwiZ3N0cmVhbWVyQ2hlY2tQcm9taXNlcyIsImJpbmFyeU5hbWUiLCJwdXNoIiwiZnMiLCJ3aGljaCIsImUiLCJCIiwiYWxsIiwibW9kdWxlQ2hlY2tQcm9taXNlcyIsIm5hbWUiLCJtb2ROYW1lIiwidG9QYWlycyIsInN0ZG91dCIsImluY2x1ZGVzIiwiZ2V0RGV2aWNlSW5mbyIsIm91dHB1dCIsInJlc3VsdCIsImtleSIsInBhdHRlcm4iLCJtYXRjaCIsImV4ZWMiLCJsb2ciLCJkZWJ1ZyIsInBhcnNlSW50IiwiY3VyRGV2aWNlSWQiLCJpbml0RGV2aWNlU3RyZWFtaW5nUHJvYyIsImRldmljZUluZm8iLCJvcHRzIiwid2lkdGgiLCJoZWlnaHQiLCJiaXRSYXRlIiwiYWRqdXN0ZWRXaWR0aCIsImFkanVzdGVkSGVpZ2h0IiwiYWRqdXN0ZWRCaXRyYXRlIiwic2NyZWVuUmVjb3JkQ21kIiwiYWRiQXJncyIsImV4ZWN1dGFibGUiLCJkZWZhdWx0QXJncyIsImRldmljZVN0cmVhbWluZyIsInBhdGgiLCJvbiIsImNvZGUiLCJzaWduYWwiLCJpc1N0YXJ0ZWQiLCJkZXZpY2VTdHJlYW1pbmdMb2dnZXIiLCJlcnJvcnNMaXN0ZW5lciIsImNodW5rIiwic3RkZXJyIiwidG9TdHJpbmciLCJzdGFydHVwTGlzdGVuZXIiLCJpc0VtcHR5IiwiaW5mbyIsInV0aWwiLCJxdW90ZSIsIndhaXRNcyIsImludGVydmFsTXMiLCJlcnJvckFuZFRocm93IiwibWVzc2FnZSIsInJlbW92ZUxpc3RlbmVyIiwiaW5pdEdzdHJlYW1lclBpcGVsaW5lIiwiZGV2aWNlU3RyZWFtaW5nUHJvYyIsInF1YWxpdHkiLCJ0Y3BQb3J0IiwiY29uc2lkZXJSb3RhdGlvbiIsImxvZ1BpcGVsaW5lRGV0YWlscyIsImdzdHJlYW1lclBpcGVsaW5lIiwiU3ViUHJvY2VzcyIsIk1hdGgiLCJtYXgiLCJmcHMiLCJzdGRpbyIsImdzdHJlYW1lckxvZ2dlciIsImdzdE91dHB1dExpc3RlbmVyIiwiZGlkRmFpbCIsInJlcCIsInN0YXJ0IiwiaWduIiwiZXh0cmFjdFJlbW90ZUFkZHJlc3MiLCJyZXEiLCJoZWFkZXJzIiwic29ja2V0IiwicmVtb3RlQWRkcmVzcyIsImNvbm5lY3Rpb24iLCJtb2JpbGVTdGFydFNjcmVlblN0cmVhbWluZyIsIm9wdGlvbnMiLCJlbnN1cmVGZWF0dXJlRW5hYmxlZCIsImhvc3QiLCJwb3J0IiwicGF0aG5hbWUiLCJpc1VuZGVmaW5lZCIsIl9zY3JlZW5TdHJlYW1pbmdQcm9wcyIsImtpbGwiLCJtanBlZ1NvY2tldCIsIm1qcGVnU2VydmVyIiwicmVzb2x2ZSIsInJlamVjdCIsIm5ldCIsImNyZWF0ZUNvbm5lY3Rpb24iLCJodHRwIiwiY3JlYXRlU2VydmVyIiwicmVzIiwiY3VycmVudFBhdGhuYW1lIiwidXJsIiwicGFyc2UiLCJ3cml0ZUhlYWQiLCJDb25uZWN0aW9uIiwid3JpdGUiLCJlbmQiLCJQcmFnbWEiLCJwaXBlIiwid2FybiIsImxpc3RlbiIsImVycm9yIiwidGltZW91dCIsImlzUnVubmluZyIsInN0b3AiLCJkZXN0cm95IiwibGlzdGVuaW5nIiwiY2xvc2UiLCJtb2JpbGVTdG9wU2NyZWVuU3RyZWFtaW5nIiwiZTEiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsUUFBUSxHQUFHLEVBQWpCO0FBRUEsTUFBTUMsc0JBQXNCLEdBQUcsQ0FBL0I7QUFDQSxNQUFNQyw0QkFBNEIsR0FBRyxJQUFyQztBQUNBLE1BQU1DLGdCQUFnQixHQUFJLGlCQUFnQkMsZ0JBQU9DLFNBQVAsS0FBcUIsTUFBckIsR0FBOEIsRUFBRyxFQUEzRTtBQUNBLE1BQU1DLGtCQUFrQixHQUFJLGtCQUFpQkYsZ0JBQU9DLFNBQVAsS0FBcUIsTUFBckIsR0FBOEIsRUFBRyxFQUE5RTtBQUNBLE1BQU1FLG9CQUFvQixHQUFHO0FBQzNCQyxFQUFBQSxVQUFVLEVBQUUsV0FEZTtBQUUzQkMsRUFBQUEsU0FBUyxFQUFFLGlCQUZnQjtBQUczQkMsRUFBQUEsT0FBTyxFQUFFLGtCQUhrQjtBQUkzQkMsRUFBQUEsYUFBYSxFQUFFLGtCQUpZO0FBSzNCQyxFQUFBQSxZQUFZLEVBQUU7QUFMYSxDQUE3QjtBQU9BLE1BQU1DLG1CQUFtQixHQUFHLGNBQTVCO0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsdUVBQXpCO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLFdBQXJCO0FBQ0EsTUFBTUMsUUFBUSxHQUFHLFdBQWpCO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLElBQXJCO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLEVBQXhCO0FBQ0EsTUFBTUMsZUFBZSxHQUFH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TTRELGlCQUFpQixDQUFDa0QsSUFBbEIsQ0FBdUIsU0FBdkIsQ0FBTjtBQUNELFNBRkQsQ0FFRSxPQUFPSyxFQUFQLEVBQVc7QUFDWG5HLDBCQUFJMkYsS0FBSixDQUFVUSxFQUFWO0FBQ0Q7QUFDRjtBQUNGOztBQUNEbkcsb0JBQUk4QixJQUFKLENBQVUsMkRBQVY7QUFDRCxHQXJCRCxTQXFCVTtBQUNSLFNBQUt1QyxxQkFBTCxHQUE2QixJQUE3QjtBQUNEO0FBQ0YsQ0F2Q0Q7O2VBMENlOUgsUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBmcywgc3lzdGVtLCBsb2dnZXIsIHV0aWwgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZXhlYywgU3ViUHJvY2VzcyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBjaGVja1BvcnRTdGF0dXMgfSBmcm9tICdwb3J0c2Nhbm5lcic7XG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBzcGF3biB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuXG5jb25zdCBjb21tYW5kcyA9IHt9O1xuXG5jb25zdCBSRUNPUkRJTkdfSU5URVJWQUxfU0VDID0gNTtcbmNvbnN0IFNUUkVBTUlOR19TVEFSVFVQX1RJTUVPVVRfTVMgPSA1MDAwO1xuY29uc3QgR1NUUkVBTUVSX0JJTkFSWSA9IGBnc3QtbGF1bmNoLTEuMCR7c3lzdGVtLmlzV2luZG93cygpID8gJy5leGUnIDogJyd9YDtcbmNvbnN0IEdTVF9JTlNQRUNUX0JJTkFSWSA9IGBnc3QtaW5zcGVjdC0xLjAke3N5c3RlbS5pc1dpbmRvd3MoKSA/ICcuZXhlJyA6ICcnfWA7XG5jb25zdCBSRVFVSVJFRF9HU1RfUExVR0lOUyA9IHtcbiAgYXZkZWNfaDI2NDogJ2dzdC1saWJhdicsXG4gIGgyNjRwYXJzZTogJ2dzdC1wbHVnaW5zLWJhZCcsXG4gIGpwZWdlbmM6ICdnc3QtcGx1Z2lucy1nb29kJyxcbiAgdGNwc2VydmVyc2luazogJ2dzdC1wbHVnaW5zLWJhc2UnLFxuICBtdWx0aXBhcnRtdXg6ICdnc3QtcGx1Z2lucy1nb29kJyxcbn07XG5jb25zdCBTQ1JFRU5SRUNPUkRfQklOQVJZID0gJ3NjcmVlbnJlY29yZCc7XG5jb25zdCBHU1RfVFVUT1JJQUxfVVJMID0gJ2h0dHBzOi8vZ3N0cmVhbWVyLmZyZWVkZXNrdG9wLm9yZy9kb2N1bWVudGF0aW9uL2luc3RhbGxpbmcvaW5kZXguaHRtbCc7XG5jb25zdCBERUZBVUxUX0hPU1QgPSAnMTI3LjAuMC4xJztcbmNvbnN0IFRDUF9IT1NUID0gJzEyNy4wLjAuMSc7XG5jb25zdCBERUZBVUxUX1BPUlQgPSA4MDkzO1xuY29uc3QgREVGQVVMVF9RVUFMSVRZID0gNzA7XG5jb25zdCBERUZBVUxUX0JJVFJBVEUgPSA0MDAwMDAwOyAvLyA0IE1icHNcbmNvbnN0IEJPVU5EQVJZX1NUUklORyA9ICctLTJhZTk3NDY4ODdmMTcwYjhjZjdjMjcxMDQ3Y2UzMTRjJztcblxuY29uc3QgQURCX1NDUkVFTl9TVFJFQU1JTkdfRkVBVFVSRSA9ICdhZGJfc2NyZWVuX3N0cmVhbWluZyc7XG5cbmZ1bmN0aW9uIGNyZWF0ZVN0cmVhbWluZ0xvZ2dlciAoc3RyZWFtTmFtZSwgdWRpZCkge1xuICByZXR1cm4gbG9nZ2VyLmdldExvZ2dlcihgJHtzdHJlYW1OYW1lfUBgICsgXy50cnVuY2F0ZSh1ZGlkLCB7XG4gICAgbGVuZ3RoOiA4LFxuICAgIG9taXNzaW9uOiAnJyxcbiAgfSkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlTdHJlYW1pbmdSZXF1aXJlbWVudHMgKGFkYikge1xuICBpZiAoIV8udHJpbShhd2FpdCBhZGIuc2hlbGwoWyd3aGljaCcsIFNDUkVFTlJFQ09SRF9CSU5BUlldKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlIHJlcXVpcmVkICcke1NDUkVFTlJFQ09SRF9CSU5BUll9JyBiaW5hcnkgaXMgbm90IGF2YWlsYWJsZSBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3RgKTtcbiAgfVxuXG4gIGNvbnN0IGdzdHJlYW1lckNoZWNrUHJvbWlzZXMgPSBbXTtcbiAgZm9yIChjb25zdCBiaW5hcnlOYW1lIG9mIFtHU1RSRUFNRVJfQklOQVJZLCBHU1RfSU5TUEVDVF9CSU5BUlldKSB7XG4gICAgZ3N0cmVhbWVyQ2hlY2tQcm9taXNlcy5wdXNoKChhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBmcy53aGljaChiaW5hcnlOYW1lKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgJyR7YmluYXJ5TmFtZX0nIGJpbmFyeSBpcyBub3QgYXZhaWxhYmxlIGluIHRoZSBQQVRIIG9uIHRoZSBob3N0IHN5c3RlbS4gYCArXG4gICAgICAgICAgYFNlZSAke0dTVF9UVVRPUklBTF9VUkx9IGZvciBtb3JlIGRldGFpbHMgb24gaG93IHRvIGluc3RhbGwgaXQuYCk7XG4gICAgICB9XG4gICAgfSkoKSk7XG4gIH1cbiAgYXdhaXQgQi5hbGwoZ3N0cmVhbWVyQ2hlY2tQcm9taXNlcyk7XG5cbiAgY29uc3QgbW9kdWxlQ2hlY2tQcm9taXNlcyA9IFtdO1xuICBmb3IgKGNvbnN0IFtuYW1lLCBtb2ROYW1lXSBvZiBfLnRvUGFpcnMoUkVRVUlSRURfR1NUX1BMVUdJTlMpKSB7XG4gICAgbW9kdWxlQ2hlY2tQcm9taXNlcy5wdXNoKChhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoR1NUX0lOU1BFQ1RfQklOQVJZLCBbbmFtZV0pO1xuICAgICAgaWYgKCFfLmluY2x1ZGVzKHN0ZG91dCwgbW9kTmFtZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBUaGUgcmVxdWlyZWQgR1N0cmVhbWVyIHBsdWdpbiAnJHtuYW1lfScgZnJvbSAnJHttb2ROYW1lfScgbW9kdWxlIGlzIG5vdCBpbnN0YWxsZWQuIGAgK1xuICAgICAgICAgIGBTZWUgJHtHU1RfVFVUT1JJQUxfVVJMfSBmb3IgbW9yZSBkZXRhaWxzIG9uIGhvdyB0byBpbnN0YWxsIGl0LmApO1xuICAgICAgfVxuICAgIH0pKCkpO1xuICB9XG4gIGF3YWl0IEIuYWxsKG1vZHVsZUNoZWNrUHJvbWlzZXMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXREZXZpY2VJbmZvIChhZGIpIHtcbiAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgYWRiLnNoZWxsKFsnZHVtcHN5cycsICdkaXNwbGF5J10pO1xuICBjb25zdCByZXN1bHQgPSB7fTtcbiAgZm9yIChjb25zdCBba2V5LCBwYXR0ZXJuXSBvZiBbXG4gICAgWyd3aWR0aCcsIC9cXGJkZXZpY2VXaWR0aD0oXFxkKykvXSxcbiAgICBbJ2hlaWdodCcsIC9cXGJkZXZpY2VIZWlnaHQ9KFxcZCspL10sXG4gICAgWydmcHMnLCAvXFxiZnBzPShcXGQrKS9dLFxuICBdKSB7XG4gICAgY29uc3QgbWF0Y2ggPSBwYXR0ZXJuLmV4ZWMob3V0cHV0KTtcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICBsb2cuZGVidWcob3V0cHV0KTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHBhcnNlIHRoZSBkZXZpY2UgJHtrZXl9IGZyb20gdGhlIGFkYiBjb21tYW5kIG91dHB1dC4gYCArXG4gICAgICAgIGBDaGVjayB0aGUgc2VydmVyIGxvZyBmb3IgbW9yZSBkZXRhaWxzLmApO1xuICAgIH1cbiAgICByZXN1bHRba2V5XSA9IHBhcnNlSW50KG1hdGNoWzFdLCAxMCk7XG4gIH1cbiAgcmVzdWx0LnVkaWQgPSBhZGIuY3VyRGV2aWNlSWQ7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXREZXZpY2VTdHJlYW1pbmdQcm9jIChhZGIsIGRldmljZUluZm8sIG9wdHMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgd2lkdGgsXG4gICAgaGVpZ2h0LFxuICAgIGJpdFJhdGUsXG4gIH0gPSBvcHRzO1xuICBjb25zdCBhZGp1c3RlZFdpZHRoID0gcGFyc2VJbnQod2lkdGgsIDEwKSB8fCBkZXZpY2VJbmZvLndpZHRoO1xuICBjb25zdCBhZGp1c3RlZEhlaWdodCA9IHBhcnNlSW50KGhlaWdodCwgMTApIHx8IGRldmljZUluZm8uaGVpZ2h0O1xuICBjb25zdCBhZGp1c3RlZEJpdHJhdGUgPSBwYXJzZUludChiaXRSYXRlLCAxMCkgfHwgREVGQVVMVF9CSVRSQVRFO1xuICBsZXQgc2NyZWVuUmVjb3JkQ21kID0gU0NSRUVOUkVDT1JEX0JJTkFSWSArXG4gICAgYCAtLW91dHB1dC1mb3JtYXQ9aDI2NGAgK1xuICAgIC8vIDUgc2Vjb25kcyBpcyBmaW5lIHRvIGRldGVjdCByb3RhdGlvbiBjaGFuZ2VzXG4gICAgYCAtLXRpbWUtbGltaXQ9JHtSRUNPUkRJTkdfSU5URVJWQUxfU0VDfWA7XG4gIGlmICh3aWR0aCB8fCBoZWlnaHQpIHtcbiAgICBzY3JlZW5SZWNvcmRDbWQgKz0gYCAtLXNpemU9JHthZGp1c3RlZFdpZHRofXgke2FkanVzdGVkSGVpZ2h0fWA7XG4gIH1cbiAgaWYgKGJpdFJhdGUpIHtcbiAgICBzY3JlZW5SZWNvcmRDbWQgKz0gYCAtLWJpdC1yYXRlPSR7YWRqdXN0ZWRCaXRyYXRlfWA7XG4gIH1cbiAgY29uc3QgYWRiQXJncyA9IFtcbiAgICAuLi5hZGIuZXhlY3V0YWJsZS5kZWZhdWx0QXJncyxcbiAgICAnZXhlYy1vdXQnLFxuICAgIC8vIFRoZSBsb29wIGlzIHJlcXVpcmVkLCBiZWNhdXNlIGJ5IGRlZmF1bHQgdGhlIG1heGltdW0gcmVjb3JkIGR1cmF0aW9uXG4gICAgLy8gZm9yIHNjcmVlbnJlY29yZCBpcyBhbHdheXMgbGltaXRlZFxuICAgIGB3aGlsZSB0cnVlOyBkbyAke3NjcmVlblJlY29yZENtZH0gLTsgZG9uZWAsXG4gIF07XG4gIGNvbnN0IGRldmljZVN0cmVhbWluZyA9IHNwYXduKGFkYi5leGVjdXRhYmxlLnBhdGgsIGFkYkFyZ3MpO1xuICBkZXZpY2VTdHJlYW1pbmcub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgbG9nLmRlYnVnKGBEZXZpY2Ugc3RyZWFtaW5nIHByb2Nlc3MgZXhpdGVkIHdpdGggY29kZSAke2NvZGV9LCBzaWduYWwgJHtzaWduYWx9YCk7XG4gIH0pO1xuXG4gIGxldCBpc1N0YXJ0ZWQgPSBmYWxzZTtcbiAgY29uc3QgZGV2aWNlU3RyZWFtaW5nTG9nZ2VyID0gY3JlYXRlU3RyZWFtaW5nTG9nZ2VyKFNDUkVFTlJFQ09SRF9CSU5BUlksIGRldmljZUluZm8udWRpZCk7XG4gIGNvbnN0IGVycm9yc0xpc3RlbmVyID0gKGNodW5rKSA9PiB7XG4gICAgY29uc3Qgc3RkZXJyID0gY2h1bmsudG9TdHJpbmcoKTtcbiAgICBpZiAoXy50cmltKHN0ZGVycikpIHtcbiAgICAgIGRldmljZVN0cmVhbWluZ0xvZ2dlci5kZWJ1ZyhzdGRlcnIpO1xuICAgIH1cbiAgfTtcbiAgZGV2aWNlU3RyZWFtaW5nLnN0ZGVyci5vbignZGF0YScsIGVycm9yc0xpc3RlbmVyKTtcblxuICBjb25zdCBzdGFydHVwTGlzdGVuZXIgPSAoY2h1bmspID0+IHtcbiAgICBpZiAoIWlzU3RhcnRlZCkge1xuICAgICAgaXNTdGFydGVkID0gIV8uaXNFbXB0eShjaHVuayk7XG4gICAgfVxuICB9O1xuICBkZXZpY2VTdHJlYW1pbmcuc3Rkb3V0Lm9uKCdkYXRhJywgc3RhcnR1cExpc3RlbmVyKTtcblxuICB0cnkge1xuICAgIGxvZy5pbmZvKGBTdGFydGluZyBkZXZpY2Ugc3RyZWFtaW5nOiAke3V0aWwucXVvdGUoW2FkYi5leGVjdXRhYmxlLnBhdGgsIC4uLmFkYkFyZ3NdKX1gKTtcbiAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKCgpID0+IGlzU3RhcnRlZCwge1xuICAgICAgd2FpdE1zOiBTVFJFQU1JTkdfU1RBUlRVUF9USU1FT1VUX01TLFxuICAgICAgaW50ZXJ2YWxNczogMzAwLFxuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coXG4gICAgICBgQ2Fubm90IHN0YXJ0IHRoZSBzY3JlZW4gc3RyZWFtaW5nIHByb2Nlc3MuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBkZXZpY2VTdHJlYW1pbmcuc3RkZXJyLnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgZXJyb3JzTGlzdGVuZXIpO1xuICAgIGRldmljZVN0cmVhbWluZy5zdGRvdXQucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBzdGFydHVwTGlzdGVuZXIpO1xuICB9XG4gIHJldHVybiBkZXZpY2VTdHJlYW1pbmc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXRHc3RyZWFtZXJQaXBlbGluZSAoZGV2aWNlU3RyZWFtaW5nUHJvYywgZGV2aWNlSW5mbywgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB3aWR0aCxcbiAgICBoZWlnaHQsXG4gICAgcXVhbGl0eSxcbiAgICB0Y3BQb3J0LFxuICAgIGNvbnNpZGVyUm90YXRpb24sXG4gICAgbG9nUGlwZWxpbmVEZXRhaWxzLFxuICB9ID0gb3B0cztcbiAgY29uc3QgYWRqdXN0ZWRXaWR0aCA9IHBhcnNlSW50KHdpZHRoLCAxMCkgfHwgZGV2aWNlSW5mby53aWR0aDtcbiAgY29uc3QgYWRqdXN0ZWRIZWlnaHQgPSBwYXJzZUludChoZWlnaHQsIDEwKSB8fCBkZXZpY2VJbmZvLmhlaWdodDtcbiAgY29uc3QgZ3N0cmVhbWVyUGlwZWxpbmUgPSBuZXcgU3ViUHJvY2VzcyhHU1RSRUFNRVJfQklOQVJZLCBbXG4gICAgJy12JyxcbiAgICAnZmRzcmMnLCAnZmQ9MCcsXG4gICAgJyEnLCAndmlkZW8veC1oMjY0LCcgK1xuICAgICAgYHdpZHRoPSR7Y29uc2lkZXJSb3RhdGlvbiA/IE1hdGgubWF4KGFkanVzdGVkV2lkdGgsIGFkanVzdGVkSGVpZ2h0KSA6IGFkanVzdGVkV2lkdGh9LGAgK1xuICAgICAgYGhlaWdodD0ke2NvbnNpZGVyUm90YXRpb24gPyBNYXRoLm1heChhZGp1c3RlZFdpZHRoLCBhZGp1c3RlZEhlaWdodCkgOiBhZGp1c3RlZEhlaWdodH0sYCArXG4gICAgICBgZnJhbWVyYXRlPSR7ZGV2aWNlSW5mby5mcHN9LzEsYCArXG4gICAgICAnYnl0ZS1zdHJlYW09dHJ1ZScsXG4gICAgJyEnLCAnaDI2NHBhcnNlJyxcbiAgICAnIScsICdxdWV1ZScsICdsZWFreT1kb3duc3RyZWFtJyxcbiAgICAnIScsICdhdmRlY19oMjY0JyxcbiAgICAnIScsICdxdWV1ZScsICdsZWFreT1kb3duc3RyZWFtJyxcbiAgICAnIScsICdqcGVnZW5jJywgYHF1YWxpdHk9JHtxdWFsaXR5fWAsXG4gICAgJyEnLCAnbXVsdGlwYXJ0bXV4JywgYGJvdW5kYXJ5PSR7Qk9VTkRBUllfU1RSSU5HfWAsXG4gICAgJyEnLCAndGNwc2VydmVyc2luaycsIGBob3N0PSR7VENQX0hPU1R9YCwgYHBvcnQ9JHt0Y3BQb3J0fWAsXG4gIF0sIHtcbiAgICBzdGRpbzogW2RldmljZVN0cmVhbWluZ1Byb2Muc3Rkb3V0LCAncGlwZScsICdwaXBlJ11cbiAgfSk7XG4gIGdzdHJlYW1lclBpcGVsaW5lLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgIGxvZy5kZWJ1ZyhgUGlwZWxpbmUgc3RyZWFtaW5nIHByb2Nlc3MgZXhpdGVkIHdpdGggY29kZSAke2NvZGV9LCBzaWduYWwgJHtzaWduYWx9YCk7XG4gIH0pO1xuICBjb25zdCBnc3RyZWFtZXJMb2dnZXIgPSBjcmVhdGVTdHJlYW1pbmdMb2dnZXIoJ2dzdCcsIGRldmljZUluZm8udWRpZCk7XG4gIGNvbnN0IGdzdE91dHB1dExpc3RlbmVyID0gKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgaWYgKF8udHJpbShzdGRlcnIgfHwgc3Rkb3V0KSkge1xuICAgICAgZ3N0cmVhbWVyTG9nZ2VyLmRlYnVnKHN0ZGVyciB8fCBzdGRvdXQpO1xuICAgIH1cbiAgfTtcbiAgZ3N0cmVhbWVyUGlwZWxpbmUub24oJ291dHB1dCcsIGdzdE91dHB1dExpc3RlbmVyKTtcbiAgbGV0IGRpZEZhaWwgPSBmYWxzZTtcbiAgdHJ5IHtcbiAgICBsb2cuaW5mbyhgU3RhcnRpbmcgR1N0cmVhbWVyIHBpcGVsaW5lOiAke2dzdHJlYW1lclBpcGVsaW5lLnJlcH1gKTtcbiAgICBhd2FpdCBnc3RyZWFtZXJQaXBlbGluZS5zdGFydCgwKTtcbiAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiAoYXdhaXQgY2hlY2tQb3J0U3RhdHVzKHRjcFBvcnQsIFRDUF9IT1NUKSkgPT09ICdvcGVuJztcbiAgICAgIH0gY2F0Y2ggKGlnbikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfSwge1xuICAgICAgd2FpdE1zOiBTVFJFQU1JTkdfU1RBUlRVUF9USU1FT1VUX01TLFxuICAgICAgaW50ZXJ2YWxNczogMzAwLFxuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgZGlkRmFpbCA9IHRydWU7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coXG4gICAgICBgQ2Fubm90IHN0YXJ0IHRoZSBzY3JlZW4gc3RyZWFtaW5nIHBpcGVsaW5lLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH0gZmluYWxseSB7XG4gICAgaWYgKCFsb2dQaXBlbGluZURldGFpbHMgfHwgZGlkRmFpbCkge1xuICAgICAgZ3N0cmVhbWVyUGlwZWxpbmUucmVtb3ZlTGlzdGVuZXIoJ291dHB1dCcsIGdzdE91dHB1dExpc3RlbmVyKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGdzdHJlYW1lclBpcGVsaW5lO1xufVxuXG5mdW5jdGlvbiBleHRyYWN0UmVtb3RlQWRkcmVzcyAocmVxKSB7XG4gIHJldHVybiByZXEuaGVhZGVyc1sneC1mb3J3YXJkZWQtZm9yJ11cbiAgICB8fCByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3NcbiAgICB8fCByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzXG4gICAgfHwgcmVxLmNvbm5lY3Rpb24uc29ja2V0LnJlbW90ZUFkZHJlc3M7XG59XG5cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdGFydFNjcmVlblN0cmVhbWluZ09wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9udW1iZXJ9IHdpZHRoIC0gVGhlIHNjYWxlZCB3aWR0aCBvZiB0aGUgZGV2aWNlJ3Mgc2NyZWVuLiBJZiB1bnNldCB0aGVuIHRoZSBzY3JpcHQgd2lsbCBhc3NpZ24gaXRcbiAqIHRvIHRoZSBhY3R1YWwgc2NyZWVuIHdpZHRoIG1lYXN1cmVkIGluIHBpeGVscy5cbiAqIEBwcm9wZXJ0eSB7P251bWJlcn0gaGVpZ2h0IC0gVGhlIHNjYWxlZCBoZWlnaHQgb2YgdGhlIGRldmljZSdzIHNjcmVlbi4gSWYgdW5zZXQgdGhlbiB0aGUgc2NyaXB0IHdpbGwgYXNzaWduIGl0XG4gKiB0byB0aGUgYWN0dWFsIHNjcmVlbiBoZWlnaHQgbWVhc3VyZWQgaW4gcGl4ZWxzLlxuICogQHByb3BlcnR5IHs/bnVtYmVyfSBiaXRSYXRlIC0gVGhlIHZpZGVvIGJpdCByYXRlIGZvciB0aGUgdmlkZW8sIGluIGJpdHMgcGVyIHNlY29uZC5cbiAqIFRoZSBkZWZhdWx0IHZhbHVlIGlzIDQwMDAwMDAgKDQgTWIvcykuIFlvdSBjYW4gaW5jcmVhc2UgdGhlIGJpdCByYXRlIHRvIGltcHJvdmUgdmlkZW8gcXVhbGl0eSxcbiAqIGJ1dCBkb2luZyBzbyByZXN1bHRzIGluIGxhcmdlciBtb3ZpZSBmaWxlcy5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gaG9zdCBbMTI3LjAuMC4xXSAtIFRoZSBJUCBhZGRyZXNzL2hvc3QgbmFtZSB0byBzdGFydCB0aGUgTUpQRUcgc2VydmVyIG9uLlxuICogWW91IGNhbiBzZXQgaXQgdG8gYDAuMC4wLjBgIHRvIHRyaWdnZXIgdGhlIGJyb2FkY2FzdCBvbiBhbGwgYXZhaWxhYmxlIG5ldHdvcmsgaW50ZXJmYWNlcy5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGF0aG5hbWUgLSBUaGUgSFRUUCByZXF1ZXN0IHBhdGggdGhlIE1KUEVHIHNlcnZlciBzaG91bGQgYmUgYXZhaWxhYmxlIG9uLlxuICogSWYgdW5zZXQgdGhlbiBhbnkgcGF0aG5hbWUgb24gdGhlIGdpdmVuIGBob3N0YC9gcG9ydGAgY29tYmluYXRpb24gd2lsbCB3b3JrLiBOb3RlIHRoYXQgdGhlIHZhbHVlXG4gKiBzaG91bGQgYWx3YXlzIHN0YXJ0IHdpdGggYSBzaW5nbGUgc2xhc2g6IGAvYFxuICogQHByb3BlcnR5IHs/bnVtYmVyfSB0Y3BQb3J0IFs4MDk0XSAtIFRoZSBwb3J0IG51bWJlciB0byBzdGFydCB0aGUgaW50ZXJuYWwgVENQIE1KUEVHIGJyb2FkY2FzdCBvbi5cbiAqIFRoaXMgdHlwZSBvZiBicm9hZGNhc3QgYWx3YXlzIHN0YXJ0cyBvbiB0aGUgbG9vcGJhY2sgaW50ZXJmYWNlIChgMTI3LjAuMC4xYCkuXG4gKiBAcHJvcGVydHkgez9udW1iZXJ9IHBvcnQgWzgwOTNdIC0gVGhlIHBvcnQgbnVtYmVyIHRvIHN0YXJ0IHRoZSBNSlBFRyBzZXJ2ZXIgb24uXG4gKiBAcHJvcGVydHkgez9udW1iZXJ9IHF1YWxpdHkgWzcwXSAtIFRoZSBxdWFsaXR5IHZhbHVlIGZvciB0aGUgc3RyZWFtZWQgSlBFRyBpbWFnZXMuXG4gKiBUaGlzIG51bWJlciBzaG91bGQgYmUgaW4gcmFuZ2UgWzEsIDEwMF0sIHdoZXJlIDEwMCBpcyB0aGUgYmVzdCBxdWFsaXR5LlxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gY29uc2lkZXJSb3RhdGlvbiBbZmFsc2VdIC0gSWYgc2V0IHRvIGB0cnVlYCB0aGVuIEdTdHJlYW1lciBwaXBlbGluZSB3aWxsXG4gKiBpbmNyZWFzZSB0aGUgZGltZW5zaW9ucyBvZiB0aGUgcmVzdWx0aW5nIGltYWdlcyB0byBwcm9wZXJseSBmaXQgaW1hZ2VzIGluIGJvdGggbGFuZHNjYXBlIGFuZFxuICogcG9ydHJhaXQgb3JpZW50YXRpb25zLiBTZXQgaXQgdG8gYHRydWVgIGlmIHRoZSBkZXZpY2Ugcm90YXRpb24gaXMgbm90IGdvaW5nIHRvIGJlIHRoZSBzYW1lIGR1cmluZyB0aGVcbiAqIGJyb2FkY2FzdGluZyBzZXNzaW9uLlxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gbG9nUGlwZWxpbmVEZXRhaWxzIFtmYWxzZV0gLSBXaGV0aGVyIHRvIGxvZyBHU3RyZWFtZXIgcGlwZWxpbmUgZXZlbnRzIGludG9cbiAqIHRoZSBzdGFuZGFyZCBsb2cgb3V0cHV0LiBNaWdodCBiZSB1c2VmdWwgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy5cbiAqL1xuXG4vKipcbiAqIFN0YXJ0cyBkZXZpY2Ugc2NyZWVuIGJyb2FkY2FzdCBieSBjcmVhdGluZyBNSlBFRyBzZXJ2ZXIuXG4gKiBNdWx0aXBsZSBjYWxscyB0byB0aGlzIG1ldGhvZCBoYXZlIG5vIGVmZmVjdCB1bmxlc3MgdGhlIHByZXZpb3VzIHN0cmVhbWluZ1xuICogc2Vzc2lvbiBpcyBzdG9wcGVkLlxuICogVGhpcyBtZXRob2Qgb25seSB3b3JrcyBpZiB0aGUgYGFkYl9zY3JlZW5fc3RyZWFtaW5nYCBmZWF0dXJlIGlzXG4gKiBlbmFibGVkIG9uIHRoZSBzZXJ2ZXIgc2lkZS5cbiAqXG4gKiBAcGFyYW0gez9TdGFydFNjcmVlblN0cmVhbWluZ09wdGlvbnN9IG9wdGlvbnMgLSBUaGUgYXZhaWxhYmxlIG9wdGlvbnMuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2NyZWVuIHN0cmVhbWluZyBoYXMgZmFpbGVkIHRvIHN0YXJ0IG9yXG4gKiBpcyBub3Qgc3VwcG9ydGVkIG9uIHRoZSBob3N0IHN5c3RlbSBvclxuICogdGhlIGNvcnJlc3BvbmRpbmcgc2VydmVyIGZlYXR1cmUgaXMgbm90IGVuYWJsZWQuXG4gKi9cbmNvbW1hbmRzLm1vYmlsZVN0YXJ0U2NyZWVuU3RyZWFtaW5nID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlU3RhcnRTY3JlZW5TdHJlYW1pbmcgKG9wdGlvbnMgPSB7fSkge1xuICB0aGlzLmVuc3VyZUZlYXR1cmVFbmFibGVkKEFEQl9TQ1JFRU5fU1RSRUFNSU5HX0ZFQVRVUkUpO1xuXG4gIGNvbnN0IHtcbiAgICB3aWR0aCxcbiAgICBoZWlnaHQsXG4gICAgYml0UmF0ZSxcbiAgICBob3N0ID0gREVGQVVMVF9IT1NULFxuICAgIHBvcnQgPSBERUZBVUxUX1BPUlQsXG4gICAgcGF0aG5hbWUsXG4gICAgdGNwUG9ydCA9IERFRkFVTFRfUE9SVCArIDEsXG4gICAgcXVhbGl0eSA9IERFRkFVTFRfUVVBTElUWSxcbiAgICBjb25zaWRlclJvdGF0aW9uID0gZmFsc2UsXG4gICAgbG9nUGlwZWxpbmVEZXRhaWxzID0gZmFsc2UsXG4gIH0gPSBvcHRpb25zO1xuXG4gIGlmIChfLmlzVW5kZWZpbmVkKHRoaXMuX3NjcmVlblN0cmVhbWluZ1Byb3BzKSkge1xuICAgIGF3YWl0IHZlcmlmeVN0cmVhbWluZ1JlcXVpcmVtZW50cyh0aGlzLmFkYik7XG4gIH1cbiAgaWYgKCFfLmlzRW1wdHkodGhpcy5fc2NyZWVuU3RyZWFtaW5nUHJvcHMpKSB7XG4gICAgbG9nLmluZm8oYFRoZSBzY3JlZW4gc3RyZWFtaW5nIHNlc3Npb24gaXMgYWxyZWFkeSBydW5uaW5nLiBgICtcbiAgICAgIGBTdG9wIGl0IGZpcnN0IGluIG9yZGVyIHRvIHN0YXJ0IGEgbmV3IG9uZS5gKTtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKChhd2FpdCBjaGVja1BvcnRTdGF0dXMocG9ydCwgaG9zdCkpID09PSAnb3BlbicpIHtcbiAgICBsb2cuaW5mbyhgVGhlIHBvcnQgIyR7cG9ydH0gYXQgJHtob3N0fSBpcyBidXN5LiBgICtcbiAgICAgIGBBc3N1bWluZyB0aGUgc2NyZWVuIHN0cmVhbWluZyBpcyBhbHJlYWR5IHJ1bm5pbmdgKTtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKChhd2FpdCBjaGVja1BvcnRTdGF0dXModGNwUG9ydCwgVENQX0hPU1QpKSA9PT0gJ29wZW4nKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSBwb3J0ICMke3RjcFBvcnR9IGF0ICR7VENQX0hPU1R9IGlzIGJ1c3kuIGAgK1xuICAgICAgYE1ha2Ugc3VyZSB0aGVyZSBhcmUgbm8gbGVmdG92ZXJzIGZyb20gcHJldmlvdXMgc2Vzc2lvbnMuYCk7XG4gIH1cbiAgdGhpcy5fc2NyZWVuU3RyZWFtaW5nUHJvcHMgPSBudWxsO1xuXG4gIGNvbnN0IGRldmljZUluZm8gPSBhd2FpdCBnZXREZXZpY2VJbmZvKHRoaXMuYWRiKTtcbiAgY29uc3QgZGV2aWNlU3RyZWFtaW5nUHJvYyA9IGF3YWl0IGluaXREZXZpY2VTdHJlYW1pbmdQcm9jKHRoaXMuYWRiLCBkZXZpY2VJbmZvLCB7XG4gICAgd2lkdGgsXG4gICAgaGVpZ2h0LFxuICAgIGJpdFJhdGUsXG4gIH0pO1xuICBsZXQgZ3N0cmVhbWVyUGlwZWxpbmU7XG4gIHRyeSB7XG4gICAgZ3N0cmVhbWVyUGlwZWxpbmUgPSBhd2FpdCBpbml0R3N0cmVhbWVyUGlwZWxpbmUoZGV2aWNlU3RyZWFtaW5nUHJvYywgZGV2aWNlSW5mbywge1xuICAgICAgd2lkdGgsXG4gICAgICBoZWlnaHQsXG4gICAgICBxdWFsaXR5LFxuICAgICAgdGNwUG9ydCxcbiAgICAgIGNvbnNpZGVyUm90YXRpb24sXG4gICAgICBsb2dQaXBlbGluZURldGFpbHMsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZGV2aWNlU3RyZWFtaW5nUHJvYy5raWxsKDApKSB7XG4gICAgICBkZXZpY2VTdHJlYW1pbmdQcm9jLmtpbGwoKTtcbiAgICB9XG4gICAgdGhyb3cgZTtcbiAgfVxuXG4gIGxldCBtanBlZ1NvY2tldDtcbiAgbGV0IG1qcGVnU2VydmVyO1xuICB0cnkge1xuICAgIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIG1qcGVnU29ja2V0ID0gbmV0LmNyZWF0ZUNvbm5lY3Rpb24odGNwUG9ydCwgVENQX0hPU1QsICgpID0+IHtcbiAgICAgICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBjb25uZWN0ZWQgdG8gTUpQRUcgc3RyZWFtIGF0IHRjcDovLyR7VENQX0hPU1R9OiR7dGNwUG9ydH1gKTtcbiAgICAgICAgbWpwZWdTZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcigocmVxLCByZXMpID0+IHtcbiAgICAgICAgICBjb25zdCByZW1vdGVBZGRyZXNzID0gZXh0cmFjdFJlbW90ZUFkZHJlc3MocmVxKTtcbiAgICAgICAgICBjb25zdCBjdXJyZW50UGF0aG5hbWUgPSB1cmwucGFyc2UocmVxLnVybCkucGF0aG5hbWU7XG4gICAgICAgICAgbG9nLmluZm8oYEdvdCBhbiBpbmNvbWluZyBzY3JlZW4gYnJhZGNhc3RpbmcgcmVxdWVzdCBmcm9tICR7cmVtb3RlQWRkcmVzc30gYCArXG4gICAgICAgICAgICBgKCR7cmVxLmhlYWRlcnNbJ3VzZXItYWdlbnQnXSB8fCAnVXNlciBBZ2VudCB1bmtub3duJ30pIGF0ICR7Y3VycmVudFBhdGhuYW1lfWApO1xuXG4gICAgICAgICAgaWYgKHBhdGhuYW1lICYmIGN1cnJlbnRQYXRobmFtZSAhPT0gcGF0aG5hbWUpIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKCdSZWplY3RpbmcgdGhlIGJyb2FkY2FzdCByZXF1ZXN0IHNpbmNlIGl0IGRvZXMgbm90IG1hdGNoIHRoZSBnaXZlbiBwYXRobmFtZScpO1xuICAgICAgICAgICAgcmVzLndyaXRlSGVhZCg0MDQsIHtcbiAgICAgICAgICAgICAgQ29ubmVjdGlvbjogJ2Nsb3NlJyxcbiAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICd0ZXh0L3BsYWluOyBjaGFyc2V0PXV0Zi04JyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmVzLndyaXRlKGAnJHtjdXJyZW50UGF0aG5hbWV9JyBkaWQgbm90IG1hdGNoIGFueSBrbm93biBlbmRwb2ludHNgKTtcbiAgICAgICAgICAgIHJlcy5lbmQoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsb2cuaW5mbygnU3RhcnRpbmcgTUpQRUcgYnJvYWRjYXN0Jyk7XG4gICAgICAgICAgcmVzLndyaXRlSGVhZCgyMDAsIHtcbiAgICAgICAgICAgICdDYWNoZS1Db250cm9sJzogJ25vLXN0b3JlLCBuby1jYWNoZSwgbXVzdC1yZXZhbGlkYXRlLCBwcmUtY2hlY2s9MCwgcG9zdC1jaGVjaz0wLCBtYXgtYWdlPTAnLFxuICAgICAgICAgICAgUHJhZ21hOiAnbm8tY2FjaGUnLFxuICAgICAgICAgICAgQ29ubmVjdGlvbjogJ2Nsb3NlJyxcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiBgbXVsdGlwYXJ0L3gtbWl4ZWQtcmVwbGFjZTsgYm91bmRhcnk9JHtCT1VOREFSWV9TVFJJTkd9YFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgbWpwZWdTb2NrZXQucGlwZShyZXMpO1xuICAgICAgICB9KTtcbiAgICAgICAgbWpwZWdTZXJ2ZXIub24oJ2Vycm9yJywgKGUpID0+IHtcbiAgICAgICAgICBsb2cud2FybihlKTtcbiAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgIH0pO1xuICAgICAgICBtanBlZ1NlcnZlci5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBNSlBFRyBzZXJ2ZXIgYXQgaHR0cDovLyR7aG9zdH06JHtwb3J0fSBoYXMgYmVlbiBjbG9zZWRgKTtcbiAgICAgICAgfSk7XG4gICAgICAgIG1qcGVnU2VydmVyLm9uKCdsaXN0ZW5pbmcnLCAoKSA9PiB7XG4gICAgICAgICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBzdGFydGVkIE1KUEVHIHNlcnZlciBhdCBodHRwOi8vJHtob3N0fToke3BvcnR9YCk7XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9KTtcbiAgICAgICAgbWpwZWdTZXJ2ZXIubGlzdGVuKHBvcnQsIGhvc3QpO1xuICAgICAgfSk7XG4gICAgICBtanBlZ1NvY2tldC5vbignZXJyb3InLCAoZSkgPT4ge1xuICAgICAgICBsb2cuZXJyb3IoZSk7XG4gICAgICAgIHJlamVjdChlKTtcbiAgICAgIH0pO1xuICAgIH0pLnRpbWVvdXQoU1RSRUFNSU5HX1NUQVJUVVBfVElNRU9VVF9NUyxcbiAgICAgIGBDYW5ub3QgY29ubmVjdCB0byB0aGUgc3RyZWFtaW5nIHNlcnZlciB3aXRoaW4gJHtTVFJFQU1JTkdfU1RBUlRVUF9USU1FT1VUX01TfW1zYCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZGV2aWNlU3RyZWFtaW5nUHJvYy5raWxsKDApKSB7XG4gICAgICBkZXZpY2VTdHJlYW1pbmdQcm9jLmtpbGwoKTtcbiAgICB9XG4gICAgaWYgKGdzdHJlYW1lclBpcGVsaW5lLmlzUnVubmluZykge1xuICAgICAgYXdhaXQgZ3N0cmVhbWVyUGlwZWxpbmUuc3RvcCgpO1xuICAgIH1cbiAgICBpZiAobWpwZWdTb2NrZXQpIHtcbiAgICAgIG1qcGVnU29ja2V0LmRlc3Ryb3koKTtcbiAgICB9XG4gICAgaWYgKG1qcGVnU2VydmVyICYmIG1qcGVnU2VydmVyLmxpc3RlbmluZykge1xuICAgICAgbWpwZWdTZXJ2ZXIuY2xvc2UoKTtcbiAgICB9XG4gICAgdGhyb3cgZTtcbiAgfVxuXG4gIHRoaXMuX3NjcmVlblN0cmVhbWluZ1Byb3BzID0ge1xuICAgIGRldmljZVN0cmVhbWluZ1Byb2MsXG4gICAgZ3N0cmVhbWVyUGlwZWxpbmUsXG4gICAgbWpwZWdTb2NrZXQsXG4gICAgbWpwZWdTZXJ2ZXIsXG4gIH07XG59O1xuXG4vKipcbiAqIFN0b3Agc2NyZWVuIHN0cmVhbWluZy5cbiAqIElmIG5vIHNjcmVlbiBzdHJlYW1pbmcgc2VydmVyIGhhcyBiZWVuIHN0YXJ0ZWQgdGhlbiBub3RoaW5nIGlzIGRvbmUuXG4gKi9cbmNvbW1hbmRzLm1vYmlsZVN0b3BTY3JlZW5TdHJlYW1pbmcgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVTdG9wU2NyZWVuU3RyZWFtaW5nICgvKiBvcHRpb25zID0ge30gKi8pIHtcbiAgaWYgKF8uaXNFbXB0eSh0aGlzLl9zY3JlZW5TdHJlYW1pbmdQcm9wcykpIHtcbiAgICBpZiAoIV8uaXNVbmRlZmluZWQodGhpcy5fc2NyZWVuU3RyZWFtaW5nUHJvcHMpKSB7XG4gICAgICBsb2cuZGVidWcoYFNjcmVlbiBzdHJlYW1pbmcgaXMgbm90IHJ1bm5pbmcuIFRoZXJlIGlzIG5vdGhpbmcgdG8gc3RvcGApO1xuICAgIH1cbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB7XG4gICAgZGV2aWNlU3RyZWFtaW5nUHJvYyxcbiAgICBnc3RyZWFtZXJQaXBlbGluZSxcbiAgICBtanBlZ1NvY2tldCxcbiAgICBtanBlZ1NlcnZlcixcbiAgfSA9IHRoaXMuX3NjcmVlblN0cmVhbWluZ1Byb3BzO1xuXG4gIHRyeSB7XG4gICAgbWpwZWdTb2NrZXQuZW5kKCk7XG4gICAgaWYgKG1qcGVnU2VydmVyLmxpc3RlbmluZykge1xuICAgICAgbWpwZWdTZXJ2ZXIuY2xvc2UoKTtcbiAgICB9XG4gICAgaWYgKGRldmljZVN0cmVhbWluZ1Byb2Mua2lsbCgwKSkge1xuICAgICAgZGV2aWNlU3RyZWFtaW5nUHJvYy5raWxsKCdTSUdJTlQnKTtcbiAgICB9XG4gICAgaWYgKGdzdHJlYW1lclBpcGVsaW5lLmlzUnVubmluZykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgZ3N0cmVhbWVyUGlwZWxpbmUuc3RvcCgnU0lHSU5UJyk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGUpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IGdzdHJlYW1lclBpcGVsaW5lLnN0b3AoJ1NJR0tJTEwnKTtcbiAgICAgICAgfSBjYXRjaCAoZTEpIHtcbiAgICAgICAgICBsb2cuZXJyb3IoZTEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgdGVybWluYXRlZCB0aGUgc2NyZWVuIHN0cmVhbWluZyBNSlBFRyBzZXJ2ZXJgKTtcbiAgfSBmaW5hbGx5IHtcbiAgICB0aGlzLl9zY3JlZW5TdHJlYW1pbmdQcm9wcyA9IG51bGw7XG4gIH1cbn07XG5cblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9zdHJlYW1zY3JlZW4uanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.helpers = exports.extensions = exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _baseDriver = require("@appium/base-driver");

var _logger = _interopRequireDefault(require("../logger"));

var _support = require("@appium/support");

var _momentTimezone = _interopRequireDefault(require("moment-timezone"));

var _appiumIosDevice = require("appium-ios-device");

var _teen_process = require("teen_process");

var _appUtils = require("../app-utils");

let commands = {},
    helpers = {},
    extensions = {};
exports.extensions = extensions;
exports.helpers = helpers;
exports.commands = commands;
const MOMENT_FORMAT_ISO8601 = 'YYYY-MM-DDTHH:mm:ssZ';

commands.active = async function active() {
  if (this.isWebContext()) {
    return this.cacheWebElements(await this.executeAtom('active_element', []));
  }

  return await this.proxyCommand(`/element/active`, 'GET');
};

commands.background = async function background(seconds) {
  const homescreen = '/wda/homescreen';
  const deactivateApp = '/wda/deactivateApp';
  let endpoint;
  let params = {};

  const selectEndpoint = timeoutSeconds => {
    if (!_support.util.hasValue(timeoutSeconds)) {
      endpoint = homescreen;
    } else if (!isNaN(timeoutSeconds)) {
      const duration = parseFloat(timeoutSeconds);

      if (duration >= 0) {
        params = {
          duration
        };
        endpoint = deactivateApp;
      } else {
        endpoint = homescreen;
      }
    }
  };

  if (_lodash.default.has(seconds, 'timeout')) {
    const {
      timeout
    } = seconds;
    selectEndpoint(isNaN(timeout) ? timeout : parseFloat(timeout) / 1000.0);
  } else {
    selectEndpoint(seconds);
  }

  if (!endpoint) {
    _logger.default.errorAndThrow(`Argument value is expected to be a valid number. ` + `${JSON.stringify(seconds)} has been provided instead`);
  }

  return await this.proxyCommand(endpoint, 'POST', params, endpoint !== homescreen);
};

commands.touchId = async function touchId(match = true) {
  await this.mobileSendBiometricMatch({
    match
  });
};

commands.toggleEnrollTouchId = async function toggleEnrollTouchId(isEnabled = true) {
  await this.mobileEnrollBiometric({
    isEnabled
  });
};

helpers.getWindowSizeWeb = async function getWindowSizeWeb() {
  return await this.executeAtom('get_window_size', []);
};

helpers.getWindowSizeNative = async function getWindowSizeNative() {
  return await this.proxyCommand(`/window/size`, 'GET');
};

commands.getWindowSize = async function getWindowSize(windowHandle = 'current') {
  if (windowHandle !== 'current') {
    throw new _baseDriver.errors.NotYetImplementedError('Currently only getting current window size is supported.');
  }

  if (!this.isWebContext()) {
    return await this.getWindowSizeNative();
  } else {
    return await this.getWindowSizeWeb();
  }
};

commands.getDeviceTime = async function getDeviceTime(format = MOMENT_FORMAT_ISO8601) {
  _logger.default.info('Attempting to capture iOS device date and time');

  if (!this.isRealDevice()) {
    _logger.default.info('On simulator. Assuming device time is the same as host time');

    const cmd = 'date';
    const args = ['+%Y-%m-%dT%H:%M:%S%z'];
    const inputFormat = 'YYYY-MM-DDTHH:mm:ssZZ';
    const stdout = (await (0, _teen_process.exec)(cmd, args)).stdout.trim();

    _logger.default.debug(`Got the following output out of '${cmd} ${args.join(' ')}': ${stdout}`);

    const parsedTimestamp = _momentTimezone.default.utc(stdout, inputFormat);

    if (!parsedTimestamp.isValid()) {
      _logger.default.warn(`Cannot parse the timestamp '${stdout}' returned by '${cmd}' command. Returning it as is`);

      return stdout;
    }

    return parsedTimestamp.utcOffset(parsedTimestamp._tzm || 0).format(format);
  }

  const {
    timestamp,
    utcOffset,
    timeZone
  } = await _appiumIosDevice.utilities.getDeviceTime(this.opts.udid);

  _logger.default.debug(`timestamp: ${timestamp}, utcOffset: ${utcOffset}, timeZone: ${timeZone}`);

  const utc = _momentTimezone.default.unix(timestamp).utc();

  if (Math.abs(utcOffset) <= 12 * 60) {
    return utc.utcOffset(utcOffset).format(format);
  }

  if (_lodash.default.includes(timeZone, '/')) {
    return utc.tz(timeZone).format(format);
  }

  if (Math.abs(timeZone) <= 12 * 60 * 60) {
    return utc.utcOffset(timeZone / 60).format(format);
  }

  _logger.default.warn('Did not know how to apply the UTC offset. Returning the timestamp without it');

  return utc.format(format);
};

commands.mobileGetDeviceTime = async function mobileGetDeviceTime(opts = {}) {
  return await this.getDeviceTime(opts.format);
};

commands.getWindowRect = async function getWindowRect() {
  const {
    width,
    height
  } = await this.getWindowSize();
  return {
    width,
    height,
    x: 0,
    y: 0
  };
};

commands.hideKeyboard = async function hideKeyboard(strategy, ...possibleKeys) {
  const keyNames = _lodash.default.compact(possibleKeys.slice(0, -1)).map(x => `${x}`);

  if (!keyNames.includes('done')) {
    keyNames.push('done');
  }

  await this.proxyCommand('/wda/keyboard/dismiss', 'POST', {
    keyNames
  });
};

commands.getStrings = async function getStrings(language, stringFile = null) {
  _logger.default.debug(`Gettings strings for language '${language}' and string file '${stringFile}'`);

  return await (0, _appUtils.parseLocalizableStrings)(Object.assign({}, this.opts, {
    language,
    stringFile,
    strictMode: true
  }));
};

commands.removeApp = async function removeApp(bundleId) {
  return await this.mobileRemoveApp({
    bundleId
  });
};

commands.launchApp = async function launchApp() {
  const appName = this.opts.app || this.opts.bundleId;

  try {
    await this.start();

    _logger.default.info(`Successfully launched the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while launching the '${appName}' app.`);

    throw err;
  }
};

commands.closeApp = async function closeApp() {
  const appName = this.opts.app || this.opts.bundleId;

  try {
    await this.stop();

    _logger.default.info(`Successfully closed the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while closing the '${appName}' app.`);

    throw err;
  }
};

commands.keys = async function keys(keys) {
  if (!this.isWebContext()) {
    throw new _baseDriver.errors.UnknownError('Command should be proxied to WDA');
  }

  let el = _support.util.unwrapElement(await this.active());

  if (_lodash.default.isEmpty(el)) {
    throw new _baseDriver.errors.NoSuchElementError();
  }

  await this.setValue(keys, el);
};

commands.setUrl = async function setUrl(url) {
  _logger.default.debug(`Attempting to set url '${url}'`);

  if (this.isWebContext()) {
    this.setCurrentUrl(url);
    this.curWebFrames = [];
    await this.remote.navToUrl(url);
    return;
  }

  if (this.isRealDevice()) {
    await this.proxyCommand('/url', 'POST', {
      url
    });
  } else {
    await this.opts.device.simctl.openUrl(url);
  }
};

commands.getViewportRect = async function getViewportRect() {
  const scale = await this.getDevicePixelRatio();
  const statusBarHeight = Math.round((await this.getStatusBarHeight()) * scale);
  const windowSize = await this.getWindowSize();
  return {
    left: 0,
    top: statusBarHeight,
    width: windowSize.width * scale,
    height: windowSize.height * scale - statusBarHeight
  };
};

commands.getScreenInfo = async function getScreenInfo() {
  return await this.proxyCommand('/wda/screen', 'GET');
};

commands.getStatusBarHeight = async function getStatusBarHeight() {
  const {
    statusBarSize
  } = await this.getScreenInfo();
  return statusBarSize.height;
};

commands.getDevicePixelRatio = async function getDevicePixelRatio() {
  const {
    scale
  } = await this.getScreenInfo();
  return scale;
};

commands.mobilePressButton = async function mobilePressButton(opts = {}) {
  const {
    name,
    durationSeconds
  } = opts;

  if (!name) {
    throw new _baseDriver.errors.InvalidArgumentError('Button name is mandatory');
  }

  if (!_lodash.default.isNil(durationSeconds) && !_lodash.default.isNumber(durationSeconds)) {
    throw new _baseDriver.errors.InvalidArgumentError('durationSeconds should be a number');
  }

  return await this.proxyCommand('/wda/pressButton', 'POST', {
    name,
    duration: durationSeconds
  });
};

commands.mobileSiriCommand = async function mobileSiriCommand(opts = {}) {
  const {
    text
  } = opts;

  if (!_support.util.hasValue(text)) {
    throw new _baseDriver.errors.InvalidArgumentError('"text" argument is mandatory');
  }

  return await this.proxyCommand('/wda/siri/activate', 'POST', {
    text
  });
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJNT01FTlRfRk9STUFUX0lTTzg2MDEiLCJhY3RpdmUiLCJpc1dlYkNvbnRleHQiLCJjYWNoZVdlYkVsZW1lbnRzIiwiZXhlY3V0ZUF0b20iLCJwcm94eUNvbW1hbmQiLCJiYWNrZ3JvdW5kIiwic2Vjb25kcyIsImhvbWVzY3JlZW4iLCJkZWFjdGl2YXRlQXBwIiwiZW5kcG9pbnQiLCJwYXJhbXMiLCJzZWxlY3RFbmRwb2ludCIsInRpbWVvdXRTZWNvbmRzIiwidXRpbCIsImhhc1ZhbHVlIiwiaXNOYU4iLCJkdXJhdGlvbiIsInBhcnNlRmxvYXQiLCJfIiwiaGFzIiwidGltZW91dCIsImxvZyIsImVycm9yQW5kVGhyb3ciLCJKU09OIiwic3RyaW5naWZ5IiwidG91Y2hJZCIsIm1hdGNoIiwibW9iaWxlU2VuZEJpb21ldHJpY01hdGNoIiwidG9nZ2xlRW5yb2xsVG91Y2hJZCIsImlzRW5hYmxlZCIsIm1vYmlsZUVucm9sbEJpb21ldHJpYyIsImdldFdpbmRvd1NpemVXZWIiLCJnZXRXaW5kb3dTaXplTmF0aXZlIiwiZ2V0V2luZG93U2l6ZSIsIndpbmRvd0hhbmRsZSIsImVycm9ycyIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJnZXREZXZpY2VUaW1lIiwiZm9ybWF0IiwiaW5mbyIsImlzUmVhbERldmljZSIsImNtZCIsImFyZ3MiLCJpbnB1dEZvcm1hdCIsInN0ZG91dCIsInRyaW0iLCJkZWJ1ZyIsImpvaW4iLCJwYXJzZWRUaW1lc3RhbXAiLCJtb21lbnQiLCJ1dGMiLCJpc1ZhbGlkIiwid2FybiIsInV0Y09mZnNldCIsIl90em0iLCJ0aW1lc3RhbXAiLCJ0aW1lWm9uZSIsInV0aWxpdGllcyIsIm9wdHMiLCJ1ZGlkIiwidW5peCIsIk1hdGgiLCJhYnMiLCJpbmNsdWRlcyIsInR6IiwibW9iaWxlR2V0RGV2aWNlVGltZSIsImdldFdpbmRvd1JlY3QiLCJ3aWR0aCIsImhlaWdodCIsIngiLCJ5IiwiaGlkZUtleWJvYXJkIiwic3RyYXRlZ3kiLCJwb3NzaWJsZUtleXMiLCJrZXlOYW1lcyIsImNvbXBhY3QiLCJzbGljZSIsIm1hcCIsInB1c2giLCJnZXRTdHJpbmdzIiwibGFuZ3VhZ2UiLCJzdHJpbmdGaWxlIiwiT2JqZWN0IiwiYXNzaWduIiwic3RyaWN0TW9kZSIsInJlbW92ZUFwcCIsImJ1bmRsZUlkIiwibW9iaWxlUmVtb3ZlQXBwIiwibGF1bmNoQXBwIiwiYXBwTmFtZSIsImFwcCIsInN0YXJ0IiwiZXJyIiwiY2xvc2VBcHAiLCJzdG9wIiwia2V5cyIsIlVua25vd25FcnJvciIsImVsIiwidW53cmFwRWxlbWVudCIsImlzRW1wdHkiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJzZXRWYWx1ZSIsInNldFVybCIsInVybCIsInNldEN1cnJlbnRVcmwiLCJjdXJXZWJGcmFtZXMiLCJyZW1vdGUiLCJuYXZUb1VybCIsImRldmljZSIsInNpbWN0bCIsIm9wZW5VcmwiLCJnZXRWaWV3cG9ydFJlY3QiLCJzY2FsZSIsImdldERldmljZVBpeGVsUmF0aW8iLCJzdGF0dXNCYXJIZWlnaHQiLCJyb3VuZCIsImdldFN0YXR1c0JhckhlaWdodCIsIndpbmRvd1NpemUiLCJsZWZ0IiwidG9wIiwiZ2V0U2NyZWVuSW5mbyIsInN0YXR1c0JhclNpemUiLCJtb2JpbGVQcmVzc0J1dHRvbiIsIm5hbWUiLCJkdXJhdGlvblNlY29uZHMiLCJJbnZhbGlkQXJndW1lbnRFcnJvciIsImlzTmlsIiwiaXNOdW1iZXIiLCJtb2JpbGVTaXJpQ29tbWFuZCIsInRleHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7QUFBQSxJQUFtQkMsT0FBTyxHQUFHLEVBQTdCO0FBQUEsSUFBaUNDLFVBQVUsR0FBRyxFQUE5Qzs7OztBQUVBLE1B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QUFHLEVBQXpDLEVBQTZDO0FBQ3hFLFFBQU07QUFBQ2lFLElBQUFBLElBQUQ7QUFBT0MsSUFBQUE7QUFBUCxNQUEwQmxFLElBQWhDOztBQUNBLE1BQUksQ0FBQ2lFLElBQUwsRUFBVztBQUNULFVBQU0sSUFBSXhGLG1CQUFPMEYsb0JBQVgsQ0FBZ0MsMEJBQWhDLENBQU47QUFDRDs7QUFDRCxNQUFJLENBQUMzRyxnQkFBRTRHLEtBQUYsQ0FBUUYsZUFBUixDQUFELElBQTZCLENBQUMxRyxnQkFBRTZHLFFBQUYsQ0FBV0gsZUFBWCxDQUFsQyxFQUErRDtBQUM3RCxVQUFNLElBQUl6RixtQkFBTzBGLG9CQUFYLENBQWdDLG9DQUFoQyxDQUFOO0FBQ0Q7O0FBQ0QsU0FBTyxNQUFNLEtBQUt6SCxZQUFMLENBQWtCLGtCQUFsQixFQUFzQyxNQUF0QyxFQUNYO0FBQUN1SCxJQUFBQSxJQUFEO0FBQU8zRyxJQUFBQSxRQUFRLEVBQUU0RztBQUFqQixHQURXLENBQWI7QUFFRCxDQVZEOztBQVlBaEksUUFBUSxDQUFDb0ksaUJBQVQsR0FBNkIsZUFBZUEsaUJBQWYsQ0FBa0N0RSxJQUFJLEdBQUcsRUFBekMsRUFBNkM7QUFDeEUsUUFBTTtBQUFDdUUsSUFBQUE7QUFBRCxNQUFTdkUsSUFBZjs7QUFDQSxNQUFJLENBQUM3QyxjQUFLQyxRQUFMLENBQWNtSCxJQUFkLENBQUwsRUFBMEI7QUFDeEIsVUFBTSxJQUFJOUYsbUJBQU8wRixvQkFBWCxDQUFnQyw4QkFBaEMsQ0FBTjtBQUNEOztBQUNELFNBQU8sTUFBTSxLQUFLekgsWUFBTCxDQUFrQixvQkFBbEIsRUFBd0MsTUFBeEMsRUFBZ0Q7QUFBQzZILElBQUFBO0FBQUQsR0FBaEQsQ0FBYjtBQUNELENBTkQ7O0FBUUEvQyxNQUFNLENBQUNDLE1BQVAsQ0FBY3JGLFVBQWQsRUFBMEJGLFFBQTFCLEVBQW9DQyxPQUFwQztlQUdlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ0BhcHBpdW0vYmFzZS1kcml2ZXInO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ0BhcHBpdW0vc3VwcG9ydCc7XG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudC10aW1lem9uZSc7XG5pbXBvcnQgeyB1dGlsaXRpZXMgfSBmcm9tICdhcHBpdW0taW9zLWRldmljZSc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IHBhcnNlTG9jYWxpemFibGVTdHJpbmdzIH0gZnJvbSAnLi4vYXBwLXV0aWxzJztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBNT01FTlRfRk9STUFUX0lTTzg2MDEgPSAnWVlZWS1NTS1ERFRISDptbTpzc1onO1xuXG5cbmNvbW1hbmRzLmFjdGl2ZSA9IGFzeW5jIGZ1bmN0aW9uIGFjdGl2ZSAoKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGVXZWJFbGVtZW50cyhhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdhY3RpdmVfZWxlbWVudCcsIFtdKSk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC9hY3RpdmVgLCAnR0VUJyk7XG59O1xuXG4vKipcbiAqIENsb3NlIGFwcCAoc2ltdWxhdGUgZGV2aWNlIGhvbWUgYnV0dG9uKS4gSXQgaXMgcG9zc2libGUgdG8gcmVzdG9yZVxuICogdGhlIGFwcCBhZnRlciB0aGUgdGltZW91dCBvciBrZWVwIGl0IG1pbmltaXplZCBiYXNlZCBvbiB0aGUgcGFyYW1ldGVyIHZhbHVlLlxuICpcbiAqIEBwYXJhbSB7P251bWJlcnxPYmplY3R9IHNlY29uZHNcbiAqIC0gYW55IHBvc2l0aXZlIG51bWJlciBvZiBzZWNvbmRzOiBjb21lIGJhY2sgYWZ0ZXIgWCBzZWNvbmRzXG4gKiAtIGFueSBuZWdhdGl2ZSBudW1iZXIgb2Ygc2Vjb25kcyBvciB6ZXJvOiBuZXZlciBjb21lIGJhY2tcbiAqIC0gdW5kZWZpbmVkL251bGw6IG5ldmVyIGNvbWUgYmFja1xuICogLSB7dGltZW91dDogNTAwMH06IGNvbWUgYmFjayBhZnRlciA1IHNlY29uZHNcbiAqIC0ge3RpbWVvdXQ6IG51bGx9LCB7dGltZW91dDogLTJ9OiBuZXZlciBjb21lIGJhY2tcbiAqL1xuY29tbWFuZHMuYmFja2dyb3VuZCA9IGFzeW5jIGZ1bmN0aW9uIGJhY2tncm91bmQgKHNlY29uZHMpIHtcbiAgY29uc3QgaG9tZXNjcmVlbiA9ICcvd2RhL2hvbWVzY3JlZW4nO1xuICBjb25zdCBkZWFjdGl2YXRlQXBwID0gJy93ZGEvZGVhY3RpdmF0ZUFwcCc7XG5cbiAgbGV0IGVuZHBvaW50O1xuICBsZXQgcGFyYW1zID0ge307XG4gIGNvbnN0IHNlbGVjdEVuZHBvaW50ID0gKHRpbWVvdXRTZWNvbmRzKSA9PiB7XG4gICAgaWYgKCF1dGlsLmhhc1ZhbHVlKHRpbWVvdXRTZWNvbmRzKSkge1xuICAgICAgZW5kcG9pbnQgPSBob21lc2NyZWVuO1xuICAgIH0gZWxzZSBpZiAoIWlzTmFOKHRpbWVvdXRTZWNvbmRzKSkge1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBwYXJzZUZsb2F0KHRpbWVvdXRTZWNvbmRzKTtcbiAgICAgIGlmIChkdXJhdGlvbiA+PSAwKSB7XG4gICAgICAgIHBhcmFtcyA9IHtkdXJhdGlvbn07XG4gICAgICAgIGVuZHBvaW50ID0gZGVhY3RpdmF0ZUFwcDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVuZHBvaW50ID0gaG9tZXNjcmVlbjtcbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIGlmIChfLmhhcyhzZWNvbmRzLCAndGltZW91dCcpKSB7XG4gICAgY29uc3Qge3RpbWVvdXR9ID0gc2Vjb25kcztcbiAgICBzZWxlY3RFbmRwb2ludChpc05hTih0aW1lb3V0KSA/IHRpbWVvdXQgOiBwYXJzZUZsb2F0KHRpbWVvdXQpIC8gMTAwMC4wKTtcbiAgfSBlbHNlIHtcbiAgICBzZWxlY3RFbmRwb2ludChzZWNvbmRzKTtcbiAgfVxuICBpZiAoIWVuZHBvaW50KSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEFyZ3VtZW50IHZhbHVlIGlzIGV4cGVjdGVkIHRvIGJlIGEgdmFsaWQgbnVtYmVyLiBgICtcbiAgICAgIGAke0pTT04uc3RyaW5naWZ5KHNlY29uZHMpfSBoYXMgYmVlbiBwcm92aWRlZCBpbnN0ZWFkYCk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGVuZHBvaW50LCAnUE9TVCcsIHBhcmFtcywgZW5kcG9pbnQgIT09IGhvbWVzY3JlZW4pO1xufTtcblxuY29tbWFuZHMudG91Y2hJZCA9IGFzeW5jIGZ1bmN0aW9uIHRvdWNoSWQgKG1hdGNoID0gdHJ1ZSkge1xuICBhd2FpdCB0aGlzLm1vYmlsZVNlbmRCaW9tZXRyaWNNYXRjaCh7bWF0Y2h9KTtcbn07XG5cbmNvbW1hbmRzLnRvZ2dsZUVucm9sbFRvdWNoSWQgPSBhc3luYyBmdW5jdGlvbiB0b2dnbGVFbnJvbGxUb3VjaElkIChpc0VuYWJsZWQgPSB0cnVlKSB7XG4gIGF3YWl0IHRoaXMubW9iaWxlRW5yb2xsQmlvbWV0cmljKHtpc0VuYWJsZWR9KTtcbn07XG5cbmhlbHBlcnMuZ2V0V2luZG93U2l6ZVdlYiA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1NpemVXZWIgKCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3dpbmRvd19zaXplJywgW10pO1xufTtcblxuaGVscGVycy5nZXRXaW5kb3dTaXplTmF0aXZlID0gYXN5bmMgZnVuY3Rpb24gZ2V0V2luZG93U2l6ZU5hdGl2ZSAoKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChgL3dpbmRvdy9zaXplYCwgJ0dFVCcpO1xufTtcblxuY29tbWFuZHMuZ2V0V2luZG93U2l6ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1NpemUgKHdpbmRvd0hhbmRsZSA9ICdjdXJyZW50Jykge1xuICBpZiAod2luZG93SGFuZGxlICE9PSAnY3VycmVudCcpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoJ0N1cnJlbnRseSBvbmx5IGdldHRpbmcgY3VycmVudCB3aW5kb3cgc2l6ZSBpcyBzdXBwb3J0ZWQuJyk7XG4gIH1cblxuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplTmF0aXZlKCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZVdlYigpO1xuICB9XG59O1xuXG4vKipcbiAqIFJldHJpZXZlcyB0aGUgY3VycmVudCBkZXZpY2UncyB0aW1lc3RhbXAuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGZvcm1hdCAtIFRoZSBzZXQgb2YgZm9ybWF0IHNwZWNpZmllcnMuIFJlYWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwczovL21vbWVudGpzLmNvbS9kb2NzLyB0byBnZXQgdGhlIGZ1bGwgbGlzdCBvZiBzdXBwb3J0ZWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRldGltZSBmb3JtYXQgc3BlY2lmaWVycy4gVGhlIGRlZmF1bHQgZm9ybWF0IGlzXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgYFlZWVktTU0tRERUSEg6bW06c3NaYCwgd2hpY2ggY29tcGxpZXMgdG8gSVNPLTg2MDFcbiAqIEByZXR1cm5zIEZvcm1hdHRlZCBkYXRldGltZSBzdHJpbmcgb3IgdGhlIHJhdyBjb21tYW5kIG91dHB1dCBpZiBmb3JtYXR0aW5nIGZhaWxzXG4gKi9cbmNvbW1hbmRzLmdldERldmljZVRpbWUgPSBhc3luYyBmdW5jdGlvbiBnZXREZXZpY2VUaW1lIChmb3JtYXQgPSBNT01FTlRfRk9STUFUX0lTTzg2MDEpIHtcbiAgbG9nLmluZm8oJ0F0dGVtcHRpbmcgdG8gY2FwdHVyZSBpT1MgZGV2aWNlIGRhdGUgYW5kIHRpbWUnKTtcbiAgaWYgKCF0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgbG9nLmluZm8oJ09uIHNpbXVsYXRvci4gQXNzdW1pbmcgZGV2aWNlIHRpbWUgaXMgdGhlIHNhbWUgYXMgaG9zdCB0aW1lJyk7XG4gICAgY29uc3QgY21kID0gJ2RhdGUnO1xuICAgIGNvbnN0IGFyZ3MgPSBbJyslWS0lbS0lZFQlSDolTTolUyV6J107XG4gICAgY29uc3QgaW5wdXRGb3JtYXQgPSAnWVlZWS1NTS1ERFRISDptbTpzc1paJztcbiAgICBjb25zdCBzdGRvdXQgPSAoYXdhaXQgZXhlYyhjbWQsIGFyZ3MpKS5zdGRvdXQudHJpbSgpO1xuICAgIGxvZy5kZWJ1ZyhgR290IHRoZSBmb2xsb3dpbmcgb3V0cHV0IG91dCBvZiAnJHtjbWR9ICR7YXJncy5qb2luKCcgJyl9JzogJHtzdGRvdXR9YCk7XG4gICAgY29uc3QgcGFyc2VkVGltZXN0YW1wID0gbW9tZW50LnV0YyhzdGRvdXQsIGlucHV0Rm9ybWF0KTtcbiAgICBpZiAoIXBhcnNlZFRpbWVzdGFtcC5pc1ZhbGlkKCkpIHtcbiAgICAgIGxvZy53YXJuKGBDYW5ub3QgcGFyc2UgdGhlIHRpbWVzdGFtcCAnJHtzdGRvdXR9JyByZXR1cm5lZCBieSAnJHtjbWR9JyBjb21tYW5kLiBSZXR1cm5pbmcgaXQgYXMgaXNgKTtcbiAgICAgIHJldHVybiBzdGRvdXQ7XG4gICAgfVxuICAgIHJldHVybiBwYXJzZWRUaW1lc3RhbXAudXRjT2Zmc2V0KHBhcnNlZFRpbWVzdGFtcC5fdHptIHx8IDApLmZvcm1hdChmb3JtYXQpO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIHRpbWVzdGFtcCxcbiAgICB1dGNPZmZzZXQsXG4gICAgdGltZVpvbmUsXG4gIH0gPSBhd2FpdCB1dGlsaXRpZXMuZ2V0RGV2aWNlVGltZSh0aGlzLm9wdHMudWRpZCk7XG4gIGxvZy5kZWJ1ZyhgdGltZXN0YW1wOiAke3RpbWVzdGFtcH0sIHV0Y09mZnNldDogJHt1dGNPZmZzZXR9LCB0aW1lWm9uZTogJHt0aW1lWm9uZX1gKTtcbiAgY29uc3QgdXRjID0gbW9tZW50LnVuaXgodGltZXN0YW1wKS51dGMoKTtcbiAgLy8gYXQgc29tZSBwb2ludCBvZiB0aW1lIEFwcGxlIHN0YXJ0ZWQgdG8gcmV0dXJuIHRpbWVzdGFtcHNcbiAgLy8gaW4gdXRjT2Zmc2V0IGluc3RlYWQgb2YgYWN0dWFsIFVUQyBvZmZzZXRzXG4gIGlmIChNYXRoLmFicyh1dGNPZmZzZXQpIDw9IDEyICogNjApIHtcbiAgICByZXR1cm4gdXRjLnV0Y09mZnNldCh1dGNPZmZzZXQpLmZvcm1hdChmb3JtYXQpO1xuICB9XG4gIC8vIHRpbWVab25lIGNvdWxkIGVpdGhlciBiZSBhIHRpbWUgem9uZSBuYW1lIG9yXG4gIC8vIGFuIFVUQyBvZmZzZXQgaW4gc2Vjb25kc1xuICBpZiAoXy5pbmNsdWRlcyh0aW1lWm9uZSwgJy8nKSkge1xuICAgIHJldHVybiB1dGMudHoodGltZVpvbmUpLmZvcm1hdChmb3JtYXQpO1xuICB9XG4gIGlmIChNYXRoLmFicyh0aW1lWm9uZSkgPD0gMTIgKiA2MCAqIDYwKSB7XG4gICAgcmV0dXJuIHV0Yy51dGNPZmZzZXQodGltZVpvbmUgLyA2MCkuZm9ybWF0KGZvcm1hdCk7XG4gIH1cbiAgbG9nLndhcm4oJ0RpZCBub3Qga25vdyBob3cgdG8gYXBwbHkgdGhlIFVUQyBvZmZzZXQuIFJldHVybmluZyB0aGUgdGltZXN0YW1wIHdpdGhvdXQgaXQnKTtcbiAgcmV0dXJuIHV0Yy5mb3JtYXQoZm9ybWF0KTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gRGV2aWNlVGltZU9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBmb3JtYXQgW1lZWVktTU0tRERUSEg6bW06c3NaXSAtIFNlZSBnZXREZXZpY2VUaW1lI2Zvcm1hdFxuICovXG5cbi8qKlxuICogUmV0cmlldmVzIHRoZSBjdXJyZW50IGRldmljZSB0aW1lXG4gKlxuICogQHBhcmFtIHtEZXZpY2VUaW1lT3B0aW9uc30gb3B0c1xuICogQHJldHVybiB7c3RyaW5nfSBGb3JtYXR0ZWQgZGF0ZXRpbWUgc3RyaW5nIG9yIHRoZSByYXcgY29tbWFuZCBvdXRwdXQgaWYgZm9ybWF0dGluZyBmYWlsc1xuICovXG5jb21tYW5kcy5tb2JpbGVHZXREZXZpY2VUaW1lID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlR2V0RGV2aWNlVGltZSAob3B0cyA9IHt9KSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLmdldERldmljZVRpbWUob3B0cy5mb3JtYXQpO1xufTtcblxuLy8gRm9yIFczQ1xuY29tbWFuZHMuZ2V0V2luZG93UmVjdCA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1JlY3QgKCkge1xuICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemUoKTtcbiAgcmV0dXJuIHtcbiAgICB3aWR0aCxcbiAgICBoZWlnaHQsXG4gICAgeDogMCxcbiAgICB5OiAwXG4gIH07XG59O1xuXG5jb21tYW5kcy5oaWRlS2V5Ym9hcmQgPSBhc3luYyBmdW5jdGlvbiBoaWRlS2V5Ym9hcmQgKHN0cmF0ZWd5LCAuLi5wb3NzaWJsZUtleXMpIHtcbiAgLy8gbGFzdCBwYXJhbWV0ZXIgaXMgdGhlIHNlc3Npb24gaWRcbiAgY29uc3Qga2V5TmFtZXMgPSBfLmNvbXBhY3QocG9zc2libGVLZXlzLnNsaWNlKDAsIC0xKSkubWFwKCh4KSA9PiBgJHt4fWApO1xuICBpZiAoIWtleU5hbWVzLmluY2x1ZGVzKCdkb25lJykpIHtcbiAgICBrZXlOYW1lcy5wdXNoKCdkb25lJyk7XG4gIH1cbiAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEva2V5Ym9hcmQvZGlzbWlzcycsICdQT1NUJywge2tleU5hbWVzfSk7XG59O1xuXG5jb21tYW5kcy5nZXRTdHJpbmdzID0gYXN5bmMgZnVuY3Rpb24gZ2V0U3RyaW5ncyAobGFuZ3VhZ2UsIHN0cmluZ0ZpbGUgPSBudWxsKSB7XG4gIGxvZy5kZWJ1ZyhgR2V0dGluZ3Mgc3RyaW5ncyBmb3IgbGFuZ3VhZ2UgJyR7bGFuZ3VhZ2V9JyBhbmQgc3RyaW5nIGZpbGUgJyR7c3RyaW5nRmlsZX0nYCk7XG4gIHJldHVybiBhd2FpdCBwYXJzZUxvY2FsaXphYmxlU3RyaW5ncyhPYmplY3QuYXNzaWduKHt9LCB0aGlzLm9wdHMsIHtcbiAgICBsYW5ndWFnZSxcbiAgICBzdHJpbmdGaWxlLFxuICAgIHN0cmljdE1vZGU6IHRydWUsXG4gIH0pKTtcbn07XG5cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIHJlbW92ZUFwcCAoYnVuZGxlSWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMubW9iaWxlUmVtb3ZlQXBwKHtidW5kbGVJZH0pO1xufTtcblxuY29tbWFuZHMubGF1bmNoQXBwID0gYXN5bmMgZnVuY3Rpb24gbGF1bmNoQXBwICgpIHtcbiAgY29uc3QgYXBwTmFtZSA9IHRoaXMub3B0cy5hcHAgfHwgdGhpcy5vcHRzLmJ1bmRsZUlkO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuc3RhcnQoKTtcbiAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IGxhdW5jaGVkIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgbGF1bmNoaW5nIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMuY2xvc2VBcHAgPSBhc3luYyBmdW5jdGlvbiBjbG9zZUFwcCAoKSB7XG4gIGNvbnN0IGFwcE5hbWUgPSB0aGlzLm9wdHMuYXBwIHx8IHRoaXMub3B0cy5idW5kbGVJZDtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnN0b3AoKTtcbiAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IGNsb3NlZCB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFNvbWV0aGluZyB3ZW50IHdyb25nIHdoaWxlIGNsb3NpbmcgdGhlICcke2FwcE5hbWV9JyBhcHAuYCk7XG4gICAgdGhyb3cgZXJyO1xuICB9XG59O1xuXG5jb21tYW5kcy5rZXlzID0gYXN5bmMgZnVuY3Rpb24ga2V5cyAoa2V5cykge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcignQ29tbWFuZCBzaG91bGQgYmUgcHJveGllZCB0byBXREEnKTtcbiAgfVxuICBsZXQgZWwgPSB1dGlsLnVud3JhcEVsZW1lbnQoYXdhaXQgdGhpcy5hY3RpdmUoKSk7XG4gIGlmIChfLmlzRW1wdHkoZWwpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgfVxuICBhd2FpdCB0aGlzLnNldFZhbHVlKGtleXMsIGVsKTtcbn07XG5cbmNvbW1hbmRzLnNldFVybCA9IGFzeW5jIGZ1bmN0aW9uIHNldFVybCAodXJsKSB7XG4gIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBzZXQgdXJsICcke3VybH0nYCk7XG5cbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aGlzLnNldEN1cnJlbnRVcmwodXJsKTtcbiAgICAvLyBtYWtlIHN1cmUgdG8gY2xlYXIgb3V0IGFueSBsZWZ0b3ZlciB3ZWIgZnJhbWVzXG4gICAgdGhpcy5jdXJXZWJGcmFtZXMgPSBbXTtcbiAgICBhd2FpdCB0aGlzLnJlbW90ZS5uYXZUb1VybCh1cmwpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy91cmwnLCAnUE9TVCcsIHt1cmx9KTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLnNpbWN0bC5vcGVuVXJsKHVybCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldFZpZXdwb3J0UmVjdCA9IGFzeW5jIGZ1bmN0aW9uIGdldFZpZXdwb3J0UmVjdCAoKSB7XG4gIGNvbnN0IHNjYWxlID0gYXdhaXQgdGhpcy5nZXREZXZpY2VQaXhlbFJhdGlvKCk7XG4gIC8vIHN0YXR1cyBiYXIgaGVpZ2h0IGNvbWVzIGluIHVuc2NhbGVkLCBzbyBzY2FsZSBpdFxuICBjb25zdCBzdGF0dXNCYXJIZWlnaHQgPSBNYXRoLnJvdW5kKGF3YWl0IHRoaXMuZ2V0U3RhdHVzQmFySGVpZ2h0KCkgKiBzY2FsZSk7XG4gIGNvbnN0IHdpbmRvd1NpemUgPSBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemUoKTtcblxuICAvLyBpb3MgcmV0dXJucyBjb29yZGluYXRlcy9kaW1lbnNpb25zIGluIGxvZ2ljYWwgcGl4ZWxzLCBub3QgZGV2aWNlIHBpeGVscyxcbiAgLy8gc28gc2NhbGUgdXAgdG8gZGV2aWNlIHBpeGVscy4gc3RhdHVzIGJhciBoZWlnaHQgaXMgYWxyZWFkeSBzY2FsZWQuXG4gIHJldHVybiB7XG4gICAgbGVmdDogMCxcbiAgICB0b3A6IHN0YXR1c0JhckhlaWdodCxcbiAgICB3aWR0aDogd2luZG93U2l6ZS53aWR0aCAqIHNjYWxlLFxuICAgIGhlaWdodDogKCh3aW5kb3dTaXplLmhlaWdodCAqIHNjYWxlKSAtIHN0YXR1c0JhckhlaWdodCksXG4gIH07XG59O1xuXG4vLyBtZW1vaXplZCBpbiBjb25zdHJ1Y3RvclxuY29tbWFuZHMuZ2V0U2NyZWVuSW5mbyA9IGFzeW5jIGZ1bmN0aW9uIGdldFNjcmVlbkluZm8gKCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvc2NyZWVuJywgJ0dFVCcpO1xufTtcblxuY29tbWFuZHMuZ2V0U3RhdHVzQmFySGVpZ2h0ID0gYXN5bmMgZnVuY3Rpb24gZ2V0U3RhdHVzQmFySGVpZ2h0ICgpIHtcbiAgY29uc3Qge3N0YXR1c0JhclNpemV9ID0gYXdhaXQgdGhpcy5nZXRTY3JlZW5JbmZvKCk7XG4gIHJldHVybiBzdGF0dXNCYXJTaXplLmhlaWdodDtcbn07XG5cbi8vIG1lbW9pemVkIGluIGNvbnN0cnVjdG9yXG5jb21tYW5kcy5nZXREZXZpY2VQaXhlbFJhdGlvID0gYXN5bmMgZnVuY3Rpb24gZ2V0RGV2aWNlUGl4ZWxSYXRpbyAoKSB7XG4gIGNvbnN0IHtzY2FsZX0gPSBhd2FpdCB0aGlzLmdldFNjcmVlbkluZm8oKTtcbiAgcmV0dXJuIHNjYWxlO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBQcmVzc0J1dHRvbk9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGJ1dHRvbiB0byBiZSBwcmVzc2VkLlxuICogQHByb3BlcnR5IHs/bnVtYmVyfSBkdXJhdGlvblNlY29uZHMgLSBEdXJhdGlvbiBpbiBmbG9hdCBzZWNvbmRzLlxuICovXG5cbi8qKlxuICogRW11bGF0ZXMgcHJlc3MgdGhlIGdpdmVuIGRldml2ZSBidXR0b24gbmFtZS5cbiAqXG4gKiBAcGFyYW0ge1ByZXNzQnV0dG9uT3B0aW9uc30gb3B0c1xuICovXG5jb21tYW5kcy5tb2JpbGVQcmVzc0J1dHRvbiA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVByZXNzQnV0dG9uIChvcHRzID0ge30pIHtcbiAgY29uc3Qge25hbWUsIGR1cmF0aW9uU2Vjb25kc30gPSBvcHRzO1xuICBpZiAoIW5hbWUpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRBcmd1bWVudEVycm9yKCdCdXR0b24gbmFtZSBpcyBtYW5kYXRvcnknKTtcbiAgfVxuICBpZiAoIV8uaXNOaWwoZHVyYXRpb25TZWNvbmRzKSAmJiAhXy5pc051bWJlcihkdXJhdGlvblNlY29uZHMpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcignZHVyYXRpb25TZWNvbmRzIHNob3VsZCBiZSBhIG51bWJlcicpO1xuICB9XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9wcmVzc0J1dHRvbicsICdQT1NUJyxcbiAgICB7bmFtZSwgZHVyYXRpb246IGR1cmF0aW9uU2Vjb25kc30pO1xufTtcblxuY29tbWFuZHMubW9iaWxlU2lyaUNvbW1hbmQgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVTaXJpQ29tbWFuZCAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHt0ZXh0fSA9IG9wdHM7XG4gIGlmICghdXRpbC5oYXNWYWx1ZSh0ZXh0KSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoJ1widGV4dFwiIGFyZ3VtZW50IGlzIG1hbmRhdG9yeScpO1xuICB9XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9zaXJpL2FjdGl2YXRlJywgJ1BPU1QnLCB7dGV4dH0pO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5cbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzLCBleHRlbnNpb25zIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvZ2VuZXJhbC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9

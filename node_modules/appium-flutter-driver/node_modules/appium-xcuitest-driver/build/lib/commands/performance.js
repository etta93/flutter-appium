"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _support = require("@appium/support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _asyncbox = require("asyncbox");

var _bluebird = _interopRequireDefault(require("bluebird"));

const commands = {};
exports.commands = commands;
const PERF_RECORD_FEAT_NAME = 'perf_record';
const PERF_RECORD_SECURITY_MESSAGE = 'Performance measurement requires relaxing security for simulator. ' + `Please set '--relaxed-security' or '--allow-insecure' with '${PERF_RECORD_FEAT_NAME}' ` + 'referencing https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/security.md for more details.';
const DEFAULT_TIMEOUT_MS = 5 * 60 * 1000;
const STOP_TIMEOUT_MS = 3 * 60 * 1000;
const STARTUP_TIMEOUT_MS = 60 * 1000;
const DEFAULT_PROFILE_NAME = 'Activity Monitor';
const DEFAULT_EXT = '.trace';
const DEFAULT_PID = 'current';
const INSTRUMENTS = 'instruments';
const XCRUN = 'xcrun';
const XCTRACE = 'xctrace';

async function requireXctrace() {
  let xcrunPath;

  try {
    xcrunPath = await _support.fs.which(XCRUN);
  } catch (e) {
    _logger.default.errorAndThrow(`${XCRUN} has not been found in PATH. ` + `Please make sure XCode development tools are installed`);
  }

  try {
    await (0, _teen_process.exec)(xcrunPath, [XCTRACE, 'help']);
  } catch (e) {
    _logger.default.errorAndThrow(`${XCTRACE} is not available for the active Xcode version. ` + `Please make sure XCode is up to date. Original error: ${e.stderr || e.message}`);
  }

  return xcrunPath;
}

async function requireInstruments() {
  try {
    return await _support.fs.which(INSTRUMENTS);
  } catch (e) {
    _logger.default.errorAndThrow(`${INSTRUMENTS} has not been found in PATH. ` + `Please make sure XCode development tools are installed`);
  }
}

class PerfRecorder {
  constructor(reportRoot, udid, opts = {}) {
    this._process = null;
    this._zippedReportPath = '';
    this._timeout = opts.timeout && opts.timeout > 0 ? opts.timeout : DEFAULT_TIMEOUT_MS;
    this._profileName = opts.profileName || DEFAULT_PROFILE_NAME;
    this._reportPath = _path.default.resolve(reportRoot, `appium_perf__${this._profileName.replace(/\W/g, '_')}__${Date.now()}${DEFAULT_EXT}`);
    this._pid = opts.pid;
    this._udid = udid;
    this._logger = _support.logger.getLogger(`${_lodash.default.truncate(this._profileName, {
      length: 10
    })}@${this._udid.substring(0, 8)}`);
    this._archivePromise = null;
  }

  get profileName() {
    return this._profileName;
  }

  async getOriginalReportPath() {
    return (await _support.fs.exists(this._reportPath)) ? this._reportPath : '';
  }

  async getZippedReportPath() {
    if (!this._archivePromise) {
      this._archivePromise = (async () => {
        const originalReportPath = await this.getOriginalReportPath();

        if (!originalReportPath) {
          return '';
        }

        const zippedReportPath = await _support.tempDir.path({
          prefix: _path.default.parse(originalReportPath).name,
          suffix: '.zip'
        });
        await _support.zip.toArchive(zippedReportPath, {
          cwd: _path.default.dirname(this._reportPath)
        });
        await _support.fs.rimraf(_path.default.dirname(this._reportPath));
        this._zippedReportPath = zippedReportPath;
        return this._zippedReportPath;
      })();
    }

    return await this._archivePromise;
  }

  isRunning() {
    var _this$_process;

    return !!((_this$_process = this._process) !== null && _this$_process !== void 0 && _this$_process.isRunning);
  }

  async _enforceTermination() {
    if (this._process && this.isRunning()) {
      this._logger.debug('Force-stopping the currently running perf recording');

      try {
        await this._process.stop('SIGKILL');
      } catch (ign) {}
    }

    this._process = null;

    const performCleanup = async () => {
      try {
        await _bluebird.default.all([this._zippedReportPath, _path.default.dirname(this._reportPath)].filter(Boolean).map(x => _support.fs.rimraf(x)));
      } catch (e) {
        this._logger.warn(e.message);
      }
    };

    if (this._archivePromise) {
      this._archivePromise.finally(async () => {
        await performCleanup();
        this._archivePromise = null;
      }).catch(() => {});
    }

    await performCleanup();
    return '';
  }

  async start() {
    let binaryPath;

    try {
      binaryPath = await requireXctrace();
    } catch (e) {
      _logger.default.debug(e.message);

      _logger.default.info(`Defaulting to ${INSTRUMENTS} usage`);

      binaryPath = await requireInstruments();
    }

    const args = [];
    const toolName = _path.default.basename(binaryPath) === XCRUN ? XCTRACE : INSTRUMENTS;

    if (toolName === XCTRACE) {
      args.push(XCTRACE, 'record', '--device', this._udid, '--template', this._profileName, '--output', this._reportPath, '--time-limit', `${this._timeout}ms`);

      if (this._pid) {
        args.push('--attach', `${this._pid}`);
      } else {
        args.push('--all-processes');
      }
    } else {
      args.push('-w', this._udid, '-t', this._profileName, '-D', this._reportPath, '-l', `${this._timeout}`);

      if (this._pid) {
        args.push('-p', `${this._pid}`);
      }
    }

    const fullCmd = [binaryPath, ...args];
    this._process = new _teen_process.SubProcess(fullCmd[0], fullCmd.slice(1));
    this._archivePromise = null;

    this._logger.debug(`Starting performance recording: ${_support.util.quote(fullCmd)}`);

    this._process.on('output', (stdout, stderr) => {
      if (_lodash.default.trim(stdout || stderr)) {
        this._logger.debug(`[${toolName}] ${stdout || stderr}`);
      }
    });

    this._process.once('exit', async (code, signal) => {
      this._process = null;

      if (code === 0) {
        this._logger.debug('Performance recording exited without errors');

        try {
          await this.getZippedReportPath();
        } catch (e) {
          this._logger.warn(e);
        }
      } else {
        await this._enforceTermination();

        this._logger.warn(`Performance recording exited with error code ${code}, signal ${signal}`);
      }
    });

    await this._process.start(0);

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        if (await this.getOriginalReportPath()) {
          return true;
        }

        if (!this._process) {
          throw new Error(`${toolName} process died unexpectedly`);
        }

        return false;
      }, {
        waitMs: STARTUP_TIMEOUT_MS,
        intervalMs: 500
      });
    } catch (e) {
      await this._enforceTermination();
      const listProfilesCommand = toolName === XCTRACE ? `${XCRUN} ${XCTRACE} list templates` : `${INSTRUMENTS} -s`;

      this._logger.errorAndThrow(`There is no ${DEFAULT_EXT} file found for performance profile ` + `'${this._profileName}'. Make sure the profile is supported on this device. ` + `You could use '${listProfilesCommand}' command to see the list of all available profiles. ` + `Check the server log for more details`);
    }

    this._logger.info(`The performance recording has started. Will timeout in ${this._timeout}ms`);
  }

  async stop(force = false) {
    if (force) {
      return await this._enforceTermination();
    }

    if (!this.isRunning()) {
      this._logger.debug('Performance recording is not running. Returning the recent result');

      return await this.getZippedReportPath();
    }

    try {
      await this._process.stop('SIGINT', STOP_TIMEOUT_MS);
    } catch (e) {
      this._logger.errorAndThrow(`Performance recording has failed to exit after ${STOP_TIMEOUT_MS}ms`);
    }

    return await this.getZippedReportPath();
  }

}

commands.mobileStartPerfRecord = async function mobileStartPerfRecord(opts = {}) {
  if (!this.isFeatureEnabled(PERF_RECORD_FEAT_NAME) && !this.isRealDevice()) {
    _logger.default.errorAndThrow(PERF_RECORD_SECURITY_MESSAGE);
  }

  const {
    timeout = DEFAULT_TIMEOUT_MS,
    profileName = DEFAULT_PROFILE_NAME,
    pid
  } = opts;

  if (!_lodash.default.isEmpty(this._perfRecorders)) {
    for (const recorder of this._perfRecorders.filter(x => x.profileName === profileName)) {
      if (recorder.isRunning()) {
        _logger.default.debug(`Performance recorder for '${profileName}' on device '${this.opts.device.udid}' ` + ` is already running. Doing nothing`);

        return;
      }

      _lodash.default.pull(this._perfRecorders, recorder);

      await recorder.stop(true);
    }
  }

  let realPid;

  if (pid) {
    if (_lodash.default.toLower(pid) === DEFAULT_PID) {
      const appInfo = await this.proxyCommand('/wda/activeAppInfo', 'GET');
      realPid = appInfo.pid;
    } else {
      realPid = pid;
    }
  }

  const recorder = new PerfRecorder(await _support.tempDir.openDir(), this.opts.device.udid, {
    timeout: parseInt(timeout, 10),
    profileName,
    pid: parseInt(realPid, 10)
  });
  await recorder.start();
  this._perfRecorders = [...(this._perfRecorders || []), recorder];
};

commands.mobileStopPerfRecord = async function mobileStopPerfRecord(opts = {}) {
  if (!this.isFeatureEnabled(PERF_RECORD_FEAT_NAME) && !this.isRealDevice()) {
    _logger.default.errorAndThrow(PERF_RECORD_SECURITY_MESSAGE);
  }

  if (_lodash.default.isEmpty(this._perfRecorders)) {
    _logger.default.info('No performance recorders have been started. Doing nothing');

    return '';
  }

  const {
    profileName = DEFAULT_PROFILE_NAME,
    remotePath
  } = opts;

  const recorders = this._perfRecorders.filter(x => x.profileName === profileName);

  if (_lodash.default.isEmpty(recorders)) {
    _logger.default.errorAndThrow(`There are no records for performance profile '${profileName}' ` + `and device ${this.opts.device.udid}. Have you started the profiling before?`);
  }

  const recorder = _lodash.default.first(recorders);

  const resultPath = await recorder.stop();

  if (!(await _support.fs.exists(resultPath))) {
    _logger.default.errorAndThrow(`There is no ${DEFAULT_EXT} file found for performance profile '${profileName}' ` + `and device ${this.opts.device.udid}. Make sure the selected profile is supported on this device`);
  }

  const result = await (0, _utils.encodeBase64OrUpload)(resultPath, remotePath, opts);

  _lodash.default.pull(this._perfRecorders, recorder);

  await _support.fs.rimraf(resultPath);
  return result;
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9wZXJmb3JtYW5jZS5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsIlBFUkZfUkVDT1JEX0ZFQVRfTkFNRSIsIlBFUkZfUkVDT1JEX1NFQ1VSSVRZX01FU1NBR0UiLCJERUZBVUxUX1RJTUVPVVRfTVMiLCJTVE9QX1RJTUVPVVRfTVMiLCJTVEFSVFVQX1RJTUVPVVRfTVMiLCJERUZBVUxUX1BST0ZJTEVfTkFNRSIsIkRFRkFVTFRfRVhUIiwiREVGQVVMVF9QSUQiLCJJTlNUUlVNRU5UUyIsIlhDUlVOIiwiWENUUkFDRSIsInJlcXVpcmVYY3RyYWNlIiwieGNydW5QYXRoIiwiZnMiLCJ3aGljaCIsImUiLCJsb2ciLCJlcnJvckFuZFRocm93Iiwic3RkZXJyIiwibWVzc2FnZSIsInJlcXVpcmVJbnN0cnVtZW50cyIsIlBlcmZSZWNvcmRlciIsImNvbnN0cnVjdG9yIiwicmVwb3J0Um9vdCIsInVkaWQiLCJvcHRzIiwiX3Byb2Nlc3MiLCJfemlwcGVkUmVwb3J0UGF0aCIsIl90aW1lb3V0IiwidGltZW91dCIsIl9wcm9maWxlTmFtZSIsInByb2ZpbGVOYW1lIiwiX3JlcG9ydFBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsInJlcGxhY2UiLCJEYXRlIiwibm93IiwiX3BpZCIsInBpZCIsIl91ZGlkIiwiX2xvZ2dlciIsImxvZ2dlciIsImdldExvZ2dlciIsIl8iLCJ0cnVuY2F0ZSIsImxlbmd0aCIsInN1YnN0cmluZyIsIl9hcmNoaXZlUHJvbWlzZSIsImdldE9yaWdpbmFsUmVwb3J0UGF0aCIsImV4aXN0cyIsImdldFppcHBlZFJlcG9ydFBhdGgiLCJvcmlnaW5hbFJlcG9ydFBhdGgiLCJ6aXBwZWRSZXBvcnRQYXRoIiwidGVtcERpciIsInByZWZpeCIsInBhcnNlIiwibmFtZSIsInN1ZmZpeCIsInppcCIsInRvQXJjaGl2ZSIsImN3ZCIsImRpcm5hbWUiLCJyaW1yYWYiLCJpc1J1bm5pbmciLCJfZW5mb3JjZVRlcm1pbmF0aW9uIiwiZGVidWciLCJzdG9wIiwiaWduIiwicGVyZm9ybUNsZWFudXAiLCJCIiwiYWxsIiwiZmlsdGVyIiwiQm9vbGVhbiIsIm1hcCIsIngiLCJ3YXJuIiwiZmluYWxseSIsImNhdGNoIiwic3RhcnQiLCJiaW5hcnlQYXRoIiwiaW5mbyIsImFyZ3MiLCJ0b29sTmFtZSIsImJhc2VuYW1lIiwicHVzaCIsImZ1bGxDbWQiLCJTdWJQcm9jZXNzIiwic2xpY2UiLCJ1dGlsIiwicXVvdGUiLCJvbiIsInN0ZG91dCIsInRyaW0iLCJvbmNlIiwiY29kZSIsInNpZ25hbCIsIkVycm9yIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImxpc3RQcm9maWxlc0NvbW1hbmQiLCJmb3JjZSIsIm1vYmlsZVN0YXJ0UGVyZlJlY29yZCIsImlzRmVhdHVyZUVuYWJsZWQiLCJpc1JlYWxEZXZpY2UiLCJpc0VtcHR5IiwiX3BlcmZSZWNvcmRlcnMiLCJyZWNvcmRlciIsImRldmljZSIsInB1bGwiLCJyZWFsUGlkIiwidG9Mb3dlciIsImFwcEluZm8iLCJwcm94eUNvbW1hbmQiLCJvcGVuRGlyIiwicGFyc2VJbnQiLCJtb2JpbGVTdG9wUGVyZlJlY29yZCIsInJlbW90ZVBhdGgiLCJyZWNvcmRlcnMiLCJmaXJzdCIsInJlc3VsdFBhdGgiLCJyZXN1bHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsUUFBUSxHQUFHLEVBQWpCOztBQUVBLE1BQU1DLHFCQUFxQixHQUFHLGFBQTlCO0FBQ0EsTUFBTUMsNEJBQTRCLEdBQUcsdUVBQ2xDLCtEQUE4REQscUJBQXNCLElBRGxELEdBRW5DLHVIQUZGO0FBR0EsTUFBTUUsa0JBQWtCLEdBQUcsSUFBSSxFQUFKLEdBQVMsSUFBcEM7QUFDQSxNQUFNQyxlQUFlLEdBQUcsSUFBSSxFQUFKLEdBQVMsSUFBakM7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxLQUFLLElBQWhDO0FBQ0EsTUFBTUMsb0JBQW9CLEdBQUcs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OztBQUNBLE1BQUlhLGdCQUFFNkQsT0FBRixDQUFVYSxTQUFWLENBQUosRUFBMEI7QUFDeEJ0RyxvQkFBSUMsYUFBSixDQUFtQixpREFBZ0RjLFdBQVksSUFBN0QsR0FDZixjQUFhLEtBQUtOLElBQUwsQ0FBVW1GLE1BQVYsQ0FBaUJwRixJQUFLLDBDQUR0QztBQUVEOztBQUVELFFBQU1tRixRQUFRLEdBQUcvRCxnQkFBRTJFLEtBQUYsQ0FBUUQsU0FBUixDQUFqQjs7QUFDQSxRQUFNRSxVQUFVLEdBQUcsTUFBTWIsUUFBUSxDQUFDeEMsSUFBVCxFQUF6Qjs7QUFDQSxNQUFJLEVBQUMsTUFBTXRELFlBQUdxQyxNQUFILENBQVVzRSxVQUFWLENBQVAsQ0FBSixFQUFrQztBQUNoQ3hHLG9CQUFJQyxhQUFKLENBQW1CLGVBQWNYLFdBQVksd0NBQXVDeUIsV0FBWSxJQUE5RSxHQUNmLGNBQWEsS0FBS04sSUFBTCxDQUFVbUYsTUFBVixDQUFpQnBGLElBQUssOERBRHRDO0FBRUQ7O0FBRUQsUUFBTWlHLE1BQU0sR0FBRyxNQUFNLGlDQUFxQkQsVUFBckIsRUFBaUNILFVBQWpDLEVBQTZDNUYsSUFBN0MsQ0FBckI7O0FBQ0FtQixrQkFBRWlFLElBQUYsQ0FBTyxLQUFLSCxjQUFaLEVBQTRCQyxRQUE1Qjs7QUFDQSxRQUFNOUYsWUFBR2tELE1BQUgsQ0FBVXlELFVBQVYsQ0FBTjtBQUNBLFNBQU9DLE1BQVA7QUFDRCxDQWhDRDs7ZUFvQ2UxSCxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIHppcCwgbG9nZ2VyLCB1dGlsLCB0ZW1wRGlyIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IFN1YlByb2Nlc3MsIGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZW5jb2RlQmFzZTY0T3JVcGxvYWQgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5jb25zdCBjb21tYW5kcyA9IHt9O1xuXG5jb25zdCBQRVJGX1JFQ09SRF9GRUFUX05BTUUgPSAncGVyZl9yZWNvcmQnO1xuY29uc3QgUEVSRl9SRUNPUkRfU0VDVVJJVFlfTUVTU0FHRSA9ICdQZXJmb3JtYW5jZSBtZWFzdXJlbWVudCByZXF1aXJlcyByZWxheGluZyBzZWN1cml0eSBmb3Igc2ltdWxhdG9yLiAnICtcbiAgYFBsZWFzZSBzZXQgJy0tcmVsYXhlZC1zZWN1cml0eScgb3IgJy0tYWxsb3ctaW5zZWN1cmUnIHdpdGggJyR7UEVSRl9SRUNPUkRfRkVBVF9OQU1FfScgYCArXG4gICdyZWZlcmVuY2luZyBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9ibG9iL21hc3Rlci9kb2NzL2VuL3dyaXRpbmctcnVubmluZy1hcHBpdW0vc2VjdXJpdHkubWQgZm9yIG1vcmUgZGV0YWlscy4nO1xuY29uc3QgREVGQVVMVF9USU1FT1VUX01TID0gNSAqIDYwICogMTAwMDtcbmNvbnN0IFNUT1BfVElNRU9VVF9NUyA9IDMgKiA2MCAqIDEwMDA7XG5jb25zdCBTVEFSVFVQX1RJTUVPVVRfTVMgPSA2MCAqIDEwMDA7XG5jb25zdCBERUZBVUxUX1BST0ZJTEVfTkFNRSA9ICdBY3Rpdml0eSBNb25pdG9yJztcbmNvbnN0IERFRkFVTFRfRVhUID0gJy50cmFjZSc7XG5jb25zdCBERUZBVUxUX1BJRCA9ICdjdXJyZW50JztcbmNvbnN0IElOU1RSVU1FTlRTID0gJ2luc3RydW1lbnRzJztcbmNvbnN0IFhDUlVOID0gJ3hjcnVuJztcbmNvbnN0IFhDVFJBQ0UgPSAneGN0cmFjZSc7XG5cblxuYXN5bmMgZnVuY3Rpb24gcmVxdWlyZVhjdHJhY2UgKCkge1xuICBsZXQgeGNydW5QYXRoO1xuICB0cnkge1xuICAgIHhjcnVuUGF0aCA9IGF3YWl0IGZzLndoaWNoKFhDUlVOKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGAke1hDUlVOfSBoYXMgbm90IGJlZW4gZm91bmQgaW4gUEFUSC4gYCArXG4gICAgICBgUGxlYXNlIG1ha2Ugc3VyZSBYQ29kZSBkZXZlbG9wbWVudCB0b29scyBhcmUgaW5zdGFsbGVkYCk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKHhjcnVuUGF0aCwgW1hDVFJBQ0UsICdoZWxwJ10pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYCR7WENUUkFDRX0gaXMgbm90IGF2YWlsYWJsZSBmb3IgdGhlIGFjdGl2ZSBYY29kZSB2ZXJzaW9uLiBgICtcbiAgICAgIGBQbGVhc2UgbWFrZSBzdXJlIFhDb2RlIGlzIHVwIHRvIGRhdGUuIE9yaWdpbmFsIGVycm9yOiAke2Uuc3RkZXJyIHx8IGUubWVzc2FnZX1gKTtcbiAgfVxuICByZXR1cm4geGNydW5QYXRoO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXF1aXJlSW5zdHJ1bWVudHMgKCkge1xuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBmcy53aGljaChJTlNUUlVNRU5UUyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgJHtJTlNUUlVNRU5UU30gaGFzIG5vdCBiZWVuIGZvdW5kIGluIFBBVEguIGAgK1xuICAgICAgYFBsZWFzZSBtYWtlIHN1cmUgWENvZGUgZGV2ZWxvcG1lbnQgdG9vbHMgYXJlIGluc3RhbGxlZGApO1xuICB9XG59XG5cblxuY2xhc3MgUGVyZlJlY29yZGVyIHtcbiAgY29uc3RydWN0b3IgKHJlcG9ydFJvb3QsIHVkaWQsIG9wdHMgPSB7fSkge1xuICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xuICAgIHRoaXMuX3ppcHBlZFJlcG9ydFBhdGggPSAnJztcbiAgICB0aGlzLl90aW1lb3V0ID0gKG9wdHMudGltZW91dCAmJiBvcHRzLnRpbWVvdXQgPiAwKSA/IG9wdHMudGltZW91dCA6IERFRkFVTFRfVElNRU9VVF9NUztcbiAgICB0aGlzLl9wcm9maWxlTmFtZSA9IG9wdHMucHJvZmlsZU5hbWUgfHwgREVGQVVMVF9QUk9GSUxFX05BTUU7XG4gICAgdGhpcy5fcmVwb3J0UGF0aCA9IHBhdGgucmVzb2x2ZShyZXBvcnRSb290LFxuICAgICAgYGFwcGl1bV9wZXJmX18ke3RoaXMuX3Byb2ZpbGVOYW1lLnJlcGxhY2UoL1xcVy9nLCAnXycpfV9fJHtEYXRlLm5vdygpfSR7REVGQVVMVF9FWFR9YCk7XG4gICAgdGhpcy5fcGlkID0gb3B0cy5waWQ7XG4gICAgdGhpcy5fdWRpZCA9IHVkaWQ7XG4gICAgdGhpcy5fbG9nZ2VyID0gbG9nZ2VyLmdldExvZ2dlcihcbiAgICAgIGAke18udHJ1bmNhdGUodGhpcy5fcHJvZmlsZU5hbWUsIHtsZW5ndGg6IDEwfSl9QCR7dGhpcy5fdWRpZC5zdWJzdHJpbmcoMCwgOCl9YCk7XG4gICAgdGhpcy5fYXJjaGl2ZVByb21pc2UgPSBudWxsO1xuICB9XG5cbiAgZ2V0IHByb2ZpbGVOYW1lICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcHJvZmlsZU5hbWU7XG4gIH1cblxuICBhc3luYyBnZXRPcmlnaW5hbFJlcG9ydFBhdGggKCkge1xuICAgIHJldHVybiAoYXdhaXQgZnMuZXhpc3RzKHRoaXMuX3JlcG9ydFBhdGgpKSA/IHRoaXMuX3JlcG9ydFBhdGggOiAnJztcbiAgfVxuXG4gIGFzeW5jIGdldFppcHBlZFJlcG9ydFBhdGggKCkge1xuICAgIC8vIFRoaXMgaXMgdG8gcHJldmVudCBwb3NzaWJsZSByYWNlIGNvbmRpdGlvbnMsIGJlY2F1c2UgdGhlIGFyY2hpdmUgb3BlcmF0aW9uXG4gICAgLy8gY291bGQgYmUgcHJldHR5IHRpbWUtaW50ZW5zaXZlXG4gICAgaWYgKCF0aGlzLl9hcmNoaXZlUHJvbWlzZSkge1xuICAgICAgdGhpcy5fYXJjaGl2ZVByb21pc2UgPSAoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBvcmlnaW5hbFJlcG9ydFBhdGggPSBhd2FpdCB0aGlzLmdldE9yaWdpbmFsUmVwb3J0UGF0aCgpO1xuICAgICAgICBpZiAoIW9yaWdpbmFsUmVwb3J0UGF0aCkge1xuICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB6aXBwZWRSZXBvcnRQYXRoID0gYXdhaXQgdGVtcERpci5wYXRoKHtcbiAgICAgICAgICBwcmVmaXg6IHBhdGgucGFyc2Uob3JpZ2luYWxSZXBvcnRQYXRoKS5uYW1lLFxuICAgICAgICAgIHN1ZmZpeDogJy56aXAnXG4gICAgICAgIH0pO1xuICAgICAgICBhd2FpdCB6aXAudG9BcmNoaXZlKHppcHBlZFJlcG9ydFBhdGgsIHtcbiAgICAgICAgICBjd2Q6IHBhdGguZGlybmFtZSh0aGlzLl9yZXBvcnRQYXRoKSxcbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IGZzLnJpbXJhZihwYXRoLmRpcm5hbWUodGhpcy5fcmVwb3J0UGF0aCkpO1xuICAgICAgICB0aGlzLl96aXBwZWRSZXBvcnRQYXRoID0gemlwcGVkUmVwb3J0UGF0aDtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ppcHBlZFJlcG9ydFBhdGg7XG4gICAgICB9KSgpO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5fYXJjaGl2ZVByb21pc2U7XG4gIH1cblxuICBpc1J1bm5pbmcgKCkge1xuICAgIHJldHVybiAhISh0aGlzLl9wcm9jZXNzPy5pc1J1bm5pbmcpO1xuICB9XG5cbiAgYXN5bmMgX2VuZm9yY2VUZXJtaW5hdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMuX3Byb2Nlc3MgJiYgdGhpcy5pc1J1bm5pbmcoKSkge1xuICAgICAgdGhpcy5fbG9nZ2VyLmRlYnVnKCdGb3JjZS1zdG9wcGluZyB0aGUgY3VycmVudGx5IHJ1bm5pbmcgcGVyZiByZWNvcmRpbmcnKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX3Byb2Nlc3Muc3RvcCgnU0lHS0lMTCcpO1xuICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIH1cbiAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcbiAgICBjb25zdCBwZXJmb3JtQ2xlYW51cCA9IGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IEIuYWxsKFt0aGlzLl96aXBwZWRSZXBvcnRQYXRoLCBwYXRoLmRpcm5hbWUodGhpcy5fcmVwb3J0UGF0aCldXG4gICAgICAgICAgLmZpbHRlcihCb29sZWFuKS5tYXAoKHgpID0+IGZzLnJpbXJhZih4KSkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aGlzLl9sb2dnZXIud2FybihlLm1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH07XG4gICAgaWYgKHRoaXMuX2FyY2hpdmVQcm9taXNlKSB7XG4gICAgICB0aGlzLl9hcmNoaXZlUHJvbWlzZVxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tdGhlblxuICAgICAgICAuZmluYWxseShhc3luYyAoKSA9PiB7XG4gICAgICAgICAgYXdhaXQgcGVyZm9ybUNsZWFudXAoKTtcbiAgICAgICAgICB0aGlzLl9hcmNoaXZlUHJvbWlzZSA9IG51bGw7XG4gICAgICAgIH0pXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by10aGVuXG4gICAgICAgIC5jYXRjaCgoKSA9PiB7fSk7XG4gICAgfVxuICAgIGF3YWl0IHBlcmZvcm1DbGVhbnVwKCk7XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIGxldCBiaW5hcnlQYXRoO1xuICAgIHRyeSB7XG4gICAgICBiaW5hcnlQYXRoID0gYXdhaXQgcmVxdWlyZVhjdHJhY2UoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuZGVidWcoZS5tZXNzYWdlKTtcbiAgICAgIGxvZy5pbmZvKGBEZWZhdWx0aW5nIHRvICR7SU5TVFJVTUVOVFN9IHVzYWdlYCk7XG4gICAgICBiaW5hcnlQYXRoID0gYXdhaXQgcmVxdWlyZUluc3RydW1lbnRzKCk7XG4gICAgfVxuXG4gICAgY29uc3QgYXJncyA9IFtdO1xuICAgIGNvbnN0IHRvb2xOYW1lID0gcGF0aC5iYXNlbmFtZShiaW5hcnlQYXRoKSA9PT0gWENSVU4gPyBYQ1RSQUNFIDogSU5TVFJVTUVOVFM7XG4gICAgaWYgKHRvb2xOYW1lID09PSBYQ1RSQUNFKSB7XG4gICAgICBhcmdzLnB1c2goXG4gICAgICAgIFhDVFJBQ0UsICdyZWNvcmQnLFxuICAgICAgICAnLS1kZXZpY2UnLCB0aGlzLl91ZGlkLFxuICAgICAgICAnLS10ZW1wbGF0ZScsIHRoaXMuX3Byb2ZpbGVOYW1lLFxuICAgICAgICAnLS1vdXRwdXQnLCB0aGlzLl9yZXBvcnRQYXRoLFxuICAgICAgICAnLS10aW1lLWxpbWl0JywgYCR7dGhpcy5fdGltZW91dH1tc2AsXG4gICAgICApO1xuICAgICAgaWYgKHRoaXMuX3BpZCkge1xuICAgICAgICBhcmdzLnB1c2goJy0tYXR0YWNoJywgYCR7dGhpcy5fcGlkfWApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXJncy5wdXNoKCctLWFsbC1wcm9jZXNzZXMnKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gaHR0cHM6Ly9oZWxwLmFwcGxlLmNvbS9pbnN0cnVtZW50cy9tYWMvY3VycmVudC8jL2RldmIxNGZmYWE1XG4gICAgICBhcmdzLnB1c2goXG4gICAgICAgICctdycsIHRoaXMuX3VkaWQsXG4gICAgICAgICctdCcsIHRoaXMuX3Byb2ZpbGVOYW1lLFxuICAgICAgICAnLUQnLCB0aGlzLl9yZXBvcnRQYXRoLFxuICAgICAgICAnLWwnLCBgJHt0aGlzLl90aW1lb3V0fWAsXG4gICAgICApO1xuICAgICAgaWYgKHRoaXMuX3BpZCkge1xuICAgICAgICBhcmdzLnB1c2goJy1wJywgYCR7dGhpcy5fcGlkfWApO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBmdWxsQ21kID0gW2JpbmFyeVBhdGgsIC4uLmFyZ3NdO1xuICAgIHRoaXMuX3Byb2Nlc3MgPSBuZXcgU3ViUHJvY2VzcyhmdWxsQ21kWzBdLCBmdWxsQ21kLnNsaWNlKDEpKTtcbiAgICB0aGlzLl9hcmNoaXZlUHJvbWlzZSA9IG51bGw7XG4gICAgdGhpcy5fbG9nZ2VyLmRlYnVnKGBTdGFydGluZyBwZXJmb3JtYW5jZSByZWNvcmRpbmc6ICR7dXRpbC5xdW90ZShmdWxsQ21kKX1gKTtcbiAgICB0aGlzLl9wcm9jZXNzLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgIGlmIChfLnRyaW0oc3Rkb3V0IHx8IHN0ZGVycikpIHtcbiAgICAgICAgdGhpcy5fbG9nZ2VyLmRlYnVnKGBbJHt0b29sTmFtZX1dICR7c3Rkb3V0IHx8IHN0ZGVycn1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLl9wcm9jZXNzLm9uY2UoJ2V4aXQnLCBhc3luYyAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcbiAgICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZygnUGVyZm9ybWFuY2UgcmVjb3JkaW5nIGV4aXRlZCB3aXRob3V0IGVycm9ycycpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIGNhY2hlIHppcHBlZCByZXBvcnRcbiAgICAgICAgICBhd2FpdCB0aGlzLmdldFppcHBlZFJlcG9ydFBhdGgoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci53YXJuKGUpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhd2FpdCB0aGlzLl9lbmZvcmNlVGVybWluYXRpb24oKTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyLndhcm4oYFBlcmZvcm1hbmNlIHJlY29yZGluZyBleGl0ZWQgd2l0aCBlcnJvciBjb2RlICR7Y29kZX0sIHNpZ25hbCAke3NpZ25hbH1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLl9wcm9jZXNzLnN0YXJ0KDApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgaWYgKGF3YWl0IHRoaXMuZ2V0T3JpZ2luYWxSZXBvcnRQYXRoKCkpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuX3Byb2Nlc3MpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7dG9vbE5hbWV9IHByb2Nlc3MgZGllZCB1bmV4cGVjdGVkbHlgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9LCB7XG4gICAgICAgIHdhaXRNczogU1RBUlRVUF9USU1FT1VUX01TLFxuICAgICAgICBpbnRlcnZhbE1zOiA1MDAsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBhd2FpdCB0aGlzLl9lbmZvcmNlVGVybWluYXRpb24oKTtcbiAgICAgIGNvbnN0IGxpc3RQcm9maWxlc0NvbW1hbmQgPSB0b29sTmFtZSA9PT0gWENUUkFDRVxuICAgICAgICA/IGAke1hDUlVOfSAke1hDVFJBQ0V9IGxpc3QgdGVtcGxhdGVzYFxuICAgICAgICA6IGAke0lOU1RSVU1FTlRTfSAtc2A7XG4gICAgICB0aGlzLl9sb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGhlcmUgaXMgbm8gJHtERUZBVUxUX0VYVH0gZmlsZSBmb3VuZCBmb3IgcGVyZm9ybWFuY2UgcHJvZmlsZSBgICtcbiAgICAgICAgYCcke3RoaXMuX3Byb2ZpbGVOYW1lfScuIE1ha2Ugc3VyZSB0aGUgcHJvZmlsZSBpcyBzdXBwb3J0ZWQgb24gdGhpcyBkZXZpY2UuIGAgK1xuICAgICAgICBgWW91IGNvdWxkIHVzZSAnJHtsaXN0UHJvZmlsZXNDb21tYW5kfScgY29tbWFuZCB0byBzZWUgdGhlIGxpc3Qgb2YgYWxsIGF2YWlsYWJsZSBwcm9maWxlcy4gYCArXG4gICAgICAgIGBDaGVjayB0aGUgc2VydmVyIGxvZyBmb3IgbW9yZSBkZXRhaWxzYCk7XG4gICAgfVxuICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBUaGUgcGVyZm9ybWFuY2UgcmVjb3JkaW5nIGhhcyBzdGFydGVkLiBXaWxsIHRpbWVvdXQgaW4gJHt0aGlzLl90aW1lb3V0fW1zYCk7XG4gIH1cblxuICBhc3luYyBzdG9wIChmb3JjZSA9IGZhbHNlKSB7XG4gICAgaWYgKGZvcmNlKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZW5mb3JjZVRlcm1pbmF0aW9uKCk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmlzUnVubmluZygpKSB7XG4gICAgICB0aGlzLl9sb2dnZXIuZGVidWcoJ1BlcmZvcm1hbmNlIHJlY29yZGluZyBpcyBub3QgcnVubmluZy4gUmV0dXJuaW5nIHRoZSByZWNlbnQgcmVzdWx0Jyk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRaaXBwZWRSZXBvcnRQYXRoKCk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuX3Byb2Nlc3Muc3RvcCgnU0lHSU5UJywgU1RPUF9USU1FT1VUX01TKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLl9sb2dnZXIuZXJyb3JBbmRUaHJvdyhgUGVyZm9ybWFuY2UgcmVjb3JkaW5nIGhhcyBmYWlsZWQgdG8gZXhpdCBhZnRlciAke1NUT1BfVElNRU9VVF9NU31tc2ApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRaaXBwZWRSZXBvcnRQYXRoKCk7XG4gIH1cbn1cblxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0YXJ0UGVyZlJlY29yZE9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9udW1iZXJ8c3RyaW5nfSB0aW1lb3V0IFszMDAwMDBdIC0gVGhlIG1heGltdW0gY291bnQgb2YgbWlsbGlzZWNvbmRzIHRvIHJlY29yZCB0aGUgcHJvZmlsaW5nIGluZm9ybWF0aW9uLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwcm9maWxlTmFtZSBbQWN0aXZpdHkgTW9uaXRvcl0gLSBUaGUgbmFtZSBvZiBleGlzdGluZyBwZXJmb3JtYW5jZSBwcm9maWxlIHRvIGFwcGx5LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDYW4gYWxzbyBjb250YWluIHRoZSBmdWxsIHBhdGggdG8gdGhlIGNob3NlbiB0ZW1wbGF0ZSBvbiB0aGUgc2VydmVyIGZpbGUgc3lzdGVtLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOb3RlLCB0aGF0IG5vdCBhbGwgcHJvZmlsZXMgYXJlIHN1cHBvcnRlZCBvbiBtb2JpbGUgZGV2aWNlcy5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ3xudW1iZXJ9IHBpZCAtIFRoZSBJRCBvZiB0aGUgcHJvY2VzcyB0byBtZWFzdXJlIHRoZSBwZXJmb3JtYW5jZSBmb3IuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTZXQgaXQgdG8gYGN1cnJlbnRgIGluIG9yZGVyIHRvIG1lYXN1cmUgdGhlIHBlcmZvcm1hbmNlIG9mXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgcHJvY2Vzcywgd2hpY2ggYmVsb25ncyB0byB0aGUgY3VycmVudGx5IGFjdGl2ZSBhcHBsaWNhdGlvbi5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFsbCBwcm9jZXNzZXMgcnVubmluZyBvbiB0aGUgZGV2aWNlIGFyZSBtZWFzdXJlZCBpZlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGlkIGlzIHVuc2V0ICh0aGUgZGVmYXVsdCBzZXR0aW5nKS5cbiAqL1xuXG4vKipcbiAqIFN0YXJ0cyBwZXJmb3JtYW5jZSBwcm9maWxpbmcgZm9yIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqIFJlbGF4aW5nIHNlY3VyaXR5IGlzIG1hbmRhdG9yeSBmb3Igc2ltdWxhdG9ycy4gSXQgY2FuIGFsd2F5cyB3b3JrIGZvciByZWFsIGRldmljZXMuXG4gKlxuICogU2luY2UgWENvZGUgMTQgdGhlIG1ldGhvZCB0cmllcyB0byB1c2UgYHhjdHJhY2VgIHRvb2wgdG8gcmVjb3JkIHBlcmZvcm1hbmNlIHN0YXRzLlxuICogVGhlIGBpbnN0cnVtZW50c2AgZGV2ZWxvcGVyIHV0aWxpdHkgaXMgdXNlZCBhcyBhIGZhbGxiYWNrIGZvciB0aGlzIHB1cnBvc2UgaWYgYHhjdHJhY2VgXG4gKiBpcyBub3QgYXZhaWxhYmxlLlxuICogSXQgaXMgcG9zc2libGUgdG8gcmVjb3JkIG11bHRpcGxlIHByb2ZpbGVzIGF0IHRoZSBzYW1lIHRpbWUuXG4gKiBSZWFkIGh0dHBzOi8vZGV2ZWxvcGVyLmFwcGxlLmNvbS9saWJyYXJ5L2NvbnRlbnQvZG9jdW1lbnRhdGlvbi9EZXZlbG9wZXJUb29scy9Db25jZXB0dWFsL0luc3RydW1lbnRzVXNlckd1aWRlL1JlY29yZGluZyxQYXVzaW5nLGFuZFN0b3BwaW5nVHJhY2VzLmh0bWxcbiAqIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogQHBhcmFtIHs/U3RhcnRQZXJmUmVjb3JkT3B0aW9uc30gb3B0cyAtIFRoZSBzZXQgb2YgcG9zc2libGUgc3RhcnQgcmVjb3JkIG9wdGlvbnNcbiAqL1xuY29tbWFuZHMubW9iaWxlU3RhcnRQZXJmUmVjb3JkID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlU3RhcnRQZXJmUmVjb3JkIChvcHRzID0ge30pIHtcbiAgaWYgKCF0aGlzLmlzRmVhdHVyZUVuYWJsZWQoUEVSRl9SRUNPUkRfRkVBVF9OQU1FKSAmJiAhdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KFBFUkZfUkVDT1JEX1NFQ1VSSVRZX01FU1NBR0UpO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIHRpbWVvdXQgPSBERUZBVUxUX1RJTUVPVVRfTVMsXG4gICAgcHJvZmlsZU5hbWUgPSBERUZBVUxUX1BST0ZJTEVfTkFNRSxcbiAgICBwaWQsXG4gIH0gPSBvcHRzO1xuXG4gIGlmICghXy5pc0VtcHR5KHRoaXMuX3BlcmZSZWNvcmRlcnMpKSB7XG4gICAgZm9yIChjb25zdCByZWNvcmRlciBvZiB0aGlzLl9wZXJmUmVjb3JkZXJzLmZpbHRlcigoeCkgPT4geC5wcm9maWxlTmFtZSA9PT0gcHJvZmlsZU5hbWUpKSB7XG4gICAgICBpZiAocmVjb3JkZXIuaXNSdW5uaW5nKCkpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBQZXJmb3JtYW5jZSByZWNvcmRlciBmb3IgJyR7cHJvZmlsZU5hbWV9JyBvbiBkZXZpY2UgJyR7dGhpcy5vcHRzLmRldmljZS51ZGlkfScgYCArXG4gICAgICAgICAgYCBpcyBhbHJlYWR5IHJ1bm5pbmcuIERvaW5nIG5vdGhpbmdgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgXy5wdWxsKHRoaXMuX3BlcmZSZWNvcmRlcnMsIHJlY29yZGVyKTtcbiAgICAgIGF3YWl0IHJlY29yZGVyLnN0b3AodHJ1ZSk7XG4gICAgfVxuICB9XG5cbiAgbGV0IHJlYWxQaWQ7XG4gIGlmIChwaWQpIHtcbiAgICBpZiAoXy50b0xvd2VyKHBpZCkgPT09IERFRkFVTFRfUElEKSB7XG4gICAgICBjb25zdCBhcHBJbmZvID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvYWN0aXZlQXBwSW5mbycsICdHRVQnKTtcbiAgICAgIHJlYWxQaWQgPSBhcHBJbmZvLnBpZDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVhbFBpZCA9IHBpZDtcbiAgICB9XG4gIH1cbiAgY29uc3QgcmVjb3JkZXIgPSBuZXcgUGVyZlJlY29yZGVyKGF3YWl0IHRlbXBEaXIub3BlbkRpcigpLCB0aGlzLm9wdHMuZGV2aWNlLnVkaWQsIHtcbiAgICB0aW1lb3V0OiBwYXJzZUludCh0aW1lb3V0LCAxMCksXG4gICAgcHJvZmlsZU5hbWUsXG4gICAgcGlkOiBwYXJzZUludChyZWFsUGlkLCAxMCksXG4gIH0pO1xuICBhd2FpdCByZWNvcmRlci5zdGFydCgpO1xuICB0aGlzLl9wZXJmUmVjb3JkZXJzID0gWy4uLih0aGlzLl9wZXJmUmVjb3JkZXJzIHx8IFtdKSwgcmVjb3JkZXJdO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdG9wUmVjb3JkaW5nT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIHRoZSByZW1vdGUgbG9jYXRpb24sIHdoZXJlIHRoZSByZXN1bHRpbmcgemlwcGVkIC50cmFjZSBmaWxlIHNob3VsZCBiZSB1cGxvYWRlZC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBmb2xsb3dpbmcgcHJvdG9jb2xzIGFyZSBzdXBwb3J0ZWQ6IGh0dHAvaHR0cHMsIGZ0cC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE51bGwgb3IgZW1wdHkgc3RyaW5nIHZhbHVlICh0aGUgZGVmYXVsdCBzZXR0aW5nKSBtZWFucyB0aGUgY29udGVudCBvZiByZXN1bHRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUgc2hvdWxkIGJlIHppcHBlZCwgZW5jb2RlZCBhcyBCYXNlNjQgYW5kIHBhc3NlZCBhcyB0aGUgZW5kcG9pbnQgcmVzcG9uc2UgdmFsdWUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbiBleGNlcHRpb24gd2lsbCBiZSB0aHJvd24gaWYgdGhlIGdlbmVyYXRlZCBmaWxlIGlzIHRvbyBiaWcgdG9cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpdCBpbnRvIHRoZSBhdmFpbGFibGUgcHJvY2VzcyBtZW1vcnkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBhc3MgLSBUaGUgcGFzc3dvcmQgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBtZXRob2QgW1BVVF0gLSBUaGUgaHR0cCBtdWx0aXBhcnQgdXBsb2FkIG1ldGhvZCBuYW1lLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcHJvZmlsZU5hbWUgW0FjdGl2aXR5IE1vbml0b3JdIC0gVGhlIG5hbWUgb2YgYW4gZXhpc3RpbmcgcGVyZm9ybWFuY2UgcHJvZmlsZSBmb3Igd2hpY2ggdGhlIHJlY29yZGluZyBoYXMgYmVlbiBtYWRlLlxuICogQHByb3BlcnR5IHs/T2JqZWN0fSBoZWFkZXJzIC0gQWRkaXRpb25hbCBoZWFkZXJzIG1hcHBpbmcgZm9yIG11bHRpcGFydCBodHRwKHMpIHVwbG9hZHNcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gZmlsZUZpZWxkTmFtZSBbZmlsZV0gLSBUaGUgbmFtZSBvZiB0aGUgZm9ybSBmaWVsZCwgd2hlcmUgdGhlIGZpbGUgY29udGVudCBCTE9CIHNob3VsZCBiZSBzdG9yZWQgZm9yXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cChzKSB1cGxvYWRzXG4gKiBAcHJvcGVydHkgez9PYmplY3R8QXJyYXk8UGFpcj59IGZvcm1GaWVsZHMgLSBBZGRpdGlvbmFsIGZvcm0gZmllbGRzIGZvciBtdWx0aXBhcnQgaHR0cChzKSB1cGxvYWRzXG4gKi9cblxuLyoqXG4gKiBTdG9wcyBwZXJmb3JtYW5jZSBwcm9maWxpbmcgZm9yIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqIFRoZSByZXN1bHRpbmcgZmlsZSBpbiAudHJhY2UgZm9ybWF0IGNhbiBiZSBlaXRoZXIgcmV0dXJuZWRcbiAqIGRpcmVjdGx5IGFzIGJhc2U2NC1lbmNvZGVkIHppcCBhcmNoaXZlIG9yIHVwbG9hZGVkIHRvIGEgcmVtb3RlIGxvY2F0aW9uXG4gKiAoc3VjaCBmaWxlcyBjYW4gYmUgcHJldHR5IGxhcmdlKS4gQWZ0ZXJ3YXJkcyBpdCBpcyBwb3NzaWJsZSB0byB1bmFyY2hpdmUgYW5kXG4gKiBvcGVuIHN1Y2ggZmlsZSB3aXRoIFhjb2RlIERldiBUb29scy5cbiAqXG4gKiBAcGFyYW0gez9TdG9wUmVjb3JkaW5nT3B0aW9uc30gb3B0cyAtIFRoZSBzZXQgb2YgcG9zc2libGUgc3RvcCByZWNvcmQgb3B0aW9uc1xuICogQHJldHVybiB7c3RyaW5nfSBFaXRoZXIgYW4gZW1wdHkgc3RyaW5nIGlmIHRoZSB1cGxvYWQgd2FzIHN1Y2Nlc3NmdWwgb3IgYmFzZS02NCBlbmNvZGVkXG4gKiBjb250ZW50IG9mIHppcHBlZCAudHJhY2UgZmlsZS5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBubyBwZXJmb3JtYW5jZSByZWNvcmRpbmcgd2l0aCBnaXZlbiBwcm9maWxlIG5hbWUvZGV2aWNlIHVkaWQgY29tYmluYXRpb25cbiAqIGhhcyBiZWVuIHN0YXJ0ZWQgYmVmb3JlIG9yIHRoZSByZXN1bHRpbmcgLnRyYWNlIGZpbGUgaGFzIG5vdCBiZWVuIGdlbmVyYXRlZCBwcm9wZXJseS5cbiAqL1xuY29tbWFuZHMubW9iaWxlU3RvcFBlcmZSZWNvcmQgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVTdG9wUGVyZlJlY29yZCAob3B0cyA9IHt9KSB7XG4gIGlmICghdGhpcy5pc0ZlYXR1cmVFbmFibGVkKFBFUkZfUkVDT1JEX0ZFQVRfTkFNRSkgJiYgIXRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhQRVJGX1JFQ09SRF9TRUNVUklUWV9NRVNTQUdFKTtcbiAgfVxuXG4gIGlmIChfLmlzRW1wdHkodGhpcy5fcGVyZlJlY29yZGVycykpIHtcbiAgICBsb2cuaW5mbygnTm8gcGVyZm9ybWFuY2UgcmVjb3JkZXJzIGhhdmUgYmVlbiBzdGFydGVkLiBEb2luZyBub3RoaW5nJyk7XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIHByb2ZpbGVOYW1lID0gREVGQVVMVF9QUk9GSUxFX05BTUUsXG4gICAgcmVtb3RlUGF0aCxcbiAgfSA9IG9wdHM7XG5cbiAgY29uc3QgcmVjb3JkZXJzID0gdGhpcy5fcGVyZlJlY29yZGVycy5maWx0ZXIoKHgpID0+IHgucHJvZmlsZU5hbWUgPT09IHByb2ZpbGVOYW1lKTtcbiAgaWYgKF8uaXNFbXB0eShyZWNvcmRlcnMpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZXJlIGFyZSBubyByZWNvcmRzIGZvciBwZXJmb3JtYW5jZSBwcm9maWxlICcke3Byb2ZpbGVOYW1lfScgYCArXG4gICAgICBgYW5kIGRldmljZSAke3RoaXMub3B0cy5kZXZpY2UudWRpZH0uIEhhdmUgeW91IHN0YXJ0ZWQgdGhlIHByb2ZpbGluZyBiZWZvcmU/YCk7XG4gIH1cblxuICBjb25zdCByZWNvcmRlciA9IF8uZmlyc3QocmVjb3JkZXJzKTtcbiAgY29uc3QgcmVzdWx0UGF0aCA9IGF3YWl0IHJlY29yZGVyLnN0b3AoKTtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMocmVzdWx0UGF0aCkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlcmUgaXMgbm8gJHtERUZBVUxUX0VYVH0gZmlsZSBmb3VuZCBmb3IgcGVyZm9ybWFuY2UgcHJvZmlsZSAnJHtwcm9maWxlTmFtZX0nIGAgK1xuICAgICAgYGFuZCBkZXZpY2UgJHt0aGlzLm9wdHMuZGV2aWNlLnVkaWR9LiBNYWtlIHN1cmUgdGhlIHNlbGVjdGVkIHByb2ZpbGUgaXMgc3VwcG9ydGVkIG9uIHRoaXMgZGV2aWNlYCk7XG4gIH1cblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBlbmNvZGVCYXNlNjRPclVwbG9hZChyZXN1bHRQYXRoLCByZW1vdGVQYXRoLCBvcHRzKTtcbiAgXy5wdWxsKHRoaXMuX3BlcmZSZWNvcmRlcnMsIHJlY29yZGVyKTtcbiAgYXdhaXQgZnMucmltcmFmKHJlc3VsdFBhdGgpO1xuICByZXR1cm4gcmVzdWx0O1xufTtcblxuXG5leHBvcnQgeyBjb21tYW5kcyB9O1xuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9wZXJmb3JtYW5jZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.assertIDB = assertIDB;
exports.default = exports.commands = void 0;
exports.parseXCTestStdout = parseXCTestStdout;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _support = require("@appium/support");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("../logger"));

let commands = {};
exports.commands = commands;
const XCTEST_TIMEOUT = 60 * 60 * 1000;

const xctestLog = _support.logger.getLogger('XCTest');

function assertIDB(opts) {
  var _opts$device;

  if (!((_opts$device = opts.device) !== null && _opts$device !== void 0 && _opts$device.idb) || !opts.launchWithIDB) {
    _logger.default.errorAndThrow(`To use XCTest runner, IDB (https://github.com/facebook/idb) must be installed ` + `and sessions must be run with the "launchWithIDB" capability`);
  }

  return opts.device.idb;
}

function parseXCTestStdout(stdout) {
  function parseKey(name) {
    const words = name.split(' ');
    let out = '';

    for (const word of words) {
      out += word.substr(0, 1).toUpperCase() + word.substr(1);
    }

    return out.substr(0, 1).toLowerCase() + out.substr(1);
  }

  function parseValue(value) {
    value = value || '';

    switch (value.toLowerCase()) {
      case 'true':
        return true;

      case 'false':
        return false;

      case '':
        return null;

      default:
        break;
    }

    if (!isNaN(value)) {
      if (!_lodash.default.isString(value)) {
        return 0;
      } else if (value.indexOf('.') > 0) {
        return parseFloat(value);
      }

      return parseInt(value, 10);
    }
  }

  if (!stdout) {
    return [];
  }

  const lines = stdout.trim().split('\n');

  if (lines.length === 1 && !lines[0].includes('|')) {
    return [lines[0]];
  }

  const results = [];

  for (const line of lines) {
    const properties = line.split('|');
    const output = {};
    let entryIndex = 0;

    for (const prop of properties) {
      if (entryIndex === 0) {
        output.testName = prop.trim();
      } else {
        let [key, value] = prop.split(':');
        output[parseKey(key.trim())] = parseValue(value ? value.trim() : '');
      }

      entryIndex++;
    }

    results.push(output);
  }

  return results;
}

commands.mobileRunXCTest = async function runXCTest({
  testRunnerBundleId,
  appUnderTestBundleId,
  xctestBundleId,
  testType = 'ui',
  env,
  args,
  timeout = XCTEST_TIMEOUT
}) {
  const subproc = await assertIDB(this.opts).runXCUITest(testRunnerBundleId, appUnderTestBundleId, xctestBundleId, {
    env,
    args,
    testType
  });
  return await new _bluebird.default((resolve, reject) => {
    let mostRecentLogObject = null;
    let xctestTimeout;

    if (timeout > 0) {
      xctestTimeout = setTimeout(() => reject(`Timed out after '${timeout}ms' waiting for XCTest to complete`), timeout);
    }

    subproc.on('output', (stdout, stderr) => {
      if (stdout) {
        try {
          mostRecentLogObject = parseXCTestStdout(stdout);
        } catch (err) {
          _logger.default.warn(`Failed to parse logs from test output: '${stdout}'`);

          _logger.default.debug(err.stack);
        }
      }

      stdout && xctestLog.info(stdout);
      stderr && xctestLog.error(stderr);
    });
    subproc.on('exit', (code, signal) => {
      clearTimeout(xctestTimeout);

      if (code !== 0) {
        const err = new Error(mostRecentLogObject);
        err.code = code;

        if (signal != null) {
          err.signal = signal;
        }

        if (mostRecentLogObject) {
          err.result = mostRecentLogObject;
        }

        return reject(err);
      }

      resolve({
        code,
        signal,
        results: mostRecentLogObject,
        passed: true
      });
    });
  });
};

commands.mobileInstallXCTestBundle = async function installXCTestBundle(opts) {
  const {
    xctestApp
  } = opts;

  if (!_lodash.default.isString(xctestApp)) {
    _logger.default.errorAndThrow(`'xctestApp' is a required parameter for 'installXCTestBundle' and ` + `must be a string. Found '${xctestApp}'`);
  }

  xctestLog.info(`Installing bundle '${xctestApp}'`);
  const idb = assertIDB(this.opts);
  const res = await this.helpers.configureApp(xctestApp, '.xctest');
  await idb.installXCTestBundle(res);
};

commands.mobileListXCTestBundles = async function listXCTestsInTestBundle() {
  return await assertIDB(this.opts).listXCTestBundles();
};

commands.mobileListXCTestsInTestBundle = async function listXCTestsInTestBundle(opts) {
  const {
    bundle
  } = opts;

  if (!_lodash.default.isString(bundle)) {
    _logger.default.errorAndThrow(`'bundle' is a required parameter for 'listXCTestsInTestBundle' and ` + `must be a string. Found '${bundle}'`);
  }

  const idb = assertIDB(this.opts);
  return await idb.listXCTestsInTestBundle(bundle);
};

Object.assign(commands);
var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy94Y3Rlc3QuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJYQ1RFU1RfVElNRU9VVCIsInhjdGVzdExvZyIsImxvZ2dlciIsImdldExvZ2dlciIsImFzc2VydElEQiIsIm9wdHMiLCJkZXZpY2UiLCJpZGIiLCJsYXVuY2hXaXRoSURCIiwibG9nIiwiZXJyb3JBbmRUaHJvdyIsInBhcnNlWENUZXN0U3Rkb3V0Iiwic3Rkb3V0IiwicGFyc2VLZXkiLCJuYW1lIiwid29yZHMiLCJzcGxpdCIsIm91dCIsIndvcmQiLCJzdWJzdHIiLCJ0b1VwcGVyQ2FzZSIsInRvTG93ZXJDYXNlIiwicGFyc2VWYWx1ZSIsInZhbHVlIiwiaXNOYU4iLCJfIiwiaXNTdHJpbmciLCJpbmRleE9mIiwicGFyc2VGbG9hdCIsInBhcnNlSW50IiwibGluZXMiLCJ0cmltIiwibGVuZ3RoIiwiaW5jbHVkZXMiLCJyZXN1bHRzIiwibGluZSIsInByb3BlcnRpZXMiLCJvdXRwdXQiLCJlbnRyeUluZGV4IiwicHJvcCIsInRlc3ROYW1lIiwia2V5IiwicHVzaCIsIm1vYmlsZVJ1blhDVGVzdCIsInJ1blhDVGVzdCIsInRlc3RSdW5uZXJCdW5kbGVJZCIsImFwcFVuZGVyVGVzdEJ1bmRsZUlkIiwieGN0ZXN0QnVuZGxlSWQiLCJ0ZXN0VHlwZSIsImVudiIsImFyZ3MiLCJ0aW1lb3V0Iiwic3VicHJvYyIsInJ1blhDVUlUZXN0IiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJtb3N0UmVjZW50TG9nT2JqZWN0IiwieGN0ZXN0VGltZW91dCIsInNldFRpbWVvdXQiLCJvbiIsInN0ZGVyciIsImVyciIsIndhcm4iLCJkZWJ1ZyIsInN0YWNrIiwiaW5mbyIsImVycm9yIiwiY29kZSIsInNpZ25hbCIsImNsZWFyVGltZW91dCIsIkVycm9yIiwicmVzdWx0IiwicGFzc2VkIiwibW9iaWxlSW5zdGFsbFhDVGVzdEJ1bmRsZSIsImluc3RhbGxYQ1Rlc3RCdW5kbGUiLCJ4Y3Rlc3RBcHAiLCJyZXMiLCJoZWxwZXJzIiwiY29uZmlndXJlQXBwIiwibW9iaWxlTGlzdFhDVGVzdEJ1bmRsZXMiLCJsaXN0WENUZXN0c0luVGVzdEJ1bmRsZSIsImxpc3RYQ1Rlc3RCdW5kbGVzIiwibW9iaWxlTGlzdFhDVGVzdHNJblRlc3RCdW5kbGUiLCJidW5kbGUiLCJPYmplY3QiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjs7QUFFQSxNQUFNQyxjQUFjLEdBQUcsS0FBSyxFQUFMLEdBQVUsSUFBakM7O0FBRUEsTUFBTUMsU0FBUyxHQUFHQyxnQkFBT0MsU0FBUCxDQUFpQixRQUFqQixDQUFsQjs7QUFPTyxTQUFTQyxTQUFULENBQW9CQyxJQUFwQixFQUEwQjtBQUFBOztBQUMvQixNQUFJLGtCQUFDQSxJQUFJLENBQUNDLE1BQU4seUNBQUMsYUFBYUMsR0FBZCxLQUFxQixDQUFDRixJQUFJLENBQUNHLGFBQS9CLEVBQThDO0FBQzVDQyxvQkFBSUMsYUFBSixDQUFtQixnRkFBRCxHQUNmLDhEQURIO0FBRUQ7O0FBQ0QsU0FBT0wsSUFBSSxDQUFDQyxNQUFMLENBQVlDLEdBQW5CO0FBQ0Q7O0FBbUJNLFNBQVNJLGlCQUFULENBQTRCQyxNQUE1QixFQUFvQztBQUV6QyxXQUFTQyxRQUFULENBQW1CQyxJQUFuQixFQUF5QjtBQUN2QixVQUFNQyxLQUFLLEdBQUdELElBQUksQ0FBQ0UsS0FBTCxDQUFXLEdBQVgsQ0FBZDtBQUNBLFFBQUlDLEdBQUcsR0FBRyxFQUFWOztBQUNBLFNBQUssTUFBTUMsSUFBWCxJQUFtQkgsS0FBbkIsRUFBMEI7QUFDeEJFLE1BQUFBLEdBQUcsSUFBSUMsSUFBSSxDQUFDQyxNQUFMLENBQVksQ0FBWixFQUFlLENBQWYsRUFBa0JDLFdBQWxCLEtBQWtDRixJQUFJLENBQUNDLE1BQUwsQ0FBWSxDQUFaLENBQXpDO0FBQ0Q7O0FBQ0QsV0FBT0YsR0FBRyxDQUFDRSxNQUFKLENBQVcs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QUFmLEdBQTBDO0FBQzNFLFNBQU8sTUFBTTdFLFNBQVMsQ0FBQyxLQUFLQyxJQUFOLENBQVQsQ0FBcUI2RSxpQkFBckIsRUFBYjtBQUNELENBRkQ7O0FBbUJBbkYsUUFBUSxDQUFDb0YsNkJBQVQsR0FBeUMsZUFBZUYsdUJBQWYsQ0FBd0M1RSxJQUF4QyxFQUE4QztBQUNyRixRQUFNO0FBQUUrRSxJQUFBQTtBQUFGLE1BQWEvRSxJQUFuQjs7QUFDQSxNQUFJLENBQUNvQixnQkFBRUMsUUFBRixDQUFXMEQsTUFBWCxDQUFMLEVBQXlCO0FBQ3ZCM0Usb0JBQUlDLGFBQUosQ0FBbUIscUVBQUQsR0FDZiw0QkFBMkIwRSxNQUFPLEdBRHJDO0FBRUQ7O0FBQ0QsUUFBTTdFLEdBQUcsR0FBR0gsU0FBUyxDQUFDLEtBQUtDLElBQU4sQ0FBckI7QUFDQSxTQUFPLE1BQU1FLEdBQUcsQ0FBQzBFLHVCQUFKLENBQTRCRyxNQUE1QixDQUFiO0FBQ0QsQ0FSRDs7QUFVQUMsTUFBTSxDQUFDQyxNQUFQLENBQWN2RixRQUFkO2VBRWVBLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcblxubGV0IGNvbW1hbmRzID0ge307XG5cbmNvbnN0IFhDVEVTVF9USU1FT1VUID0gNjAgKiA2MCAqIDEwMDA7IC8vIDYwIG1pbnV0ZSB0aW1lb3V0XG5cbmNvbnN0IHhjdGVzdExvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ1hDVGVzdCcpO1xuXG4vKipcbiAqIEFzc2VydHMgdGhhdCBJREIgaXMgcHJlc2VudCBhbmQgdGhhdCBsYXVuY2hXaXRoSURCIHdhcyB1c2VkXG4gKlxuICogQHBhcmFtIHtvYmplY3R9IG9wdHMgT3B0cyBvYmplY3QgZnJvbSB0aGUgZHJpdmVyIGluc3RhbmNlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhc3NlcnRJREIgKG9wdHMpIHtcbiAgaWYgKCFvcHRzLmRldmljZT8uaWRiIHx8ICFvcHRzLmxhdW5jaFdpdGhJREIpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVG8gdXNlIFhDVGVzdCBydW5uZXIsIElEQiAoaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL2lkYikgbXVzdCBiZSBpbnN0YWxsZWQgYCArXG4gICAgICBgYW5kIHNlc3Npb25zIG11c3QgYmUgcnVuIHdpdGggdGhlIFwibGF1bmNoV2l0aElEQlwiIGNhcGFiaWxpdHlgKTtcbiAgfVxuICByZXR1cm4gb3B0cy5kZXZpY2UuaWRiO1xufVxuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gWENUZXN0UmVzdWx0XG4gKlxuICogQHByb3BlcnR5IHtzdHJpbmd9IHRlc3ROYW1lIE5hbWUgb2YgdGhlIHRlc3QgKGUuZy46ICdYQ1Rlc3RlckFwcFVJVGVzdHMgLSBYQ1Rlc3RlckFwcFVJVGVzdHMuWENUZXN0ZXJBcHBVSVRlc3RzL3Rlc3RFeGFtcGxlJylcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGFzc2VkIERpZCB0aGUgdGVzdHMgcGFzcz9cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY3Jhc2hlZCBEaWQgdGhlIHRlc3RzIGNyYXNoP1xuICogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uIEhvdyBsb25nIGRpZCB0aGUgdGVzdHMgdGFrZSAoaW4gc2Vjb25kcylcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBmYWlsdXJlTWVzc2FnZSBGYWlsdXJlIG1lc3NhZ2UgKGlmIGFwcGxpY2FibGUpXG4gKiBAcHJvcGVydHkge251bWJlcn0gbG9jYXRpb24gVGhlIGdlb2xvY2F0aW9uIG9mIHRoZSB0ZXN0cyAoaWYgYXBwbGljYWJsZSlcbiAqL1xuXG4vKipcbiAqIFBhcnNlIHRoZSBzdGRvdXQgb2YgWEMgdGVzdCBsb2dcbiAqIEBwYXJhbSB7c3RyaW5nfSBzdGRvdXQgQSBsaW5lIG9mIHN0YW5kYXJkIG91dCBmcm9tIGBpZGIgeGN0ZXN0IHJ1biAuLi5gXG4gKiBAcmV0dXJucyB7QXJyYXk8WENUZXN0UmVzdWx0Pn0gcmVzdWx0cyBUaGUgZmluYWwgb3V0cHV0IG9mIHRoZSBYQ1Rlc3QgcnVuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVhDVGVzdFN0ZG91dCAoc3Rkb3V0KSB7XG4gIC8vIFBhcnNlcyBhICdrZXknIGludG8gSlNPTiBmb3JtYXRcbiAgZnVuY3Rpb24gcGFyc2VLZXkgKG5hbWUpIHtcbiAgICBjb25zdCB3b3JkcyA9IG5hbWUuc3BsaXQoJyAnKTtcbiAgICBsZXQgb3V0ID0gJyc7XG4gICAgZm9yIChjb25zdCB3b3JkIG9mIHdvcmRzKSB7XG4gICAgICBvdXQgKz0gd29yZC5zdWJzdHIoMCwgMSkudG9VcHBlckNhc2UoKSArIHdvcmQuc3Vic3RyKDEpO1xuICAgIH1cbiAgICByZXR1cm4gb3V0LnN1YnN0cigwLCAxKS50b0xvd2VyQ2FzZSgpICsgb3V0LnN1YnN0cigxKTtcbiAgfVxuXG4gIC8vIFBhcnNlcyBhICd2YWx1ZScgaW50byBKU09OIGZvcm1hdFxuICBmdW5jdGlvbiBwYXJzZVZhbHVlICh2YWx1ZSkge1xuICAgIHZhbHVlID0gdmFsdWUgfHwgJyc7XG4gICAgc3dpdGNoICh2YWx1ZS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICBjYXNlICd0cnVlJzogcmV0dXJuIHRydWU7XG4gICAgICBjYXNlICdmYWxzZSc6IHJldHVybiBmYWxzZTtcbiAgICAgIGNhc2UgJyc6IHJldHVybiBudWxsO1xuICAgICAgZGVmYXVsdDogYnJlYWs7XG4gICAgfVxuICAgIGlmICghaXNOYU4odmFsdWUpKSB7XG4gICAgICBpZiAoIV8uaXNTdHJpbmcodmFsdWUpKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfSBlbHNlIGlmICh2YWx1ZS5pbmRleE9mKCcuJykgPiAwKSB7XG4gICAgICAgIHJldHVybiBwYXJzZUZsb2F0KHZhbHVlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApO1xuICAgIH1cbiAgfVxuICBpZiAoIXN0ZG91dCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIC8vIFBhcnNlIGVhY2ggbGluZSBpbnRvIGFuIGFycmF5XG4gIGNvbnN0IGxpbmVzID0gc3Rkb3V0LnRyaW0oKS5zcGxpdCgnXFxuJyk7XG5cbiAgLy8gT25lIHNpbmdsZSBzdHJpbmcsIGp1c3QgcmV0dXJuIHRoZSBzdHJpbmdcbiAgaWYgKGxpbmVzLmxlbmd0aCA9PT0gMSAmJiAhbGluZXNbMF0uaW5jbHVkZXMoJ3wnKSkge1xuICAgIHJldHVybiBbbGluZXNbMF1dO1xuICB9XG5cbiAgY29uc3QgcmVzdWx0cyA9IFtdO1xuICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcbiAgICAvLyBUaGUgcHJvcGVydGllcyBhcmUgc3BsaXQgdXAgYnkgcGlwZXMgYW5kIGVhY2ggcHJvcGVydHlcbiAgICAvLyBoYXMgdGhlIGZvcm1hdCBcIlNvbWUgS2V5IDogU29tZSBWYWx1ZVwiXG4gICAgY29uc3QgcHJvcGVydGllcyA9IGxpbmUuc3BsaXQoJ3wnKTtcblxuICAgIC8vIFBhcnNlIGVhY2ggcHJvcGVydHlcbiAgICBjb25zdCBvdXRwdXQgPSB7fTtcbiAgICBsZXQgZW50cnlJbmRleCA9IDA7XG4gICAgZm9yIChjb25zdCBwcm9wIG9mIHByb3BlcnRpZXMpIHtcbiAgICAgIGlmIChlbnRyeUluZGV4ID09PSAwKSB7XG4gICAgICAgIC8vIFRoZSBmaXJzdCBwcm9wZXJ0eSBvbmx5IGNvbnRhaW5zIG9uZSBzdHJpbmcgdGhhdCBjb250YWluc1xuICAgICAgICAvLyB0aGUgdGVzdCBuYW1lIChlLmcuOiAnWENUZXN0ZXJBcHBVSVRlc3RzIC0gWENUZXN0ZXJBcHBVSVRlc3RzLlhDVGVzdGVyQXBwVUlUZXN0cy90ZXN0RXhhbXBsZScpXG4gICAgICAgIG91dHB1dC50ZXN0TmFtZSA9IHByb3AudHJpbSgpO1xuICAgICAgfSBlbHNlIHtcblxuICAgICAgICBsZXQgW2tleSwgdmFsdWVdID0gcHJvcC5zcGxpdCgnOicpO1xuICAgICAgICBvdXRwdXRbcGFyc2VLZXkoa2V5LnRyaW0oKSldID0gcGFyc2VWYWx1ZSh2YWx1ZSA/IHZhbHVlLnRyaW0oKSA6ICcnKTtcbiAgICAgIH1cbiAgICAgIGVudHJ5SW5kZXgrKztcbiAgICB9XG4gICAgLy8gQWRkIHRoaXMgbGluZSB0byB0aGUgcmVzdWx0c1xuICAgIHJlc3VsdHMucHVzaChvdXRwdXQpO1xuICB9XG4gIHJldHVybiByZXN1bHRzO1xufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFJ1blhDVUlUZXN0UmVzcG9uc2VcbiAqXG4gKiBAcHJvcGVydHkge0FycmF5PFhDVGVzdFJlc3VsdD59IHJlc3VsdHMgVGhlIHJlc3VsdHMgb2YgYWxsIHRoZSB0ZXN0cyB3aXRoIGluZm9ybWF0aW9uXG4gKiBAcHJvcGVydHkge251bWJlcn0gY29kZSBUaGUgZXhpdCBjb2RlIG9mIHRoZSBwcm9jZXNzXG4gKiBAcHJvcGVydHkge3N0cmluZ30gc2lnbmFsIFRoZSBzaWduYWwgdGhhdCB0ZXJtaW5hdGVkIHRoZSBwcm9jZXNzIChvciBudWxsKSAoZS5nLjogU0lHVEVSTSlcbiAqXG4gKi9cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBSdW5YQ1VJVGVzdE9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgeyFzdHJpbmd9IHRlc3RSdW5uZXJCdW5kbGVJZCBUZXN0IGFwcCBidW5kbGUgKGUuZy46ICdpby5hcHBpdW0uWENUZXN0ZXJBcHBVSVRlc3RzLnhjdHJ1bm5lcicpXG4gKiBAcHJvcGVydHkgeyFzdHJpbmd9IGFwcFVuZGVyVGVzdEJ1bmRsZUlkIEFwcC11bmRlci10ZXN0IGJ1bmRsZVxuICogQHByb3BlcnR5IHshc3RyaW5nfSB4Y1Rlc3RCdW5kbGVJRCB4Y3Rlc3QgYnVuZGxlIGlkXG4gKiBAcHJvcGVydHkge3N0cmluZ30gdGVzdFR5cGUgW3VpXSBYQyB0ZXN0IHR5cGUuICdhcHAnLCAndWknLCBvciAnbG9naWMnXG4gKiBAcHJvcGVydHkge29iamVjdH0gZW52IEVudmlyb25tZW50IHZhcmlhYmxlcyBwYXNzZWQgdG8gdGVzdFxuICogQHByb3BlcnR5IHtBcnJheTxTdHJpbmc+fSBhcmdzIExhdW5jaCBhcmd1bWVudHMgdG8gc3RhcnQgdGhlIHRlc3Qgd2l0aCAoc2VlIGh0dHBzOi8vZGV2ZWxvcGVyLmFwcGxlLmNvbS9kb2N1bWVudGF0aW9uL3hjdGVzdC94Y3VpYXBwbGljYXRpb24vMTUwMDQ3Ny1sYXVuY2hhcmd1bWVudHMgZm9yIHJlZmVyZW5jZSlcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lb3V0IFszNjAwMDBdIFRpbWVvdXQgaWYgc2Vzc2lvbiBkb2Vzbid0IGNvbXBsZXRlIGFmdGVyIGdpdmVuIHRpbWUgKGluIG1pbGxpc2Vjb25kcylcbiAqL1xuXG5cbi8qKlxuICogQHR5cGVkZWYge0Vycm9yfSBYQ1VJVGVzdEVycm9yXG4gKlxuICogQHByb3BlcnR5IHtudW1iZXJ9IGNvZGUgU3VicHJvY2VzcyBleGl0IGNvZGVcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBzaWduYWwgVGhlIHNpZ25hbCAoU0lHKikgdGhhdCBjYXVzZWQgdGhlIHByb2Nlc3MgdG8gZmFpbFxuICogQHByb3BlcnR5IHshQXJyYXk8WENUZXN0UmVzdWx0Pn0gcmVzdWx0cyBUaGUgb3V0cHV0IG9mIHRoZSBmYWlsZWQgdGVzdCAoaWYgdGhlcmUgaXMgb3V0cHV0KVxuICovXG5cbi8qKlxuICogUnVuIGFuIFhDVGVzdC4gTGF1bmNoZXMgYSBzdWJwcm9jZXNzIHRoYXQgcnVucyB0aGUgWEMgVGVzdCBhbmQgYmxvY2tzXG4gKiB1bnRpbCBpdCBpcyBjb21wbGV0ZS4gUGFyc2VzIHRoZSBzdGRvdXQgb2YgdGhlIHByb2Nlc3MgYW5kIHJldHVybnNcbiAqIHJlc3VsdCBhcyBhbiBhcnJheVxuICpcbiAqIFNlZSBodHRwczovL2ZiaWRiLmlvL2RvY3MvdGVzdF9leGVjdXRpb24gZm9yIHJlZmVyZW5jZVxuICpcbiAqIEBwYXJhbSB7UnVuWENVSVRlc3RPcHRpb25zfSBydW5YQ1VJVGVzdE9wdGlvbnNcbiAqIEB0aHJvd3Mge1hDVUlUZXN0RXJyb3J9IEVycm9yIHRocm93biBpZiBzdWJwcm9jZXNzIHJldHVybnMgbm9uLXplcm8gZXhpdCBjb2RlXG4gKiBAcmV0dXJucyB7UnVuWENVSVRlc3RSZXNwb25zZX1cbiAqL1xuY29tbWFuZHMubW9iaWxlUnVuWENUZXN0ID0gYXN5bmMgZnVuY3Rpb24gcnVuWENUZXN0ICh7XG4gIHRlc3RSdW5uZXJCdW5kbGVJZCxcbiAgYXBwVW5kZXJUZXN0QnVuZGxlSWQsXG4gIHhjdGVzdEJ1bmRsZUlkLFxuICB0ZXN0VHlwZSA9ICd1aScsXG4gIGVudixcbiAgYXJncyxcbiAgdGltZW91dCA9IFhDVEVTVF9USU1FT1VULFxufSkge1xuICBjb25zdCBzdWJwcm9jID0gYXdhaXQgYXNzZXJ0SURCKHRoaXMub3B0cykucnVuWENVSVRlc3QoXG4gICAgICAgIHRlc3RSdW5uZXJCdW5kbGVJZCwgYXBwVW5kZXJUZXN0QnVuZGxlSWQsIHhjdGVzdEJ1bmRsZUlkLCB7ZW52LCBhcmdzLCB0ZXN0VHlwZX0sXG4gICk7XG4gIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgbGV0IG1vc3RSZWNlbnRMb2dPYmplY3QgPSBudWxsO1xuICAgIGxldCB4Y3Rlc3RUaW1lb3V0O1xuICAgIGlmICh0aW1lb3V0ID4gMCkge1xuICAgICAgeGN0ZXN0VGltZW91dCA9IHNldFRpbWVvdXQoXG4gICAgICAgICgpID0+IHJlamVjdChgVGltZWQgb3V0IGFmdGVyICcke3RpbWVvdXR9bXMnIHdhaXRpbmcgZm9yIFhDVGVzdCB0byBjb21wbGV0ZWApLFxuICAgICAgICB0aW1lb3V0XG4gICAgICApO1xuICAgIH1cblxuICAgIHN1YnByb2Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKHN0ZG91dCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIG1vc3RSZWNlbnRMb2dPYmplY3QgPSBwYXJzZVhDVGVzdFN0ZG91dChzdGRvdXQpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAvLyBGYWlscyBpZiBsb2cgcGFyc2luZyBmYWlscy5cbiAgICAgICAgICAvLyBUaGlzIGlzIGluIGNhc2UgSURCIGNoYW5nZXMgdGhlIHdheSB0aGF0IGxvZ3MgYXJlIGZvcm1hdHRlZCBhbmRcbiAgICAgICAgICAvLyBpdCBicmVha3MgJ3BhcnNlWENUZXN0U3Rkb3V0Jy4gSWYgdGhhdCBoYXBwZW5zIHdlIHN0aWxsIHdhbnQgdGhlIHByb2Nlc3NcbiAgICAgICAgICAvLyB0byBmaW5pc2hcbiAgICAgICAgICBsb2cud2FybihgRmFpbGVkIHRvIHBhcnNlIGxvZ3MgZnJvbSB0ZXN0IG91dHB1dDogJyR7c3Rkb3V0fSdgKTtcbiAgICAgICAgICBsb2cuZGVidWcoZXJyLnN0YWNrKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgc3Rkb3V0ICYmIHhjdGVzdExvZy5pbmZvKHN0ZG91dCk7XG4gICAgICBzdGRlcnIgJiYgeGN0ZXN0TG9nLmVycm9yKHN0ZGVycik7XG4gICAgfSk7XG5cbiAgICBzdWJwcm9jLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgY2xlYXJUaW1lb3V0KHhjdGVzdFRpbWVvdXQpO1xuICAgICAgaWYgKGNvZGUgIT09IDApIHtcbiAgICAgICAgY29uc3QgZXJyID0gbmV3IEVycm9yKG1vc3RSZWNlbnRMb2dPYmplY3QpO1xuICAgICAgICBlcnIuY29kZSA9IGNvZGU7XG4gICAgICAgIGlmIChzaWduYWwgIT0gbnVsbCkge1xuICAgICAgICAgIGVyci5zaWduYWwgPSBzaWduYWw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1vc3RSZWNlbnRMb2dPYmplY3QpIHtcbiAgICAgICAgICBlcnIucmVzdWx0ID0gbW9zdFJlY2VudExvZ09iamVjdDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgICByZXNvbHZlKHtcbiAgICAgICAgY29kZSwgc2lnbmFsLCByZXN1bHRzOiBtb3N0UmVjZW50TG9nT2JqZWN0LCBwYXNzZWQ6IHRydWUsXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEluc3RhbGxYQ1Rlc3RCdW5kbGVPcHRzXG4gKlxuICogQHByb3BlcnR5IHt4Y3Rlc3RBcHB9IHhjdGVzdEJ1bmRsZSBQYXRoIG9mIHRoZSBYQ1Rlc3QgYXBwIChVUkwgb3IgLmFwcClcbiAqL1xuXG4vKipcbiAqIEluc3RhbGwgYW4gWENUZXN0QnVuZGxlXG4gKlxuICogQHBhcmFtIHtJbnN0YWxsWENUZXN0QnVuZGxlT3B0cyF9IG9wdHMgSW5zdGFsbCB4Y3Rlc3QgYnVuZGxlIG9wdHNcbiAqL1xuY29tbWFuZHMubW9iaWxlSW5zdGFsbFhDVGVzdEJ1bmRsZSA9IGFzeW5jIGZ1bmN0aW9uIGluc3RhbGxYQ1Rlc3RCdW5kbGUgKG9wdHMpIHtcbiAgY29uc3QgeyB4Y3Rlc3RBcHAgfSA9IG9wdHM7XG4gIGlmICghXy5pc1N0cmluZyh4Y3Rlc3RBcHApKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYCd4Y3Rlc3RBcHAnIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyIGZvciAnaW5zdGFsbFhDVGVzdEJ1bmRsZScgYW5kIGAgK1xuICAgICAgYG11c3QgYmUgYSBzdHJpbmcuIEZvdW5kICcke3hjdGVzdEFwcH0nYCk7XG4gIH1cbiAgeGN0ZXN0TG9nLmluZm8oYEluc3RhbGxpbmcgYnVuZGxlICcke3hjdGVzdEFwcH0nYCk7XG4gIGNvbnN0IGlkYiA9IGFzc2VydElEQih0aGlzLm9wdHMpO1xuICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmhlbHBlcnMuY29uZmlndXJlQXBwKHhjdGVzdEFwcCwgJy54Y3Rlc3QnKTtcbiAgYXdhaXQgaWRiLmluc3RhbGxYQ1Rlc3RCdW5kbGUocmVzKTtcbn07XG5cbi8qKlxuICogTGlzdCBYQ1Rlc3QgYnVuZGxlcyB0aGF0IGFyZSBpbnN0YWxsZWQgb24gZGV2aWNlXG4gKlxuICogQHJldHVybnMge0FycmF5PHN0cmluZz59IExpc3Qgb2YgWENUZXN0IGJ1bmRsZXMgKGUuZy46IFwiWENUZXN0ZXJBcHBVSVRlc3RzLlhDVGVzdGVyQXBwVUlUZXN0cy90ZXN0TGF1bmNoUGVyZm9ybWFuY2VcIilcbiAqL1xuY29tbWFuZHMubW9iaWxlTGlzdFhDVGVzdEJ1bmRsZXMgPSBhc3luYyBmdW5jdGlvbiBsaXN0WENUZXN0c0luVGVzdEJ1bmRsZSAoKSB7XG4gIHJldHVybiBhd2FpdCBhc3NlcnRJREIodGhpcy5vcHRzKS5saXN0WENUZXN0QnVuZGxlcygpO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBMaXN0WENUZXN0c09wdHNcbiAqXG4gKiBAcHJvcGVydHkgeyFzdHJpbmd9IGJ1bmRsZSBCdW5kbGUgSUQgb2YgdGhlIFhDVGVzdFxuICovXG5cbi8qKlxuICogTGlzdCBYQ1Rlc3RzIGluIGEgdGVzdCBidW5kbGVcbiAqXG4gKiBAcGFyYW0geyFMaXN0WENUZXN0c09wdHN9IG9wdHMgWENUZXN0IGxpc3Qgb3B0aW9uc1xuICpcbiAqIEByZXR1cm5zIHtBcnJheTxzdHJpbmc+fSBUaGUgbGlzdCBvZiB4Y3Rlc3RzIGluIHRoZSB0ZXN0IGJ1bmRsZVxuICogICAgKGUuZy46IFsgJ1hDVGVzdGVyQXBwVUlUZXN0cy5YQ1Rlc3RlckFwcFVJVGVzdHMvdGVzdEV4YW1wbGUnLFxuICAgICAgICAgICAgICAgICdYQ1Rlc3RlckFwcFVJVGVzdHMuWENUZXN0ZXJBcHBVSVRlc3RzL3Rlc3RMYXVuY2hQZXJmb3JtYW5jZScgXSApXG4gKi9cbmNvbW1hbmRzLm1vYmlsZUxpc3RYQ1Rlc3RzSW5UZXN0QnVuZGxlID0gYXN5bmMgZnVuY3Rpb24gbGlzdFhDVGVzdHNJblRlc3RCdW5kbGUgKG9wdHMpIHtcbiAgY29uc3QgeyBidW5kbGUgfSA9IG9wdHM7XG4gIGlmICghXy5pc1N0cmluZyhidW5kbGUpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYCdidW5kbGUnIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyIGZvciAnbGlzdFhDVGVzdHNJblRlc3RCdW5kbGUnIGFuZCBgICtcbiAgICAgIGBtdXN0IGJlIGEgc3RyaW5nLiBGb3VuZCAnJHtidW5kbGV9J2ApO1xuICB9XG4gIGNvbnN0IGlkYiA9IGFzc2VydElEQih0aGlzLm9wdHMpO1xuICByZXR1cm4gYXdhaXQgaWRiLmxpc3RYQ1Rlc3RzSW5UZXN0QnVuZGxlKGJ1bmRsZSk7XG59O1xuXG5PYmplY3QuYXNzaWduKGNvbW1hbmRzKTtcbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3hjdGVzdC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9

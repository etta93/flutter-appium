"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.helpers = exports.default = void 0;

require("source-map-support/register");

var _baseDriver = require("@appium/base-driver");

var _logger = _interopRequireDefault(require("../logger"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const GET = 'GET';
const POST = 'POST';
const DELETE = 'DELETE';
const SUPPORTED_METHODS = [GET, POST, DELETE];
let helpers = {},
    extensions = {};
exports.helpers = helpers;
const WDA_ROUTES = {
  '/wda/touch/perform': {
    POST: 'performTouch'
  },
  '/wda/touch/multi/perform': {
    POST: 'performMultiAction'
  },
  '/wda/screen': {
    GET: 'getScreenInfo'
  },
  '/wda/alert/buttons': {
    GET: 'getAlertButtons'
  },
  '/wda/apps/launch': {
    POST: 'mobileLaunchApp'
  },
  '/wda/apps/terminate': {
    POST: 'mobileTerminateApp'
  },
  '/wda/apps/activate': {
    POST: 'mobileActivateApp'
  },
  '/wda/apps/state': {
    POST: 'mobileQueryAppState'
  },
  '/wda/keys': {
    POST: 'keys'
  },
  '/wda/touch_id': {
    POST: 'touchId'
  },
  '/wda/keyboard/dismiss': {
    POST: 'hideKeyboard'
  },
  '/wda/lock': {
    POST: 'lock'
  },
  '/wda/unlock': {
    POST: 'unlock'
  },
  '/wda/locked': {
    GET: 'isLocked'
  },
  '/wda/tap/nil': {
    POST: 'clickCoords'
  },
  '/window/size': {
    GET: 'getWindowSize'
  }
};

function wdaRouteToCommandName(endpoint, method) {
  return WDA_ROUTES[endpoint] ? WDA_ROUTES[endpoint][method] : null;
}

helpers.proxyCommand = async function proxyCommand(endpoint, method, body, isSessionCommand = true) {
  if (this.shutdownUnexpectedly) {
    return;
  }

  if (!endpoint) {
    _logger.default.errorAndThrow('Proxying requires an endpoint');
  } else if (!SUPPORTED_METHODS.includes(method)) {
    _logger.default.errorAndThrow(`Proxying only works for the following requests: ${SUPPORTED_METHODS.join(', ')}`);
  }

  if (!this.wda) {
    throw new Error('Cannot call proxyCommand without WDA driver active');
  }

  const proxy = isSessionCommand ? this.wda.jwproxy : this.wda.noSessionProxy;

  if (!proxy) {
    throw new Error('Cannot call proxyCommand without WDA proxy active');
  }

  let cmdName = wdaRouteToCommandName(endpoint, method) || (0, _baseDriver.routeToCommandName)(endpoint, method);

  const timeout = this._getCommandTimeout(cmdName);

  if (!cmdName) {
    cmdName = 'Unknown';

    _logger.default.info(`Proxying to WDA with an unknown route: ${method} ${endpoint}`);
  }

  if (!timeout) {
    return await proxy.command(endpoint, method, body);
  }

  _logger.default.debug(`Setting custom timeout to ${timeout} ms for '${cmdName}' command`);

  let isCommandExpired = false;
  const res = await _bluebird.default.resolve(proxy.command(endpoint, method, body)).timeout(timeout).catch(_bluebird.default.Promise.TimeoutError, () => {
    isCommandExpired = true;
  });

  if (isCommandExpired) {
    proxy.cancelActiveRequests();
    const errMsg = `Appium did not get any response from '${cmdName}' command in ${timeout} ms`;
    await this.startUnexpectedShutdown(new _baseDriver.errors.TimeoutError(errMsg));

    _logger.default.errorAndThrow(errMsg);
  }

  return res;
};

Object.assign(extensions, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9wcm94eS1oZWxwZXIuanMiXSwibmFtZXMiOlsiR0VUIiwiUE9TVCIsIkRFTEVURSIsIlNVUFBPUlRFRF9NRVRIT0RTIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJXREFfUk9VVEVTIiwid2RhUm91dGVUb0NvbW1hbmROYW1lIiwiZW5kcG9pbnQiLCJtZXRob2QiLCJwcm94eUNvbW1hbmQiLCJib2R5IiwiaXNTZXNzaW9uQ29tbWFuZCIsInNodXRkb3duVW5leHBlY3RlZGx5IiwibG9nIiwiZXJyb3JBbmRUaHJvdyIsImluY2x1ZGVzIiwiam9pbiIsIndkYSIsIkVycm9yIiwicHJveHkiLCJqd3Byb3h5Iiwibm9TZXNzaW9uUHJveHkiLCJjbWROYW1lIiwidGltZW91dCIsIl9nZXRDb21tYW5kVGltZW91dCIsImluZm8iLCJjb21tYW5kIiwiZGVidWciLCJpc0NvbW1hbmRFeHBpcmVkIiwicmVzIiwiQiIsInJlc29sdmUiLCJjYXRjaCIsIlByb21pc2UiLCJUaW1lb3V0RXJyb3IiLCJjYW5jZWxBY3RpdmVSZXF1ZXN0cyIsImVyck1zZyIsInN0YXJ0VW5leHBlY3RlZFNodXRkb3duIiwiZXJyb3JzIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLEdBQUcsR0FBRyxLQUFaO0FBQ0EsTUFBTUMsSUFBSSxHQUFHLE1BQWI7QUFDQSxNQUFNQyxNQUFNLEdBQUcsUUFBZjtBQUNBLE1BQU1DLGlCQUFpQixHQUFHLENBQUNILEdBQUQsRUFBTUMsSUFBTixFQUFZQyxNQUFaLENBQTFCO0FBRUEsSUFBSUUsT0FBTyxHQUFHLEVBQWQ7QUFBQSxJQUFrQkMsVUFBVSxHQUFHLEVBQS9COztBQUVBLE1BQU1DLFVBQVUsR0FBRztBQUNqQix3QkFBc0I7QUFDcEJMLElBQUFBLElBQUksRUFBRTtBQURjLEdBREw7QUFJakIsOEJBQTRCO0FBQzFCQSxJQUFBQSxJQUFJLEVB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QUFXLDZCQUE0QkosT0FBUSxZQUFXRCxPQUFRLFdBQWxFOztBQUNBLE1BQUlNLGdCQUFnQixHQUFHLEtBQXZCO0FBQ0EsUUFBTUMsR0FBRyxHQUFHLE1BQU1DLGtCQUFFQyxPQUFGLENBQVVaLEtBQUssQ0FBQ08sT0FBTixDQUFjbkIsUUFBZCxFQUF3QkMsTUFBeEIsRUFBZ0NFLElBQWhDLENBQVYsRUFDSGEsT0FERyxDQUNLQSxPQURMLEVBRUhTLEtBRkcsQ0FFR0Ysa0JBQUVHLE9BQUYsQ0FBVUMsWUFGYixFQUUyQixNQUFNO0FBQ25DTixJQUFBQSxnQkFBZ0IsR0FBRyxJQUFuQjtBQUNELEdBSkcsQ0FBbEI7O0FBS0EsTUFBSUEsZ0JBQUosRUFBc0I7QUFDcEJULElBQUFBLEtBQUssQ0FBQ2dCLG9CQUFOO0FBQ0EsVUFBTUMsTUFBTSxHQUFJLHlDQUF3Q2QsT0FBUSxnQkFBZUMsT0FBUSxLQUF2RjtBQUNBLFVBQU0sS0FBS2MsdUJBQUwsQ0FBNkIsSUFBSUMsbUJBQU9KLFlBQVgsQ0FBd0JFLE1BQXhCLENBQTdCLENBQU47O0FBQ0F2QixvQkFBSUMsYUFBSixDQUFrQnNCLE1BQWxCO0FBQ0Q7O0FBQ0QsU0FBT1AsR0FBUDtBQUNELENBN0NEOztBQStDQVUsTUFBTSxDQUFDQyxNQUFQLENBQWNwQyxVQUFkLEVBQTBCRCxPQUExQjtlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXJyb3JzLCByb3V0ZVRvQ29tbWFuZE5hbWUgfSBmcm9tICdAYXBwaXVtL2Jhc2UtZHJpdmVyJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuXG5jb25zdCBHRVQgPSAnR0VUJztcbmNvbnN0IFBPU1QgPSAnUE9TVCc7XG5jb25zdCBERUxFVEUgPSAnREVMRVRFJztcbmNvbnN0IFNVUFBPUlRFRF9NRVRIT0RTID0gW0dFVCwgUE9TVCwgREVMRVRFXTtcblxubGV0IGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBXREFfUk9VVEVTID0ge1xuICAnL3dkYS90b3VjaC9wZXJmb3JtJzoge1xuICAgIFBPU1Q6ICdwZXJmb3JtVG91Y2gnLFxuICB9LFxuICAnL3dkYS90b3VjaC9tdWx0aS9wZXJmb3JtJzoge1xuICAgIFBPU1Q6ICdwZXJmb3JtTXVsdGlBY3Rpb24nLFxuICB9LFxuICAnL3dkYS9zY3JlZW4nOiB7XG4gICAgR0VUOiAnZ2V0U2NyZWVuSW5mbycsXG4gIH0sXG4gICcvd2RhL2FsZXJ0L2J1dHRvbnMnOiB7XG4gICAgR0VUOiAnZ2V0QWxlcnRCdXR0b25zJyxcbiAgfSxcbiAgJy93ZGEvYXBwcy9sYXVuY2gnOiB7XG4gICAgUE9TVDogJ21vYmlsZUxhdW5jaEFwcCcsXG4gIH0sXG4gICcvd2RhL2FwcHMvdGVybWluYXRlJzoge1xuICAgIFBPU1Q6ICdtb2JpbGVUZXJtaW5hdGVBcHAnLFxuICB9LFxuICAnL3dkYS9hcHBzL2FjdGl2YXRlJzoge1xuICAgIFBPU1Q6ICdtb2JpbGVBY3RpdmF0ZUFwcCcsXG4gIH0sXG4gICcvd2RhL2FwcHMvc3RhdGUnOiB7XG4gICAgUE9TVDogJ21vYmlsZVF1ZXJ5QXBwU3RhdGUnLFxuICB9LFxuICAnL3dkYS9rZXlzJzoge1xuICAgIFBPU1Q6ICdrZXlzJyxcbiAgfSxcbiAgJy93ZGEvdG91Y2hfaWQnOiB7XG4gICAgUE9TVDogJ3RvdWNoSWQnLFxuICB9LFxuICAnL3dkYS9rZXlib2FyZC9kaXNtaXNzJzoge1xuICAgIFBPU1Q6ICdoaWRlS2V5Ym9hcmQnLFxuICB9LFxuICAnL3dkYS9sb2NrJzoge1xuICAgIFBPU1Q6ICdsb2NrJyxcbiAgfSxcbiAgJy93ZGEvdW5sb2NrJzoge1xuICAgIFBPU1Q6ICd1bmxvY2snLFxuICB9LFxuICAnL3dkYS9sb2NrZWQnOiB7XG4gICAgR0VUOiAnaXNMb2NrZWQnLFxuICB9LFxuICAnL3dkYS90YXAvbmlsJzoge1xuICAgIFBPU1Q6ICdjbGlja0Nvb3JkcycsXG4gIH0sXG4gICcvd2luZG93L3NpemUnOiB7XG4gICAgR0VUOiAnZ2V0V2luZG93U2l6ZScsXG4gIH0sXG59O1xuXG5mdW5jdGlvbiB3ZGFSb3V0ZVRvQ29tbWFuZE5hbWUgKGVuZHBvaW50LCBtZXRob2QpIHtcbiAgcmV0dXJuIFdEQV9ST1VURVNbZW5kcG9pbnRdID8gV0RBX1JPVVRFU1tlbmRwb2ludF1bbWV0aG9kXSA6IG51bGw7XG59XG5cbmhlbHBlcnMucHJveHlDb21tYW5kID0gYXN5bmMgZnVuY3Rpb24gcHJveHlDb21tYW5kIChlbmRwb2ludCwgbWV0aG9kLCBib2R5LCBpc1Nlc3Npb25Db21tYW5kID0gdHJ1ZSkge1xuICBpZiAodGhpcy5zaHV0ZG93blVuZXhwZWN0ZWRseSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICghZW5kcG9pbnQpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdygnUHJveHlpbmcgcmVxdWlyZXMgYW4gZW5kcG9pbnQnKTtcbiAgfSBlbHNlIGlmICghU1VQUE9SVEVEX01FVEhPRFMuaW5jbHVkZXMobWV0aG9kKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBQcm94eWluZyBvbmx5IHdvcmtzIGZvciB0aGUgZm9sbG93aW5nIHJlcXVlc3RzOiAke1NVUFBPUlRFRF9NRVRIT0RTLmpvaW4oJywgJyl9YCk7XG4gIH1cblxuICBpZiAoIXRoaXMud2RhKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgY2FsbCBwcm94eUNvbW1hbmQgd2l0aG91dCBXREEgZHJpdmVyIGFjdGl2ZScpO1xuICB9XG4gIGNvbnN0IHByb3h5ID0gaXNTZXNzaW9uQ29tbWFuZCA/IHRoaXMud2RhLmp3cHJveHkgOiB0aGlzLndkYS5ub1Nlc3Npb25Qcm94eTtcbiAgaWYgKCFwcm94eSkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNhbGwgcHJveHlDb21tYW5kIHdpdGhvdXQgV0RBIHByb3h5IGFjdGl2ZScpO1xuICB9XG5cbiAgbGV0IGNtZE5hbWUgPSB3ZGFSb3V0ZVRvQ29tbWFuZE5hbWUoZW5kcG9pbnQsIG1ldGhvZCkgfHwgcm91dGVUb0NvbW1hbmROYW1lKGVuZHBvaW50LCBtZXRob2QpO1xuICBjb25zdCB0aW1lb3V0ID0gdGhpcy5fZ2V0Q29tbWFuZFRpbWVvdXQoY21kTmFtZSk7XG4gIGlmICghY21kTmFtZSkge1xuICAgIC8vIHRoaXMgc2hvdWxkIG5ldmVyIGhhcHBlbiBleGNlcHQgd2hlbiBhZGRpbmcgbmV3IHJvdXRlc1xuICAgIGNtZE5hbWUgPSAnVW5rbm93bic7IC8vIGp1c3QgZm9yIGxvZ2dpbmcgcHVycG9zZXMgYmVsb3dcbiAgICBsb2cuaW5mbyhgUHJveHlpbmcgdG8gV0RBIHdpdGggYW4gdW5rbm93biByb3V0ZTogJHttZXRob2R9ICR7ZW5kcG9pbnR9YCk7XG4gIH1cblxuICBpZiAoIXRpbWVvdXQpIHtcbiAgICByZXR1cm4gYXdhaXQgcHJveHkuY29tbWFuZChlbmRwb2ludCwgbWV0aG9kLCBib2R5KTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZyhgU2V0dGluZyBjdXN0b20gdGltZW91dCB0byAke3RpbWVvdXR9IG1zIGZvciAnJHtjbWROYW1lfScgY29tbWFuZGApO1xuICBsZXQgaXNDb21tYW5kRXhwaXJlZCA9IGZhbHNlO1xuICBjb25zdCByZXMgPSBhd2FpdCBCLnJlc29sdmUocHJveHkuY29tbWFuZChlbmRwb2ludCwgbWV0aG9kLCBib2R5KSlcbiAgICAgICAgICAgICAgICAudGltZW91dCh0aW1lb3V0KVxuICAgICAgICAgICAgICAgIC5jYXRjaChCLlByb21pc2UuVGltZW91dEVycm9yLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpc0NvbW1hbmRFeHBpcmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgaWYgKGlzQ29tbWFuZEV4cGlyZWQpIHtcbiAgICBwcm94eS5jYW5jZWxBY3RpdmVSZXF1ZXN0cygpO1xuICAgIGNvbnN0IGVyck1zZyA9IGBBcHBpdW0gZGlkIG5vdCBnZXQgYW55IHJlc3BvbnNlIGZyb20gJyR7Y21kTmFtZX0nIGNvbW1hbmQgaW4gJHt0aW1lb3V0fSBtc2A7XG4gICAgYXdhaXQgdGhpcy5zdGFydFVuZXhwZWN0ZWRTaHV0ZG93bihuZXcgZXJyb3JzLlRpbWVvdXRFcnJvcihlcnJNc2cpKTtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhlcnJNc2cpO1xuICB9XG4gIHJldHVybiByZXM7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3Byb3h5LWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9

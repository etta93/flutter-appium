"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _baseDriver = require("@appium/base-driver");

var _iosCrashLog = require("../device-log/ios-crash-log");

var _iosSimulatorLog = require("../device-log/ios-simulator-log");

var _iosDeviceLog = require("../device-log/ios-device-log");

var _logger = _interopRequireDefault(require("../logger"));

var _ws = _interopRequireDefault(require("ws"));

var _safariConsoleLog = _interopRequireDefault(require("../device-log/safari-console-log"));

var _safariNetworkLog = _interopRequireDefault(require("../device-log/safari-network-log"));

const extensions = {};

const WEBSOCKET_ENDPOINT = sessionId => `${_baseDriver.DEFAULT_WS_PATHNAME_PREFIX}/session/${sessionId}/appium/device/syslog`;

const GET_SERVER_LOGS_FEATURE = 'get_server_logs';

extensions.extractLogs = async function extractLogs(logType, logsContainer = {}) {
  if (_lodash.default.isEmpty(logsContainer)) {
    throw new Error('No logs currently available. Is the device/simulator started?');
  }

  const logObject = logsContainer[logType];
  const logs = logObject ? await logObject.getLogs() : null;

  if (logs) {
    return logs;
  }

  throw new Error(`No logs of type '${logType}' found.`);
};

extensions.supportedLogTypes = {
  syslog: {
    description: 'System Logs - Device logs for iOS applications on real devices and simulators',
    getter: async self => await self.extractLogs('syslog', self.logs)
  },
  crashlog: {
    description: 'Crash Logs - Crash reports for iOS applications on real devices and simulators',
    getter: async self => await self.extractLogs('crashlog', self.logs)
  },
  performance: {
    description: 'Performance Logs - Debug Timelines on real devices and simulators',
    getter: async self => await self.extractLogs('performance', self.logs)
  },
  safariConsole: {
    description: 'Safari Console Logs - data written to the JS console in Safari',
    getter: async self => await self.extractLogs('safariConsole', self.logs)
  },
  safariNetwork: {
    description: 'Safari Network Logs - information about network operations undertaken by Safari',
    getter: async self => await self.extractLogs('safariNetwork', self.logs)
  },
  server: {
    description: 'Appium server logs',
    getter: self => {
      self.ensureFeatureEnabled(GET_SERVER_LOGS_FEATURE);
      return _logger.default.unwrap().record.map(function (x) {
        return {
          timestamp: Date.now(),
          level: 'ALL',
          message: _lodash.default.isEmpty(x.prefix) ? x.message : `[${x.prefix}] ${x.message}`
        };
      });
    }
  }
};

extensions.startLogCapture = async function startLogCapture() {
  this.logs = this.logs || {};

  if (!_lodash.default.isUndefined(this.logs.syslog) && this.logs.syslog.isCapturing) {
    _logger.default.warn('Trying to start iOS log capture but it has already started!');

    return true;
  }

  if (_lodash.default.isUndefined(this.logs.syslog)) {
    this.logs.crashlog = new _iosCrashLog.IOSCrashLog({
      sim: this.opts.device,
      udid: this.isRealDevice() ? this.opts.udid : undefined
    });

    if (this.isRealDevice()) {
      this.logs.syslog = new _iosDeviceLog.IOSDeviceLog({
        udid: this.opts.udid,
        showLogs: this.opts.showIOSLog
      });
    } else {
      this.logs.syslog = new _iosSimulatorLog.IOSSimulatorLog({
        sim: this.opts.device,
        showLogs: this.opts.showIOSLog,
        xcodeVersion: this.xcodeVersion,
        iosSimulatorLogsPredicate: this.opts.iosSimulatorLogsPredicate
      });
    }

    this.logs.safariConsole = new _safariConsoleLog.default(!!this.opts.showSafariConsoleLog);
    this.logs.safariNetwork = new _safariNetworkLog.default(!!this.opts.showSafariNetworkLog);
  }

  try {
    await this.logs.syslog.startCapture();
  } catch (err) {
    _logger.default.warn(`Continuing without capturing device logs: ${err.message}`);

    return false;
  }

  await this.logs.crashlog.startCapture();
  await this.logs.safariConsole.startCapture();
  await this.logs.safariNetwork.startCapture();
  return true;
};

extensions.mobileStartLogsBroadcast = async function mobileStartLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (!_lodash.default.isEmpty(await this.server.getWebSocketHandlers(pathname))) {
    _logger.default.debug(`The system logs broadcasting web socket server is already listening at ${pathname}`);

    return;
  }

  _logger.default.info(`Assigning system logs broadcasting web socket server to ${pathname}`);

  const wss = new _ws.default.Server({
    noServer: true
  });
  wss.on('connection', (ws, req) => {
    if (req) {
      var _req$connection;

      const remoteIp = _lodash.default.isEmpty(req.headers['x-forwarded-for']) ? (_req$connection = req.connection) === null || _req$connection === void 0 ? void 0 : _req$connection.remoteAddress : req.headers['x-forwarded-for'];

      _logger.default.debug(`Established a new system logs listener web socket connection from ${remoteIp}`);
    } else {
      _logger.default.debug('Established a new system logs listener web socket connection');
    }

    if (_lodash.default.isEmpty(this._syslogWebsocketListener)) {
      this._syslogWebsocketListener = logRecord => {
        if ((ws === null || ws === void 0 ? void 0 : ws.readyState) === _ws.default.OPEN) {
          ws.send(logRecord.message);
        }
      };
    }

    this.logs.syslog.on('output', this._syslogWebsocketListener);
    ws.on('close', (code, reason) => {
      if (!_lodash.default.isEmpty(this._syslogWebsocketListener)) {
        this.logs.syslog.removeListener('output', this._syslogWebsocketListener);
        this._syslogWebsocketListener = null;
      }

      let closeMsg = 'System logs listener web socket is closed.';

      if (!_lodash.default.isEmpty(code)) {
        closeMsg += ` Code: ${code}.`;
      }

      if (!_lodash.default.isEmpty(reason)) {
        closeMsg += ` Reason: ${reason.toString()}.`;
      }

      _logger.default.debug(closeMsg);
    });
  });
  await this.server.addWebSocketHandler(pathname, wss);
};

extensions.mobileStopLogsBroadcast = async function mobileStopLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (_lodash.default.isEmpty(await this.server.getWebSocketHandlers(pathname))) {
    return;
  }

  _logger.default.debug('Stopping the system logs broadcasting web socket server');

  await this.server.removeWebSocketHandler(pathname);
};

var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sb2cuanMiXSwibmFtZXMiOlsiZXh0ZW5zaW9ucyIsIldFQlNPQ0tFVF9FTkRQT0lOVCIsInNlc3Npb25JZCIsIkRFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIiwiR0VUX1NFUlZFUl9MT0dTX0ZFQVRVUkUiLCJleHRyYWN0TG9ncyIsImxvZ1R5cGUiLCJsb2dzQ29udGFpbmVyIiwiXyIsImlzRW1wdHkiLCJFcnJvciIsImxvZ09iamVjdCIsImxvZ3MiLCJnZXRMb2dzIiwic3VwcG9ydGVkTG9nVHlwZXMiLCJzeXNsb2ciLCJkZXNjcmlwdGlvbiIsImdldHRlciIsInNlbGYiLCJjcmFzaGxvZyIsInBlcmZvcm1hbmNlIiwic2FmYXJpQ29uc29sZSIsInNhZmFyaU5ldHdvcmsiLCJzZXJ2ZXIiLCJlbnN1cmVGZWF0dXJlRW5hYmxlZCIsImxvZyIsInVud3JhcCIsInJlY29yZCIsIm1hcCIsIngiLCJ0aW1lc3RhbXAiLCJEYXRlIiwibm93IiwibGV2ZWwiLCJtZXNzYWdlIiwicHJlZml4Iiwic3RhcnRMb2dDYXB0dXJlIiwiaXNVbmRlZmluZWQiLCJpc0NhcHR1cmluZyIsIndhcm4iLCJJT1NDcmFzaExvZyIsInNpbSIsIm9wdHMiLCJkZXZpY2UiLCJ1ZGlkIiwiaXNSZWFsRGV2aWNlIiwidW5kZWZpbmVkIiwiSU9TRGV2aWNlTG9nIiwic2hvd0xvZ3MiLCJzaG93SU9TTG9nIiwiSU9TU2ltdWxhdG9yTG9nIiwieGNvZGVWZXJzaW9uIiwiaW9zU2ltdWxhdG9yTG9nc1ByZWRpY2F0ZSIsIlNhZmFyaUNvbnNvbGVMb2ciLCJzaG93U2FmYXJpQ29uc29sZUxvZyIsIlNhZmFyaU5ldHdvcmtMb2ciLCJzaG93U2FmYXJpTmV0d29ya0xvZyIsInN0YXJ0Q2FwdHVyZSIsImVyciIsIm1vYmlsZVN0YXJ0TG9nc0Jyb2FkY2FzdCIsInBhdGhuYW1lIiwiZ2V0V2ViU29ja2V0SGFuZGxlcnMiLCJkZWJ1ZyIsImluZm8iLCJ3c3MiLCJXZWJTb2NrZXQiLCJTZXJ2ZXIiLCJub1NlcnZlciIsIm9uIiwid3MiLCJyZXEiLCJyZW1vdGVJcCIsImhlYWRlcnMiLCJjb25uZWN0aW9uIiwicmVtb3RlQWRkcmVzcyIsIl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lciIsImxvZ1JlY29yZCIsInJlYWR5U3RhdGUiLCJPUEVOIiwic2VuZCIsImNvZGUiLCJyZWFzb24iLCJyZW1vdmVMaXN0ZW5lciIsImNsb3NlTXNnIiwidG9TdHJpbmciLCJhZGRXZWJTb2NrZXRIYW5kbGVyIiwibW9iaWxlU3RvcExvZ3NCcm9hZGNhc3QiLCJyZW1vdmVXZWJTb2NrZXRIYW5kbGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLFVBQVUsR0FBRyxFQUFuQjs7QUFFQSxNQUFNQyxrQkFBa0IsR0FBSUMsU0FBRCxJQUFnQixHQUFFQyxzQ0FBMkIsWUFBV0QsU0FBVSx1QkFBN0Y7O0FBQ0EsTUFBTUUsdUJBQXVCLEdBQUcsaUJBQWhDOztBQUVBSixVQUFVLENBQUNLLFdBQVgsR0FBeUIsZUFBZUEsV0FBZixDQUE0QkMsT0FBNUIsRUFBcUNDLGFBQWEsR0FBRyxFQUFyRCxFQUF5RDtBQUdoRixNQUFJQyxnQkFBRUMsT0FBRixDQUFVRixhQUFWLENBQUosRUFBOEI7QUFDNUIsVUFBTSxJQUFJRyxLQUFKLENBQVUsK0RBQVYsQ0FBTjtBQUNEOztBQUdELFFBQU1DLFNBQVMsR0FBR0osYUFBYSxDQUFDRCxPQUFELENBQS9CO0FBQ0EsUUFBTU0sSUFBSSxHQUFHRCxTQUFTLEdBQUcsTUFBTUEsU0FBUyxDQUFDRSxPQUFWLEVBQVQsR0FBK0IsSUFBckQ7O0FBQ0EsTUFBSUQsSUFBSixFQUFVO0FBQ1IsV0FBT0EsSUFBUDtBQUNEOztBQUNELFFBQU0sSUFBSUYsS0FBSixDQUFXLG9CQUFtQkosT0FBUSxVQUF0QyxDQUFOO0FBQ0QsQ0FkRDs7QUFnQkFOLFVBQVUsQ0FBQ2MsaUJB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LFFBQU0xQixRQUFRLEdBQUczRCxrQkFBa0IsQ0FBQyxLQUFLQyxTQUFOLENBQW5DOztBQUNBLE1BQUlNLGdCQUFFQyxPQUFGLENBQVUsTUFBTSxLQUFLYyxNQUFMLENBQVlzQyxvQkFBWixDQUFpQ0QsUUFBakMsQ0FBaEIsQ0FBSixFQUFpRTtBQUMvRDtBQUNEOztBQUVEbkMsa0JBQUlxQyxLQUFKLENBQVUseURBQVY7O0FBQ0EsUUFBTSxLQUFLdkMsTUFBTCxDQUFZZ0Usc0JBQVosQ0FBbUMzQixRQUFuQyxDQUFOO0FBQ0QsQ0FSRDs7ZUFXZTVELFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgREVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVggfSBmcm9tICdAYXBwaXVtL2Jhc2UtZHJpdmVyJztcbmltcG9ydCB7IElPU0NyYXNoTG9nIH0gZnJvbSAnLi4vZGV2aWNlLWxvZy9pb3MtY3Jhc2gtbG9nJztcbmltcG9ydCB7IElPU1NpbXVsYXRvckxvZyB9IGZyb20gJy4uL2RldmljZS1sb2cvaW9zLXNpbXVsYXRvci1sb2cnO1xuaW1wb3J0IHsgSU9TRGV2aWNlTG9nIH0gZnJvbSAnLi4vZGV2aWNlLWxvZy9pb3MtZGV2aWNlLWxvZyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcbmltcG9ydCBTYWZhcmlDb25zb2xlTG9nIGZyb20gJy4uL2RldmljZS1sb2cvc2FmYXJpLWNvbnNvbGUtbG9nJztcbmltcG9ydCBTYWZhcmlOZXR3b3JrTG9nIGZyb20gJy4uL2RldmljZS1sb2cvc2FmYXJpLW5ldHdvcmstbG9nJztcblxuXG5jb25zdCBleHRlbnNpb25zID0ge307XG5cbmNvbnN0IFdFQlNPQ0tFVF9FTkRQT0lOVCA9IChzZXNzaW9uSWQpID0+IGAke0RFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYfS9zZXNzaW9uLyR7c2Vzc2lvbklkfS9hcHBpdW0vZGV2aWNlL3N5c2xvZ2A7XG5jb25zdCBHRVRfU0VSVkVSX0xPR1NfRkVBVFVSRSA9ICdnZXRfc2VydmVyX2xvZ3MnO1xuXG5leHRlbnNpb25zLmV4dHJhY3RMb2dzID0gYXN5bmMgZnVuY3Rpb24gZXh0cmFjdExvZ3MgKGxvZ1R5cGUsIGxvZ3NDb250YWluZXIgPSB7fSkge1xuICAvLyBtYWtlIHN1cmUgdGhhdCB3ZSBoYXZlIGxvZ3MgYXQgYWxsXG4gIC8vIG90aGVyd2lzZSBpdCdzIG5vdCBiZWVuIGluaXRpYWxpemVkXG4gIGlmIChfLmlzRW1wdHkobG9nc0NvbnRhaW5lcikpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGxvZ3MgY3VycmVudGx5IGF2YWlsYWJsZS4gSXMgdGhlIGRldmljZS9zaW11bGF0b3Igc3RhcnRlZD8nKTtcbiAgfVxuXG4gIC8vIElmIGxvZ3MgY2FwdHVyZWQgc3VjY2Vzc2Z1bGx5IHNlbmQgcmVzcG9uc2Ugd2l0aCBkYXRhLCBlbHNlIHNlbmQgZXJyb3JcbiAgY29uc3QgbG9nT2JqZWN0ID0gbG9nc0NvbnRhaW5lcltsb2dUeXBlXTtcbiAgY29uc3QgbG9ncyA9IGxvZ09iamVjdCA/IGF3YWl0IGxvZ09iamVjdC5nZXRMb2dzKCkgOiBudWxsO1xuICBpZiAobG9ncykge1xuICAgIHJldHVybiBsb2dzO1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihgTm8gbG9ncyBvZiB0eXBlICcke2xvZ1R5cGV9JyBmb3VuZC5gKTtcbn07XG5cbmV4dGVuc2lvbnMuc3VwcG9ydGVkTG9nVHlwZXMgPSB7XG4gIHN5c2xvZzoge1xuICAgIGRlc2NyaXB0aW9uOiAnU3lzdGVtIExvZ3MgLSBEZXZpY2UgbG9ncyBmb3IgaU9TIGFwcGxpY2F0aW9ucyBvbiByZWFsIGRldmljZXMgYW5kIHNpbXVsYXRvcnMnLFxuICAgIGdldHRlcjogYXN5bmMgKHNlbGYpID0+IGF3YWl0IHNlbGYuZXh0cmFjdExvZ3MoJ3N5c2xvZycsIHNlbGYubG9ncyksXG4gIH0sXG4gIGNyYXNobG9nOiB7XG4gICAgZGVzY3JpcHRpb246ICdDcmFzaCBMb2dzIC0gQ3Jhc2ggcmVwb3J0cyBmb3IgaU9TIGFwcGxpY2F0aW9ucyBvbiByZWFsIGRldmljZXMgYW5kIHNpbXVsYXRvcnMnLFxuICAgIGdldHRlcjogYXN5bmMgKHNlbGYpID0+IGF3YWl0IHNlbGYuZXh0cmFjdExvZ3MoJ2NyYXNobG9nJywgc2VsZi5sb2dzKSxcbiAgfSxcbiAgcGVyZm9ybWFuY2U6IHtcbiAgICBkZXNjcmlwdGlvbjogJ1BlcmZvcm1hbmNlIExvZ3MgLSBEZWJ1ZyBUaW1lbGluZXMgb24gcmVhbCBkZXZpY2VzIGFuZCBzaW11bGF0b3JzJyxcbiAgICBnZXR0ZXI6IGFzeW5jIChzZWxmKSA9PiBhd2FpdCBzZWxmLmV4dHJhY3RMb2dzKCdwZXJmb3JtYW5jZScsIHNlbGYubG9ncyksXG4gIH0sXG4gIHNhZmFyaUNvbnNvbGU6IHtcbiAgICBkZXNjcmlwdGlvbjogJ1NhZmFyaSBDb25zb2xlIExvZ3MgLSBkYXRhIHdyaXR0ZW4gdG8gdGhlIEpTIGNvbnNvbGUgaW4gU2FmYXJpJyxcbiAgICBnZXR0ZXI6IGFzeW5jIChzZWxmKSA9PiBhd2FpdCBzZWxmLmV4dHJhY3RMb2dzKCdzYWZhcmlDb25zb2xlJywgc2VsZi5sb2dzKSxcbiAgfSxcbiAgc2FmYXJpTmV0d29yazoge1xuICAgIGRlc2NyaXB0aW9uOiAnU2FmYXJpIE5ldHdvcmsgTG9ncyAtIGluZm9ybWF0aW9uIGFib3V0IG5ldHdvcmsgb3BlcmF0aW9ucyB1bmRlcnRha2VuIGJ5IFNhZmFyaScsXG4gICAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4gYXdhaXQgc2VsZi5leHRyYWN0TG9ncygnc2FmYXJpTmV0d29yaycsIHNlbGYubG9ncyksXG4gIH0sXG4gIHNlcnZlcjoge1xuICAgIGRlc2NyaXB0aW9uOiAnQXBwaXVtIHNlcnZlciBsb2dzJyxcbiAgICBnZXR0ZXI6IChzZWxmKSA9PiB7XG4gICAgICBzZWxmLmVuc3VyZUZlYXR1cmVFbmFibGVkKEdFVF9TRVJWRVJfTE9HU19GRUFUVVJFKTtcbiAgICAgIHJldHVybiBsb2cudW53cmFwKCkucmVjb3JkXG4gICAgICAgIC5tYXAoZnVuY3Rpb24gKHgpIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLy8gbnBtbG9nIGRvZXMgbm90IGtlZXAgdGltZXN0YW1wcyBpbiB0aGUgaGlzdG9yeVxuICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgbGV2ZWw6ICdBTEwnLFxuICAgICAgICAgICAgbWVzc2FnZTogXy5pc0VtcHR5KHgucHJlZml4KSA/IHgubWVzc2FnZSA6IGBbJHt4LnByZWZpeH1dICR7eC5tZXNzYWdlfWAsXG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgfSxcbn07XG5cbmV4dGVuc2lvbnMuc3RhcnRMb2dDYXB0dXJlID0gYXN5bmMgZnVuY3Rpb24gc3RhcnRMb2dDYXB0dXJlICgpIHtcbiAgdGhpcy5sb2dzID0gdGhpcy5sb2dzIHx8IHt9O1xuICBpZiAoIV8uaXNVbmRlZmluZWQodGhpcy5sb2dzLnN5c2xvZykgJiYgdGhpcy5sb2dzLnN5c2xvZy5pc0NhcHR1cmluZykge1xuICAgIGxvZy53YXJuKCdUcnlpbmcgdG8gc3RhcnQgaU9TIGxvZyBjYXB0dXJlIGJ1dCBpdCBoYXMgYWxyZWFkeSBzdGFydGVkIScpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIGlmIChfLmlzVW5kZWZpbmVkKHRoaXMubG9ncy5zeXNsb2cpKSB7XG4gICAgdGhpcy5sb2dzLmNyYXNobG9nID0gbmV3IElPU0NyYXNoTG9nKHtcbiAgICAgIHNpbTogdGhpcy5vcHRzLmRldmljZSxcbiAgICAgIHVkaWQ6IHRoaXMuaXNSZWFsRGV2aWNlKCkgPyB0aGlzLm9wdHMudWRpZCA6IHVuZGVmaW5lZCxcbiAgICB9KTtcblxuICAgIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICB0aGlzLmxvZ3Muc3lzbG9nID0gbmV3IElPU0RldmljZUxvZyh7XG4gICAgICAgIHVkaWQ6IHRoaXMub3B0cy51ZGlkLFxuICAgICAgICBzaG93TG9nczogdGhpcy5vcHRzLnNob3dJT1NMb2csXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2dzLnN5c2xvZyA9IG5ldyBJT1NTaW11bGF0b3JMb2coe1xuICAgICAgICBzaW06IHRoaXMub3B0cy5kZXZpY2UsXG4gICAgICAgIHNob3dMb2dzOiB0aGlzLm9wdHMuc2hvd0lPU0xvZyxcbiAgICAgICAgeGNvZGVWZXJzaW9uOiB0aGlzLnhjb2RlVmVyc2lvbixcbiAgICAgICAgaW9zU2ltdWxhdG9yTG9nc1ByZWRpY2F0ZTogdGhpcy5vcHRzLmlvc1NpbXVsYXRvckxvZ3NQcmVkaWNhdGUsXG4gICAgICB9KTtcbiAgICB9XG4gICAgdGhpcy5sb2dzLnNhZmFyaUNvbnNvbGUgPSBuZXcgU2FmYXJpQ29uc29sZUxvZyghIXRoaXMub3B0cy5zaG93U2FmYXJpQ29uc29sZUxvZyk7XG4gICAgdGhpcy5sb2dzLnNhZmFyaU5ldHdvcmsgPSBuZXcgU2FmYXJpTmV0d29ya0xvZyghIXRoaXMub3B0cy5zaG93U2FmYXJpTmV0d29ya0xvZyk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmxvZ3Muc3lzbG9nLnN0YXJ0Q2FwdHVyZSgpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgQ29udGludWluZyB3aXRob3V0IGNhcHR1cmluZyBkZXZpY2UgbG9nczogJHtlcnIubWVzc2FnZX1gKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgYXdhaXQgdGhpcy5sb2dzLmNyYXNobG9nLnN0YXJ0Q2FwdHVyZSgpO1xuICBhd2FpdCB0aGlzLmxvZ3Muc2FmYXJpQ29uc29sZS5zdGFydENhcHR1cmUoKTtcbiAgYXdhaXQgdGhpcy5sb2dzLnNhZmFyaU5ldHdvcmsuc3RhcnRDYXB0dXJlKCk7XG5cbiAgcmV0dXJuIHRydWU7XG59O1xuXG4vKipcbiAqIFN0YXJ0cyBpT1Mgc3lzdGVtIGxvZ3MgYnJvYWRjYXN0IHdlYnNvY2tldCBvbiB0aGUgc2FtZSBob3N0IGFuZCBwb3J0XG4gKiB3aGVyZSBBcHBpdW0gc2VydmVyIGlzIHJ1bm5pbmcgYXQgYC93cy9zZXNzaW9uLzpzZXNzaW9uSWQ6L2FwcGl1bS9zeXNsb2dgIGVuZHBvaW50LiBUaGUgbWV0aG9kXG4gKiB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiB0aGUgd2ViIHNvY2tldCBpcyBhbHJlYWR5IGxpc3RlbmluZy5cbiAqXG4gKiBFYWNoIGNvbm5lY3RlZCB3ZWJjb2tldCBsaXN0ZW5lciB3aWxsIHJlY2VpdmUgc3lzbG9nIGxpbmVzXG4gKiBhcyBzb29uIGFzIHRoZXkgYXJlIHZpc2libGUgdG8gQXBwaXVtLlxuICovXG5leHRlbnNpb25zLm1vYmlsZVN0YXJ0TG9nc0Jyb2FkY2FzdCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVN0YXJ0TG9nc0Jyb2FkY2FzdCAoKSB7XG4gIGNvbnN0IHBhdGhuYW1lID0gV0VCU09DS0VUX0VORFBPSU5UKHRoaXMuc2Vzc2lvbklkKTtcbiAgaWYgKCFfLmlzRW1wdHkoYXdhaXQgdGhpcy5zZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMocGF0aG5hbWUpKSkge1xuICAgIGxvZy5kZWJ1ZyhgVGhlIHN5c3RlbSBsb2dzIGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlciBpcyBhbHJlYWR5IGxpc3RlbmluZyBhdCAke3BhdGhuYW1lfWApO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZy5pbmZvKGBBc3NpZ25pbmcgc3lzdGVtIGxvZ3MgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyIHRvICR7cGF0aG5hbWV9YCk7XG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS93ZWJzb2NrZXRzL3dzL2Jsb2IvbWFzdGVyL2RvYy93cy5tZFxuICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7XG4gICAgbm9TZXJ2ZXI6IHRydWUsXG4gIH0pO1xuICB3c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3MsIHJlcSkgPT4ge1xuICAgIGlmIChyZXEpIHtcbiAgICAgIGNvbnN0IHJlbW90ZUlwID0gXy5pc0VtcHR5KHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXSlcbiAgICAgICAgPyByZXEuY29ubmVjdGlvbj8ucmVtb3RlQWRkcmVzc1xuICAgICAgICA6IHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXTtcbiAgICAgIGxvZy5kZWJ1ZyhgRXN0YWJsaXNoZWQgYSBuZXcgc3lzdGVtIGxvZ3MgbGlzdGVuZXIgd2ViIHNvY2tldCBjb25uZWN0aW9uIGZyb20gJHtyZW1vdGVJcH1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKCdFc3RhYmxpc2hlZCBhIG5ldyBzeXN0ZW0gbG9ncyBsaXN0ZW5lciB3ZWIgc29ja2V0IGNvbm5lY3Rpb24nKTtcbiAgICB9XG5cbiAgICBpZiAoXy5pc0VtcHR5KHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyKSkge1xuICAgICAgdGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIgPSAobG9nUmVjb3JkKSA9PiB7XG4gICAgICAgIGlmICh3cz8ucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHtcbiAgICAgICAgICB3cy5zZW5kKGxvZ1JlY29yZC5tZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gICAgdGhpcy5sb2dzLnN5c2xvZy5vbignb3V0cHV0JywgdGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIpO1xuXG4gICAgd3Mub24oJ2Nsb3NlJywgKGNvZGUsIHJlYXNvbikgPT4ge1xuICAgICAgaWYgKCFfLmlzRW1wdHkodGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIpKSB7XG4gICAgICAgIHRoaXMubG9ncy5zeXNsb2cucmVtb3ZlTGlzdGVuZXIoJ291dHB1dCcsIHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIgPSBudWxsO1xuICAgICAgfVxuXG4gICAgICBsZXQgY2xvc2VNc2cgPSAnU3lzdGVtIGxvZ3MgbGlzdGVuZXIgd2ViIHNvY2tldCBpcyBjbG9zZWQuJztcbiAgICAgIGlmICghXy5pc0VtcHR5KGNvZGUpKSB7XG4gICAgICAgIGNsb3NlTXNnICs9IGAgQ29kZTogJHtjb2RlfS5gO1xuICAgICAgfVxuICAgICAgaWYgKCFfLmlzRW1wdHkocmVhc29uKSkge1xuICAgICAgICBjbG9zZU1zZyArPSBgIFJlYXNvbjogJHtyZWFzb24udG9TdHJpbmcoKX0uYDtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhjbG9zZU1zZyk7XG4gICAgfSk7XG4gIH0pO1xuICBhd2FpdCB0aGlzLnNlcnZlci5hZGRXZWJTb2NrZXRIYW5kbGVyKHBhdGhuYW1lLCB3c3MpO1xufTtcblxuLyoqXG4gKiBTdG9wcyB0aGUgcHJldmlvdXNseSBzdGFydGVkIHN5c2xvZyBicm9hZGNhc3Rpbmcgd2Vzb2NrZXQgc2VydmVyLlxuICogVGhpcyBtZXRob2Qgd2lsbCByZXR1cm4gaW1tZWRpYXRlbHkgaWYgbm8gc2VydmVyIGlzIHJ1bm5pbmcuXG4gKi9cbmV4dGVuc2lvbnMubW9iaWxlU3RvcExvZ3NCcm9hZGNhc3QgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVTdG9wTG9nc0Jyb2FkY2FzdCAoKSB7XG4gIGNvbnN0IHBhdGhuYW1lID0gV0VCU09DS0VUX0VORFBPSU5UKHRoaXMuc2Vzc2lvbklkKTtcbiAgaWYgKF8uaXNFbXB0eShhd2FpdCB0aGlzLnNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycyhwYXRobmFtZSkpKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmRlYnVnKCdTdG9wcGluZyB0aGUgc3lzdGVtIGxvZ3MgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyJyk7XG4gIGF3YWl0IHRoaXMuc2VydmVyLnJlbW92ZVdlYlNvY2tldEhhbmRsZXIocGF0aG5hbWUpO1xufTtcblxuXG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvbG9nLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _cssSelectorParser = require("css-selector-parser");

var _lodash = _interopRequireDefault(require("lodash"));

var _baseDriver = require("@appium/base-driver");

const CssConverter = {};
const parser = new _cssSelectorParser.CssSelectorParser();
parser.registerSelectorPseudos('has');
parser.registerNestingOperators('>', '+', '~');
parser.registerAttrEqualityMods('^', '$', '*', '~');
parser.enableSubstitutes();
const BOOLEAN_ATTRS = ['visible', 'accessible', 'accessibility-container', 'enabled'];
const NUMERIC_ATTRS = ['index'];
const STR_ATTRS = ['label', 'name', 'value', 'type'];
const ALL_ATTRS = [...BOOLEAN_ATTRS, ...NUMERIC_ATTRS, ...STR_ATTRS];
const ATTRIBUTE_ALIASES = [['name', ['id']], ['index', ['nth-child']]];

function toCamelCase(str) {
  if (!str) {
    return '';
  }

  const tokens = str.split('-').map(str => str.charAt(0).toUpperCase() + str.slice(1).toLowerCase());
  const out = tokens.join('');
  return out.charAt(0).toLowerCase() + out.slice(1);
}

function requireBoolean(css) {
  var _css$value;

  const val = ((_css$value = css.value) === null || _css$value === void 0 ? void 0 : _css$value.toLowerCase()) || 'true';

  switch (val) {
    case '0':
    case 'false':
      return '0';

    case '1':
    case 'true':
      return '1';

    default:
      throw new TypeError(`'${css.name}' must be true, false or empty. Found '${css.value}'`);
  }
}

function requireAttributeName(css) {
  const attrName = css.name.toLowerCase();

  if (ALL_ATTRS.includes(attrName)) {
    return attrName.toLowerCase();
  }

  for (const [officialAttr, aliasAttrs] of ATTRIBUTE_ALIASES) {
    if (aliasAttrs.includes(attrName)) {
      return officialAttr;
    }
  }

  throw new Error(`'${attrName}' is not a valid attribute. ` + `Supported attributes are '${ALL_ATTRS.join(', ')}'`);
}

function parseAttr(cssAttr) {
  if (cssAttr.valueType && cssAttr.valueType !== 'string') {
    throw new TypeError(`'${cssAttr.name}=${cssAttr.value}' is an invalid attribute. ` + `Only 'string' and empty attribute types are supported. Found '${cssAttr.valueType}'`);
  }

  const attrName = toCamelCase(requireAttributeName(cssAttr));

  if (!STR_ATTRS.includes(attrName) && !BOOLEAN_ATTRS.includes(attrName)) {
    throw new Error(`'${attrName}' is not supported. Supported attributes are ` + `'${[...STR_ATTRS, ...BOOLEAN_ATTRS].join(', ')}'`);
  }

  if (attrName === 'index') {
    return {
      index: cssAttr.value
    };
  }

  if (BOOLEAN_ATTRS.includes(attrName)) {
    return `${attrName} == ${requireBoolean(cssAttr)}`;
  }

  let value = cssAttr.value || '';

  if (value === '') {
    return `[${attrName} LIKE ${value}]`;
  }

  switch (cssAttr.operator) {
    case '=':
      return `${attrName} == "${value}"`;

    case '*=':
      return `${attrName} MATCHES "${_lodash.default.escapeRegExp(value)}"`;

    case '^=':
      return `${attrName} BEGINSWITH "${value}"`;

    case '$=':
      return `${attrName} ENDSWITH "${value}"`;

    case '~=':
      return `${attrName} CONTAINS "${value}"`;

    default:
      throw new Error(`Unsupported CSS attribute operator '${cssAttr.operator}'. ` + ` '=', '*=', '^=', '$=' and '~=' are supported.`);
  }
}

function parsePseudo(cssPseudo) {
  if (cssPseudo.valueType && cssPseudo.valueType !== 'string') {
    throw new Error(`'${cssPseudo.name}=${cssPseudo.value}'. ` + `Unsupported css pseudo class value type: '${cssPseudo.valueType}'. Only 'string' type or empty is supported.`);
  }

  const pseudoName = requireAttributeName(cssPseudo);

  if (BOOLEAN_ATTRS.includes(pseudoName)) {
    return `${toCamelCase(pseudoName)} == ${requireBoolean(cssPseudo)}`;
  }

  if (pseudoName === 'index') {
    return {
      index: cssPseudo.value
    };
  }
}

function parseCssRule(cssRule) {
  const {
    nestingOperator
  } = cssRule;

  if (nestingOperator && nestingOperator !== ' ' && nestingOperator !== '>') {
    throw new Error(`'${nestingOperator}' is not a supported combinator. ` + `Only child combinator (>) and descendant combinator are supported.`);
  }

  let iosClassChainSelector = '';

  if (cssRule.classNames) {
    throw new _baseDriver.errors.InvalidSelectorError(`'${[cssRule || '', ...cssRule.classNames].join('.')}'
      is not a valid ios class. Must be a single string (e.g.: XCUIElementTypeWindow) without
      dots separating them`);
  }

  if (cssRule.tagName && cssRule.tagName !== '*' && !cssRule.tagName.toLowerCase().startsWith('xcuielementtype')) {
    const capitalizedTagName = cssRule.tagName.charAt(0).toUpperCase() + cssRule.tagName.slice(1);
    cssRule.tagName = `XCUIElementType${capitalizedTagName}`;
  }

  iosClassChainSelector += cssRule.tagName || '*';
  let attrs = [];

  if (cssRule.id) {
    attrs.push(`name == "${cssRule.id}"`);
  }

  if (cssRule.attrs) {
    for (const attr of cssRule.attrs) {
      attrs.push(parseAttr(attr));
    }
  }

  if (cssRule.pseudos) {
    for (const pseudo of cssRule.pseudos) {
      attrs.push(parsePseudo(pseudo));
    }
  }

  const nonIndexAttrs = attrs.filter(attr => _lodash.default.isString(attr));

  if (nonIndexAttrs && nonIndexAttrs.length > 0) {
    iosClassChainSelector += `[\`${nonIndexAttrs.join(' AND ')}\`]`;
  }

  const indexAttr = attrs.find(attr => _lodash.default.isObject(attr) && attr.index);

  if (indexAttr) {
    iosClassChainSelector += `[${indexAttr.index}]`;
  }

  if (cssRule.rule) {
    iosClassChainSelector += `/${parseCssRule(cssRule.rule)}`;
  }

  if (cssRule.nestingOperator === '>') {
    return iosClassChainSelector;
  } else {
    return `**/` + iosClassChainSelector;
  }
}

function parseCssObject(css) {
  switch (css.type) {
    case 'rule':
      return parseCssRule(css);

    case 'ruleSet':
      return parseCssObject(css.rule);

    case 'selectors':
      return css.selectors.map(selector => parseCssObject(selector)).join('; ');

    default:
      throw new Error(`iOS Class Chain does not support '${css.type}' css. Only supports 'rule', 'ruleSet', 'selectors'`);
  }
}

CssConverter.toIosClassChainSelector = function toIosClassChainSelector(cssSelector) {
  let cssObj;

  try {
    cssObj = parser.parse(cssSelector);
  } catch (e) {
    throw new _baseDriver.errors.InvalidSelectorError(`Invalid CSS selector '${cssSelector}'. Reason: '${e.message}'`);
  }

  try {
    return parseCssObject(cssObj);
  } catch (e) {
    throw new _baseDriver.errors.InvalidSelectorError(`Unsupported CSS selector '${cssSelector}'. Reason: '${e.message}'`);
  }
};

var _default = CssConverter;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jc3MtY29udmVydGVyLmpzIl0sIm5hbWVzIjpbIkNzc0NvbnZlcnRlciIsInBhcnNlciIsIkNzc1NlbGVjdG9yUGFyc2VyIiwicmVnaXN0ZXJTZWxlY3RvclBzZXVkb3MiLCJyZWdpc3Rlck5lc3RpbmdPcGVyYXRvcnMiLCJyZWdpc3RlckF0dHJFcXVhbGl0eU1vZHMiLCJlbmFibGVTdWJzdGl0dXRlcyIsIkJPT0xFQU5fQVRUUlMiLCJOVU1FUklDX0FUVFJTIiwiU1RSX0FUVFJTIiwiQUxMX0FUVFJTIiwiQVRUUklCVVRFX0FMSUFTRVMiLCJ0b0NhbWVsQ2FzZSIsInN0ciIsInRva2VucyIsInNwbGl0IiwibWFwIiwiY2hhckF0IiwidG9VcHBlckNhc2UiLCJzbGljZSIsInRvTG93ZXJDYXNlIiwib3V0Iiwiam9pbiIsInJlcXVpcmVCb29sZWFuIiwiY3NzIiwidmFsIiwidmFsdWUiLCJUeXBlRXJyb3IiLCJuYW1lIiwicmVxdWlyZUF0dHJpYnV0ZU5hbWUiLCJhdHRyTmFtZSIsImluY2x1ZGVzIiwib2ZmaWNpYWxBdHRyIiwiYWxpYXNBdHRycyIsIkVycm9yIiwicGFyc2VBdHRyIiwiY3NzQXR0ciIsInZhbHVlVHlwZSIsImluZGV4Iiwib3BlcmF0b3IiLCJfIiwiZXNjYXBlUmVnRXhwIiwicGFyc2VQc2V1ZG8iLCJjc3NQc2V1ZG8iLCJwc2V1ZG9OYW1lIiwicGFyc2VDc3NSdWxlIiwiY3NzUnVsZSIsIm5lc3RpbmdPcGVyYXRvciIsImlvc0NsYXNzQ2hhaW5TZWxlY3RvciIsImNsYXNzTmFtZXMiLCJlcnJvcnMiLCJJbnZhbGlkU2VsZWN0b3JFcnJvciIsInRhZ05hbWUiLCJzdGFydHNXaXRoIiwiY2FwaXRhbGl6ZWRUYWdOYW1lIiwiYXR0cnMiLCJpZCIsInB1c2giLCJhdHRyIiwicHNldWRvcyIsInBzZXVkbyIsIm5vbkluZGV4QXR0cnMiLCJmaWx0ZXIiLCJpc1N0cmluZyIsImxlbmd0aCIsImluZGV4QXR0ciIsImZpbmQiLCJpc09iamVjdCIsInJ1bGUiLCJwYXJzZUNzc09iamVjdCIsInR5cGUiLCJzZWxlY3RvcnMiLCJzZWxlY3RvciIsInRvSW9zQ2xhc3NDaGFpblNlbGVjdG9yIiwiY3NzU2VsZWN0b3IiLCJjc3NPYmoiLCJwYXJzZSIsImUiLCJtZXNzYWdlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLFlBQVksR0FBRyxFQUFyQjtBQUVBLE1BQU1DLE1BQU0sR0FBRyxJQUFJQyxvQ0FBSixFQUFmO0FBQ0FELE1BQU0sQ0FBQ0UsdUJBQVAsQ0FBK0IsS0FBL0I7QUFDQUYsTUFBTSxDQUFDRyx3QkFBUCxDQUFnQyxHQUFoQyxFQUFxQyxHQUFyQyxFQUEwQyxHQUExQztBQUNBSCxNQUFNLENBQUNJLHdCQUFQLENBQWdDLEdBQWhDLEVBQXFDLEdBQXJDLEVBQTBDLEdBQTFDLEVBQStDLEdBQS9DO0FBQ0FKLE1BQU0sQ0FBQ0ssaUJBQVA7QUFFQSxNQUFNQyxhQUFhLEdBQUcsQ0FDcEIsU0FEb0IsRUFDVCxZQURTLEVBQ0sseUJBREwsRUFDZ0MsU0FEaEMsQ0FBdEI7QUFJQSxNQUFNQyxhQUFhLEdBQUcsQ0FDcEIsT0FEb0IsQ0FBdEI7QUFJQSxNQUFNQyxTQUFTLEdBQUcsQ0FDaEIsT0FEZ0IsRUFDUCxNQURPLEVBQ0MsT0FERCxFQUNVLE1BRFYsQ0FBbEI7QUFJQSxNQUFNQyxTQUFTLEdBQUcsQ0FDaEIsR0FBR0gsYUFEYSxFQUVoQixHQUFHQyxhQUZhLEVBR2hCLEdBQUdDLFNBSGEsQ0FBbEI7QUFNQSxNQUFNRSxpQkFBaUIsR0FBRyxDQUN4QixDQUFDLE1BQUQsRUFBUyxDQUFDLElBQUQsQ0FBVCxDQUR3QixFQUV4QixDQUFDLE9BQUQsRUFBVSxDQUFDLFdBQUQsQ0FBVixDQUZ3QixDQUExQjs7QUFXQSxTQUFTQyxXQUFULENBQXNCQyxHQUF0QixFQUEyQjtBQUN6QixNQUFJLENBQUNBLEdBQUwsRUFBVTtBQUNSLFdBQU8sRUFBUDtBQUNEOztBQUNELFFBQU1DLE1BQU0sR0FBR0Qs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QU47QUFDRDs7QUFDRCxNQUFJO0FBQ0YsV0FBT1QsY0FBYyxDQUFDTSxNQUFELENBQXJCO0FBQ0QsR0FGRCxDQUVFLE9BQU9FLENBQVAsRUFBVTtBQUNWLFVBQU0sSUFBSTNCLG1CQUFPQyxvQkFBWCxDQUFpQyw2QkFBNEJ1QixXQUFZLGVBQWNHLENBQUMsQ0FBQ0MsT0FBUSxHQUFqRyxDQUFOO0FBQ0Q7QUFDRixDQVpEOztlQWNlOUUsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENzc1NlbGVjdG9yUGFyc2VyIH0gZnJvbSAnY3NzLXNlbGVjdG9yLXBhcnNlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnQGFwcGl1bS9iYXNlLWRyaXZlcic7XG5cbmNvbnN0IENzc0NvbnZlcnRlciA9IHt9O1xuXG5jb25zdCBwYXJzZXIgPSBuZXcgQ3NzU2VsZWN0b3JQYXJzZXIoKTtcbnBhcnNlci5yZWdpc3RlclNlbGVjdG9yUHNldWRvcygnaGFzJyk7XG5wYXJzZXIucmVnaXN0ZXJOZXN0aW5nT3BlcmF0b3JzKCc+JywgJysnLCAnficpO1xucGFyc2VyLnJlZ2lzdGVyQXR0ckVxdWFsaXR5TW9kcygnXicsICckJywgJyonLCAnficpO1xucGFyc2VyLmVuYWJsZVN1YnN0aXR1dGVzKCk7XG5cbmNvbnN0IEJPT0xFQU5fQVRUUlMgPSBbXG4gICd2aXNpYmxlJywgJ2FjY2Vzc2libGUnLCAnYWNjZXNzaWJpbGl0eS1jb250YWluZXInLCAnZW5hYmxlZCcsXG5dO1xuXG5jb25zdCBOVU1FUklDX0FUVFJTID0gW1xuICAnaW5kZXgnXG5dO1xuXG5jb25zdCBTVFJfQVRUUlMgPSBbXG4gICdsYWJlbCcsICduYW1lJywgJ3ZhbHVlJywgJ3R5cGUnLFxuXTtcblxuY29uc3QgQUxMX0FUVFJTID0gW1xuICAuLi5CT09MRUFOX0FUVFJTLFxuICAuLi5OVU1FUklDX0FUVFJTLFxuICAuLi5TVFJfQVRUUlMsXG5dO1xuXG5jb25zdCBBVFRSSUJVVEVfQUxJQVNFUyA9IFtcbiAgWyduYW1lJywgWydpZCddXSxcbiAgWydpbmRleCcsIFsnbnRoLWNoaWxkJ11dLFxuXTtcblxuLyoqXG4gKiBDb252ZXJ0IGh5cGhlbiBzZXBhcmF0ZWQgd29yZCB0byBjYW1lbCBjYXNlXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHN0clxuICogQHJldHVybnMge3N0cmluZ30gVGhlIGh5cGhlbiBzZXBhcmF0ZWQgd29yZCB0cmFuc2xhdGVkIHRvIGNhbWVsIGNhc2VcbiAqL1xuZnVuY3Rpb24gdG9DYW1lbENhc2UgKHN0cikge1xuICBpZiAoIXN0cikge1xuICAgIHJldHVybiAnJztcbiAgfVxuICBjb25zdCB0b2tlbnMgPSBzdHIuc3BsaXQoJy0nKS5tYXAoKHN0cikgPT4gc3RyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpLnRvTG93ZXJDYXNlKCkpO1xuICBjb25zdCBvdXQgPSB0b2tlbnMuam9pbignJyk7XG4gIHJldHVybiBvdXQuY2hhckF0KDApLnRvTG93ZXJDYXNlKCkgKyBvdXQuc2xpY2UoMSk7XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQ3NzTmFtZVZhbHVlT2JqZWN0XG4gKiBAcHJvcGVydHkgez9uYW1lfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBDU1Mgb2JqZWN0XG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZhbHVlIFRoZSB2YWx1ZSBvZiB0aGUgQ1NTIG9iamVjdFxuICovXG5cbi8qKlxuICogR2V0IHRoZSBib29sZWFuIGZyb20gYSBDU1Mgb2JqZWN0LiBJZiBlbXB0eSwgcmV0dXJuIHRydWUuIElmIG5vdCB0cnVlL2ZhbHNlL2VtcHR5LCB0aHJvdyBleGNlcHRpb25cbiAqXG4gKiBAcGFyYW0ge0Nzc05hbWVWYWx1ZU9iamVjdH0gY3NzIEEgQ1NTIG9iamVjdCB0aGF0IGhhcyAnbmFtZScgYW5kICd2YWx1ZSdcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEVpdGhlciAndHJ1ZScgb3IgJ2ZhbHNlJy4gSWYgdmFsdWUgaXMgZW1wdHksIHJldHVybiAndHJ1ZSdcbiAqL1xuZnVuY3Rpb24gcmVxdWlyZUJvb2xlYW4gKGNzcykge1xuICBjb25zdCB2YWwgPSBjc3MudmFsdWU/LnRvTG93ZXJDYXNlKCkgfHwgJ3RydWUnOyAvLyBhbiBvbWl0dGVkIGJvb2xlYW4gYXR0cmlidXRlIG1lYW5zICd0cnVlJyAoZS5nLjogaW5wdXRbY2hlY2tlZF0gbWVhbnMgY2hlY2tlZCBpcyB0cnVlKVxuICBzd2l0Y2ggKHZhbCkge1xuICAgIGNhc2UgJzAnOlxuICAgIGNhc2UgJ2ZhbHNlJzpcbiAgICAgIHJldHVybiAnMCc7XG4gICAgY2FzZSAnMSc6XG4gICAgY2FzZSAndHJ1ZSc6XG4gICAgICByZXR1cm4gJzEnO1xuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGAnJHtjc3MubmFtZX0nIG11c3QgYmUgdHJ1ZSwgZmFsc2Ugb3IgZW1wdHkuIEZvdW5kICcke2Nzcy52YWx1ZX0nYCk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZXQgdGhlIGNhbm9uaWNhbCBmb3JtIG9mIGEgQ1NTIGF0dHJpYnV0ZSBuYW1lXG4gKlxuICogQ29udmVydHMgdG8gbG93ZXJjYXNlIGFuZCBpZiBhbiBhdHRyaWJ1dGUgbmFtZSBpcyBhbiBhbGlhcyBmb3Igc29tZXRoaW5nIGVsc2UsIHJldHVyblxuICogd2hhdCBpdCBpcyBhbiBhbGlhcyBmb3JcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gY3NzIENTUyBvYmplY3RcbiAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBjYW5vbmljYWwgYXR0cmlidXRlIG5hbWVcbiAqL1xuZnVuY3Rpb24gcmVxdWlyZUF0dHJpYnV0ZU5hbWUgKGNzcykge1xuICBjb25zdCBhdHRyTmFtZSA9IGNzcy5uYW1lLnRvTG93ZXJDYXNlKCk7XG5cbiAgLy8gQ2hlY2sgaWYgaXQncyBzdXBwb3J0ZWQgYW5kIGlmIGl0IGlzLCByZXR1cm4gaXRcbiAgaWYgKEFMTF9BVFRSUy5pbmNsdWRlcyhhdHRyTmFtZSkpIHtcbiAgICByZXR1cm4gYXR0ck5hbWUudG9Mb3dlckNhc2UoKTtcbiAgfVxuXG4gIC8vIElmIGF0dHJOYW1lIGlzIGFuIGFsaWFzIGZvciBzb21ldGhpbmcgZWxzZSwgcmV0dXJuIHRoYXRcbiAgZm9yIChjb25zdCBbb2ZmaWNpYWxBdHRyLCBhbGlhc0F0dHJzXSBvZiBBVFRSSUJVVEVfQUxJQVNFUykge1xuICAgIGlmIChhbGlhc0F0dHJzLmluY2x1ZGVzKGF0dHJOYW1lKSkge1xuICAgICAgcmV0dXJuIG9mZmljaWFsQXR0cjtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGAnJHthdHRyTmFtZX0nIGlzIG5vdCBhIHZhbGlkIGF0dHJpYnV0ZS4gYCArXG4gICAgYFN1cHBvcnRlZCBhdHRyaWJ1dGVzIGFyZSAnJHtBTExfQVRUUlMuam9pbignLCAnKX0nYCk7XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQ3NzQXR0clxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2YWx1ZVR5cGUgVHlwZSBvZiBhdHRyaWJ1dGUgKG11c3QgYmUgc3RyaW5nIG9yIGVtcHR5KVxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2YWx1ZSBWYWx1ZSBvZiB0aGUgYXR0cmlidXRlXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG9wZXJhdG9yIFRoZSBvcGVyYXRvciBiZXR3ZWVuIHZhbHVlIGFuZCB2YWx1ZSB0eXBlICg9LCAqPSwgLCBePSwgJD0pXG4gKi9cblxuLyoqXG4gKiBDb252ZXJ0IGEgQ1NTIGF0dHJpYnV0ZSBpbnRvIGEgVWlTZWxlY3RvciBtZXRob2QgY2FsbFxuICpcbiAqIEBwYXJhbSB7Q3NzQXR0cn0gY3NzQXR0ciBDU1MgYXR0cmlidXRlIG9iamVjdFxuICogQHJldHVybnMge3N0cmluZ30gQ1NTIGF0dHJpYnV0ZSBwYXJzZWQgYXMgVWlTZWxlY3RvclxuICovXG5mdW5jdGlvbiBwYXJzZUF0dHIgKGNzc0F0dHIpIHtcbiAgaWYgKGNzc0F0dHIudmFsdWVUeXBlICYmIGNzc0F0dHIudmFsdWVUeXBlICE9PSAnc3RyaW5nJykge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYCcke2Nzc0F0dHIubmFtZX09JHtjc3NBdHRyLnZhbHVlfScgaXMgYW4gaW52YWxpZCBhdHRyaWJ1dGUuIGAgK1xuICAgICAgYE9ubHkgJ3N0cmluZycgYW5kIGVtcHR5IGF0dHJpYnV0ZSB0eXBlcyBhcmUgc3VwcG9ydGVkLiBGb3VuZCAnJHtjc3NBdHRyLnZhbHVlVHlwZX0nYCk7XG4gIH1cbiAgY29uc3QgYXR0ck5hbWUgPSB0b0NhbWVsQ2FzZShyZXF1aXJlQXR0cmlidXRlTmFtZShjc3NBdHRyKSk7XG5cbiAgLy8gVmFsaWRhdGUgdGhhdCBpdCdzIGEgc3VwcG9ydGVkIGF0dHJpYnV0ZVxuICBpZiAoIVNUUl9BVFRSUy5pbmNsdWRlcyhhdHRyTmFtZSkgJiYgIUJPT0xFQU5fQVRUUlMuaW5jbHVkZXMoYXR0ck5hbWUpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAnJHthdHRyTmFtZX0nIGlzIG5vdCBzdXBwb3J0ZWQuIFN1cHBvcnRlZCBhdHRyaWJ1dGVzIGFyZSBgICtcbiAgICAgIGAnJHtbLi4uU1RSX0FUVFJTLCAuLi5CT09MRUFOX0FUVFJTXS5qb2luKCcsICcpfSdgKTtcbiAgfVxuXG4gIC8vIFBhcnNlIGluZGV4IGlmIGl0J3MgYW4gaW5kZXggYXR0cmlidXRlXG4gIGlmIChhdHRyTmFtZSA9PT0gJ2luZGV4Jykge1xuICAgIHJldHVybiB7aW5kZXg6IGNzc0F0dHIudmFsdWV9O1xuICB9XG4gIGlmIChCT09MRUFOX0FUVFJTLmluY2x1ZGVzKGF0dHJOYW1lKSkge1xuICAgIHJldHVybiBgJHthdHRyTmFtZX0gPT0gJHtyZXF1aXJlQm9vbGVhbihjc3NBdHRyKX1gO1xuICB9XG5cbiAgbGV0IHZhbHVlID0gY3NzQXR0ci52YWx1ZSB8fCAnJztcbiAgaWYgKHZhbHVlID09PSAnJykge1xuICAgIHJldHVybiBgWyR7YXR0ck5hbWV9IExJS0UgJHt2YWx1ZX1dYDtcbiAgfVxuXG4gIHN3aXRjaCAoY3NzQXR0ci5vcGVyYXRvcikge1xuICAgIGNhc2UgJz0nOlxuICAgICAgcmV0dXJuIGAke2F0dHJOYW1lfSA9PSBcIiR7dmFsdWV9XCJgO1xuICAgIGNhc2UgJyo9JzpcbiAgICAgIHJldHVybiBgJHthdHRyTmFtZX0gTUFUQ0hFUyBcIiR7Xy5lc2NhcGVSZWdFeHAodmFsdWUpfVwiYDtcbiAgICBjYXNlICdePSc6XG4gICAgICByZXR1cm4gYCR7YXR0ck5hbWV9IEJFR0lOU1dJVEggXCIke3ZhbHVlfVwiYDtcbiAgICBjYXNlICckPSc6XG4gICAgICByZXR1cm4gYCR7YXR0ck5hbWV9IEVORFNXSVRIIFwiJHt2YWx1ZX1cImA7XG4gICAgY2FzZSAnfj0nOlxuICAgICAgcmV0dXJuIGAke2F0dHJOYW1lfSBDT05UQUlOUyBcIiR7dmFsdWV9XCJgO1xuICAgIGRlZmF1bHQ6XG4gICAgICAvLyBVbnJlYWNoYWJsZSwgYnV0IGFkZGluZyBlcnJvciBpbiBjYXNlIGEgbmV3IENTUyBhdHRyaWJ1dGUgaXMgYWRkZWQuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIENTUyBhdHRyaWJ1dGUgb3BlcmF0b3IgJyR7Y3NzQXR0ci5vcGVyYXRvcn0nLiBgICtcbiAgICAgICAgYCAnPScsICcqPScsICdePScsICckPScgYW5kICd+PScgYXJlIHN1cHBvcnRlZC5gKTtcbiAgfVxufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENzc1BzZXVkb1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2YWx1ZVR5cGUgVGhlIHR5cGUgb2YgQ1NTIHBzZXVkbyBzZWxlY3RvciAoaHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvY3NzLXNlbGVjdG9yLXBhcnNlciBmb3IgcmVmZXJlbmNlKVxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBwc2V1ZG8gc2VsZWN0b3JcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmFsdWUgVGhlIHZhbHVlIG9mIHRoZSBwc2V1ZG8gc2VsZWN0b3JcbiAqL1xuXG4vKipcbiAqIENvbnZlcnQgYSBDU1MgcHNldWRvIGNsYXNzIHRvIGEgVWlTZWxlY3RvclxuICpcbiAqIEBwYXJhbSB7Q3NzUHNldWRvfSBjc3NQc2V1ZG8gQ1NTIFBzZXVkbyBjbGFzc1xuICogQHJldHVybnMge3N0cmluZ30gUHNldWRvIHNlbGVjdG9yIHBhcnNlZCBhcyBVaVNlbGVjdG9yXG4gKi9cbmZ1bmN0aW9uIHBhcnNlUHNldWRvIChjc3NQc2V1ZG8pIHtcbiAgaWYgKGNzc1BzZXVkby52YWx1ZVR5cGUgJiYgY3NzUHNldWRvLnZhbHVlVHlwZSAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCcke2Nzc1BzZXVkby5uYW1lfT0ke2Nzc1BzZXVkby52YWx1ZX0nLiBgICtcbiAgICAgIGBVbnN1cHBvcnRlZCBjc3MgcHNldWRvIGNsYXNzIHZhbHVlIHR5cGU6ICcke2Nzc1BzZXVkby52YWx1ZVR5cGV9Jy4gT25seSAnc3RyaW5nJyB0eXBlIG9yIGVtcHR5IGlzIHN1cHBvcnRlZC5gKTtcbiAgfVxuXG4gIGNvbnN0IHBzZXVkb05hbWUgPSByZXF1aXJlQXR0cmlidXRlTmFtZShjc3NQc2V1ZG8pO1xuXG4gIGlmIChCT09MRUFOX0FUVFJTLmluY2x1ZGVzKHBzZXVkb05hbWUpKSB7XG4gICAgcmV0dXJuIGAke3RvQ2FtZWxDYXNlKHBzZXVkb05hbWUpfSA9PSAke3JlcXVpcmVCb29sZWFuKGNzc1BzZXVkbyl9YDtcbiAgfVxuXG4gIGlmIChwc2V1ZG9OYW1lID09PSAnaW5kZXgnKSB7XG4gICAgcmV0dXJuIHtpbmRleDogY3NzUHNldWRvLnZhbHVlfTtcbiAgfVxufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENzc1J1bGVcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbmVzdGluZ09wZXJhdG9yIFRoZSBuZXN0aW5nIG9wZXJhdG9yIChha2E6IGNvbWJpbmF0b3IgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQ1NTL0NTU19TZWxlY3RvcnMpXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHRhZ05hbWUgVGhlIHRhZyBuYW1lIChha2E6IHR5cGUgc2VsZWN0b3IgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQ1NTL1R5cGVfc2VsZWN0b3JzKVxuICogQHByb3BlcnR5IHs/c3RyaW5nW119IGNsYXNzTmFtZXMgQW4gYXJyYXkgb2YgQ1NTIGNsYXNzIG5hbWVzXG4gKiBAcHJvcGVydHkgez9Dc3NBdHRyW119IGF0dHJzIEFuIGFycmF5IG9mIENTUyBhdHRyaWJ1dGVzXG4gKiBAcHJvcGVydHkgez9Dc3NQc2V1ZG9bXX0gYXR0cnMgQW4gYXJyYXkgb2YgQ1NTIHBzZXVkb3NcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gaWQgQ1NTIGlkZW50aWZpZXJcbiAqIEBwcm9wZXJ0eSB7P0Nzc1J1bGV9IHJ1bGUgQSBkZXNjZW5kYW50IG9mIHRoaXMgQ1NTIHJ1bGVcbiAqL1xuXG4vKipcbiAqIENvbnZlcnQgYSBDU1MgcnVsZSB0byBhIFVpU2VsZWN0b3JcbiAqIEBwYXJhbSB7Q3NzUnVsZX0gY3NzUnVsZSBDU1MgcnVsZSBkZWZpbml0aW9uXG4gKi9cbmZ1bmN0aW9uIHBhcnNlQ3NzUnVsZSAoY3NzUnVsZSkge1xuICBjb25zdCB7IG5lc3RpbmdPcGVyYXRvciB9ID0gY3NzUnVsZTtcbiAgaWYgKG5lc3RpbmdPcGVyYXRvciAmJiBuZXN0aW5nT3BlcmF0b3IgIT09ICcgJyAmJiBuZXN0aW5nT3BlcmF0b3IgIT09ICc+Jykge1xuICAgIHRocm93IG5ldyBFcnJvcihgJyR7bmVzdGluZ09wZXJhdG9yfScgaXMgbm90IGEgc3VwcG9ydGVkIGNvbWJpbmF0b3IuIGAgK1xuICAgICAgYE9ubHkgY2hpbGQgY29tYmluYXRvciAoPikgYW5kIGRlc2NlbmRhbnQgY29tYmluYXRvciBhcmUgc3VwcG9ydGVkLmApO1xuICB9XG5cbiAgbGV0IGlvc0NsYXNzQ2hhaW5TZWxlY3RvciA9ICcnO1xuICBpZiAoY3NzUnVsZS5jbGFzc05hbWVzKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkU2VsZWN0b3JFcnJvcihgJyR7W2Nzc1J1bGUgfHwgJycsIC4uLmNzc1J1bGUuY2xhc3NOYW1lc10uam9pbignLicpfSdcbiAgICAgIGlzIG5vdCBhIHZhbGlkIGlvcyBjbGFzcy4gTXVzdCBiZSBhIHNpbmdsZSBzdHJpbmcgKGUuZy46IFhDVUlFbGVtZW50VHlwZVdpbmRvdykgd2l0aG91dFxuICAgICAgZG90cyBzZXBhcmF0aW5nIHRoZW1gKTtcbiAgfVxuICBpZiAoY3NzUnVsZS50YWdOYW1lICYmIGNzc1J1bGUudGFnTmFtZSAhPT0gJyonICYmICFjc3NSdWxlLnRhZ05hbWUudG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKCd4Y3VpZWxlbWVudHR5cGUnKSkge1xuICAgIGNvbnN0IGNhcGl0YWxpemVkVGFnTmFtZSA9IGNzc1J1bGUudGFnTmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGNzc1J1bGUudGFnTmFtZS5zbGljZSgxKTtcbiAgICBjc3NSdWxlLnRhZ05hbWUgPSBgWENVSUVsZW1lbnRUeXBlJHtjYXBpdGFsaXplZFRhZ05hbWV9YDtcbiAgfVxuICBpb3NDbGFzc0NoYWluU2VsZWN0b3IgKz0gKGNzc1J1bGUudGFnTmFtZSB8fCAnKicpO1xuXG4gIGxldCBhdHRycyA9IFtdO1xuICBpZiAoY3NzUnVsZS5pZCkge1xuICAgIGF0dHJzLnB1c2goYG5hbWUgPT0gXCIke2Nzc1J1bGUuaWR9XCJgKTtcbiAgfVxuICBpZiAoY3NzUnVsZS5hdHRycykge1xuICAgIGZvciAoY29uc3QgYXR0ciBvZiBjc3NSdWxlLmF0dHJzKSB7XG4gICAgICBhdHRycy5wdXNoKHBhcnNlQXR0cihhdHRyKSk7XG4gICAgfVxuICB9XG4gIGlmIChjc3NSdWxlLnBzZXVkb3MpIHtcbiAgICBmb3IgKGNvbnN0IHBzZXVkbyBvZiBjc3NSdWxlLnBzZXVkb3MpIHtcbiAgICAgIGF0dHJzLnB1c2gocGFyc2VQc2V1ZG8ocHNldWRvKSk7XG4gICAgfVxuICB9XG4gIGNvbnN0IG5vbkluZGV4QXR0cnMgPSBhdHRycy5maWx0ZXIoKGF0dHIpID0+IF8uaXNTdHJpbmcoYXR0cikpO1xuICBpZiAobm9uSW5kZXhBdHRycyAmJiBub25JbmRleEF0dHJzLmxlbmd0aCA+IDApIHtcbiAgICBpb3NDbGFzc0NoYWluU2VsZWN0b3IgKz0gYFtcXGAke25vbkluZGV4QXR0cnMuam9pbignIEFORCAnKX1cXGBdYDtcbiAgfVxuXG4gIGNvbnN0IGluZGV4QXR0ciA9IGF0dHJzLmZpbmQoKGF0dHIpID0+IF8uaXNPYmplY3QoYXR0cikgJiYgYXR0ci5pbmRleCk7XG4gIGlmIChpbmRleEF0dHIpIHtcbiAgICBpb3NDbGFzc0NoYWluU2VsZWN0b3IgKz0gYFske2luZGV4QXR0ci5pbmRleH1dYDtcbiAgfVxuXG4gIGlmIChjc3NSdWxlLnJ1bGUpIHtcbiAgICBpb3NDbGFzc0NoYWluU2VsZWN0b3IgKz0gYC8ke3BhcnNlQ3NzUnVsZShjc3NSdWxlLnJ1bGUpfWA7XG4gIH1cblxuICBpZiAoY3NzUnVsZS5uZXN0aW5nT3BlcmF0b3IgPT09ICc+Jykge1xuICAgIHJldHVybiBpb3NDbGFzc0NoYWluU2VsZWN0b3I7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGAqKi9gICsgaW9zQ2xhc3NDaGFpblNlbGVjdG9yO1xuICB9XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQ3NzT2JqZWN0XG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHR5cGUgVHlwZSBvZiBDU1Mgb2JqZWN0LiAncnVsZScsICdydWxlc2V0JyBvciAnc2VsZWN0b3JzJ1xuICovXG5cbi8qKlxuICogQ29udmVydCBDU1Mgb2JqZWN0IHRvIGlPUyBDbGFzcyBDaGFpbiBzZWxlY3RvclxuICogQHBhcmFtIHtDc3NPYmplY3R9IGNzcyBDU1Mgb2JqZWN0XG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgQ1NTIG9iamVjdCBwYXJzZWQgYXMgYSBVaVNlbGVjdG9yXG4gKi9cbmZ1bmN0aW9uIHBhcnNlQ3NzT2JqZWN0IChjc3MpIHtcbiAgc3dpdGNoIChjc3MudHlwZSkge1xuICAgIGNhc2UgJ3J1bGUnOlxuICAgICAgcmV0dXJuIHBhcnNlQ3NzUnVsZShjc3MpO1xuICAgIGNhc2UgJ3J1bGVTZXQnOlxuICAgICAgcmV0dXJuIHBhcnNlQ3NzT2JqZWN0KGNzcy5ydWxlKTtcbiAgICBjYXNlICdzZWxlY3RvcnMnOlxuICAgICAgcmV0dXJuIGNzcy5zZWxlY3RvcnMubWFwKChzZWxlY3RvcikgPT4gcGFyc2VDc3NPYmplY3Qoc2VsZWN0b3IpKS5qb2luKCc7ICcpO1xuXG4gICAgZGVmYXVsdDpcbiAgICAgIC8vIFRoaXMgaXMgbmV2ZXIgcmVhY2hhYmxlLCBidXQgaWYgaXQgZXZlciBpcyBkbyB0aGlzLlxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBpT1MgQ2xhc3MgQ2hhaW4gZG9lcyBub3Qgc3VwcG9ydCAnJHtjc3MudHlwZX0nIGNzcy4gT25seSBzdXBwb3J0cyAncnVsZScsICdydWxlU2V0JywgJ3NlbGVjdG9ycydgKTtcbiAgfVxufVxuXG4vKipcbiAqIENvbnZlcnQgYSBDU1Mgc2VsZWN0b3IgdG8gYSBpT1MgQ2xhc3MgQ2hhaW4gc2VsZWN0b3JcbiAqIEBwYXJhbSB7c3RyaW5nfSBjc3NTZWxlY3RvciBDU1MgU2VsZWN0b3JcbiAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBDU1Mgc2VsZWN0b3IgY29udmVydGVkIHRvIGFuIGlPUyBDbGFzcyBDaGFpblxuICovXG5Dc3NDb252ZXJ0ZXIudG9Jb3NDbGFzc0NoYWluU2VsZWN0b3IgPSBmdW5jdGlvbiB0b0lvc0NsYXNzQ2hhaW5TZWxlY3RvciAoY3NzU2VsZWN0b3IpIHtcbiAgbGV0IGNzc09iajtcbiAgdHJ5IHtcbiAgICBjc3NPYmogPSBwYXJzZXIucGFyc2UoY3NzU2VsZWN0b3IpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkU2VsZWN0b3JFcnJvcihgSW52YWxpZCBDU1Mgc2VsZWN0b3IgJyR7Y3NzU2VsZWN0b3J9Jy4gUmVhc29uOiAnJHtlLm1lc3NhZ2V9J2ApO1xuICB9XG4gIHRyeSB7XG4gICAgcmV0dXJuIHBhcnNlQ3NzT2JqZWN0KGNzc09iaik7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRTZWxlY3RvckVycm9yKGBVbnN1cHBvcnRlZCBDU1Mgc2VsZWN0b3IgJyR7Y3NzU2VsZWN0b3J9Jy4gUmVhc29uOiAnJHtlLm1lc3NhZ2V9J2ApO1xuICB9XG59O1xuXG5leHBvcnQgZGVmYXVsdCBDc3NDb252ZXJ0ZXI7Il0sImZpbGUiOiJsaWIvY3NzLWNvbnZlcnRlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9

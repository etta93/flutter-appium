"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DEFAULT_TIMEOUT_KEY = void 0;
exports.checkAppPresent = checkAppPresent;
exports.clearLogs = clearLogs;
exports.clearSystemFiles = clearSystemFiles;
exports.detectUdid = detectUdid;
exports.encodeBase64OrUpload = encodeBase64OrUpload;
exports.getAndCheckIosSdkVersion = getAndCheckIosSdkVersion;
exports.getAndCheckXcodeVersion = getAndCheckXcodeVersion;
exports.getDriverInfo = getDriverInfo;
exports.getPIDsListeningOnPort = getPIDsListeningOnPort;
exports.isLocalHost = isLocalHost;
exports.markSystemFilesForCleanup = markSystemFilesForCleanup;
exports.normalizeCommandTimeouts = normalizeCommandTimeouts;
exports.normalizePlatformVersion = normalizePlatformVersion;
exports.printUser = printUser;
exports.removeAllSessionWebSocketHandlers = removeAllSessionWebSocketHandlers;
exports.translateDeviceName = translateDeviceName;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumIosDevice = require("appium-ios-device");

var _support = require("@appium/support");

var _path = _interopRequireDefault(require("path"));

var _teen_process = require("teen_process");

var _appiumXcode = _interopRequireDefault(require("appium-xcode"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _iosGenericSimulators = _interopRequireDefault(require("./ios-generic-simulators"));

var _url = _interopRequireDefault(require("url"));

var _os = _interopRequireDefault(require("os"));

var _semver = _interopRequireDefault(require("semver"));

const DEFAULT_TIMEOUT_KEY = 'default';
exports.DEFAULT_TIMEOUT_KEY = DEFAULT_TIMEOUT_KEY;
const XCTEST_LOG_FILES_PATTERNS = [/^Session-WebDriverAgentRunner.*\.log$/i, /^StandardOutputAndStandardError\.txt$/i];
const XCTEST_LOGS_CACHE_FOLDER_PREFIX = 'com.apple.dt.XCTest';

async function detectUdid() {
  _logger.default.debug('Auto-detecting real device udid...');

  const udids = await _appiumIosDevice.utilities.getConnectedDevices();

  if (_lodash.default.isEmpty(udids)) {
    throw new Error('No device is connected to the host');
  }

  const udid = _lodash.default.last(udids);

  if (udids.length > 1) {
    _logger.default.warn(`Multiple devices found: ${udids.join(', ')}`);

    _logger.default.warn(`Choosing '${udid}'. If this is wrong, manually set with 'udid' desired capability`);
  }

  _logger.default.debug(`Detected real device udid: '${udid}'`);

  return udid;
}

async function getAndCheckXcodeVersion() {
  let version;

  try {
    version = await _appiumXcode.default.getVersion(true);
  } catch (err) {
    _logger.default.debug(err);

    _logger.default.errorAndThrow(`Could not determine Xcode version: ${err.message}`);
  }

  if (version.versionFloat < 7.3) {
    _logger.default.errorAndThrow(`Xcode version '${version.versionString}'. Support for ` + `Xcode ${version.versionString} is not supported. ` + `Please upgrade to version 7.3 or higher`);
  }

  return version;
}

async function getAndCheckIosSdkVersion() {
  try {
    return await _appiumXcode.default.getMaxIOSSDK();
  } catch (err) {
    _logger.default.errorAndThrow(`Could not determine iOS SDK version: ${err.message}`);
  }
}

function getGenericSimulatorForIosVersion(platformVersion, deviceName) {
  let genericSimulators = _iosGenericSimulators.default[deviceName];

  if (genericSimulators) {
    genericSimulators = genericSimulators.sort(([simOne], [simTwo]) => _support.util.compareVersions(simOne, '<', simTwo) ? -1 : 1);
    let genericIosSimulator;

    for (const [platformVersionFromList, iosSimulator] of genericSimulators) {
      if (_support.util.compareVersions(platformVersionFromList, '>', platformVersion)) {
        break;
      }

      genericIosSimulator = iosSimulator;
    }

    return genericIosSimulator;
  }
}

function translateDeviceName(platformVersion, deviceName = '') {
  const deviceNameTranslated = getGenericSimulatorForIosVersion(platformVersion, deviceName.toLowerCase().trim());

  if (deviceNameTranslated) {
    _logger.default.debug(`Changing deviceName from '${deviceName}' to '${deviceNameTranslated}'`);

    return deviceNameTranslated;
  }

  return deviceName;
}

async function clearLogs(locations) {
  _logger.default.debug('Clearing log files');

  const cleanupPromises = [];

  for (const location of locations) {
    if (!(await _support.fs.exists(location))) {
      continue;
    }

    cleanupPromises.push((async () => {
      let size;

      try {
        const {
          stdout
        } = await (0, _teen_process.exec)('du', ['-sh', location]);
        size = stdout.trim().split(/\s+/)[0];
      } catch (ign) {}

      try {
        _logger.default.debug(`Deleting '${location}'. ${size ? `Freeing ${size}.` : ''}`);

        await _support.fs.rimraf(location);
      } catch (err) {
        _logger.default.warn(`Unable to delete '${location}': ${err.message}`);
      }
    })());
  }

  if (!_lodash.default.isEmpty(cleanupPromises)) {
    await _bluebird.default.all(cleanupPromises);
  }

  _logger.default.debug('Finished clearing log files');
}

const derivedDataCleanupMarkers = new Map();

async function markSystemFilesForCleanup(wda) {
  if (!wda || !(await wda.retrieveDerivedDataPath())) {
    _logger.default.warn('No WebDriverAgent derived data available, so unable to mark system files for cleanup');

    return;
  }

  const logsRoot = _path.default.resolve(await wda.retrieveDerivedDataPath(), 'Logs');

  let markersCount = 0;

  if (derivedDataCleanupMarkers.has(logsRoot)) {
    markersCount = derivedDataCleanupMarkers.get(logsRoot);
  }

  derivedDataCleanupMarkers.set(logsRoot, ++markersCount);
}

async function clearSystemFiles(wda) {
  if (!wda || !(await wda.retrieveDerivedDataPath())) {
    _logger.default.warn('No WebDriverAgent derived data available, so unable to clear system files');

    return;
  }

  const logsRoot = _path.default.resolve(await wda.retrieveDerivedDataPath(), 'Logs');

  if (derivedDataCleanupMarkers.has(logsRoot)) {
    let markersCount = derivedDataCleanupMarkers.get(logsRoot);
    derivedDataCleanupMarkers.set(logsRoot, --markersCount);

    if (markersCount > 0) {
      _logger.default.info(`Not cleaning '${logsRoot}' folder, because the other session does not expect it to be cleaned`);

      return;
    }
  }

  derivedDataCleanupMarkers.set(logsRoot, 0);
  const globPattern = `${_os.default.tmpdir()}/${XCTEST_LOGS_CACHE_FOLDER_PREFIX}*/`;
  const dstFolders = await _support.fs.glob(globPattern);

  if (_lodash.default.isEmpty(dstFolders)) {
    _logger.default.debug(`Did not find the temporary XCTest logs root at '${globPattern}'`);
  } else {
    for (const dstFolder of dstFolders) {
      let scheduledFilesCount = 0;

      _bluebird.default.resolve(_support.fs.walkDir(dstFolder, true, (itemPath, isDir) => {
        if (isDir) {
          return;
        }

        const fileName = _path.default.basename(itemPath);

        if (!XCTEST_LOG_FILES_PATTERNS.some(p => p.test(fileName))) {
          return;
        }

        _support.fs.unlink(itemPath).catch(e => {
          _logger.default.info(e.message);
        });

        scheduledFilesCount++;
      })).finally(() => {
        if (scheduledFilesCount > 0) {
          _logger.default.info(`Scheduled ${scheduledFilesCount} temporary XCTest log ` + `${_support.util.pluralize('file', scheduledFilesCount)} for cleanup in '${dstFolder}'`);
        }
      }).catch(e => {
        _logger.default.info(e.message);
      });
    }

    _logger.default.debug(`Started background XCTest logs cleanup in '${dstFolders}'`);
  }

  if (await _support.fs.exists(logsRoot)) {
    _logger.default.info(`Cleaning test logs in '${logsRoot}' folder`);

    await clearLogs([logsRoot]);
    return;
  }

  _logger.default.info(`There is no ${logsRoot} folder, so not cleaning files`);
}

async function checkAppPresent(app) {
  _logger.default.debug(`Checking whether app '${app}' is actually present on file system`);

  if (!(await _support.fs.exists(app))) {
    _logger.default.errorAndThrow(`Could not find app at '${app}'`);
  }

  _logger.default.debug('App is present');
}

async function getDriverInfo() {
  const stat = await _support.fs.stat(_path.default.resolve(__dirname, '..'));
  const built = stat.mtime.getTime();

  const pkg = require(__filename.includes('build/lib/utils') ? '../../package.json' : '../package.json');

  const version = pkg.version;
  return {
    built,
    version
  };
}

function normalizeCommandTimeouts(value) {
  if (typeof value !== 'string') {
    return value;
  }

  let result = {};

  if (!isNaN(value)) {
    result[DEFAULT_TIMEOUT_KEY] = _lodash.default.toInteger(value);
    return result;
  }

  try {
    result = JSON.parse(value);

    if (!_lodash.default.isPlainObject(result)) {
      throw new Error();
    }
  } catch (err) {
    _logger.default.errorAndThrow(`"commandTimeouts" capability should be a valid JSON object. "${value}" was given instead`);
  }

  for (let [cmd, timeout] of _lodash.default.toPairs(result)) {
    if (!_lodash.default.isInteger(timeout) || timeout <= 0) {
      _logger.default.errorAndThrow(`The timeout for "${cmd}" should be a valid natural number of milliseconds. "${timeout}" was given instead`);
    }
  }

  return result;
}

async function printUser() {
  try {
    let {
      stdout
    } = await (0, _teen_process.exec)('whoami');

    _logger.default.debug(`Current user: '${stdout.trim()}'`);
  } catch (err) {
    _logger.default.debug(`Unable to get username running server: ${err.message}`);
  }
}

async function getPIDsListeningOnPort(port, filteringFunc = null) {
  const result = [];

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)('lsof', ['-ti', `tcp:${port}`]);
    result.push(...stdout.trim().split(/\n+/));
  } catch (e) {
    return result;
  }

  if (!_lodash.default.isFunction(filteringFunc)) {
    return result;
  }

  return await _bluebird.default.filter(result, async x => {
    const {
      stdout
    } = await (0, _teen_process.exec)('ps', ['-p', x, '-o', 'command']);
    return await filteringFunc(stdout);
  });
}

async function encodeBase64OrUpload(localPath, remotePath = null, uploadOptions = {}) {
  if (!(await _support.fs.exists(localPath))) {
    _logger.default.errorAndThrow(`The file at '${localPath}' does not exist or is not accessible`);
  }

  if (_lodash.default.isEmpty(remotePath)) {
    const {
      size
    } = await _support.fs.stat(localPath);

    _logger.default.debug(`The size of the file is ${_support.util.toReadableSizeString(size)}`);

    return (await _support.util.toInMemoryBase64(localPath)).toString();
  }

  const {
    user,
    pass,
    method,
    headers,
    fileFieldName,
    formFields
  } = uploadOptions;
  const options = {
    method: method || 'PUT',
    headers,
    fileFieldName,
    formFields
  };

  if (user && pass) {
    options.auth = {
      user,
      pass
    };
  }

  await _support.net.uploadFile(localPath, remotePath, options);
  return '';
}

async function removeAllSessionWebSocketHandlers(server, sessionId) {
  if (!server || !_lodash.default.isFunction(server.getWebSocketHandlers)) {
    return;
  }

  const activeHandlers = await server.getWebSocketHandlers(sessionId);

  for (const pathname of _lodash.default.keys(activeHandlers)) {
    await server.removeWebSocketHandler(pathname);
  }
}

function isLocalHost(urlString) {
  try {
    const {
      hostname
    } = _url.default.parse(urlString);

    return ['localhost', '127.0.0.1', '::1', '::ffff:127.0.0.1'].includes(hostname);
  } catch (ign) {
    _logger.default.warn(`'${urlString}' cannot be parsed as a valid URL`);
  }

  return false;
}

function normalizePlatformVersion(originalVersion) {
  const normalizedVersion = _semver.default.coerce(originalVersion);

  if (!normalizedVersion) {
    throw new Error(`The platform version '${originalVersion}' should be a valid version number`);
  }

  return `${normalizedVersion.major}.${normalizedVersion.minor}`;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1RJTUVPVVRfS0VZIiwiWENURVNUX0xPR19GSUxFU19QQVRURVJOUyIsIlhDVEVTVF9MT0dTX0NBQ0hFX0ZPTERFUl9QUkVGSVgiLCJkZXRlY3RVZGlkIiwibG9nIiwiZGVidWciLCJ1ZGlkcyIsInV0aWxpdGllcyIsImdldENvbm5lY3RlZERldmljZXMiLCJfIiwiaXNFbXB0eSIsIkVycm9yIiwidWRpZCIsImxhc3QiLCJsZW5ndGgiLCJ3YXJuIiwiam9pbiIsImdldEFuZENoZWNrWGNvZGVWZXJzaW9uIiwidmVyc2lvbiIsInhjb2RlIiwiZ2V0VmVyc2lvbiIsImVyciIsImVycm9yQW5kVGhyb3ciLCJtZXNzYWdlIiwidmVyc2lvbkZsb2F0IiwidmVyc2lvblN0cmluZyIsImdldEFuZENoZWNrSW9zU2RrVmVyc2lvbiIsImdldE1heElPU1NESyIsImdldEdlbmVyaWNTaW11bGF0b3JGb3JJb3NWZXJzaW9uIiwicGxhdGZvcm1WZXJzaW9uIiwiZGV2aWNlTmFtZSIsImdlbmVyaWNTaW11bGF0b3JzIiwiaW9zR2VuZXJpY1NpbXVsYXRvcnMiLCJzb3J0Iiwic2ltT25lIiwic2ltVHdvIiwidXRpbCIsImNvbXBhcmVWZXJzaW9ucyIsImdlbmVyaWNJb3NTaW11bGF0b3IiLCJwbGF0Zm9ybVZlcnNpb25Gcm9tTGlzdCIsImlvc1NpbXVsYXRvciIsInRyYW5zbGF0ZURldmljZU5hbWUiLCJkZXZpY2VOYW1lVHJhbnNsYXRlZCIsInRvTG93ZXJDYXNlIiwidHJpbSIsImNsZWFyTG9ncyIsImxvY2F0aW9ucyIsImNsZWFudXBQcm9taXNlcyIsImxvY2F0aW9uIiwiZnMiLCJleGlzdHMiLCJwdXNoIiwic2l6ZSIsInN0ZG91dCIsInNwbGl0IiwiaWduIiwicmltcmFmIiwiQiIsImFsbCIsImRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMiLCJNYXAiLCJtYXJrU3lzdGVtRmlsZXNGb3JDbGVhbnVwIiwid2RhIiwicmV0cmlldmVEZXJpdmVkRGF0YVBhdGgiLCJsb2dzUm9vdCIsInBhdGgiLCJyZXNvbHZlIiwibWFya2Vyc0NvdW50IiwiaGFzIiwiZ2V0Iiwic2V0IiwiY2xlYXJTeXN0ZW1GaWxlcyIsImluZm8iLCJnbG9iUGF0dGVybiIsIm9zIiwidG1wZGlyIiwiZHN0Rm9sZGVycyIsImdsb2IiLCJkc3RGb2xkZXIiLCJzY2hlZHVsZWRGaWxlc0NvdW50Iiwid2Fsa0RpciIsIml0ZW1QYXRoIiwiaXNEaXIiLCJmaWxlTmFtZSIsImJhc2VuYW1lIiwic29tZSIsInAiLCJ0ZXN0IiwidW5saW5rIiwiY2F0Y2giLCJlIiwiZmluYWxseSIsInBsdXJhbGl6ZSIsImNoZWNrQXBwUHJlc2VudCIsImFwcCIsImdldERyaXZlckluZm8iLCJzdGF0IiwiX19kaXJuYW1lIiwiYnVpbHQiLCJtdGltZSIsImdldFRpbWUiLCJwa2ciLCJyZXF1aXJlIiwiX19maWxlbmFtZSIsImluY2x1ZGVzIiwibm9ybWFsaXplQ29tbWFuZFRpbWVvdXRzIiwidmFsdWUiLCJyZXN1bHQiLCJpc05hTiIsInRvSW50ZWdlciIsIkpTT04iLCJwYXJzZSIsImlzUGxhaW5PYmplY3QiLCJjbWQiLCJ0aW1lb3V0IiwidG9QYWlycyIsImlzSW50ZWdlciIsInByaW50VXNlciIsImdldFBJRHNMaXN0ZW5pbmdPblBvcnQiLCJwb3J0IiwiZmlsdGVyaW5nRnVuYyIsImlzRnVuY3Rpb24iLCJmaWx0ZXIiLCJ4IiwiZW5jb2RlQmFzZTY0T3JVcGxvYWQiLCJsb2NhbFBhdGgiLCJyZW1vdGVQYXRoIiwidXBsb2FkT3B0aW9ucyIsInRvUmVhZGFibGVTaXplU3RyaW5nIiwidG9Jbk1lbW9yeUJhc2U2NCIsInRvU3RyaW5nIiwidXNlciIsInBhc3MiLCJtZXRob2QiLCJoZWFkZXJzIiwiZmlsZUZpZWxkTmFtZSIsImZvcm1GaWVsZHMiLCJvcHRpb25zIiwiYXV0aCIsIm5ldCIsInVwbG9hZEZpbGUiLCJyZW1vdmVBbGxTZXNzaW9uV2ViU29ja2V0SGFuZGxlcnMiLCJzZXJ2ZXIiLCJzZXNzaW9uSWQiLCJnZXRXZWJTb2NrZXRIYW5kbGVycyIsImFjdGl2ZUhhbmRsZXJzIiwicGF0aG5hbWUiLCJrZXlzIiwicmVtb3ZlV2ViU29ja2V0SGFuZGxlciIsImlzTG9jYWxIb3N0IiwidXJsU3RyaW5nIiwiaG9zdG5hbWUiLCJ1cmwiLCJub3JtYWxpemVQbGF0Zm9ybVZlcnNpb24iLCJvcmlnaW5hbFZlcnNpb24iLCJub3JtYWxpemVkVmVyc2lvbiIsInNlbXZlciIsImNvZXJjZSIsIm1ham9yIiwibWlub3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLG1CQUFtQixHQUFHLFNBQTVCOztBQUNBLE1BQU1DLHlCQUF5QixHQUFHLENBQ2hDLHdDQURnQyxFQUVoQyx3Q0FGZ0MsQ0FBbEM7QUFJQSxNQUFNQywrQkFBK0IsR0FBRyxxQkFBeEM7O0FBR0EsZUFBZUMsVUFBZixHQUE2QjtBQUMzQkMsa0JBQUlDLEtBQUosQ0FBVSxvQ0FBVjs7QUFDQSxRQUFNQyxLQUFLLEdBQUcsTUFBTUMsMkJBQVVDLG1CQUFWLEVBQXBCOztBQUNBLE1BQUlDLGdCQUFFQyxPQUFGLENBQVVKLEtBQVYsQ0FBSixFQUFzQjtBQUNwQixVQUFNLElBQUlLLEtBQUosQ0FBVSxvQ0FBVixDQUFOO0FBQ0Q7O0FBQ0QsUUFBTUMsSUFBSSxHQUFHSCxnQkFBRUksSUFBRixDQUFPUCxLQUFQLENBQWI7O0FBQ0EsTUFBSUEsS0FBSyxDQUFDUSxNQUFOLEdBQWUsQ0FBbkIsRUFBc0I7QUFDcEJWLG9CQUFJVyxJQUFKLENBQVUsMkJBQTBCVCxLQUFLLENBQUNVLElBQU4sQ0FBVyxJQUFYLENBQWlCLEVBQXJEOztBQUNBWixvQkFBSVcsSUFBSixDQUFVLGFBQVlILElBQUssa0VBQTNCO0FBQ0Q7O0FBQ0RSLGtCQUFJQyxLQUFKLENB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QUFNSCxNQUFNLENBQUNNLHNCQUFQLENBQThCRixRQUE5QixDQUFOO0FBQ0Q7QUFDRjs7QUFPRCxTQUFTRyxXQUFULENBQXNCQyxTQUF0QixFQUFpQztBQUMvQixNQUFJO0FBQ0YsVUFBTTtBQUFDQyxNQUFBQTtBQUFELFFBQWFDLGFBQUl6QyxLQUFKLENBQVV1QyxTQUFWLENBQW5COztBQUNBLFdBQU8sQ0FBQyxXQUFELEVBQWMsV0FBZCxFQUEyQixLQUEzQixFQUFrQyxrQkFBbEMsRUFBc0Q5QyxRQUF0RCxDQUErRCtDLFFBQS9ELENBQVA7QUFDRCxHQUhELENBR0UsT0FBT2hHLEdBQVAsRUFBWTtBQUNabkQsb0JBQUlXLElBQUosQ0FBVSxJQUFHdUksU0FBVSxtQ0FBdkI7QUFDRDs7QUFDRCxTQUFPLEtBQVA7QUFDRDs7QUFTRCxTQUFTRyx3QkFBVCxDQUFtQ0MsZUFBbkMsRUFBb0Q7QUFDbEQsUUFBTUMsaUJBQWlCLEdBQUdDLGdCQUFPQyxNQUFQLENBQWNILGVBQWQsQ0FBMUI7O0FBQ0EsTUFBSSxDQUFDQyxpQkFBTCxFQUF3QjtBQUN0QixVQUFNLElBQUloSixLQUFKLENBQVcseUJBQXdCK0ksZUFBZ0Isb0NBQW5ELENBQU47QUFDRDs7QUFDRCxTQUFRLEdBQUVDLGlCQUFpQixDQUFDRyxLQUFNLElBQUdILGlCQUFpQixDQUFDSSxLQUFNLEVBQTdEO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyB1dGlsaXRpZXMgfSBmcm9tICdhcHBpdW0taW9zLWRldmljZSc7XG5pbXBvcnQgeyBmcywgdXRpbCwgbmV0IH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBpb3NHZW5lcmljU2ltdWxhdG9ycyBmcm9tICcuL2lvcy1nZW5lcmljLXNpbXVsYXRvcnMnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcblxuXG5jb25zdCBERUZBVUxUX1RJTUVPVVRfS0VZID0gJ2RlZmF1bHQnO1xuY29uc3QgWENURVNUX0xPR19GSUxFU19QQVRURVJOUyA9IFtcbiAgL15TZXNzaW9uLVdlYkRyaXZlckFnZW50UnVubmVyLipcXC5sb2ckL2ksXG4gIC9eU3RhbmRhcmRPdXRwdXRBbmRTdGFuZGFyZEVycm9yXFwudHh0JC9pLFxuXTtcbmNvbnN0IFhDVEVTVF9MT0dTX0NBQ0hFX0ZPTERFUl9QUkVGSVggPSAnY29tLmFwcGxlLmR0LlhDVGVzdCc7XG5cblxuYXN5bmMgZnVuY3Rpb24gZGV0ZWN0VWRpZCAoKSB7XG4gIGxvZy5kZWJ1ZygnQXV0by1kZXRlY3RpbmcgcmVhbCBkZXZpY2UgdWRpZC4uLicpO1xuICBjb25zdCB1ZGlkcyA9IGF3YWl0IHV0aWxpdGllcy5nZXRDb25uZWN0ZWREZXZpY2VzKCk7XG4gIGlmIChfLmlzRW1wdHkodWRpZHMpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdObyBkZXZpY2UgaXMgY29ubmVjdGVkIHRvIHRoZSBob3N0Jyk7XG4gIH1cbiAgY29uc3QgdWRpZCA9IF8ubGFzdCh1ZGlkcyk7XG4gIGlmICh1ZGlkcy5sZW5ndGggPiAxKSB7XG4gICAgbG9nLndhcm4oYE11bHRpcGxlIGRldmljZXMgZm91bmQ6ICR7dWRpZHMuam9pbignLCAnKX1gKTtcbiAgICBsb2cud2FybihgQ2hvb3NpbmcgJyR7dWRpZH0nLiBJZiB0aGlzIGlzIHdyb25nLCBtYW51YWxseSBzZXQgd2l0aCAndWRpZCcgZGVzaXJlZCBjYXBhYmlsaXR5YCk7XG4gIH1cbiAgbG9nLmRlYnVnKGBEZXRlY3RlZCByZWFsIGRldmljZSB1ZGlkOiAnJHt1ZGlkfSdgKTtcbiAgcmV0dXJuIHVkaWQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFuZENoZWNrWGNvZGVWZXJzaW9uICgpIHtcbiAgbGV0IHZlcnNpb247XG4gIHRyeSB7XG4gICAgdmVyc2lvbiA9IGF3YWl0IHhjb2RlLmdldFZlcnNpb24odHJ1ZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5kZWJ1ZyhlcnIpO1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgZGV0ZXJtaW5lIFhjb2RlIHZlcnNpb246ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cblxuICAvLyB3ZSBkbyBub3Qgc3VwcG9ydCBYY29kZXMgPCA3LjMsXG4gIGlmICh2ZXJzaW9uLnZlcnNpb25GbG9hdCA8IDcuMykge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBYY29kZSB2ZXJzaW9uICcke3ZlcnNpb24udmVyc2lvblN0cmluZ30nLiBTdXBwb3J0IGZvciBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgWGNvZGUgJHt2ZXJzaW9uLnZlcnNpb25TdHJpbmd9IGlzIG5vdCBzdXBwb3J0ZWQuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGBQbGVhc2UgdXBncmFkZSB0byB2ZXJzaW9uIDcuMyBvciBoaWdoZXJgKTtcbiAgfVxuICByZXR1cm4gdmVyc2lvbjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QW5kQ2hlY2tJb3NTZGtWZXJzaW9uICgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgeGNvZGUuZ2V0TWF4SU9TU0RLKCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgZGV0ZXJtaW5lIGlPUyBTREsgdmVyc2lvbjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCB0aGUgZ2VuZXJpYyBzaW11bGF0b3IgZm9yIGEgZ2l2ZW4gSU9TIHZlcnNpb24gYW5kIGRldmljZSB0eXBlIChpUGhvbmUsIGlQYWQpXG4gKlxuICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBwbGF0Zm9ybVZlcnNpb24gSU9TIHZlcnNpb24uIGUuZy4pIDEzLjBcbiAqIEBwYXJhbSB7c3RyaW5nfSBkZXZpY2VOYW1lIFR5cGUgb2YgSU9TIGRldmljZS4gQ2FuIGJlIGlQaG9uZSwgaVBhZCAocG9zc2libHkgbW9yZSBpbiB0aGUgZnV0dXJlKVxuICpcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEdlbmVyaWMgaVBob25lIG9yIGlQYWQgc2ltdWxhdG9yIChpZiBhcHBsaWNhYmxlKVxuICovXG5mdW5jdGlvbiBnZXRHZW5lcmljU2ltdWxhdG9yRm9ySW9zVmVyc2lvbiAocGxhdGZvcm1WZXJzaW9uLCBkZXZpY2VOYW1lKSB7XG4gIGxldCBnZW5lcmljU2ltdWxhdG9ycyA9IGlvc0dlbmVyaWNTaW11bGF0b3JzW2RldmljZU5hbWVdO1xuXG4gIGlmIChnZW5lcmljU2ltdWxhdG9ycykge1xuICAgIGdlbmVyaWNTaW11bGF0b3JzID0gZ2VuZXJpY1NpbXVsYXRvcnMuc29ydCgoW3NpbU9uZV0sIFtzaW1Ud29dKSA9PiB1dGlsLmNvbXBhcmVWZXJzaW9ucyhzaW1PbmUsICc8Jywgc2ltVHdvKSA/IC0xIDogMSk7XG5cbiAgICAvLyBGaW5kIHRoZSBoaWdoZXN0IGlPUyB2ZXJzaW9uIGluIHRoZSBsaXN0IHRoYXQgaXMgYmVsb3cgdGhlIHByb3ZpZGVkIHZlcnNpb25cbiAgICBsZXQgZ2VuZXJpY0lvc1NpbXVsYXRvcjtcbiAgICBmb3IgKGNvbnN0IFtwbGF0Zm9ybVZlcnNpb25Gcm9tTGlzdCwgaW9zU2ltdWxhdG9yXSBvZiBnZW5lcmljU2ltdWxhdG9ycykge1xuICAgICAgaWYgKHV0aWwuY29tcGFyZVZlcnNpb25zKHBsYXRmb3JtVmVyc2lvbkZyb21MaXN0LCAnPicsIHBsYXRmb3JtVmVyc2lvbikpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBnZW5lcmljSW9zU2ltdWxhdG9yID0gaW9zU2ltdWxhdG9yO1xuICAgIH1cbiAgICByZXR1cm4gZ2VuZXJpY0lvc1NpbXVsYXRvcjtcbiAgfVxufVxuXG5mdW5jdGlvbiB0cmFuc2xhdGVEZXZpY2VOYW1lIChwbGF0Zm9ybVZlcnNpb24sIGRldmljZU5hbWUgPSAnJykge1xuICBjb25zdCBkZXZpY2VOYW1lVHJhbnNsYXRlZCA9IGdldEdlbmVyaWNTaW11bGF0b3JGb3JJb3NWZXJzaW9uKHBsYXRmb3JtVmVyc2lvbiwgZGV2aWNlTmFtZS50b0xvd2VyQ2FzZSgpLnRyaW0oKSk7XG4gIGlmIChkZXZpY2VOYW1lVHJhbnNsYXRlZCkge1xuICAgIGxvZy5kZWJ1ZyhgQ2hhbmdpbmcgZGV2aWNlTmFtZSBmcm9tICcke2RldmljZU5hbWV9JyB0byAnJHtkZXZpY2VOYW1lVHJhbnNsYXRlZH0nYCk7XG4gICAgcmV0dXJuIGRldmljZU5hbWVUcmFuc2xhdGVkO1xuICB9XG4gIHJldHVybiBkZXZpY2VOYW1lO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjbGVhckxvZ3MgKGxvY2F0aW9ucykge1xuICBsb2cuZGVidWcoJ0NsZWFyaW5nIGxvZyBmaWxlcycpO1xuICBjb25zdCBjbGVhbnVwUHJvbWlzZXMgPSBbXTtcbiAgZm9yIChjb25zdCBsb2NhdGlvbiBvZiBsb2NhdGlvbnMpIHtcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhsb2NhdGlvbikpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGNsZWFudXBQcm9taXNlcy5wdXNoKChhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc2l6ZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnZHUnLCBbJy1zaCcsIGxvY2F0aW9uXSk7XG4gICAgICAgIHNpemUgPSBzdGRvdXQudHJpbSgpLnNwbGl0KC9cXHMrLylbMF07XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICB0cnkge1xuICAgICAgICBsb2cuZGVidWcoYERlbGV0aW5nICcke2xvY2F0aW9ufScuICR7c2l6ZSA/IGBGcmVlaW5nICR7c2l6ZX0uYCA6ICcnfWApO1xuICAgICAgICBhd2FpdCBmcy5yaW1yYWYobG9jYXRpb24pO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZy53YXJuKGBVbmFibGUgdG8gZGVsZXRlICcke2xvY2F0aW9ufSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfSkoKSk7XG4gIH1cbiAgaWYgKCFfLmlzRW1wdHkoY2xlYW51cFByb21pc2VzKSkge1xuICAgIGF3YWl0IEIuYWxsKGNsZWFudXBQcm9taXNlcyk7XG4gIH1cbiAgbG9nLmRlYnVnKCdGaW5pc2hlZCBjbGVhcmluZyBsb2cgZmlsZXMnKTtcbn1cblxuLy8gVGhpcyBtYXAgY29udGFpbnMgZGVyaXZlZCBkYXRhIGxvZ3MgZm9sZGVycyBhcyBrZXlzXG4vLyBhbmQgdmFsdWVzIGFyZSB0aGUgY291bnQgb2YgdGltZXMgdGhlIHBhcnRpY3VsYXJcbi8vIGZvbGRlciBoYXMgYmVlbiBzY2hlZHVsZWQgZm9yIHJlbW92YWxcbmNvbnN0IGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMgPSBuZXcgTWFwKCk7XG5cbmFzeW5jIGZ1bmN0aW9uIG1hcmtTeXN0ZW1GaWxlc0ZvckNsZWFudXAgKHdkYSkge1xuICBpZiAoIXdkYSB8fCAhYXdhaXQgd2RhLnJldHJpZXZlRGVyaXZlZERhdGFQYXRoKCkpIHtcbiAgICBsb2cud2FybignTm8gV2ViRHJpdmVyQWdlbnQgZGVyaXZlZCBkYXRhIGF2YWlsYWJsZSwgc28gdW5hYmxlIHRvIG1hcmsgc3lzdGVtIGZpbGVzIGZvciBjbGVhbnVwJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgbG9nc1Jvb3QgPSBwYXRoLnJlc29sdmUoYXdhaXQgd2RhLnJldHJpZXZlRGVyaXZlZERhdGFQYXRoKCksICdMb2dzJyk7XG4gIGxldCBtYXJrZXJzQ291bnQgPSAwO1xuICBpZiAoZGVyaXZlZERhdGFDbGVhbnVwTWFya2Vycy5oYXMobG9nc1Jvb3QpKSB7XG4gICAgbWFya2Vyc0NvdW50ID0gZGVyaXZlZERhdGFDbGVhbnVwTWFya2Vycy5nZXQobG9nc1Jvb3QpO1xuICB9XG4gIGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMuc2V0KGxvZ3NSb290LCArK21hcmtlcnNDb3VudCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNsZWFyU3lzdGVtRmlsZXMgKHdkYSkge1xuICAvLyBvbmx5IHdhbnQgdG8gY2xlYXIgdGhlIHN5c3RlbSBmaWxlcyBmb3IgdGhlIHBhcnRpY3VsYXIgV0RBIHhjb2RlIHJ1blxuICBpZiAoIXdkYSB8fCAhYXdhaXQgd2RhLnJldHJpZXZlRGVyaXZlZERhdGFQYXRoKCkpIHtcbiAgICBsb2cud2FybignTm8gV2ViRHJpdmVyQWdlbnQgZGVyaXZlZCBkYXRhIGF2YWlsYWJsZSwgc28gdW5hYmxlIHRvIGNsZWFyIHN5c3RlbSBmaWxlcycpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGxvZ3NSb290ID0gcGF0aC5yZXNvbHZlKGF3YWl0IHdkYS5yZXRyaWV2ZURlcml2ZWREYXRhUGF0aCgpLCAnTG9ncycpO1xuICBpZiAoZGVyaXZlZERhdGFDbGVhbnVwTWFya2Vycy5oYXMobG9nc1Jvb3QpKSB7XG4gICAgbGV0IG1hcmtlcnNDb3VudCA9IGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMuZ2V0KGxvZ3NSb290KTtcbiAgICBkZXJpdmVkRGF0YUNsZWFudXBNYXJrZXJzLnNldChsb2dzUm9vdCwgLS1tYXJrZXJzQ291bnQpO1xuICAgIGlmIChtYXJrZXJzQ291bnQgPiAwKSB7XG4gICAgICBsb2cuaW5mbyhgTm90IGNsZWFuaW5nICcke2xvZ3NSb290fScgZm9sZGVyLCBiZWNhdXNlIHRoZSBvdGhlciBzZXNzaW9uIGRvZXMgbm90IGV4cGVjdCBpdCB0byBiZSBjbGVhbmVkYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG4gIGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMuc2V0KGxvZ3NSb290LCAwKTtcblxuICAvLyBDbGVhbmluZyB1cCBiaWcgdGVtcG9yYXJ5IGZpbGVzIGNyZWF0ZWQgYnkgWENUZXN0OiBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvOTQxMFxuICBjb25zdCBnbG9iUGF0dGVybiA9IGAke29zLnRtcGRpcigpfS8ke1hDVEVTVF9MT0dTX0NBQ0hFX0ZPTERFUl9QUkVGSVh9Ki9gO1xuICBjb25zdCBkc3RGb2xkZXJzID0gYXdhaXQgZnMuZ2xvYihnbG9iUGF0dGVybik7XG4gIGlmIChfLmlzRW1wdHkoZHN0Rm9sZGVycykpIHtcbiAgICBsb2cuZGVidWcoYERpZCBub3QgZmluZCB0aGUgdGVtcG9yYXJ5IFhDVGVzdCBsb2dzIHJvb3QgYXQgJyR7Z2xvYlBhdHRlcm59J2ApO1xuICB9IGVsc2Uge1xuICAgIC8vIHBlcmZvcm0gdGhlIGNsZWFudXAgYXN5bmNocm9ub3VzbHlcbiAgICBmb3IgKGNvbnN0IGRzdEZvbGRlciBvZiBkc3RGb2xkZXJzKSB7XG4gICAgICBsZXQgc2NoZWR1bGVkRmlsZXNDb3VudCA9IDA7XG4gICAgICBCLnJlc29sdmUoZnMud2Fsa0Rpcihkc3RGb2xkZXIsIHRydWUsIChpdGVtUGF0aCwgaXNEaXIpID0+IHtcbiAgICAgICAgaWYgKGlzRGlyKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGZpbGVOYW1lID0gcGF0aC5iYXNlbmFtZShpdGVtUGF0aCk7XG4gICAgICAgIGlmICghWENURVNUX0xPR19GSUxFU19QQVRURVJOUy5zb21lKChwKSA9PiBwLnRlc3QoZmlsZU5hbWUpKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGRlbGV0ZSB0aGUgZmlsZSBhc3luY2hyb25vdXNseVxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tdGhlblxuICAgICAgICBmcy51bmxpbmsoaXRlbVBhdGgpLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgbG9nLmluZm8oZS5tZXNzYWdlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHNjaGVkdWxlZEZpbGVzQ291bnQrKztcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLXRoZW5cbiAgICAgIH0pKS5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgaWYgKHNjaGVkdWxlZEZpbGVzQ291bnQgPiAwKSB7XG4gICAgICAgICAgbG9nLmluZm8oYFNjaGVkdWxlZCAke3NjaGVkdWxlZEZpbGVzQ291bnR9IHRlbXBvcmFyeSBYQ1Rlc3QgbG9nIGAgK1xuICAgICAgICAgICAgYCR7dXRpbC5wbHVyYWxpemUoJ2ZpbGUnLCBzY2hlZHVsZWRGaWxlc0NvdW50KX0gZm9yIGNsZWFudXAgaW4gJyR7ZHN0Rm9sZGVyfSdgKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tdGhlblxuICAgICAgfSkuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgbG9nLmluZm8oZS5tZXNzYWdlKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFN0YXJ0ZWQgYmFja2dyb3VuZCBYQ1Rlc3QgbG9ncyBjbGVhbnVwIGluICcke2RzdEZvbGRlcnN9J2ApO1xuICB9XG5cbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhsb2dzUm9vdCkpIHtcbiAgICBsb2cuaW5mbyhgQ2xlYW5pbmcgdGVzdCBsb2dzIGluICcke2xvZ3NSb290fScgZm9sZGVyYCk7XG4gICAgYXdhaXQgY2xlYXJMb2dzKFtsb2dzUm9vdF0pO1xuICAgIHJldHVybjtcbiAgfVxuICBsb2cuaW5mbyhgVGhlcmUgaXMgbm8gJHtsb2dzUm9vdH0gZm9sZGVyLCBzbyBub3QgY2xlYW5pbmcgZmlsZXNgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tBcHBQcmVzZW50IChhcHApIHtcbiAgbG9nLmRlYnVnKGBDaGVja2luZyB3aGV0aGVyIGFwcCAnJHthcHB9JyBpcyBhY3R1YWxseSBwcmVzZW50IG9uIGZpbGUgc3lzdGVtYCk7XG4gIGlmICghKGF3YWl0IGZzLmV4aXN0cyhhcHApKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgZmluZCBhcHAgYXQgJyR7YXBwfSdgKTtcbiAgfVxuICBsb2cuZGVidWcoJ0FwcCBpcyBwcmVzZW50Jyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldERyaXZlckluZm8gKCkge1xuICBjb25zdCBzdGF0ID0gYXdhaXQgZnMuc3RhdChwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nKSk7XG4gIGNvbnN0IGJ1aWx0ID0gc3RhdC5tdGltZS5nZXRUaW1lKCk7XG5cbiAgLy8gZ2V0IHRoZSBwYWNrYWdlLmpzb24gYW5kIHRoZSB2ZXJzaW9uIGZyb20gaXRcbiAgY29uc3QgcGtnID0gcmVxdWlyZShfX2ZpbGVuYW1lLmluY2x1ZGVzKCdidWlsZC9saWIvdXRpbHMnKSA/ICcuLi8uLi9wYWNrYWdlLmpzb24nIDogJy4uL3BhY2thZ2UuanNvbicpO1xuICBjb25zdCB2ZXJzaW9uID0gcGtnLnZlcnNpb247XG5cbiAgcmV0dXJuIHtcbiAgICBidWlsdCxcbiAgICB2ZXJzaW9uLFxuICB9O1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVDb21tYW5kVGltZW91dHMgKHZhbHVlKSB7XG4gIC8vIFRoZSB2YWx1ZSBpcyBub3JtYWxpemVkIGFscmVhZHlcbiAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICBsZXQgcmVzdWx0ID0ge307XG4gIC8vIFVzZSBhcyBkZWZhdWx0IHRpbWVvdXQgZm9yIGFsbCBjb21tYW5kcyBpZiBhIHNpbmdsZSBpbnRlZ2VyIHZhbHVlIGlzIHByb3ZpZGVkXG4gIGlmICghaXNOYU4odmFsdWUpKSB7XG4gICAgcmVzdWx0W0RFRkFVTFRfVElNRU9VVF9LRVldID0gXy50b0ludGVnZXIodmFsdWUpO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvLyBKU09OIG9iamVjdCBoYXMgYmVlbiBwcm92aWRlZC4gTGV0J3MgcGFyc2UgaXRcbiAgdHJ5IHtcbiAgICByZXN1bHQgPSBKU09OLnBhcnNlKHZhbHVlKTtcbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChyZXN1bHQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBcImNvbW1hbmRUaW1lb3V0c1wiIGNhcGFiaWxpdHkgc2hvdWxkIGJlIGEgdmFsaWQgSlNPTiBvYmplY3QuIFwiJHt2YWx1ZX1cIiB3YXMgZ2l2ZW4gaW5zdGVhZGApO1xuICB9XG4gIGZvciAobGV0IFtjbWQsIHRpbWVvdXRdIG9mIF8udG9QYWlycyhyZXN1bHQpKSB7XG4gICAgaWYgKCFfLmlzSW50ZWdlcih0aW1lb3V0KSB8fCB0aW1lb3V0IDw9IDApIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgdGltZW91dCBmb3IgXCIke2NtZH1cIiBzaG91bGQgYmUgYSB2YWxpZCBuYXR1cmFsIG51bWJlciBvZiBtaWxsaXNlY29uZHMuIFwiJHt0aW1lb3V0fVwiIHdhcyBnaXZlbiBpbnN0ZWFkYCk7XG4gICAgfVxuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHByaW50VXNlciAoKSB7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnd2hvYW1pJyk7XG4gICAgbG9nLmRlYnVnKGBDdXJyZW50IHVzZXI6ICcke3N0ZG91dC50cmltKCl9J2ApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYFVuYWJsZSB0byBnZXQgdXNlcm5hbWUgcnVubmluZyBzZXJ2ZXI6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZXQgdGhlIElEcyBvZiBwcm9jZXNzZXMgbGlzdGVuaW5nIG9uIHRoZSBwYXJ0aWN1bGFyIHN5c3RlbSBwb3J0LlxuICogSXQgaXMgYWxzbyBwb3NzaWJsZSB0byBhcHBseSBhZGRpdGlvbmFsIGZpbHRlcmluZyBiYXNlZCBvbiB0aGVcbiAqIHByb2Nlc3MgY29tbWFuZCBsaW5lLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gcG9ydCAtIFRoZSBwb3J0IG51bWJlci5cbiAqIEBwYXJhbSB7P0Z1bmN0aW9ufSBmaWx0ZXJpbmdGdW5jIC0gT3B0aW9uYWwgbGFtYmRhIGZ1bmN0aW9uLCB3aGljaFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlaXZlcyBjb21tYW5kIGxpbmUgc3RyaW5nIG9mIHRoZSBwYXJ0aWN1bGFyIHByb2Nlc3NcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuaW5nIG9uIGdpdmVuIHBvcnQsIGFuZCBpcyBleHBlY3RlZCB0byByZXR1cm5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWl0aGVyIHRydWUgb3IgZmFsc2UgdG8gaW5jbHVkZS9leGNsdWRlIHRoZSBjb3JyZXNwb25kaW5nIFBJRFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tIHRoZSByZXN1bHRpbmcgYXJyYXkuXG4gKiBAcmV0dXJucyB7QXJyYXk8c3RyaW5nPn0gLSB0aGUgbGlzdCBvZiBtYXRjaGVkIHByb2Nlc3MgaWRzLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRQSURzTGlzdGVuaW5nT25Qb3J0IChwb3J0LCBmaWx0ZXJpbmdGdW5jID0gbnVsbCkge1xuICBjb25zdCByZXN1bHQgPSBbXTtcbiAgdHJ5IHtcbiAgICAvLyBUaGlzIG9ubHkgd29ya3Mgc2luY2UgTWFjIE9TIFggRWwgQ2FwaXRhblxuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnbHNvZicsIFsnLXRpJywgYHRjcDoke3BvcnR9YF0pO1xuICAgIHJlc3VsdC5wdXNoKC4uLihzdGRvdXQudHJpbSgpLnNwbGl0KC9cXG4rLykpKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBpZiAoIV8uaXNGdW5jdGlvbihmaWx0ZXJpbmdGdW5jKSkge1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IEIuZmlsdGVyKHJlc3VsdCwgYXN5bmMgKHgpID0+IHtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3BzJywgWyctcCcsIHgsICctbycsICdjb21tYW5kJ10pO1xuICAgIHJldHVybiBhd2FpdCBmaWx0ZXJpbmdGdW5jKHN0ZG91dCk7XG4gIH0pO1xufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFVwbG9hZE9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBhc3MgLSBUaGUgcGFzc3dvcmQgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBtZXRob2QgLSBUaGUgaHR0cCBtdWx0aXBhcnQgdXBsb2FkIG1ldGhvZCBuYW1lLiBUaGUgJ1BVVCcgb25lIGlzIHVzZWQgYnkgZGVmYXVsdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9PYmplY3R9IGhlYWRlcnMgLSBBZGRpdGlvbmFsIGhlYWRlcnMgbWFwcGluZyBmb3IgbXVsdGlwYXJ0IGh0dHAocykgdXBsb2Fkc1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSBmaWxlRmllbGROYW1lIFtmaWxlXSAtIFRoZSBuYW1lIG9mIHRoZSBmb3JtIGZpZWxkLCB3aGVyZSB0aGUgZmlsZSBjb250ZW50IEJMT0Igc2hvdWxkIGJlIHN0b3JlZCBmb3JcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwKHMpIHVwbG9hZHNcbiAqIEBwcm9wZXJ0eSB7P09iamVjdHxBcnJheTxQYWlyPn0gZm9ybUZpZWxkcyAtIEFkZGl0aW9uYWwgZm9ybSBmaWVsZHMgZm9yIG11bHRpcGFydCBodHRwKHMpIHVwbG9hZHNcbiAqL1xuXG5cbi8qKlxuICogRW5jb2RlcyB0aGUgZ2l2ZW4gbG9jYWwgZmlsZSB0byBiYXNlNjQgYW5kIHJldHVybnMgdGhlIHJlc3VsdGluZyBzdHJpbmdcbiAqIG9yIHVwbG9hZHMgaXQgdG8gYSByZW1vdGUgc2VydmVyIHVzaW5nIGh0dHAvaHR0cHMgb3IgZnRwIHByb3RvY29sc1xuICogaWYgYHJlbW90ZVBhdGhgIGlzIHNldFxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhbFBhdGggLSBUaGUgcGF0aCB0byBhbiBleGlzdGluZyBsb2NhbCBmaWxlXG4gKiBAcGFyYW0gez9zdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcGF0aCB0byB0aGUgcmVtb3RlIGxvY2F0aW9uLCB3aGVyZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcyBmaWxlIHNob3VsZCBiZSB1cGxvYWRlZFxuICogQHBhcmFtIHs/VXBsb2FkT3B0aW9uc30gdXBsb2FkT3B0aW9ucyAtIFNldCBvZiB1cGxvYWQgb3B0aW9uc1xuICogQHJldHVybnMge3N0cmluZ30gRWl0aGVyIGFuIGVtcHR5IHN0cmluZyBpZiB0aGUgdXBsb2FkIHdhcyBzdWNjZXNzZnVsIG9yXG4gKiBiYXNlNjQtZW5jb2RlZCBmaWxlIHJlcHJlc2VudGF0aW9uIGlmIGByZW1vdGVQYXRoYCBpcyBmYWxzeVxuICovXG5hc3luYyBmdW5jdGlvbiBlbmNvZGVCYXNlNjRPclVwbG9hZCAobG9jYWxQYXRoLCByZW1vdGVQYXRoID0gbnVsbCwgdXBsb2FkT3B0aW9ucyA9IHt9KSB7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGxvY2FsUGF0aCkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlIGZpbGUgYXQgJyR7bG9jYWxQYXRofScgZG9lcyBub3QgZXhpc3Qgb3IgaXMgbm90IGFjY2Vzc2libGVgKTtcbiAgfVxuXG4gIGlmIChfLmlzRW1wdHkocmVtb3RlUGF0aCkpIHtcbiAgICBjb25zdCB7c2l6ZX0gPSBhd2FpdCBmcy5zdGF0KGxvY2FsUGF0aCk7XG4gICAgbG9nLmRlYnVnKGBUaGUgc2l6ZSBvZiB0aGUgZmlsZSBpcyAke3V0aWwudG9SZWFkYWJsZVNpemVTdHJpbmcoc2l6ZSl9YCk7XG4gICAgcmV0dXJuIChhd2FpdCB1dGlsLnRvSW5NZW1vcnlCYXNlNjQobG9jYWxQYXRoKSkudG9TdHJpbmcoKTtcbiAgfVxuXG4gIGNvbnN0IHt1c2VyLCBwYXNzLCBtZXRob2QsIGhlYWRlcnMsIGZpbGVGaWVsZE5hbWUsIGZvcm1GaWVsZHN9ID0gdXBsb2FkT3B0aW9ucztcbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICBtZXRob2Q6IG1ldGhvZCB8fCAnUFVUJyxcbiAgICBoZWFkZXJzLFxuICAgIGZpbGVGaWVsZE5hbWUsXG4gICAgZm9ybUZpZWxkcyxcbiAgfTtcbiAgaWYgKHVzZXIgJiYgcGFzcykge1xuICAgIG9wdGlvbnMuYXV0aCA9IHt1c2VyLCBwYXNzfTtcbiAgfVxuICBhd2FpdCBuZXQudXBsb2FkRmlsZShsb2NhbFBhdGgsIHJlbW90ZVBhdGgsIG9wdGlvbnMpO1xuICByZXR1cm4gJyc7XG59XG5cbi8qKlxuICogU3RvcHMgYW5kIHJlbW92ZXMgYWxsIHdlYiBzb2NrZXQgaGFuZGxlcnMgdGhhdCBhcmUgbGlzdGVuaW5nXG4gKiBpbiBzY29wZSBvZiB0aGUgY3VycmVjdCBzZXNzaW9uLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBzZXJ2ZXIgLSBUaGUgaW5zdGFuY2Ugb2YgTm9kZUpzIEhUVFAgc2VydmVyLFxuICogd2hpY2ggaG9zdHMgQXBwaXVtXG4gKiBAcGFyYW0ge3N0cmluZ30gc2Vzc2lvbklkIC0gVGhlIGlkIG9mIHRoZSBjdXJyZW50IHNlc3Npb25cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcmVtb3ZlQWxsU2Vzc2lvbldlYlNvY2tldEhhbmRsZXJzIChzZXJ2ZXIsIHNlc3Npb25JZCkge1xuICBpZiAoIXNlcnZlciB8fCAhXy5pc0Z1bmN0aW9uKHNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycykpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBhY3RpdmVIYW5kbGVycyA9IGF3YWl0IHNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycyhzZXNzaW9uSWQpO1xuICBmb3IgKGNvbnN0IHBhdGhuYW1lIG9mIF8ua2V5cyhhY3RpdmVIYW5kbGVycykpIHtcbiAgICBhd2FpdCBzZXJ2ZXIucmVtb3ZlV2ViU29ja2V0SGFuZGxlcihwYXRobmFtZSk7XG4gIH1cbn1cblxuLyoqXG4gKiBSZXR1cm5zIHRydWUgaWYgdGhlIHVybFN0cmluZyBpcyBsb2NhbGhvc3RcbiAqIEBwYXJhbSB7P3N0cmluZ30gdXJsU3RyaW5nXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJuIHRydWUgaWYgdGhlIHVybFN0cmluZyBpcyBsb2NhbGhvc3RcbiAqL1xuZnVuY3Rpb24gaXNMb2NhbEhvc3QgKHVybFN0cmluZykge1xuICB0cnkge1xuICAgIGNvbnN0IHtob3N0bmFtZX0gPSB1cmwucGFyc2UodXJsU3RyaW5nKTtcbiAgICByZXR1cm4gWydsb2NhbGhvc3QnLCAnMTI3LjAuMC4xJywgJzo6MScsICc6OmZmZmY6MTI3LjAuMC4xJ10uaW5jbHVkZXMoaG9zdG5hbWUpO1xuICB9IGNhdGNoIChpZ24pIHtcbiAgICBsb2cud2FybihgJyR7dXJsU3RyaW5nfScgY2Fubm90IGJlIHBhcnNlZCBhcyBhIHZhbGlkIFVSTGApO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuLyoqXG4gKiBOb3JtYWxpemVzIHBsYXRmb3JtVmVyc2lvbiB0byBhIHZhbGlkIGlPUyB2ZXJzaW9uIHN0cmluZ1xuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBvcmlnaW5hbFZlcnNpb24gLSBMb29zZSB2ZXJzaW9uIG51bWJlciwgdGhhdCBjYW4gYmUgcGFyc2VkIGJ5IHNlbXZlclxuICogQHJldHVybiB7c3RyaW5nfSBpT1MgdmVyc2lvbiBudW1iZXIgaW4gPG1ham9yPi48bWlub3I+IGZvcm1hdFxuICogQHRocm93cyB7RXJyb3J9IGlmIHRoZSB2ZXJzaW9uIG51bWJlciBjYW5ub3QgYmUgcGFyc2VkXG4gKi9cbmZ1bmN0aW9uIG5vcm1hbGl6ZVBsYXRmb3JtVmVyc2lvbiAob3JpZ2luYWxWZXJzaW9uKSB7XG4gIGNvbnN0IG5vcm1hbGl6ZWRWZXJzaW9uID0gc2VtdmVyLmNvZXJjZShvcmlnaW5hbFZlcnNpb24pO1xuICBpZiAoIW5vcm1hbGl6ZWRWZXJzaW9uKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgcGxhdGZvcm0gdmVyc2lvbiAnJHtvcmlnaW5hbFZlcnNpb259JyBzaG91bGQgYmUgYSB2YWxpZCB2ZXJzaW9uIG51bWJlcmApO1xuICB9XG4gIHJldHVybiBgJHtub3JtYWxpemVkVmVyc2lvbi5tYWpvcn0uJHtub3JtYWxpemVkVmVyc2lvbi5taW5vcn1gO1xufVxuXG5cbmV4cG9ydCB7XG4gIGRldGVjdFVkaWQsIGdldEFuZENoZWNrWGNvZGVWZXJzaW9uLCBnZXRBbmRDaGVja0lvc1Nka1ZlcnNpb24sXG4gIGNoZWNrQXBwUHJlc2VudCwgZ2V0RHJpdmVySW5mbyxcbiAgY2xlYXJTeXN0ZW1GaWxlcywgdHJhbnNsYXRlRGV2aWNlTmFtZSwgbm9ybWFsaXplQ29tbWFuZFRpbWVvdXRzLFxuICBERUZBVUxUX1RJTUVPVVRfS0VZLCBtYXJrU3lzdGVtRmlsZXNGb3JDbGVhbnVwLCBwcmludFVzZXIsXG4gIGdldFBJRHNMaXN0ZW5pbmdPblBvcnQsIGVuY29kZUJhc2U2NE9yVXBsb2FkLCByZW1vdmVBbGxTZXNzaW9uV2ViU29ja2V0SGFuZGxlcnMsXG4gIGlzTG9jYWxIb3N0LCBub3JtYWxpemVQbGF0Zm9ybVZlcnNpb24sIGNsZWFyTG9ncyxcbn07XG4iXSwiZmlsZSI6ImxpYi91dGlscy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9

"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.IOSCrashLog = void 0;

require("source-map-support/register");

var _support = require("@appium/support");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumIosDevice = require("appium-ios-device");

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _pyIosDeviceClient = _interopRequireDefault(require("../py-ios-device-client"));

const REAL_DEVICE_MAGIC = '3620bbb0-fb9f-4b62-a668-896f2edc4d88';
const MAGIC_SEP = '/';

class IOSCrashLog {
  constructor(opts = {}) {
    this.udid = opts.udid;
    this.pyideviceClient = this.udid ? new _pyIosDeviceClient.default(this.udid) : null;
    const logDir = opts.udid ? _path.default.resolve(process.env.HOME, 'Library', 'Logs', 'CrashReporter', 'MobileDevice') : _path.default.resolve(process.env.HOME, 'Library', 'Logs', 'DiagnosticReports');
    this.logDir = logDir || _path.default.resolve(process.env.HOME || '/', 'Library', 'Logs', 'DiagnosticReports');
    this.prevLogs = [];
    this.logsSinceLastRequest = [];
    this.phoneName = null;
    this.sim = opts.sim;
  }

  async _gatherFromRealDevice() {
    if (await this.pyideviceClient.assertExists(false)) {
      return (await this.pyideviceClient.listCrashes()).map(x => `${REAL_DEVICE_MAGIC}${MAGIC_SEP}${x}`);
    }

    let crashLogsRoot = this.logDir;

    if (this.udid) {
      this.phoneName = this.phoneName || (await _appiumIosDevice.utilities.getDeviceName(this.udid));
      crashLogsRoot = _path.default.resolve(crashLogsRoot, this.phoneName);
    }

    if (!(await _support.fs.exists(crashLogsRoot))) {
      _logger.default.debug(`Crash reports root '${crashLogsRoot}' does not exist. Got nothing to gather.`);

      return [];
    }

    const foundFiles = await _support.fs.glob(`${crashLogsRoot}/**/*.crash`, {
      strict: false
    });
    return foundFiles;
  }

  async _gatherFromSimulator() {
    if (!(await _support.fs.exists(this.logDir))) {
      _logger.default.debug(`Crash reports root '${this.logDir}' does not exist. Got nothing to gather.`);

      return [];
    }

    const foundFiles = await _support.fs.glob(`${this.logDir}/**/*.crash`, {
      strict: false
    });
    return await _bluebird.default.filter(foundFiles, async x => {
      try {
        const content = await _support.fs.readFile(x, 'utf8');
        return content.toUpperCase().includes(this.sim.udid.toUpperCase());
      } catch (err) {
        return false;
      }
    });
  }

  async getCrashes() {
    return this.udid ? await this._gatherFromRealDevice() : await this._gatherFromSimulator();
  }

  async startCapture() {
    this.prevLogs = await this.getCrashes();
  }

  async stopCapture() {}

  async getLogs() {
    let crashFiles = await this.getCrashes();

    let diff = _lodash.default.difference(crashFiles, this.prevLogs, this.logsSinceLastRequest);

    this.logsSinceLastRequest = _lodash.default.union(this.logsSinceLastRequest, diff);
    return await this.filesToJSON(diff);
  }

  async getAllLogs() {
    let crashFiles = await this.getCrashes();

    let logFiles = _lodash.default.difference(crashFiles, this.prevLogs);

    return await this.filesToJSON(logFiles);
  }

  async filesToJSON(paths) {
    const tmpRoot = await _support.tempDir.openDir();

    try {
      return (await _bluebird.default.map(paths, async fullPath => {
        if (_lodash.default.includes(fullPath, REAL_DEVICE_MAGIC)) {
          const fileName = _lodash.default.last(fullPath.split(MAGIC_SEP));

          try {
            await this.pyideviceClient.exportCrash(fileName, tmpRoot);
          } catch (e) {
            _logger.default.warn(`Cannot export the crash report '${fileName}'. Skipping it. ` + `Original error: ${e.message}`);

            return;
          }

          fullPath = _path.default.join(tmpRoot, fileName);
        }

        const stat = await _support.fs.stat(fullPath);
        return {
          timestamp: stat.ctime.getTime(),
          level: 'ALL',
          message: await _support.fs.readFile(fullPath, 'utf8')
        };
      })).filter(Boolean);
    } finally {
      await _support.fs.rimraf(tmpRoot);
    }
  }

}

exports.IOSCrashLog = IOSCrashLog;
var _default = IOSCrashLog;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL2lvcy1jcmFzaC1sb2cuanMiXSwibmFtZXMiOlsiUkVBTF9ERVZJQ0VfTUFHSUMiLCJNQUdJQ19TRVAiLCJJT1NDcmFzaExvZyIsImNvbnN0cnVjdG9yIiwib3B0cyIsInVkaWQiLCJweWlkZXZpY2VDbGllbnQiLCJQeWlkZXZpY2UiLCJsb2dEaXIiLCJwYXRoIiwicmVzb2x2ZSIsInByb2Nlc3MiLCJlbnYiLCJIT01FIiwicHJldkxvZ3MiLCJsb2dzU2luY2VMYXN0UmVxdWVzdCIsInBob25lTmFtZSIsInNpbSIsIl9nYXRoZXJGcm9tUmVhbERldmljZSIsImFzc2VydEV4aXN0cyIsImxpc3RDcmFzaGVzIiwibWFwIiwieCIsImNyYXNoTG9nc1Jvb3QiLCJ1dGlsaXRpZXMiLCJnZXREZXZpY2VOYW1lIiwiZnMiLCJleGlzdHMiLCJsb2ciLCJkZWJ1ZyIsImZvdW5kRmlsZXMiLCJnbG9iIiwic3RyaWN0IiwiX2dhdGhlckZyb21TaW11bGF0b3IiLCJCIiwiZmlsdGVyIiwiY29udGVudCIsInJlYWRGaWxlIiwidG9VcHBlckNhc2UiLCJpbmNsdWRlcyIsImVyciIsImdldENyYXNoZXMiLCJzdGFydENhcHR1cmUiLCJzdG9wQ2FwdHVyZSIsImdldExvZ3MiLCJjcmFzaEZpbGVzIiwiZGlmZiIsIl8iLCJkaWZmZXJlbmNlIiwidW5pb24iLCJmaWxlc1RvSlNPTiIsImdldEFsbExvZ3MiLCJsb2dGaWxlcyIsInBhdGhzIiwidG1wUm9vdCIsInRlbXBEaXIiLCJvcGVuRGlyIiwiZnVsbFBhdGgiLCJmaWxlTmFtZSIsImxhc3QiLCJzcGxpdCIsImV4cG9ydENyYXNoIiwiZSIsIndhcm4iLCJtZXNzYWdlIiwiam9pbiIsInN0YXQiLCJ0aW1lc3RhbXAiLCJjdGltZSIsImdldFRpbWUiLCJsZXZlbCIsIkJvb2xlYW4iLCJyaW1yYWYiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7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VixDQUFOO0FBQ0Q7QUFDRjs7QUEzR2U7OztlQStHSHBELFciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcywgdGVtcERpciB9IGZyb20gJ0BhcHBpdW0vc3VwcG9ydCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyB1dGlsaXRpZXMgfSBmcm9tICdhcHBpdW0taW9zLWRldmljZSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgUHlpZGV2aWNlIGZyb20gJy4uL3B5LWlvcy1kZXZpY2UtY2xpZW50JztcblxuY29uc3QgUkVBTF9ERVZJQ0VfTUFHSUMgPSAnMzYyMGJiYjAtZmI5Zi00YjYyLWE2NjgtODk2ZjJlZGM0ZDg4JztcbmNvbnN0IE1BR0lDX1NFUCA9ICcvJztcblxuXG5jbGFzcyBJT1NDcmFzaExvZyB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICB0aGlzLnVkaWQgPSBvcHRzLnVkaWQ7XG4gICAgdGhpcy5weWlkZXZpY2VDbGllbnQgPSB0aGlzLnVkaWQgPyBuZXcgUHlpZGV2aWNlKHRoaXMudWRpZCkgOiBudWxsO1xuICAgIGNvbnN0IGxvZ0RpciA9IG9wdHMudWRpZFxuICAgICAgPyBwYXRoLnJlc29sdmUocHJvY2Vzcy5lbnYuSE9NRSwgJ0xpYnJhcnknLCAnTG9ncycsICdDcmFzaFJlcG9ydGVyJywgJ01vYmlsZURldmljZScpXG4gICAgICA6IHBhdGgucmVzb2x2ZShwcm9jZXNzLmVudi5IT01FLCAnTGlicmFyeScsICdMb2dzJywgJ0RpYWdub3N0aWNSZXBvcnRzJyk7XG4gICAgdGhpcy5sb2dEaXIgPSBsb2dEaXJcbiAgICAgIHx8IHBhdGgucmVzb2x2ZShwcm9jZXNzLmVudi5IT01FIHx8ICcvJywgJ0xpYnJhcnknLCAnTG9ncycsICdEaWFnbm9zdGljUmVwb3J0cycpO1xuICAgIHRoaXMucHJldkxvZ3MgPSBbXTtcbiAgICB0aGlzLmxvZ3NTaW5jZUxhc3RSZXF1ZXN0ID0gW107XG4gICAgdGhpcy5waG9uZU5hbWUgPSBudWxsO1xuICAgIHRoaXMuc2ltID0gb3B0cy5zaW07XG4gIH1cblxuICBhc3luYyBfZ2F0aGVyRnJvbVJlYWxEZXZpY2UgKCkge1xuICAgIGlmIChhd2FpdCB0aGlzLnB5aWRldmljZUNsaWVudC5hc3NlcnRFeGlzdHMoZmFsc2UpKSB7XG4gICAgICByZXR1cm4gKGF3YWl0IHRoaXMucHlpZGV2aWNlQ2xpZW50Lmxpc3RDcmFzaGVzKCkpXG4gICAgICAgIC5tYXAoKHgpID0+IGAke1JFQUxfREVWSUNFX01BR0lDfSR7TUFHSUNfU0VQfSR7eH1gKTtcbiAgICB9XG5cbiAgICBsZXQgY3Jhc2hMb2dzUm9vdCA9IHRoaXMubG9nRGlyO1xuICAgIGlmICh0aGlzLnVkaWQpIHtcbiAgICAgIHRoaXMucGhvbmVOYW1lID0gdGhpcy5waG9uZU5hbWUgfHwgYXdhaXQgdXRpbGl0aWVzLmdldERldmljZU5hbWUodGhpcy51ZGlkKTtcbiAgICAgIGNyYXNoTG9nc1Jvb3QgPSBwYXRoLnJlc29sdmUoY3Jhc2hMb2dzUm9vdCwgdGhpcy5waG9uZU5hbWUpO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhjcmFzaExvZ3NSb290KSkge1xuICAgICAgbG9nLmRlYnVnKGBDcmFzaCByZXBvcnRzIHJvb3QgJyR7Y3Jhc2hMb2dzUm9vdH0nIGRvZXMgbm90IGV4aXN0LiBHb3Qgbm90aGluZyB0byBnYXRoZXIuYCk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGNvbnN0IGZvdW5kRmlsZXMgPSBhd2FpdCBmcy5nbG9iKGAke2NyYXNoTG9nc1Jvb3R9LyoqLyouY3Jhc2hgLCB7XG4gICAgICBzdHJpY3Q6IGZhbHNlXG4gICAgfSk7XG4gICAgcmV0dXJuIGZvdW5kRmlsZXM7XG4gIH1cblxuICBhc3luYyBfZ2F0aGVyRnJvbVNpbXVsYXRvciAoKSB7XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHModGhpcy5sb2dEaXIpKSB7XG4gICAgICBsb2cuZGVidWcoYENyYXNoIHJlcG9ydHMgcm9vdCAnJHt0aGlzLmxvZ0Rpcn0nIGRvZXMgbm90IGV4aXN0LiBHb3Qgbm90aGluZyB0byBnYXRoZXIuYCk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGNvbnN0IGZvdW5kRmlsZXMgPSBhd2FpdCBmcy5nbG9iKGAke3RoaXMubG9nRGlyfS8qKi8qLmNyYXNoYCwge1xuICAgICAgc3RyaWN0OiBmYWxzZVxuICAgIH0pO1xuICAgIC8vIEZvciBTaW11bGF0b3Igb25seSBpbmNsdWRlIGZpbGVzLCB0aGF0IGNvbnRhaW4gY3VycmVudCBVRElEXG4gICAgcmV0dXJuIGF3YWl0IEIuZmlsdGVyKGZvdW5kRmlsZXMsIGFzeW5jICh4KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgZnMucmVhZEZpbGUoeCwgJ3V0ZjgnKTtcbiAgICAgICAgcmV0dXJuIGNvbnRlbnQudG9VcHBlckNhc2UoKS5pbmNsdWRlcyh0aGlzLnNpbS51ZGlkLnRvVXBwZXJDYXNlKCkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldENyYXNoZXMgKCkge1xuICAgIHJldHVybiB0aGlzLnVkaWRcbiAgICAgID8gYXdhaXQgdGhpcy5fZ2F0aGVyRnJvbVJlYWxEZXZpY2UoKVxuICAgICAgOiBhd2FpdCB0aGlzLl9nYXRoZXJGcm9tU2ltdWxhdG9yKCk7XG4gIH1cblxuICBhc3luYyBzdGFydENhcHR1cmUgKCkge1xuICAgIHRoaXMucHJldkxvZ3MgPSBhd2FpdCB0aGlzLmdldENyYXNoZXMoKTtcbiAgfVxuXG4gIGFzeW5jIHN0b3BDYXB0dXJlICgpIHtcbiAgICAvLyBuZWVkZWQgZm9yIGNvbnNpc3RlbnQgQVBJIHdpdGggb3RoZXIgbG9nc1xuICB9XG5cbiAgYXN5bmMgZ2V0TG9ncyAoKSB7XG4gICAgbGV0IGNyYXNoRmlsZXMgPSBhd2FpdCB0aGlzLmdldENyYXNoZXMoKTtcbiAgICBsZXQgZGlmZiA9IF8uZGlmZmVyZW5jZShjcmFzaEZpbGVzLCB0aGlzLnByZXZMb2dzLCB0aGlzLmxvZ3NTaW5jZUxhc3RSZXF1ZXN0KTtcbiAgICB0aGlzLmxvZ3NTaW5jZUxhc3RSZXF1ZXN0ID0gXy51bmlvbih0aGlzLmxvZ3NTaW5jZUxhc3RSZXF1ZXN0LCBkaWZmKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maWxlc1RvSlNPTihkaWZmKTtcbiAgfVxuXG4gIGFzeW5jIGdldEFsbExvZ3MgKCkge1xuICAgIGxldCBjcmFzaEZpbGVzID0gYXdhaXQgdGhpcy5nZXRDcmFzaGVzKCk7XG4gICAgbGV0IGxvZ0ZpbGVzID0gXy5kaWZmZXJlbmNlKGNyYXNoRmlsZXMsIHRoaXMucHJldkxvZ3MpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbGVzVG9KU09OKGxvZ0ZpbGVzKTtcbiAgfVxuXG4gIGFzeW5jIGZpbGVzVG9KU09OIChwYXRocykge1xuICAgIGNvbnN0IHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIChhd2FpdCBCLm1hcChwYXRocywgYXN5bmMgKGZ1bGxQYXRoKSA9PiB7XG4gICAgICAgIGlmIChfLmluY2x1ZGVzKGZ1bGxQYXRoLCBSRUFMX0RFVklDRV9NQUdJQykpIHtcbiAgICAgICAgICBjb25zdCBmaWxlTmFtZSA9IF8ubGFzdChmdWxsUGF0aC5zcGxpdChNQUdJQ19TRVApKTtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5weWlkZXZpY2VDbGllbnQuZXhwb3J0Q3Jhc2goZmlsZU5hbWUsIHRtcFJvb3QpO1xuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGxvZy53YXJuKGBDYW5ub3QgZXhwb3J0IHRoZSBjcmFzaCByZXBvcnQgJyR7ZmlsZU5hbWV9Jy4gU2tpcHBpbmcgaXQuIGAgK1xuICAgICAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmdWxsUGF0aCA9IHBhdGguam9pbih0bXBSb290LCBmaWxlTmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc3RhdCA9IGF3YWl0IGZzLnN0YXQoZnVsbFBhdGgpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHRpbWVzdGFtcDogc3RhdC5jdGltZS5nZXRUaW1lKCksXG4gICAgICAgICAgbGV2ZWw6ICdBTEwnLFxuICAgICAgICAgIG1lc3NhZ2U6IGF3YWl0IGZzLnJlYWRGaWxlKGZ1bGxQYXRoLCAndXRmOCcpXG4gICAgICAgIH07XG4gICAgICB9KSkuZmlsdGVyKEJvb2xlYW4pO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYodG1wUm9vdCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IElPU0NyYXNoTG9nIH07XG5leHBvcnQgZGVmYXVsdCBJT1NDcmFzaExvZztcbiJdLCJmaWxlIjoibGliL2RldmljZS1sb2cvaW9zLWNyYXNoLWxvZy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9

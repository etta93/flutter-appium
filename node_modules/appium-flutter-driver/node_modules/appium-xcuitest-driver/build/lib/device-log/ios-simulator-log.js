"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.IOSSimulatorLog = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _iosLog = require("./ios-log");

var _support = require("@appium/support");

var _teen_process = require("teen_process");

const log = _support.logger.getLogger('IOSSimulatorLog');

const START_TIMEOUT = 10000;

class IOSSimulatorLog extends _iosLog.IOSLog {
  constructor({
    sim,
    showLogs,
    xcodeVersion,
    iosSimulatorLogsPredicate
  }) {
    super();
    this.sim = sim;
    this.showLogs = !!showLogs;
    this.xcodeVersion = xcodeVersion;
    this.predicate = iosSimulatorLogsPredicate;
    this.proc = null;
  }

  async startCapture() {
    if (_lodash.default.isUndefined(this.sim.udid)) {
      throw new Error(`Log capture requires a sim udid`);
    }

    if (!(await this.sim.isRunning())) {
      throw new Error(`iOS Simulator with udid '${this.sim.udid}' is not running`);
    }

    const spawnArgs = ['log', 'stream', '--style', 'compact'];

    if (this.predicate) {
      spawnArgs.push('--predicate', this.predicate);
    }

    log.debug(`Starting log capture for iOS Simulator with udid '${this.sim.udid}' ` + `using simctl`);

    try {
      await (0, _teen_process.exec)('pkill', ['-f', [this.sim.udid, ...spawnArgs].join(' ')]);
    } catch (ign) {}

    try {
      this.proc = await this.sim.simctl.spawnSubProcess(spawnArgs);
      await this.finishStartingLogCapture();
    } catch (e) {
      throw new Error(`Simulator log capture failed. Original error: ${e.message}`);
    }
  }

  async finishStartingLogCapture() {
    if (!this.proc) {
      log.errorAndThrow('Could not capture simulator log');
    }

    let firstLine = true;
    let logRow = '';
    this.proc.on('output', (stdout, stderr) => {
      if (stdout) {
        if (firstLine) {
          if (stdout.endsWith('\n')) {
            firstLine = false;
          }
        } else {
          logRow += stdout;

          if (stdout.endsWith('\n')) {
            this.onOutput(logRow);
            logRow = '';
          }
        }
      }

      if (stderr) {
        this.onOutput(logRow, 'STDERR');
      }
    });

    let sd = (stdout, stderr) => {
      if (/execvp\(\)/.test(stderr)) {
        throw new Error('iOS log capture process failed to start');
      }

      return stdout || stderr;
    };

    await this.proc.start(sd, START_TIMEOUT);
  }

  async stopCapture() {
    if (!this.proc) {
      return;
    }

    await this.killLogSubProcess();
    this.proc = null;
  }

  async killLogSubProcess() {
    if (!this.proc.isRunning) {
      return;
    }

    log.debug('Stopping iOS log capture');

    try {
      await this.proc.stop('SIGTERM', 1000);
    } catch (e) {
      if (!this.proc.isRunning) {
        return;
      }

      log.warn('Cannot stop log capture process. Sending SIGKILL');
      await this.proc.stop('SIGKILL');
    }
  }

  get isCapturing() {
    return this.proc && this.proc.isRunning;
  }

  onOutput(logRow, prefix = '') {
    const logs = _lodash.default.cloneDeep(logRow.split('\n'));

    for (const logLine of logs) {
      if (!logLine) continue;
      this.broadcast(logLine);

      if (this.showLogs) {
        const space = prefix.length > 0 ? ' ' : '';
        log.info(`[IOS_SYSLOG_ROW${space}${prefix}] ${logLine}`);
      }
    }
  }

}

exports.IOSSimulatorLog = IOSSimulatorLog;
var _default = IOSSimulatorLog;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL2lvcy1zaW11bGF0b3ItbG9nLmpzIl0sIm5hbWVzIjpbImxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIlNUQVJUX1RJTUVPVVQiLCJJT1NTaW11bGF0b3JMb2ciLCJJT1NMb2ciLCJjb25zdHJ1Y3RvciIsInNpbSIsInNob3dMb2dzIiwieGNvZGVWZXJzaW9uIiwiaW9zU2ltdWxhdG9yTG9nc1ByZWRpY2F0ZSIsInByZWRpY2F0ZSIsInByb2MiLCJzdGFydENhcHR1cmUiLCJfIiwiaXNVbmRlZmluZWQiLCJ1ZGlkIiwiRXJyb3IiLCJpc1J1bm5pbmciLCJzcGF3bkFyZ3MiLCJwdXNoIiwiZGVidWciLCJqb2luIiwiaWduIiwic2ltY3RsIiwic3Bhd25TdWJQcm9jZXNzIiwiZmluaXNoU3RhcnRpbmdMb2dDYXB0dXJlIiwiZSIsIm1lc3NhZ2UiLCJlcnJvckFuZFRocm93IiwiZmlyc3RMaW5lIiwibG9nUm93Iiwib24iLCJzdGRvdXQiLCJzdGRlcnIiLCJlbmRzV2l0aCIsIm9uT3V0cHV0Iiwic2QiLCJ0ZXN0Iiwic3RhcnQiLCJzdG9wQ2FwdHVyZSIsImtpbGxMb2dTdWJQcm9jZXNzIiwic3RvcCIsIndhcm4iLCJpc0NhcHR1cmluZyIsInByZWZpeCIsImxvZ3MiLCJjbG9uZURlZXAiLCJzcGxpdCIsImxvZ0xpbmUiLCJicm9hZGNhc3QiLCJzcGFjZSIsImxlbmd0aCIsImluZm8iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsR0FBRyxHQUFHQyxnQkFBT0MsU0FBUCxDQUFpQixpQkFBakIsQ0FBWjs7QUFFQSxNQUFNQyxhQUFhLEdBQUcsS0FBdEI7O0FBRUEsTUFBTUMsZUFBTixTQUE4QkMsY0FBOUIsQ0FBcUM7QUFDbkNDLEVBQUFBLFdBQVcsQ0FBRTtBQUFDQyxJQUFBQSxHQUFEO0FBQU1DLElBQUFBLFFBQU47QUFBZ0JDLElBQUFBLFlBQWhCO0FBQThCQyxJQUFB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QTRCO0FBQzFCLFVBQUksQ0FBQ0csT0FBTCxFQUFjO0FBQ2QsV0FBS0MsU0FBTCxDQUFlRCxPQUFmOztBQUNBLFVBQUksS0FBS3pDLFFBQVQsRUFBbUI7QUFDakIsY0FBTTJDLEtBQUssR0FBR04sTUFBTSxDQUFDTyxNQUFQLEdBQWdCLENBQWhCLEdBQW9CLEdBQXBCLEdBQTBCLEVBQXhDO0FBQ0FwRCxRQUFBQSxHQUFHLENBQUNxRCxJQUFKLENBQVUsa0JBQWlCRixLQUFNLEdBQUVOLE1BQU8sS0FBSUksT0FBUSxFQUF0RDtBQUNEO0FBQ0Y7QUFDRjs7QUFqSGtDOzs7ZUFxSHRCN0MsZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBJT1NMb2cgfSBmcm9tICcuL2lvcy1sb2cnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdJT1NTaW11bGF0b3JMb2cnKTtcblxuY29uc3QgU1RBUlRfVElNRU9VVCA9IDEwMDAwO1xuXG5jbGFzcyBJT1NTaW11bGF0b3JMb2cgZXh0ZW5kcyBJT1NMb2cge1xuICBjb25zdHJ1Y3RvciAoe3NpbSwgc2hvd0xvZ3MsIHhjb2RlVmVyc2lvbiwgaW9zU2ltdWxhdG9yTG9nc1ByZWRpY2F0ZX0pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuc2ltID0gc2ltO1xuICAgIHRoaXMuc2hvd0xvZ3MgPSAhIXNob3dMb2dzO1xuICAgIHRoaXMueGNvZGVWZXJzaW9uID0geGNvZGVWZXJzaW9uO1xuICAgIHRoaXMucHJlZGljYXRlID0gaW9zU2ltdWxhdG9yTG9nc1ByZWRpY2F0ZTtcbiAgICB0aGlzLnByb2MgPSBudWxsO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRDYXB0dXJlICgpIHtcbiAgICBpZiAoXy5pc1VuZGVmaW5lZCh0aGlzLnNpbS51ZGlkKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBMb2cgY2FwdHVyZSByZXF1aXJlcyBhIHNpbSB1ZGlkYCk7XG4gICAgfVxuXG4gICAgaWYgKCFhd2FpdCB0aGlzLnNpbS5pc1J1bm5pbmcoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBpT1MgU2ltdWxhdG9yIHdpdGggdWRpZCAnJHt0aGlzLnNpbS51ZGlkfScgaXMgbm90IHJ1bm5pbmdgKTtcbiAgICB9XG4gICAgY29uc3Qgc3Bhd25BcmdzID0gW1xuICAgICAgJ2xvZycsXG4gICAgICAnc3RyZWFtJyxcbiAgICAgICctLXN0eWxlJywgJ2NvbXBhY3QnLFxuICAgIF07XG4gICAgaWYgKHRoaXMucHJlZGljYXRlKSB7XG4gICAgICBzcGF3bkFyZ3MucHVzaCgnLS1wcmVkaWNhdGUnLCB0aGlzLnByZWRpY2F0ZSk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgbG9nIGNhcHR1cmUgZm9yIGlPUyBTaW11bGF0b3Igd2l0aCB1ZGlkICcke3RoaXMuc2ltLnVkaWR9JyBgICtcbiAgICAgIGB1c2luZyBzaW1jdGxgKTtcbiAgICB0cnkge1xuICAgICAgLy8gY2xlYW51cCBleGlzdGluZyBsaXN0ZW5lcnMgaWYgdGhlIHByZXZpb3VzIHNlc3Npb24gaGFzIG5vdCBiZWVuIHRlcm1pbmF0ZWQgcHJvcGVybHlcbiAgICAgIGF3YWl0IGV4ZWMoJ3BraWxsJywgWyctZicsIFt0aGlzLnNpbS51ZGlkLCAuLi5zcGF3bkFyZ3NdLmpvaW4oJyAnKV0pO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICB0cnkge1xuICAgICAgdGhpcy5wcm9jID0gYXdhaXQgdGhpcy5zaW0uc2ltY3RsLnNwYXduU3ViUHJvY2VzcyhzcGF3bkFyZ3MpO1xuICAgICAgYXdhaXQgdGhpcy5maW5pc2hTdGFydGluZ0xvZ0NhcHR1cmUoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNpbXVsYXRvciBsb2cgY2FwdHVyZSBmYWlsZWQuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmaW5pc2hTdGFydGluZ0xvZ0NhcHR1cmUgKCkge1xuICAgIGlmICghdGhpcy5wcm9jKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdygnQ291bGQgbm90IGNhcHR1cmUgc2ltdWxhdG9yIGxvZycpO1xuICAgIH1cbiAgICBsZXQgZmlyc3RMaW5lID0gdHJ1ZTtcbiAgICBsZXQgbG9nUm93ID0gJyc7XG4gICAgdGhpcy5wcm9jLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgIGlmIChzdGRvdXQpIHtcbiAgICAgICAgaWYgKGZpcnN0TGluZSkge1xuICAgICAgICAgIGlmIChzdGRvdXQuZW5kc1dpdGgoJ1xcbicpKSB7XG4gICAgICAgICAgICAvLyBkb24ndCBzdG9yZSB0aGUgZmlyc3QgbGluZSBvZiB0aGUgbG9nIGJlY2F1c2UgaXQgY2FtZSBiZWZvcmUgdGhlIHNpbSB3YXMgbGF1bmNoZWRcbiAgICAgICAgICAgIGZpcnN0TGluZSA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsb2dSb3cgKz0gc3Rkb3V0O1xuICAgICAgICAgIGlmIChzdGRvdXQuZW5kc1dpdGgoJ1xcbicpKSB7XG4gICAgICAgICAgICB0aGlzLm9uT3V0cHV0KGxvZ1Jvdyk7XG4gICAgICAgICAgICBsb2dSb3cgPSAnJztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChzdGRlcnIpIHtcbiAgICAgICAgdGhpcy5vbk91dHB1dChsb2dSb3csICdTVERFUlInKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGxldCBzZCA9IChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKC9leGVjdnBcXChcXCkvLnRlc3Qoc3RkZXJyKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2lPUyBsb2cgY2FwdHVyZSBwcm9jZXNzIGZhaWxlZCB0byBzdGFydCcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHN0ZG91dCB8fCBzdGRlcnI7XG4gICAgfTtcbiAgICBhd2FpdCB0aGlzLnByb2Muc3RhcnQoc2QsIFNUQVJUX1RJTUVPVVQpO1xuICB9XG5cbiAgYXN5bmMgc3RvcENhcHR1cmUgKCkge1xuICAgIGlmICghdGhpcy5wcm9jKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGF3YWl0IHRoaXMua2lsbExvZ1N1YlByb2Nlc3MoKTtcbiAgICB0aGlzLnByb2MgPSBudWxsO1xuICB9XG5cbiAgYXN5bmMga2lsbExvZ1N1YlByb2Nlc3MgKCkge1xuICAgIGlmICghdGhpcy5wcm9jLmlzUnVubmluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsb2cuZGVidWcoJ1N0b3BwaW5nIGlPUyBsb2cgY2FwdHVyZScpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnByb2Muc3RvcCgnU0lHVEVSTScsIDEwMDApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmICghdGhpcy5wcm9jLmlzUnVubmluZykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBsb2cud2FybignQ2Fubm90IHN0b3AgbG9nIGNhcHR1cmUgcHJvY2Vzcy4gU2VuZGluZyBTSUdLSUxMJyk7XG4gICAgICBhd2FpdCB0aGlzLnByb2Muc3RvcCgnU0lHS0lMTCcpO1xuICAgIH1cbiAgfVxuXG4gIGdldCBpc0NhcHR1cmluZyAoKSB7XG4gICAgcmV0dXJuIHRoaXMucHJvYyAmJiB0aGlzLnByb2MuaXNSdW5uaW5nO1xuICB9XG5cbiAgb25PdXRwdXQgKGxvZ1JvdywgcHJlZml4ID0gJycpIHtcbiAgICBjb25zdCBsb2dzID0gXy5jbG9uZURlZXAobG9nUm93LnNwbGl0KCdcXG4nKSk7XG4gICAgZm9yIChjb25zdCBsb2dMaW5lIG9mIGxvZ3MpIHtcbiAgICAgIGlmICghbG9nTGluZSkgY29udGludWU7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICAgIHRoaXMuYnJvYWRjYXN0KGxvZ0xpbmUpO1xuICAgICAgaWYgKHRoaXMuc2hvd0xvZ3MpIHtcbiAgICAgICAgY29uc3Qgc3BhY2UgPSBwcmVmaXgubGVuZ3RoID4gMCA/ICcgJyA6ICcnO1xuICAgICAgICBsb2cuaW5mbyhgW0lPU19TWVNMT0dfUk9XJHtzcGFjZX0ke3ByZWZpeH1dICR7bG9nTGluZX1gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgSU9TU2ltdWxhdG9yTG9nIH07XG5leHBvcnQgZGVmYXVsdCBJT1NTaW11bGF0b3JMb2c7XG4iXSwiZmlsZSI6ImxpYi9kZXZpY2UtbG9nL2lvcy1zaW11bGF0b3ItbG9nLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=

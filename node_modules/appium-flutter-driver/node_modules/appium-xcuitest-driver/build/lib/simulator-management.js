"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createSim = createSim;
exports.getExistingSim = getExistingSim;
exports.installToSimulator = installToSimulator;
exports.runSimulatorReset = runSimulatorReset;
exports.setLocale = setLocale;
exports.setLocaleAndPreferences = setLocaleAndPreferences;
exports.setPreferences = setPreferences;
exports.shutdownOtherSimulators = shutdownOtherSimulators;
exports.shutdownSimulator = shutdownSimulator;

require("source-map-support/register");

var _appiumIosSimulator = require("appium-ios-simulator");

var _nodeSimctl = _interopRequireDefault(require("node-simctl"));

var _appiumWebdriveragent = require("appium-webdriveragent");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _support = require("@appium/support");

var _desiredCaps = require("./desired-caps");

const APPIUM_SIM_PREFIX = 'appiumTest';
const SETTINGS_CAPS = ['locationServicesEnabled', 'locationServicesAuthorized'];
const SAFARI_SETTINGS_CAPS = ['safariAllowPopups', 'safariIgnoreFraudWarning', 'safariOpenLinksInBackground'];

async function createSim(caps, platform = _desiredCaps.PLATFORM_NAME_IOS) {
  const devicesSetPath = caps.simulatorDevicesSetPath;
  const udid = await new _nodeSimctl.default({
    devicesSetPath
  }).createDevice(`${APPIUM_SIM_PREFIX}-${_support.util.uuidV4().toUpperCase()}-${caps.deviceName}`, caps.deviceName, caps.platformVersion, {
    platform
  });
  return await (0, _appiumIosSimulator.getSimulator)(udid, {
    platform,
    checkExistence: false,
    devicesSetPath
  });
}

async function getExistingSim(opts = {}) {
  const {
    platformVersion,
    deviceName,
    simulatorDevicesSetPath: devicesSetPath
  } = opts;
  let appiumTestDevice;
  const simctl = new _nodeSimctl.default({
    devicesSetPath
  });

  for (const device of _lodash.default.values(await simctl.getDevices(platformVersion))) {
    if (device.name === deviceName) {
      return await (0, _appiumIosSimulator.getSimulator)(device.udid, {
        platform: device.platform,
        checkExistence: false,
        devicesSetPath
      });
    }

    if (device.name.startsWith(APPIUM_SIM_PREFIX) && device.name.endsWith(deviceName)) {
      appiumTestDevice = device;

      if (device.state === 'Booted') {
        break;
      }
    }
  }

  if (appiumTestDevice) {
    _logger.default.warn(`Unable to find device '${deviceName}'. ` + `Found '${appiumTestDevice.name}' (udid: '${appiumTestDevice.udid}') instead`);

    return await (0, _appiumIosSimulator.getSimulator)(appiumTestDevice.udid, {
      platform: appiumTestDevice.platform,
      checkExistence: false,
      devicesSetPath
    });
  }

  return null;
}

async function shutdownSimulator(device) {
  await (0, _appiumWebdriveragent.resetTestProcesses)(device.udid, true);
  await device.shutdown();
}

async function runSimulatorReset(device, opts) {
  if (opts.noReset && !opts.fullReset) {
    _logger.default.debug('Reset: noReset is on. Leaving simulator as is');

    return;
  }

  if (!device) {
    _logger.default.debug('Reset: no device available. Skipping');

    return;
  }

  if (opts.fullReset) {
    _logger.default.debug('Reset: fullReset is on. Cleaning simulator');

    await shutdownSimulator(device);
    let isKeychainsBackupSuccessful = false;

    if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      isKeychainsBackupSuccessful = await device.backupKeychains();
    }

    await device.clean();

    if (isKeychainsBackupSuccessful) {
      await device.restoreKeychains(opts.keychainsExcludePatterns || []);

      _logger.default.info(`Successfully restored keychains after full reset`);
    } else if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      _logger.default.warn('Cannot restore keychains after full reset, because ' + 'the backup operation did not succeed');
    }
  } else if (opts.bundleId) {
    if (await device.isRunning()) {
      if (opts.enforceSimulatorShutdown) {
        await shutdownSimulator(device);
      } else {
        try {
          await device.simctl.terminateApp(opts.bundleId);
        } catch (err) {
          _logger.default.warn(`Reset: failed to terminate Simulator application with id "${opts.bundleId}"`);
        }
      }
    }

    if (opts.app) {
      _logger.default.info('Not scrubbing third party app in anticipation of uninstall');

      return;
    }

    const isSafari = (opts.browserName || '').toLowerCase() === 'safari';

    try {
      if (isSafari) {
        await device.cleanSafari();
      } else {
        await device.scrubCustomApp('', opts.bundleId);
      }
    } catch (err) {
      _logger.default.warn(err.message);

      _logger.default.warn(`Reset: could not scrub ${isSafari ? 'Safari browser' : 'application with id "' + opts.bundleId + '"'}. Leaving as is.`);
    }
  }
}

async function installToSimulator(device, app, bundleId, opts = {}) {
  if (!app) {
    _logger.default.debug('No app path is given. Nothing to install.');

    return;
  }

  const {
    noReset = true,
    newSimulator = false
  } = opts;

  if (!newSimulator && bundleId && (await device.isAppInstalled(bundleId))) {
    if (noReset) {
      _logger.default.debug(`App '${bundleId}' is already installed. No need to reinstall.`);

      return;
    }

    _logger.default.debug(`Reset requested. Removing app with id '${bundleId}' from the device`);

    await device.removeApp(bundleId);
  }

  _logger.default.debug(`Installing '${app}' on Simulator with UUID '${device.udid}'...`);

  try {
    await device.installApp(app);
  } catch (e) {
    _logger.default.info(`Got an error on '${app}' install: ${e.message}`);

    _logger.default.info('Retrying application install');

    await device.installApp(app);
  }

  _logger.default.debug('The app has been installed successfully.');
}

async function shutdownOtherSimulators(currentDevice) {
  const simctl = new _nodeSimctl.default({
    devicesSetPath: currentDevice.devicesSetPath
  });

  const allDevices = _lodash.default.flatMap(_lodash.default.values(await simctl.getDevices()));

  const otherBootedDevices = allDevices.filter(device => device.udid !== currentDevice.udid && device.state === 'Booted');

  if (_lodash.default.isEmpty(otherBootedDevices)) {
    _logger.default.info('No other running simulators have been detected');

    return;
  }

  _logger.default.info(`Detected ${otherBootedDevices.length} other running ${_support.util.pluralize('Simulator', otherBootedDevices.length)}.` + `Shutting them down...`);

  for (const {
    udid
  } of otherBootedDevices) {
    await (0, _appiumWebdriveragent.resetTestProcesses)(udid, true);
    simctl.udid = udid;
    await simctl.shutdownDevice();
  }
}

async function launchAndQuitSimulator(sim, opts = {}) {
  _logger.default.debug('No simulator directories found.');

  const {
    safari,
    timeout
  } = opts;
  return timeout ? await sim.launchAndQuit(safari, timeout) : await sim.launchAndQuit(safari);
}

function checkPreferences(settings, opts = {}) {
  for (let setting of settings) {
    if (_lodash.default.has(opts, setting)) {
      return true;
    }
  }

  return false;
}

async function setLocaleAndPreferences(sim, opts, safari = false, shutdownFn = _lodash.default.noop) {
  const localConfig = await setLocale(sim, opts, {}, safari);
  const prefsUpdated = await setPreferences(sim, opts, safari);

  if (localConfig._updated || prefsUpdated) {
    _logger.default.debug('Updated settings. Rebooting the simulator if it is already open');

    await shutdownFn(sim);
  } else {
    _logger.default.debug('Setting did not need to be updated');
  }

  delete localConfig._updated;
  return localConfig;
}

async function setLocale(sim, opts, localeConfig = {}, safari = false) {
  if (!opts.language && !opts.locale && !opts.calendarFormat) {
    _logger.default.debug('No reason to set locale');

    return {
      _updated: false
    };
  }

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, {
      safari,
      timeout: opts.simulatorStartupTimeout
    });
  }

  _logger.default.debug('Setting locale information');

  localeConfig = {
    language: opts.language || localeConfig.language,
    locale: opts.locale || localeConfig.locale,
    calendarFormat: opts.calendarFormat || localeConfig.calendarFormat,
    _updated: false
  };

  try {
    let updated = await sim.updateLocale(opts.language, opts.locale, opts.calendarFormat);

    if (updated) {
      localeConfig._updated = true;
    }
  } catch (e) {
    _logger.default.errorAndThrow(`Appium was unable to set locale info: ${e}`);
  }

  return localeConfig;
}

async function setPreferences(sim, opts, safari = false) {
  let needToSetPrefs = checkPreferences(SETTINGS_CAPS, opts);
  let needToSetSafariPrefs = checkPreferences(SAFARI_SETTINGS_CAPS, opts);

  if (!needToSetPrefs && !needToSetSafariPrefs) {
    _logger.default.debug('No iOS / app preferences to set');

    return false;
  }

  _logger.default.debug('Setting iOS and app preferences');

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, {
      safari,
      timeout: opts.simulatorStartupTimeout
    });
  }

  let updated = false;

  try {
    if (needToSetPrefs) {
      updated = await setLocServicesPrefs(sim, opts);
    }
  } catch (e) {
    _logger.default.error('Error setting location services preferences, prefs will not work');

    _logger.default.error(e);
  }

  try {
    if (needToSetSafariPrefs) {
      updated = (await setSafariPrefs(sim, opts)) || updated;
    }
  } catch (e) {
    _logger.default.error('Error setting safari preferences, prefs will not work');

    _logger.default.error(e);
  }

  return updated;
}

async function setLocServicesPrefs(sim, opts = {}) {
  let locServ = _lodash.default.find([opts.locationServicesEnabled, opts.locationServicesAuthorized], c => !_lodash.default.isUndefined(c));

  if (!_lodash.default.isUndefined(locServ)) {
    locServ = locServ ? 1 : 0;

    _logger.default.debug(`Setting location services to ${locServ}`);

    await sim.updateSettings('locationServices', {
      LocationServicesEnabled: locServ,
      'LocationServicesEnabledIn7.0': locServ,
      'LocationServicesEnabledIn8.0': locServ
    });
  }

  if (!_lodash.default.isUndefined(opts.locationServicesAuthorized)) {
    if (!opts.bundleId) {
      let msg = "Can't set location services for app without bundle ID";

      _logger.default.errorAndThrow(msg);
    }

    let locAuth = !!opts.locationServicesAuthorized;

    if (locAuth) {
      _logger.default.debug('Authorizing location services for app');
    } else {
      _logger.default.debug('De-authorizing location services for app');
    }

    await sim.updateLocationSettings(opts.bundleId, locAuth);
  }
}

async function setSafariPrefs(sim, opts = {}) {
  let safariSettings = {};

  if (_lodash.default.has(opts, 'safariAllowPopups')) {
    const val = !!opts.safariAllowPopups;

    _logger.default.debug(`Setting javascript window opening to '${val}'`);

    safariSettings.WebKitJavaScriptCanOpenWindowsAutomatically = val;
    safariSettings.JavaScriptCanOpenWindowsAutomatically = val;
  }

  if (_lodash.default.has(opts, 'safariIgnoreFraudWarning')) {
    const val = !opts.safariIgnoreFraudWarning;

    _logger.default.debug(`Setting fraudulent website warning to '${val}'`);

    safariSettings.WarnAboutFraudulentWebsites = val;
  }

  if (_lodash.default.has(opts, 'safariOpenLinksInBackground')) {
    const val = opts.safariOpenLinksInBackground ? 1 : 0;

    _logger.default.debug(`Setting opening links in background to '${!!val}'`);

    safariSettings.OpenLinksInBackground = val;
  }

  return _lodash.default.size(safariSettings) > 0 ? await sim.updateSafariSettings(safariSettings) : false;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3ItbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJBUFBJVU1fU0lNX1BSRUZJWCIsIlNFVFRJTkdTX0NBUFMiLCJTQUZBUklfU0VUVElOR1NfQ0FQUyIsImNyZWF0ZVNpbSIsImNhcHMiLCJwbGF0Zm9ybSIsIlBMQVRGT1JNX05BTUVfSU9TIiwiZGV2aWNlc1NldFBhdGgiLCJzaW11bGF0b3JEZXZpY2VzU2V0UGF0aCIsInVkaWQiLCJTaW1jdGwiLCJjcmVhdGVEZXZpY2UiLCJ1dGlsIiwidXVpZFY0IiwidG9VcHBlckNhc2UiLCJkZXZpY2VOYW1lIiwicGxhdGZvcm1WZXJzaW9uIiwiY2hlY2tFeGlzdGVuY2UiLCJnZXRFeGlzdGluZ1NpbSIsIm9wdHMiLCJhcHBpdW1UZXN0RGV2aWNlIiwic2ltY3RsIiwiZGV2aWNlIiwiXyIsInZhbHVlcyIsImdldERldmljZXMiLCJuYW1lIiwic3RhcnRzV2l0aCIsImVuZHNXaXRoIiwic3RhdGUiLCJsb2ciLCJ3YXJuIiwic2h1dGRvd25TaW11bGF0b3IiLCJzaHV0ZG93biIsInJ1blNpbXVsYXRvclJlc2V0Iiwibm9SZXNldCIsImZ1bGxSZXNldCIsImRlYnVnIiwiaXNLZXljaGFpbnNCYWNrdXBTdWNjZXNzZnVsIiwia2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIiwia2VlcEtleUNoYWlucyIsImJhY2t1cEtleWNoYWlucyIsImNsZWFuIiwicmVzdG9yZUtleWNoYWlucyIsImluZm8iLCJidW5kbGVJZCIsImlzUnVubmluZyIsImVuZm9yY2VTaW11bGF0b3JTaHV0ZG93biIsInRlcm1pbmF0ZUFwcCIsImVyciIsImFwcCIsImlzU2FmYXJpIiwiYnJvd3Nlck5hbWUiLCJ0b0xvd2VyQ2FzZSIsImNsZWFuU2FmYXJpIiwic2NydWJDdXN0b21BcHAiLCJtZXNzYWdlIiwiaW5zdGFsbFRvU2ltdWxhdG9yIiwibmV3U2ltdWxhdG9yIiwiaXNBcHBJbnN0YWxsZWQiLCJyZW1vdmVBcHAiLCJpbnN0YWxsQXBwIiwiZSIsInNodXRkb3duT3RoZXJTaW11bGF0b3JzIiwiY3VycmVudERldmljZSIsImFsbERldmljZXMiLCJmbGF0TWFwIiwib3RoZXJCb290ZWREZXZpY2VzIiwiZmlsdGVyIiwiaXNFbXB0eSIsImxlbmd0aCIsInBsdXJhbGl6ZSIsInNodXRkb3duRGV2aWNlIiwibGF1bmNoQW5kUXVpdFNpbXVsYXRvciIsInNpbSIsInNhZmFyaSIsInRpbWVvdXQiLCJsYXVuY2hBbmRRdWl0IiwiY2hlY2tQcmVmZXJlbmNlcyIsInNldHRpbmdzIiwic2V0dGluZyIsImhhcyIsInNldExvY2FsZUFuZFByZWZlcmVuY2VzIiwic2h1dGRvd25GbiIsIm5vb3AiLCJsb2NhbENvbmZpZyIsInNldExvY2FsZSIsInByZWZzVXBkYXRlZCIsInNldFByZWZlcmVuY2VzIiwiX3VwZGF0ZWQiLCJsb2NhbGVDb25maWciLCJsYW5ndWFnZSIsImxvY2FsZSIsImNhbGVuZGFyRm9ybWF0IiwiaXNGcmVzaCIsInNpbXVsYXRvclN0YXJ0dXBUaW1lb3V0IiwidXBkYXRlZCIsInVwZGF0ZUxvY2FsZSIsImVycm9yQW5kVGhyb3ciLCJuZWVkVG9TZXRQcmVmcyIsIm5lZWRUb1NldFNhZmFyaVByZWZzIiwic2V0TG9jU2VydmljZXNQcmVmcyIsImVycm9yIiwic2V0U2FmYXJpUHJlZnMiLCJsb2NTZXJ2IiwiZmluZCIsImxvY2F0aW9uU2VydmljZXNFbmFibGVkIiwibG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQiLCJjIiwiaXNVbmRlZmluZWQiLCJ1cGRhdGVTZXR0aW5ncyIsIkxvY2F0aW9uU2VydmljZXNFbmFibGVkIiwibXNnIiwibG9jQXV0aCIsInVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MiLCJzYWZhcmlTZXR0aW5ncyIsInZhbCIsInNhZmFyaUFsbG93UG9wdXBzIiwiV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSIsIkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkiLCJzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmciLCJXYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMiLCJzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQiLCJPcGVuTGlua3NJbkJhY2tncm91bmQiLCJzaXplIiwidXBkYXRlU2FmYXJpU2V0dGluZ3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxpQkFBaUIsR0FBRyxZQUExQjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxDQUNwQix5QkFEb0IsRUFFcEIsNEJBRm9CLENBQXRCO0FBSUEsTUFBTUMsb0JBQW9CLEdBQUcsQ0FDM0IsbUJBRDJCLEVBRTNCLDBCQUYyQixFQUczQiw2QkFIMkIsQ0FBN0I7O0FBbUJBLGVBQWVDLFNBQWYsQ0FBMEJDLElBQTFCLEVBQWdDQyxRQUFRLEdBQUdDLDhCQUEzQyxFQUE4RDtBQUM1RCxRQUFNQyxjQUFjLEdBQUdILElBQUksQ0FBQ0ksdUJBQTVCO0FBQ0EsUUFBTUMsSUFBSSxHQUFHLE1BQU0sSUFBSUMsbUJBQUosQ0FBVztBQUFDSCxJQUFBQTtBQUFELEdBQVgsRUFBNkJJLFlBQTdCLENBQ2hCLEdBQUVYLGlCQUFrQixJQUFHWSxjQUFLQyxNQUFMLEdBQWNDLFdBQWQsRUFBNEIsSUFBR1YsSUFBSSxDQUFDVyxVQUFXLEVBRHRELEVBRWpCWCxJQUFJLENBQUNXLFVBRlksRUFHakJYLElBQUksQ0FBQ1ksZUFIWSxFQUlqQjtBQUFDWCxJQUFBQTtBQUFELEdBSmlCLENBQW5CO0FBTUEsU0FBTyxNQUFNLHNDQUFhSSxJQUFiLEVBQW1CO0FBQzlCSixJQUFBQSxRQUQ4QjtBQUU5QlksSUFBQUEsY0FBYyxFQUFFLEtBRmM7QUFHOUJWLElBQUFBO0FBSDhCLEdBQW5CLENBQWI7QUFLRDs7QUFlRCxlQUFlVyxjQUFmLENBQStCQyxJQUFJLEdBQUcsRUFBdEMsRUFBMEM7QUFDeEMsUUFBTTtBQUNKSCxJQUFBQSxlQURJO0FBRUpE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LElBQUYsQ0FBT1QsY0FBUCxJQUF5QixDQUExQixHQUNILE1BQU16QyxHQUFHLENBQUNtRCxvQkFBSixDQUF5QlYsY0FBekIsQ0FESCxHQUVILEtBRko7QUFHRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldFNpbXVsYXRvciB9IGZyb20gJ2FwcGl1bS1pb3Mtc2ltdWxhdG9yJztcbmltcG9ydCBTaW1jdGwgZnJvbSAnbm9kZS1zaW1jdGwnO1xuaW1wb3J0IHsgcmVzZXRUZXN0UHJvY2Vzc2VzIH0gZnJvbSAnYXBwaXVtLXdlYmRyaXZlcmFnZW50JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHsgUExBVEZPUk1fTkFNRV9JT1MgfSBmcm9tICcuL2Rlc2lyZWQtY2Fwcyc7XG5cblxuY29uc3QgQVBQSVVNX1NJTV9QUkVGSVggPSAnYXBwaXVtVGVzdCc7XG5jb25zdCBTRVRUSU5HU19DQVBTID0gW1xuICAnbG9jYXRpb25TZXJ2aWNlc0VuYWJsZWQnLFxuICAnbG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQnLFxuXTtcbmNvbnN0IFNBRkFSSV9TRVRUSU5HU19DQVBTID0gW1xuICAnc2FmYXJpQWxsb3dQb3B1cHMnLFxuICAnc2FmYXJpSWdub3JlRnJhdWRXYXJuaW5nJyxcbiAgJ3NhZmFyaU9wZW5MaW5rc0luQmFja2dyb3VuZCcsXG5dO1xuXG4vKipcbiAqIENhcGFiaWxpdHkgc2V0IGJ5IGEgdXNlclxuICpcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBkZXZpY2VOYW1lIC0gQSBuYW1lIGZvciB0aGUgZGV2aWNlXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGxhdGZvcm1WZXJzaW9uIC0gVGhlIHZlcnNpb24gb2YgaU9TIHRvIHVzZVxuICovXG4vKipcbiAqIENyZWF0ZSBhIG5ldyBzaW11bGF0b3Igd2l0aCBgYXBwaXVtVGVzdC1gIHByZWZpeCBhbmQgcmV0dXJuIHRoZSBvYmplY3QuXG4gKlxuICogQHBhcmFtIHtvYmplY3R9IFNpbUNyZWF0aW9uQ2FwcyAtIENhcGFiaWxpdHkgc2V0IGJ5IGEgdXNlci4gVGhlIG9wdGlvbnMgYXZhaWxhYmxlIGFyZTpcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBwbGF0Zm9ybSBbaU9TXSAtIFBsYXRmb3JtIG5hbWUgaW4gb3JkZXIgdG8gc3BlY2lmeSBydW50aW1lIHN1Y2ggYXMgJ2lPUycsICd0dk9TJywgJ3dhdGNoT1MnXG4gKiBAcmV0dXJucyB7b2JqZWN0fSBTaW11bGF0b3Igb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGUgdWRpZCBwYXNzZWQgaW4uXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVNpbSAoY2FwcywgcGxhdGZvcm0gPSBQTEFURk9STV9OQU1FX0lPUykge1xuICBjb25zdCBkZXZpY2VzU2V0UGF0aCA9IGNhcHMuc2ltdWxhdG9yRGV2aWNlc1NldFBhdGg7XG4gIGNvbnN0IHVkaWQgPSBhd2FpdCBuZXcgU2ltY3RsKHtkZXZpY2VzU2V0UGF0aH0pLmNyZWF0ZURldmljZShcbiAgICBgJHtBUFBJVU1fU0lNX1BSRUZJWH0tJHt1dGlsLnV1aWRWNCgpLnRvVXBwZXJDYXNlKCl9LSR7Y2Fwcy5kZXZpY2VOYW1lfWAsXG4gICAgY2Fwcy5kZXZpY2VOYW1lLFxuICAgIGNhcHMucGxhdGZvcm1WZXJzaW9uLFxuICAgIHtwbGF0Zm9ybX0sXG4gICk7XG4gIHJldHVybiBhd2FpdCBnZXRTaW11bGF0b3IodWRpZCwge1xuICAgIHBsYXRmb3JtLFxuICAgIGNoZWNrRXhpc3RlbmNlOiBmYWxzZSxcbiAgICBkZXZpY2VzU2V0UGF0aCxcbiAgfSk7XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU2ltdWxhdG9yTG9va3VwT3B0aW9uc1xuICogQHByb3BlcnR5IHshc3RyaW5nfSBkZXZpY2VOYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGRldmljZSB0byBsb29rdXBcbiAqIEBwcm9wZXJ0eSB7IXN0cmluZ30gcGxhdGZvcm1WZXJzaW9uIC0gVGhlIHBsYXRmb3JtIHZlcnNpb24gc3RyaW5nXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHNpbXVsYXRvckRldmljZXNTZXRQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgc2ltdWxhdG9yIGRldmljZXMgc2V0XG4gKi9cblxuLyoqXG4gKiBHZXQgYSBzaW11bGF0b3Igd2hpY2ggaXMgYWxyZWFkeSBydW5uaW5nLlxuICpcbiAqIEBwYXJhbSB7P1NpbXVsYXRvckxvb2t1cE9wdGlvbnN9IG9wdHNcbiAqIEByZXR1cm5zIHs/U2ltdWxhdG9yfSBUaGUgbWF0Y2hlZCBTaW11bGF0b3IgaW5zdGFuY2Ugb3IgYG51bGxgIGlmIG5vIG1hdGNoaW5nICBkZXZpY2UgaXMgZm91bmQuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldEV4aXN0aW5nU2ltIChvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHBsYXRmb3JtVmVyc2lvbixcbiAgICBkZXZpY2VOYW1lLFxuICAgIHNpbXVsYXRvckRldmljZXNTZXRQYXRoOiBkZXZpY2VzU2V0UGF0aCxcbiAgfSA9IG9wdHM7XG5cbiAgbGV0IGFwcGl1bVRlc3REZXZpY2U7XG4gIGNvbnN0IHNpbWN0bCA9IG5ldyBTaW1jdGwoe2RldmljZXNTZXRQYXRofSk7XG4gIGZvciAoY29uc3QgZGV2aWNlIG9mIF8udmFsdWVzKGF3YWl0IHNpbWN0bC5nZXREZXZpY2VzKHBsYXRmb3JtVmVyc2lvbikpKSB7XG4gICAgaWYgKGRldmljZS5uYW1lID09PSBkZXZpY2VOYW1lKSB7XG4gICAgICByZXR1cm4gYXdhaXQgZ2V0U2ltdWxhdG9yKGRldmljZS51ZGlkLCB7XG4gICAgICAgIHBsYXRmb3JtOiBkZXZpY2UucGxhdGZvcm0sXG4gICAgICAgIGNoZWNrRXhpc3RlbmNlOiBmYWxzZSxcbiAgICAgICAgZGV2aWNlc1NldFBhdGgsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoZGV2aWNlLm5hbWUuc3RhcnRzV2l0aChBUFBJVU1fU0lNX1BSRUZJWCkgJiYgZGV2aWNlLm5hbWUuZW5kc1dpdGgoZGV2aWNlTmFtZSkpIHtcbiAgICAgIGFwcGl1bVRlc3REZXZpY2UgPSBkZXZpY2U7XG4gICAgICAvLyBjaG9vc2UgdGhlIGZpcnN0IGJvb3RlZCBzaW11bGF0b3JcbiAgICAgIGlmIChkZXZpY2Uuc3RhdGUgPT09ICdCb290ZWQnKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChhcHBpdW1UZXN0RGV2aWNlKSB7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byBmaW5kIGRldmljZSAnJHtkZXZpY2VOYW1lfScuIGAgK1xuICAgICAgYEZvdW5kICcke2FwcGl1bVRlc3REZXZpY2UubmFtZX0nICh1ZGlkOiAnJHthcHBpdW1UZXN0RGV2aWNlLnVkaWR9JykgaW5zdGVhZGApO1xuICAgIHJldHVybiBhd2FpdCBnZXRTaW11bGF0b3IoYXBwaXVtVGVzdERldmljZS51ZGlkLCB7XG4gICAgICBwbGF0Zm9ybTogYXBwaXVtVGVzdERldmljZS5wbGF0Zm9ybSxcbiAgICAgIGNoZWNrRXhpc3RlbmNlOiBmYWxzZSxcbiAgICAgIGRldmljZXNTZXRQYXRoLFxuICAgIH0pO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaHV0ZG93blNpbXVsYXRvciAoZGV2aWNlKSB7XG4gIC8vIHN0b3AgWENUZXN0IHByb2Nlc3NlcyBpZiBydW5uaW5nIHRvIGF2b2lkIHVuZXhwZWN0ZWQgc2lkZSBlZmZlY3RzXG4gIGF3YWl0IHJlc2V0VGVzdFByb2Nlc3NlcyhkZXZpY2UudWRpZCwgdHJ1ZSk7XG4gIGF3YWl0IGRldmljZS5zaHV0ZG93bigpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW5TaW11bGF0b3JSZXNldCAoZGV2aWNlLCBvcHRzKSB7XG4gIGlmIChvcHRzLm5vUmVzZXQgJiYgIW9wdHMuZnVsbFJlc2V0KSB7XG4gICAgLy8gbm9SZXNldCA9PT0gdHJ1ZSAmJiBmdWxsUmVzZXQgPT09IGZhbHNlXG4gICAgbG9nLmRlYnVnKCdSZXNldDogbm9SZXNldCBpcyBvbi4gTGVhdmluZyBzaW11bGF0b3IgYXMgaXMnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoIWRldmljZSkge1xuICAgIGxvZy5kZWJ1ZygnUmVzZXQ6IG5vIGRldmljZSBhdmFpbGFibGUuIFNraXBwaW5nJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKG9wdHMuZnVsbFJlc2V0KSB7XG4gICAgbG9nLmRlYnVnKCdSZXNldDogZnVsbFJlc2V0IGlzIG9uLiBDbGVhbmluZyBzaW11bGF0b3InKTtcbiAgICBhd2FpdCBzaHV0ZG93blNpbXVsYXRvcihkZXZpY2UpO1xuICAgIGxldCBpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwgPSBmYWxzZTtcbiAgICBpZiAob3B0cy5rZXljaGFpbnNFeGNsdWRlUGF0dGVybnMgfHwgb3B0cy5rZWVwS2V5Q2hhaW5zKSB7XG4gICAgICBpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwgPSBhd2FpdCBkZXZpY2UuYmFja3VwS2V5Y2hhaW5zKCk7XG4gICAgfVxuICAgIGF3YWl0IGRldmljZS5jbGVhbigpO1xuICAgIGlmIChpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwpIHtcbiAgICAgIGF3YWl0IGRldmljZS5yZXN0b3JlS2V5Y2hhaW5zKG9wdHMua2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIHx8IFtdKTtcbiAgICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgcmVzdG9yZWQga2V5Y2hhaW5zIGFmdGVyIGZ1bGwgcmVzZXRgKTtcbiAgICB9IGVsc2UgaWYgKG9wdHMua2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIHx8IG9wdHMua2VlcEtleUNoYWlucykge1xuICAgICAgbG9nLndhcm4oJ0Nhbm5vdCByZXN0b3JlIGtleWNoYWlucyBhZnRlciBmdWxsIHJlc2V0LCBiZWNhdXNlICcgK1xuICAgICAgICAgICAgICAgJ3RoZSBiYWNrdXAgb3BlcmF0aW9uIGRpZCBub3Qgc3VjY2VlZCcpO1xuICAgIH1cbiAgfSBlbHNlIGlmIChvcHRzLmJ1bmRsZUlkKSB7XG4gICAgLy8gZmFzdFJlc2V0IG9yIG5vUmVzZXRcblxuICAgIC8vIFRlcm1pbmF0ZSB0aGUgYXBwIHVuZGVyIHRlc3QgaWYgaXQgaXMgc3RpbGwgcnVubmluZyBvbiBTaW11bGF0b3JcbiAgICAvLyBUZXJtaW5hdGlvbiBpcyBub3QgbmVlZGVkIGlmIFNpbXVsYXRvciBpcyBub3QgcnVubmluZ1xuICAgIGlmIChhd2FpdCBkZXZpY2UuaXNSdW5uaW5nKCkpIHtcbiAgICAgIGlmIChvcHRzLmVuZm9yY2VTaW11bGF0b3JTaHV0ZG93bikge1xuICAgICAgICBhd2FpdCBzaHV0ZG93blNpbXVsYXRvcihkZXZpY2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBkZXZpY2Uuc2ltY3RsLnRlcm1pbmF0ZUFwcChvcHRzLmJ1bmRsZUlkKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLndhcm4oYFJlc2V0OiBmYWlsZWQgdG8gdGVybWluYXRlIFNpbXVsYXRvciBhcHBsaWNhdGlvbiB3aXRoIGlkIFwiJHtvcHRzLmJ1bmRsZUlkfVwiYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG9wdHMuYXBwKSB7XG4gICAgICBsb2cuaW5mbygnTm90IHNjcnViYmluZyB0aGlyZCBwYXJ0eSBhcHAgaW4gYW50aWNpcGF0aW9uIG9mIHVuaW5zdGFsbCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBpc1NhZmFyaSA9IChvcHRzLmJyb3dzZXJOYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpID09PSAnc2FmYXJpJztcbiAgICB0cnkge1xuICAgICAgaWYgKGlzU2FmYXJpKSB7XG4gICAgICAgIGF3YWl0IGRldmljZS5jbGVhblNhZmFyaSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gaU9TIDgrIGRvZXMgbm90IG5lZWQgYmFzZW5hbWVcbiAgICAgICAgYXdhaXQgZGV2aWNlLnNjcnViQ3VzdG9tQXBwKCcnLCBvcHRzLmJ1bmRsZUlkKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGVyci5tZXNzYWdlKTtcbiAgICAgIGxvZy53YXJuKGBSZXNldDogY291bGQgbm90IHNjcnViICR7aXNTYWZhcmkgPyAnU2FmYXJpIGJyb3dzZXInIDogJ2FwcGxpY2F0aW9uIHdpdGggaWQgXCInICsgb3B0cy5idW5kbGVJZCArICdcIid9LiBMZWF2aW5nIGFzIGlzLmApO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEluc3RhbGxPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gbm9SZXNldCBbZmFsc2VdIFdoZXRoZXIgdG8gZGlzYWJsZSByZXNldFxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gbmV3U2ltdWxhdG9yIFtmYWxzZV0gV2hldGhlciB0aGUgc2ltdWxhdG9yIGlzIGJyYW5kIG5ld1xuICovXG5cbi8qKlxuICogQHBhcmFtIHtvYmplY3R9IGRldmljZSBUaGUgc2ltdWxhdG9yIGRldmljZSBvYmplY3RcbiAqIEBwYXJhbSB7P3N0cmluZ30gYXBwIFRoZSBhcHAgdG8gdGhlIHBhdGhcbiAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVJZCBUaGUgYnVuZGxlIGlkIHRvIGVuc3VyZSBpdCBpcyBhbHJlYWR5IGluc3RhbGxlZCBhbmQgdW5pbnN0YWxsIGl0XG4gKiBAcGFyYW0gez9JbnN0YWxsT3B0aW9uc30gb3B0c1xuICovXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsVG9TaW11bGF0b3IgKGRldmljZSwgYXBwLCBidW5kbGVJZCwgb3B0cyA9IHt9KSB7XG4gIGlmICghYXBwKSB7XG4gICAgbG9nLmRlYnVnKCdObyBhcHAgcGF0aCBpcyBnaXZlbi4gTm90aGluZyB0byBpbnN0YWxsLicpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICBub1Jlc2V0ID0gdHJ1ZSxcbiAgICBuZXdTaW11bGF0b3IgPSBmYWxzZSxcbiAgfSA9IG9wdHM7XG5cbiAgaWYgKCFuZXdTaW11bGF0b3IgJiYgYnVuZGxlSWQgJiYgYXdhaXQgZGV2aWNlLmlzQXBwSW5zdGFsbGVkKGJ1bmRsZUlkKSkge1xuICAgIGlmIChub1Jlc2V0KSB7XG4gICAgICBsb2cuZGVidWcoYEFwcCAnJHtidW5kbGVJZH0nIGlzIGFscmVhZHkgaW5zdGFsbGVkLiBObyBuZWVkIHRvIHJlaW5zdGFsbC5gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBSZXNldCByZXF1ZXN0ZWQuIFJlbW92aW5nIGFwcCB3aXRoIGlkICcke2J1bmRsZUlkfScgZnJvbSB0aGUgZGV2aWNlYCk7XG4gICAgYXdhaXQgZGV2aWNlLnJlbW92ZUFwcChidW5kbGVJZCk7XG4gIH1cblxuICBsb2cuZGVidWcoYEluc3RhbGxpbmcgJyR7YXBwfScgb24gU2ltdWxhdG9yIHdpdGggVVVJRCAnJHtkZXZpY2UudWRpZH0nLi4uYCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZGV2aWNlLmluc3RhbGxBcHAoYXBwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIGl0IHNvbWV0aW1lcyBmYWlscyBvbiBYY29kZSAxMCBiZWNhdXNlIG9mIGEgcmFjZSBjb25kaXRpb25cbiAgICBsb2cuaW5mbyhgR290IGFuIGVycm9yIG9uICcke2FwcH0nIGluc3RhbGw6ICR7ZS5tZXNzYWdlfWApO1xuICAgIGxvZy5pbmZvKCdSZXRyeWluZyBhcHBsaWNhdGlvbiBpbnN0YWxsJyk7XG4gICAgYXdhaXQgZGV2aWNlLmluc3RhbGxBcHAoYXBwKTtcbiAgfVxuICBsb2cuZGVidWcoJ1RoZSBhcHAgaGFzIGJlZW4gaW5zdGFsbGVkIHN1Y2Nlc3NmdWxseS4nKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2h1dGRvd25PdGhlclNpbXVsYXRvcnMgKGN1cnJlbnREZXZpY2UpIHtcbiAgY29uc3Qgc2ltY3RsID0gbmV3IFNpbWN0bCh7XG4gICAgZGV2aWNlc1NldFBhdGg6IGN1cnJlbnREZXZpY2UuZGV2aWNlc1NldFBhdGhcbiAgfSk7XG4gIGNvbnN0IGFsbERldmljZXMgPSBfLmZsYXRNYXAoXy52YWx1ZXMoYXdhaXQgc2ltY3RsLmdldERldmljZXMoKSkpO1xuICBjb25zdCBvdGhlckJvb3RlZERldmljZXMgPSBhbGxEZXZpY2VzLmZpbHRlcigoZGV2aWNlKSA9PiBkZXZpY2UudWRpZCAhPT0gY3VycmVudERldmljZS51ZGlkICYmIGRldmljZS5zdGF0ZSA9PT0gJ0Jvb3RlZCcpO1xuICBpZiAoXy5pc0VtcHR5KG90aGVyQm9vdGVkRGV2aWNlcykpIHtcbiAgICBsb2cuaW5mbygnTm8gb3RoZXIgcnVubmluZyBzaW11bGF0b3JzIGhhdmUgYmVlbiBkZXRlY3RlZCcpO1xuICAgIHJldHVybjtcbiAgfVxuICBsb2cuaW5mbyhgRGV0ZWN0ZWQgJHtvdGhlckJvb3RlZERldmljZXMubGVuZ3RofSBvdGhlciBydW5uaW5nICR7dXRpbC5wbHVyYWxpemUoJ1NpbXVsYXRvcicsIG90aGVyQm9vdGVkRGV2aWNlcy5sZW5ndGgpfS5gICtcbiAgICBgU2h1dHRpbmcgdGhlbSBkb3duLi4uYCk7XG4gIGZvciAoY29uc3Qge3VkaWR9IG9mIG90aGVyQm9vdGVkRGV2aWNlcykge1xuICAgIC8vIEl0IGlzIG5lY2Vzc2FyeSB0byBzdG9wIHRoZSBjb3JyZXNwb25kaW5nIHhjb2RlYnVpbGQgcHJvY2VzcyBiZWZvcmUga2lsbGluZ1xuICAgIC8vIHRoZSBzaW11bGF0b3IsIG90aGVyd2lzZSBpdCB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgcmVzdGFydGVkXG4gICAgYXdhaXQgcmVzZXRUZXN0UHJvY2Vzc2VzKHVkaWQsIHRydWUpO1xuICAgIHNpbWN0bC51ZGlkID0gdWRpZDtcbiAgICBhd2FpdCBzaW1jdGwuc2h1dGRvd25EZXZpY2UoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yIChzaW0sIG9wdHMgPSB7fSkge1xuICBsb2cuZGVidWcoJ05vIHNpbXVsYXRvciBkaXJlY3RvcmllcyBmb3VuZC4nKTtcbiAgY29uc3QgeyBzYWZhcmksIHRpbWVvdXQgfSA9IG9wdHM7XG4gIHJldHVybiB0aW1lb3V0XG4gICAgPyBhd2FpdCBzaW0ubGF1bmNoQW5kUXVpdChzYWZhcmksIHRpbWVvdXQpXG4gICAgOiBhd2FpdCBzaW0ubGF1bmNoQW5kUXVpdChzYWZhcmkpO1xufVxuXG5mdW5jdGlvbiBjaGVja1ByZWZlcmVuY2VzIChzZXR0aW5ncywgb3B0cyA9IHt9KSB7XG4gIGZvciAobGV0IHNldHRpbmcgb2Ygc2V0dGluZ3MpIHtcbiAgICBpZiAoXy5oYXMob3B0cywgc2V0dGluZykpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldExvY2FsZUFuZFByZWZlcmVuY2VzIChzaW0sIG9wdHMsIHNhZmFyaSA9IGZhbHNlLCBzaHV0ZG93bkZuID0gXy5ub29wKSB7XG4gIGNvbnN0IGxvY2FsQ29uZmlnID0gYXdhaXQgc2V0TG9jYWxlKHNpbSwgb3B0cywge30sIHNhZmFyaSk7XG4gIGNvbnN0IHByZWZzVXBkYXRlZCA9IGF3YWl0IHNldFByZWZlcmVuY2VzKHNpbSwgb3B0cywgc2FmYXJpKTtcbiAgaWYgKGxvY2FsQ29uZmlnLl91cGRhdGVkIHx8IHByZWZzVXBkYXRlZCkge1xuICAgIGxvZy5kZWJ1ZygnVXBkYXRlZCBzZXR0aW5ncy4gUmVib290aW5nIHRoZSBzaW11bGF0b3IgaWYgaXQgaXMgYWxyZWFkeSBvcGVuJyk7XG4gICAgYXdhaXQgc2h1dGRvd25GbihzaW0pO1xuICB9IGVsc2Uge1xuICAgIGxvZy5kZWJ1ZygnU2V0dGluZyBkaWQgbm90IG5lZWQgdG8gYmUgdXBkYXRlZCcpO1xuICB9XG4gIGRlbGV0ZSBsb2NhbENvbmZpZy5fdXBkYXRlZDtcbiAgcmV0dXJuIGxvY2FsQ29uZmlnO1xufVxuXG4vLyBwYXNzIGluIHRoZSBzaW11bGF0b3Igc28gdGhhdCBvdGhlciBzeXN0ZW1zIHRoYXQgdXNlIHRoZSBmdW5jdGlvbiBjYW4gc3VwcGx5XG4vLyB3aGF0ZXZlciB0aGV5IGhhdmVcbmFzeW5jIGZ1bmN0aW9uIHNldExvY2FsZSAoc2ltLCBvcHRzLCBsb2NhbGVDb25maWcgPSB7fSwgc2FmYXJpID0gZmFsc2UpIHtcbiAgaWYgKCFvcHRzLmxhbmd1YWdlICYmICFvcHRzLmxvY2FsZSAmJiAhb3B0cy5jYWxlbmRhckZvcm1hdCkge1xuICAgIGxvZy5kZWJ1ZygnTm8gcmVhc29uIHRvIHNldCBsb2NhbGUnKTtcbiAgICByZXR1cm4ge1xuICAgICAgX3VwZGF0ZWQ6IGZhbHNlLFxuICAgIH07XG4gIH1cblxuICAvLyB3ZSBuZWVkIHRoZSBzaW11bGF0b3IgdG8gaGF2ZSBpdHMgZGlyZWN0b3JpZXMgaW4gcGxhY2VcbiAgaWYgKGF3YWl0IHNpbS5pc0ZyZXNoKCkpIHtcbiAgICBhd2FpdCBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yKHNpbSwge1xuICAgICAgc2FmYXJpLFxuICAgICAgdGltZW91dDogb3B0cy5zaW11bGF0b3JTdGFydHVwVGltZW91dCxcbiAgICB9KTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygnU2V0dGluZyBsb2NhbGUgaW5mb3JtYXRpb24nKTtcbiAgbG9jYWxlQ29uZmlnID0ge1xuICAgIGxhbmd1YWdlOiBvcHRzLmxhbmd1YWdlIHx8IGxvY2FsZUNvbmZpZy5sYW5ndWFnZSxcbiAgICBsb2NhbGU6IG9wdHMubG9jYWxlIHx8IGxvY2FsZUNvbmZpZy5sb2NhbGUsXG4gICAgY2FsZW5kYXJGb3JtYXQ6IG9wdHMuY2FsZW5kYXJGb3JtYXQgfHwgbG9jYWxlQ29uZmlnLmNhbGVuZGFyRm9ybWF0LFxuICAgIF91cGRhdGVkOiBmYWxzZSxcbiAgfTtcblxuICB0cnkge1xuICAgIGxldCB1cGRhdGVkID0gYXdhaXQgc2ltLnVwZGF0ZUxvY2FsZShvcHRzLmxhbmd1YWdlLCBvcHRzLmxvY2FsZSwgb3B0cy5jYWxlbmRhckZvcm1hdCk7XG4gICAgaWYgKHVwZGF0ZWQpIHtcbiAgICAgIGxvY2FsZUNvbmZpZy5fdXBkYXRlZCA9IHRydWU7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEFwcGl1bSB3YXMgdW5hYmxlIHRvIHNldCBsb2NhbGUgaW5mbzogJHtlfWApO1xuICB9XG5cbiAgcmV0dXJuIGxvY2FsZUNvbmZpZztcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0UHJlZmVyZW5jZXMgKHNpbSwgb3B0cywgc2FmYXJpID0gZmFsc2UpIHtcbiAgbGV0IG5lZWRUb1NldFByZWZzID0gY2hlY2tQcmVmZXJlbmNlcyhTRVRUSU5HU19DQVBTLCBvcHRzKTtcbiAgbGV0IG5lZWRUb1NldFNhZmFyaVByZWZzID0gY2hlY2tQcmVmZXJlbmNlcyhTQUZBUklfU0VUVElOR1NfQ0FQUywgb3B0cyk7XG4gIGlmICghbmVlZFRvU2V0UHJlZnMgJiYgIW5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgbG9nLmRlYnVnKCdObyBpT1MgLyBhcHAgcHJlZmVyZW5jZXMgdG8gc2V0Jyk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbG9nLmRlYnVnKCdTZXR0aW5nIGlPUyBhbmQgYXBwIHByZWZlcmVuY2VzJyk7XG5cbiAgaWYgKGF3YWl0IHNpbS5pc0ZyZXNoKCkpIHtcbiAgICBhd2FpdCBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yKHNpbSwge1xuICAgICAgc2FmYXJpLFxuICAgICAgdGltZW91dDogb3B0cy5zaW11bGF0b3JTdGFydHVwVGltZW91dCxcbiAgICB9KTtcbiAgfVxuXG4gIGxldCB1cGRhdGVkID0gZmFsc2U7XG4gIHRyeSB7XG4gICAgaWYgKG5lZWRUb1NldFByZWZzKSB7XG4gICAgICB1cGRhdGVkID0gYXdhaXQgc2V0TG9jU2VydmljZXNQcmVmcyhzaW0sIG9wdHMpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvcignRXJyb3Igc2V0dGluZyBsb2NhdGlvbiBzZXJ2aWNlcyBwcmVmZXJlbmNlcywgcHJlZnMgd2lsbCBub3Qgd29yaycpO1xuICAgIGxvZy5lcnJvcihlKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgaWYgKG5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgICB1cGRhdGVkID0gYXdhaXQgc2V0U2FmYXJpUHJlZnMoc2ltLCBvcHRzKSB8fCB1cGRhdGVkO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvcignRXJyb3Igc2V0dGluZyBzYWZhcmkgcHJlZmVyZW5jZXMsIHByZWZzIHdpbGwgbm90IHdvcmsnKTtcbiAgICBsb2cuZXJyb3IoZSk7XG4gIH1cblxuICByZXR1cm4gdXBkYXRlZDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0TG9jU2VydmljZXNQcmVmcyAoc2ltLCBvcHRzID0ge30pIHtcbiAgbGV0IGxvY1NlcnYgPSBfLmZpbmQoW29wdHMubG9jYXRpb25TZXJ2aWNlc0VuYWJsZWQsIG9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWRdLCAoYykgPT4gIV8uaXNVbmRlZmluZWQoYykpO1xuICBpZiAoIV8uaXNVbmRlZmluZWQobG9jU2VydikpIHtcbiAgICBsb2NTZXJ2ID0gbG9jU2VydiA/IDEgOiAwO1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBsb2NhdGlvbiBzZXJ2aWNlcyB0byAke2xvY1NlcnZ9YCk7XG4gICAgYXdhaXQgc2ltLnVwZGF0ZVNldHRpbmdzKCdsb2NhdGlvblNlcnZpY2VzJywge1xuICAgICAgTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWQ6IGxvY1NlcnYsXG4gICAgICAnTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWRJbjcuMCc6IGxvY1NlcnYsXG4gICAgICAnTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWRJbjguMCc6IGxvY1NlcnZcbiAgICB9KTtcbiAgfVxuICBpZiAoIV8uaXNVbmRlZmluZWQob3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZCkpIHtcbiAgICBpZiAoIW9wdHMuYnVuZGxlSWQpIHtcbiAgICAgIGxldCBtc2cgPSBcIkNhbid0IHNldCBsb2NhdGlvbiBzZXJ2aWNlcyBmb3IgYXBwIHdpdGhvdXQgYnVuZGxlIElEXCI7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgIH1cbiAgICBsZXQgbG9jQXV0aCA9ICEhb3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZDtcbiAgICBpZiAobG9jQXV0aCkge1xuICAgICAgbG9nLmRlYnVnKCdBdXRob3JpemluZyBsb2NhdGlvbiBzZXJ2aWNlcyBmb3IgYXBwJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZygnRGUtYXV0aG9yaXppbmcgbG9jYXRpb24gc2VydmljZXMgZm9yIGFwcCcpO1xuICAgIH1cbiAgICBhd2FpdCBzaW0udXBkYXRlTG9jYXRpb25TZXR0aW5ncyhvcHRzLmJ1bmRsZUlkLCBsb2NBdXRoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRTYWZhcmlQcmVmcyAoc2ltLCBvcHRzID0ge30pIHtcbiAgbGV0IHNhZmFyaVNldHRpbmdzID0ge307XG5cbiAgaWYgKF8uaGFzKG9wdHMsICdzYWZhcmlBbGxvd1BvcHVwcycpKSB7XG4gICAgY29uc3QgdmFsID0gISFvcHRzLnNhZmFyaUFsbG93UG9wdXBzO1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBqYXZhc2NyaXB0IHdpbmRvdyBvcGVuaW5nIHRvICcke3ZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSA9IHZhbDtcbiAgICBzYWZhcmlTZXR0aW5ncy5KYXZhU2NyaXB0Q2FuT3BlbldpbmRvd3NBdXRvbWF0aWNhbGx5ID0gdmFsO1xuICB9XG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpSWdub3JlRnJhdWRXYXJuaW5nJykpIHtcbiAgICBjb25zdCB2YWwgPSAhb3B0cy5zYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmc7XG4gICAgbG9nLmRlYnVnKGBTZXR0aW5nIGZyYXVkdWxlbnQgd2Vic2l0ZSB3YXJuaW5nIHRvICcke3ZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuV2FybkFib3V0RnJhdWR1bGVudFdlYnNpdGVzID0gdmFsO1xuICB9XG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kJykpIHtcbiAgICBjb25zdCB2YWwgPSBvcHRzLnNhZmFyaU9wZW5MaW5rc0luQmFja2dyb3VuZCA/IDEgOiAwO1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBvcGVuaW5nIGxpbmtzIGluIGJhY2tncm91bmQgdG8gJyR7ISF2YWx9J2ApO1xuICAgIHNhZmFyaVNldHRpbmdzLk9wZW5MaW5rc0luQmFja2dyb3VuZCA9IHZhbDtcbiAgfVxuICByZXR1cm4gKF8uc2l6ZShzYWZhcmlTZXR0aW5ncykgPiAwKVxuICAgID8gYXdhaXQgc2ltLnVwZGF0ZVNhZmFyaVNldHRpbmdzKHNhZmFyaVNldHRpbmdzKVxuICAgIDogZmFsc2U7XG59XG5cbmV4cG9ydCB7XG4gIGNyZWF0ZVNpbSwgZ2V0RXhpc3RpbmdTaW0sIHJ1blNpbXVsYXRvclJlc2V0LCBpbnN0YWxsVG9TaW11bGF0b3IsXG4gIHNodXRkb3duU2ltdWxhdG9yLCBzaHV0ZG93bk90aGVyU2ltdWxhdG9ycyxcbiAgc2V0TG9jYWxlLCBzZXRQcmVmZXJlbmNlcywgc2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMsXG59O1xuIl0sImZpbGUiOiJsaWIvc2ltdWxhdG9yLW1hbmFnZW1lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==

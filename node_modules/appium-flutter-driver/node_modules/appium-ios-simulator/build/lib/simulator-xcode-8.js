"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _simulatorXcode = require("./simulator-xcode-6");

var _simulatorXcode2 = _interopRequireDefault(require("./simulator-xcode-7"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

var _teen_process = require("teen_process");

var _geolocation = require("./geolocation");

var _support = require("@appium/support");

var _utils = require("./utils");

const STARTUP_TIMEOUT = 120 * 1000;

const PROCESS_LAUNCH_OK_PATTERN = bundleId => new RegExp(`${bundleId.replace('.', '\\.')}:\\s+\\d+`);

class SimulatorXcode8 extends _simulatorXcode2.default {
  constructor(udid, xcodeVersion) {
    super(udid, xcodeVersion);
    this.isFreshFiles = ['Library/Cookies', 'Library/Preferences/.GlobalPreferences.plist', 'Library/Preferences/com.apple.springboard.plist', 'var/run/syslog.pid'];
    this._idb = null;
    this._locationMenu = 'Debug';
  }

  set idb(value) {
    this._idb = value;
  }

  get idb() {
    return this._idb;
  }

  async killUIClient(opts = {}) {
    let {
      pid,
      signal = 2
    } = opts;
    pid = pid || (await this.getUIClientPid());

    if (!pid) {
      return false;
    }

    _logger.default.debug(`Sending ${signal} kill signal to Simulator UI client with PID ${pid}`);

    try {
      await (0, _teen_process.exec)('kill', [`-${signal}`, pid]);
      return true;
    } catch (e) {
      if (e.code === 1) {
        return false;
      }

      throw new Error(`Cannot kill the Simulator UI client. Original error: ${e.message}`);
    }
  }

  async isAppInstalled(bundleId) {
    try {
      const appContainer = await this.simctl.getAppContainer(bundleId);
      return appContainer.endsWith('.app');
    } catch (err) {
      try {
        const info = await this.simctl.appInfo(bundleId);
        return info.includes('ApplicationType');
      } catch (e) {
        return false;
      }
    }
  }

  get startupTimeout() {
    return STARTUP_TIMEOUT;
  }

  async waitForBoot(startupTimeout) {
    await this.simctl.startBootMonitor({
      timeout: startupTimeout
    });
    this.emit(_simulatorXcode.BOOT_COMPLETED_EVENT);
  }

  async openUrl(url) {
    if (!(await this.isRunning())) {
      throw new Error(`Tried to open '${url}', but Simulator is not in Booted state`);
    }

    const timer = new _support.timing.Timer().start();
    let lastError = null;

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        try {
          const stdout = await this.simctl.launchApp(_utils.MOBILE_SAFARI_BUNDLE_ID);

          if (PROCESS_LAUNCH_OK_PATTERN(_utils.MOBILE_SAFARI_BUNDLE_ID).test(stdout)) {
            await this.simctl.openUrl(url);
            return true;
          }
        } catch (err) {
          _logger.default.warn(`Failed to open '${url}' in Safari. Retrying...`);

          lastError = err.stderr || err.message;
        }

        return false;
      }, {
        waitMs: _utils.SAFARI_STARTUP_TIMEOUT,
        intervalMs: 500
      });
    } catch (err) {
      throw new Error(`Safari cannot open '${url}' after ${timer.getDuration().asSeconds.toFixed(3)}s ` + `because of: ${lastError || 'an unknown error'}`);
    }

    _logger.default.debug(`Safari successfully opened '${url}' in ${timer.getDuration().asSeconds.toFixed(3)}s`);
  }

  async cleanSafari(keepPrefs = true) {
    try {
      if (await this.isRunning()) {
        await this.simctl.terminateApp(_utils.MOBILE_SAFARI_BUNDLE_ID);
      }
    } catch (ign) {}

    await super.cleanSafari(keepPrefs);
  }

  async cleanCustomApp(appFile, appBundleId, scrub = false) {
    try {
      await this.simctl.terminateApp(appBundleId);
    } catch (ign) {}

    await super.cleanCustomApp(appFile, appBundleId, scrub);
  }

  async shake() {
    _logger.default.info(`Performing shake gesture on ${this.udid} Simulator`);

    await this.simctl.spawnProcess(['notifyutil', '-p', 'com.apple.UIKit.SimulatorShake']);
  }

  async isBiometricEnrolled() {
    const output = await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
        end tell
      end tell
    `);

    _logger.default.debug(`Touch ID enrolled state: ${output}`);

    return _lodash.default.isString(output) && output.trim() === 'true';
  }

  async enrollBiometric(isEnabled = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
          if ${isEnabled ? 'not ' : ''}isChecked then
            click dstMenuItem
          end if
        end tell
      end tell
    `);
  }

  async sendBiometricMatch(shouldMatch = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "${shouldMatch ? 'Matching Touch' : 'Non-matching Touch'}" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          click dstMenuItem
        end tell
      end tell
    `);
  }

  async setGeolocation(latitude, longitude) {
    const locationSetters = [async () => await (0, _geolocation.setLocationWithLyft)(this.udid, latitude, longitude), async () => await (0, _geolocation.setLocationWithIdb)(this.idb, latitude, longitude), async () => await (0, _geolocation.setLocationWithAppleScript)(this, latitude, longitude, this._locationMenu)];
    let lastError;

    for (const setter of locationSetters) {
      try {
        await setter();
        return true;
      } catch (e) {
        _logger.default.info(e.message);

        lastError = e;
      }
    }

    throw lastError;
  }

}

var _default = SimulatorXcode8;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOC5qcyJdLCJuYW1lcyI6WyJTVEFSVFVQX1RJTUVPVVQiLCJQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOIiwiYnVuZGxlSWQiLCJSZWdFeHAiLCJyZXBsYWNlIiwiU2ltdWxhdG9yWGNvZGU4IiwiU2ltdWxhdG9yWGNvZGU3IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwieGNvZGVWZXJzaW9uIiwiaXNGcmVzaEZpbGVzIiwiX2lkYiIsIl9sb2NhdGlvbk1lbnUiLCJpZGIiLCJ2YWx1ZSIsImtpbGxVSUNsaWVudCIsIm9wdHMiLCJwaWQiLCJzaWduYWwiLCJnZXRVSUNsaWVudFBpZCIsImxvZyIsImRlYnVnIiwiZSIsImNvZGUiLCJFcnJvciIsIm1lc3NhZ2UiLCJpc0FwcEluc3RhbGxlZCIsImFwcENvbnRhaW5lciIsInNpbWN0bCIsImdldEFwcENvbnRhaW5lciIsImVuZHNXaXRoIiwiZXJyIiwiaW5mbyIsImFwcEluZm8iLCJpbmNsdWRlcyIsInN0YXJ0dXBUaW1lb3V0Iiwid2FpdEZvckJvb3QiLCJzdGFydEJvb3RNb25pdG9yIiwidGltZW91dCIsImVtaXQiLCJCT09UX0NPTVBMRVRFRF9FVkVOVCIsIm9wZW5VcmwiLCJ1cmwiLCJpc1J1bm5pbmciLCJ0aW1lciIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJsYXN0RXJyb3IiLCJzdGRvdXQiLCJsYXVuY2hBcHAiLCJNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCIsInRlc3QiLCJ3YXJuIiwic3RkZXJyIiwid2FpdE1zIiwiU0FGQVJJX1NUQVJUVVBfVElNRU9VVCIsImludGVydmFsTXMiLCJnZXREdXJhdGlvbiIsImFzU2Vjb25kcyIsInRvRml4ZWQiLCJjbGVhblNhZmFyaSIsImtlZXBQcmVmcyIsInRlcm1pbmF0ZUFwcCIsImlnbiIsImNsZWFuQ3VzdG9tQXBwIiwiYXBwRmlsZSIsImFwcEJ1bmRsZUlkIiwic2NydWIiLCJzaGFrZSIsInNwYXduUHJvY2VzcyIsImlzQmlvbWV0cmljRW5yb2xsZWQiLCJvdXRwdXQiLCJleGVjdXRlVUlDbGllbnRTY3JpcHQiLCJfIiwiaXNTdHJpbmciLCJ0cmltIiwiZW5yb2xsQmlvbWV0cmljIiwiaXNFbmFibGVkIiwic2VuZEJpb21ldHJpY01hdGNoIiwic2hvdWxkTWF0Y2giLCJzZXRHZW9sb2NhdGlvbiIsImxhdGl0dWRlIiwibG9uZ2l0dWRlIiwibG9jYXRpb25TZXR0ZXJzIiwic2V0dGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUlBOztBQUNBOztBQUlBLE1BQU1BLGVBQWUsR0FBRyxNQUFNLElBQTlCOztBQUNBLE1BQU1DLHlCQUF5QixHQUFJQyxRQUFELElBQWMsSUFBSUMsTUFBSixDQUFZLEdBQUVELFFBQVEsQ0FBQ0UsT0FBVCxDQUFpQixHQUFqQixFQUFzQixLQUF0QixDQUE2QixXQUEzQyxDQUFoRDs7QUFFQSxNQUFNQyxlQUFOLFNBQThCQyx3QkFBOUIsQ0FBOEM7QUFDNUNDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBRixFQUFRQyxZQUFSLEVBQXNCO0FBQy9CLFVBQU1ELElBQU4sRUFBWUMsWUFBWjtBQUtBLFNBQUtDLFlBQUwsR0FBb0IsQ0FDbEIsaUJBRGtCLEVBRWxCLDhDQUZrQixFQUdsQixpREFIa0IsRUFJbEIsb0JBSmtCLENBQXBCO0FBTUEsU0FBS0MsSUFBTCxHQUFZLElBQVo7QUFJQSxTQUFLQyxhQUFMLEdBQXFCLE9BQXJCO0FBQ0Q7O0FBT00sTUFBSEMsR0FBRyxDQUFFQyxLQUFGLEVBQVM7QUFDZCxTQUFLSCxJQUFMLEdBQVlHLEtBQVo7QUFDRDs7QUFLTSxNQUFIRCxHQUFHLEdBQUk7QUFDVCxXQUFPLEtBQUtGLElBQVo7QUFDRDs7QUFpQmlCLFFBQVpJLFlBQVksQ0FBRUMsSUFBSSxHQUFHLEVBQVQsRUFBYTtBQUM3QixRQUFJO0FBQ0ZDLE1BQUFBLEdBREU7QUFFRkMsTUFBQUEsTUFBTSxHQUFHO0FBRlAsUUFHQUYs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cEMsVUFBSTtBQUNGLGNBQU1DLE1BQU0sRUFBWjtBQUNBLGVBQU8sSUFBUDtBQUNELE9BSEQsQ0FHRSxPQUFPL0QsQ0FBUCxFQUFVO0FBQ1ZGLHdCQUFJWSxJQUFKLENBQVNWLENBQUMsQ0FBQ0csT0FBWDs7QUFDQXVCLFFBQUFBLFNBQVMsR0FBRzFCLENBQVo7QUFDRDtBQUNGOztBQUNELFVBQU0wQixTQUFOO0FBQ0Q7O0FBclIyQzs7ZUF3Ui9CM0MsZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJPT1RfQ09NUExFVEVEX0VWRU5UIH0gZnJvbSAnLi9zaW11bGF0b3IteGNvZGUtNic7XG5pbXBvcnQgU2ltdWxhdG9yWGNvZGU3IGZyb20gJy4vc2ltdWxhdG9yLXhjb2RlLTcnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHtcbiAgc2V0TG9jYXRpb25XaXRoTHlmdCxcbiAgc2V0TG9jYXRpb25XaXRoSWRiLFxuICBzZXRMb2NhdGlvbldpdGhBcHBsZVNjcmlwdCB9IGZyb20gJy4vZ2VvbG9jYXRpb24nO1xuaW1wb3J0IHsgdGltaW5nIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IE1PQklMRV9TQUZBUklfQlVORExFX0lELCBTQUZBUklfU1RBUlRVUF9USU1FT1VUIH0gZnJvbSAnLi91dGlscyc7XG5cblxuLy8gdGhlc2Ugc2ltcyBhcmUgc2xvb29vb29vb3dcbmNvbnN0IFNUQVJUVVBfVElNRU9VVCA9IDEyMCAqIDEwMDA7XG5jb25zdCBQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOID0gKGJ1bmRsZUlkKSA9PiBuZXcgUmVnRXhwKGAke2J1bmRsZUlkLnJlcGxhY2UoJy4nLCAnXFxcXC4nKX06XFxcXHMrXFxcXGQrYCk7XG5cbmNsYXNzIFNpbXVsYXRvclhjb2RlOCBleHRlbmRzIFNpbXVsYXRvclhjb2RlNyB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCB4Y29kZVZlcnNpb24pIHtcbiAgICBzdXBlcih1ZGlkLCB4Y29kZVZlcnNpb24pO1xuXG4gICAgLy8gbGlzdCBvZiBmaWxlcyB0byBjaGVjayBmb3Igd2hlbiBzZWVpbmcgaWYgYSBzaW11bGF0b3IgaXMgXCJmcmVzaFwiXG4gICAgLy8gKG1lYW5pbmcgaXQgaGFzIG5ldmVyIGJlZW4gYm9vdGVkKS5cbiAgICAvLyBJZiB0aGVzZSBmaWxlcyBhcmUgcHJlc2VudCwgd2UgYXNzdW1lIGl0J3MgYmVlbiBzdWNjZXNzZnVsbHkgYm9vdGVkXG4gICAgdGhpcy5pc0ZyZXNoRmlsZXMgPSBbXG4gICAgICAnTGlicmFyeS9Db29raWVzJyxcbiAgICAgICdMaWJyYXJ5L1ByZWZlcmVuY2VzLy5HbG9iYWxQcmVmZXJlbmNlcy5wbGlzdCcsXG4gICAgICAnTGlicmFyeS9QcmVmZXJlbmNlcy9jb20uYXBwbGUuc3ByaW5nYm9hcmQucGxpc3QnLFxuICAgICAgJ3Zhci9ydW4vc3lzbG9nLnBpZCdcbiAgICBdO1xuICAgIHRoaXMuX2lkYiA9IG51bGw7XG5cbiAgICAvLyBmb3Igc2V0dGluZyB0aGUgbG9jYXRpb24gdXNpbmcgQXBwbGVTY3JpcHQsIHRoZSB0b3AtbGV2ZWwgbWVudSB0aHJvdWdoIHdoaWNoXG4gICAgLy8gdGhlICdMb2NhdGlvbicgb3B0aW9uIGlzIGZvdW5kXG4gICAgdGhpcy5fbG9jYXRpb25NZW51ID0gJ0RlYnVnJztcbiAgfVxuXG4gIC8qKlxuICAgKiBJREIgaW5zdGFuY2Ugc2V0dGVyXG4gICAqXG4gICAqIEBwYXJhbSB7SURCfSB2YWx1ZVxuICAgKi9cbiAgc2V0IGlkYiAodmFsdWUpIHtcbiAgICB0aGlzLl9pZGIgPSB2YWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJuIHtJREJ9IGlkYiBpbnN0YW5jZVxuICAgKi9cbiAgZ2V0IGlkYiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lkYjtcbiAgfVxuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBraWxsT3B0c1xuICAgKiBAcHJvcGVydHkgez9udW1iZXJ8c3RyaW5nfSBwaWQgLSBQcm9jZXNzIGlkIG9mIHRoZSBVSSBTaW11bGF0b3Igd2luZG93XG4gICAqIEBwcm9wZXJ0eSB7bnVtYmVyfHN0cmluZ30gc2lnbmFsIFsyXSAtIFRoZSBzaWduYWwgbnVtYmVyIHRvIHNlbmQgdG8gdGhlXG4gICAqIGBraWxsYCBjb21tYW5kXG4gICAqL1xuXG4gIC8qKlxuICAgKiBLaWxsIHRoZSBVSSBjbGllbnQgaWYgaXQgaXMgcnVubmluZy5cbiAgICpcbiAgICogQHBhcmFtIHs/a2lsbE9wdHN9IG9wdHNcbiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgVUkgY2xpZW50IHdhcyBzdWNjZXNzZnVsbHkga2lsbGVkIG9yIGZhbHNlXG4gICAqICAgICAgICAgICAgICAgICAgIGlmIGl0IGlzIG5vdCBydW5uaW5nLlxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2VuZGluZyB0aGUgc2lnbmFsIHRvIHRoZSBjbGllbnQgcHJvY2VzcyBmYWlsc1xuICAgKi9cbiAgYXN5bmMga2lsbFVJQ2xpZW50IChvcHRzID0ge30pIHtcbiAgICBsZXQge1xuICAgICAgcGlkLFxuICAgICAgc2lnbmFsID0gMixcbiAgICB9ID0gb3B0cztcbiAgICBwaWQgPSBwaWQgfHwgYXdhaXQgdGhpcy5nZXRVSUNsaWVudFBpZCgpO1xuICAgIGlmICghcGlkKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBTZW5kaW5nICR7c2lnbmFsfSBraWxsIHNpZ25hbCB0byBTaW11bGF0b3IgVUkgY2xpZW50IHdpdGggUElEICR7cGlkfWApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKCdraWxsJywgW2AtJHtzaWduYWx9YCwgcGlkXSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoZS5jb2RlID09PSAxKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGtpbGwgdGhlIFNpbXVsYXRvciBVSSBjbGllbnQuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZ5IHdoZXRoZXIgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gaXMgaW5zdGFsbGVkIG9uIFNpbXVsYXRvci5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVJZCAtIFRoZSBidW5kbGUgaWQgb2YgdGhlIGFwcGxpY2F0aW9uIHRvIGJlIGNoZWNrZWQuXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIGFwcGxpY2F0aW9uIGlzIGluc3RhbGxlZC5cbiAgICovXG4gIGFzeW5jIGlzQXBwSW5zdGFsbGVkIChidW5kbGVJZCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhcHBDb250YWluZXIgPSBhd2FpdCB0aGlzLnNpbWN0bC5nZXRBcHBDb250YWluZXIoYnVuZGxlSWQpO1xuICAgICAgcmV0dXJuIGFwcENvbnRhaW5lci5lbmRzV2l0aCgnLmFwcCcpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gZ2V0X2FwcF9jb250YWluZXIgc3ViY29tbWFuZCBmYWlscyBmb3Igc3lzdGVtIGFwcGxpY2F0aW9ucyxcbiAgICAgIC8vIHNvIHdlIHRyeSB0aGUgaGlkZGVuIGFwcGluZm8gc3ViY29tbWFuZCwgd2hpY2ggcHJpbnRzIGNvcnJlY3QgaW5mbyBmb3JcbiAgICAgIC8vIHN5c3RlbS9oaWRkZW4gYXBwc1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgaW5mbyA9IGF3YWl0IHRoaXMuc2ltY3RsLmFwcEluZm8oYnVuZGxlSWQpO1xuICAgICAgICByZXR1cm4gaW5mby5pbmNsdWRlcygnQXBwbGljYXRpb25UeXBlJyk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbWF4IG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCBTaW11bGF0b3IgYm9vdGluZyBpcyBjb21wbGV0ZWQuXG4gICAqL1xuICBnZXQgc3RhcnR1cFRpbWVvdXQgKCkge1xuICAgIHJldHVybiBTVEFSVFVQX1RJTUVPVVQ7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZ5IHdoZXRoZXIgdGhlIFNpbXVsYXRvciBib290aW5nIGlzIGNvbXBsZXRlZCBhbmQvb3Igd2FpdCBmb3IgaXRcbiAgICogdW50aWwgdGhlIHRpbWVvdXQgZXhwaXJlcy5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydHVwVGltZW91dCAtIHRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgYm9vdGluZyBpcyBjb21wbGV0ZWQuXG4gICAqIEBlbWl0cyBCT09UX0NPTVBMRVRFRF9FVkVOVCBpZiB0aGUgY3VycmVudCBTaW11bGF0b3IgaXMgcmVhZHkgdG8gYWNjZXB0IHNpbWN0bCBjb21tYW5kcywgbGlrZSAnaW5zdGFsbCcuXG4gICAqL1xuICBhc3luYyB3YWl0Rm9yQm9vdCAoc3RhcnR1cFRpbWVvdXQpIHtcbiAgICBhd2FpdCB0aGlzLnNpbWN0bC5zdGFydEJvb3RNb25pdG9yKHt0aW1lb3V0OiBzdGFydHVwVGltZW91dH0pO1xuICAgIHRoaXMuZW1pdChCT09UX0NPTVBMRVRFRF9FVkVOVCk7XG4gIH1cblxuICAvKipcbiAgICogT3BlbiB0aGUgZ2l2ZW4gVVJMIGluIG1vYmlsZSBTYWZhcmkgYnJvd3Nlci5cbiAgICogVGhlIGJyb3dzZXIgd2lsbCBiZSBzdGFydGVkIGF1dG9tYXRpY2FsbHkgaWYgaXQgaXMgbm90IHJ1bm5pbmcuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIFVSTCB0byBiZSBvcGVuZWQuXG4gICAqL1xuICBhc3luYyBvcGVuVXJsICh1cmwpIHtcbiAgICBpZiAoIWF3YWl0IHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJpZWQgdG8gb3BlbiAnJHt1cmx9JywgYnV0IFNpbXVsYXRvciBpcyBub3QgaW4gQm9vdGVkIHN0YXRlYCk7XG4gICAgfVxuICAgIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gICAgbGV0IGxhc3RFcnJvciA9IG51bGw7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIFRoaXMgaXMgdG8gbWFrZSBzdXJlIFNhZmFyaSBpcyBhbHJlYWR5IHJ1bm5pbmdcbiAgICAgICAgICBjb25zdCBzdGRvdXQgPSBhd2FpdCB0aGlzLnNpbWN0bC5sYXVuY2hBcHAoTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQpO1xuICAgICAgICAgIGlmIChQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOKE1PQklMRV9TQUZBUklfQlVORExFX0lEKS50ZXN0KHN0ZG91dCkpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2ltY3RsLm9wZW5VcmwodXJsKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLndhcm4oYEZhaWxlZCB0byBvcGVuICcke3VybH0nIGluIFNhZmFyaS4gUmV0cnlpbmcuLi5gKTtcbiAgICAgICAgICBsYXN0RXJyb3IgPSBlcnIuc3RkZXJyIHx8IGVyci5tZXNzYWdlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0sIHt3YWl0TXM6IFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQsIGludGVydmFsTXM6IDUwMH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBTYWZhcmkgY2Fubm90IG9wZW4gJyR7dXJsfScgYWZ0ZXIgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzU2Vjb25kcy50b0ZpeGVkKDMpfXMgYCArXG4gICAgICAgIGBiZWNhdXNlIG9mOiAke2xhc3RFcnJvciB8fCAnYW4gdW5rbm93biBlcnJvcid9YCk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgU2FmYXJpIHN1Y2Nlc3NmdWxseSBvcGVuZWQgJyR7dXJsfScgaW4gJHt0aW1lci5nZXREdXJhdGlvbigpLmFzU2Vjb25kcy50b0ZpeGVkKDMpfXNgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhbiB1cCB0aGUgZGlyZWN0b3JpZXMgZm9yIG1vYmlsZSBTYWZhcmkuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGtlZXBQcmVmcyAtIFdoZXRoZXIgdG8ga2VlcCBTYWZhcmkgcHJlZmVyZW5jZXMgZnJvbSBiZWluZyBkZWxldGVkLlxuICAgKi9cbiAgYXN5bmMgY2xlYW5TYWZhcmkgKGtlZXBQcmVmcyA9IHRydWUpIHtcbiAgICB0cnkge1xuICAgICAgaWYgKGF3YWl0IHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5zaW1jdGwudGVybWluYXRlQXBwKE1PQklMRV9TQUZBUklfQlVORExFX0lEKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIGlnbm9yZSBlcnJvclxuICAgIH1cbiAgICBhd2FpdCBzdXBlci5jbGVhblNhZmFyaShrZWVwUHJlZnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFuL3NjcnViIHRoZSBwYXJ0aWN1bGFyIGFwcGxpY2F0aW9uIG9uIFNpbXVsYXRvci5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhcHBGaWxlIC0gQXBwbGljYXRpb24gbmFtZSBtaW51cyBcIi5hcHBcIi5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEJ1bmRsZUlkIC0gQnVuZGxlIGlkZW50aWZpZXIgb2YgdGhlIGFwcGxpY2F0aW9uLlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNjcnViIC0gSWYgYHNjcnViYCBpcyBmYWxzZSwgd2Ugd2FudCB0byBjbGVhbiBieSBkZWxldGluZyB0aGUgYXBwIGFuZCBhbGxcbiAgICogICBmaWxlcyBhc3NvY2lhdGVkIHdpdGggaXQuIElmIGBzY3J1YmAgaXMgdHJ1ZSwgd2UganVzdCB3YW50IHRvIGRlbGV0ZSB0aGUgcHJlZmVyZW5jZXMgYW5kXG4gICAqICAgY2hhbmdlZCBmaWxlcy5cbiAgICovXG4gIGFzeW5jIGNsZWFuQ3VzdG9tQXBwIChhcHBGaWxlLCBhcHBCdW5kbGVJZCwgc2NydWIgPSBmYWxzZSkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnNpbWN0bC50ZXJtaW5hdGVBcHAoYXBwQnVuZGxlSWQpO1xuICAgIH0gY2F0Y2ggKGlnbikge1xuICAgICAgLy8gaWdub3JlIGVycm9yXG4gICAgfVxuICAgIGF3YWl0IHN1cGVyLmNsZWFuQ3VzdG9tQXBwKGFwcEZpbGUsIGFwcEJ1bmRsZUlkLCBzY3J1Yik7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSBTaGFrZSBnZXN0dXJlIG9uIFNpbXVsYXRvciB3aW5kb3cuXG4gICAqL1xuICBhc3luYyBzaGFrZSAoKSB7XG4gICAgbG9nLmluZm8oYFBlcmZvcm1pbmcgc2hha2UgZ2VzdHVyZSBvbiAke3RoaXMudWRpZH0gU2ltdWxhdG9yYCk7XG4gICAgYXdhaXQgdGhpcy5zaW1jdGwuc3Bhd25Qcm9jZXNzKFtcbiAgICAgICdub3RpZnl1dGlsJyxcbiAgICAgICctcCcsICdjb20uYXBwbGUuVUlLaXQuU2ltdWxhdG9yU2hha2UnXG4gICAgXSk7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBpc0Jpb21ldHJpY0Vucm9sbGVkICgpIHtcbiAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCB0aGlzLmV4ZWN1dGVVSUNsaWVudFNjcmlwdChgXG4gICAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICAgIHRlbGwgcHJvY2VzcyBcIlNpbXVsYXRvclwiXG4gICAgICAgICAgc2V0IGRzdE1lbnVJdGVtIHRvIG1lbnUgaXRlbSBcIlRvZ2dsZSBFbnJvbGxlZCBTdGF0ZVwiIG9mIG1lbnUgMSBvZiBtZW51IGl0ZW0gXCJUb3VjaCBJRFwiIG9mIG1lbnUgMSBvZiBtZW51IGJhciBpdGVtIFwiSGFyZHdhcmVcIiBvZiBtZW51IGJhciAxXG4gICAgICAgICAgc2V0IGlzQ2hlY2tlZCB0byAodmFsdWUgb2YgYXR0cmlidXRlIFwiQVhNZW51SXRlbU1hcmtDaGFyXCIgb2YgZHN0TWVudUl0ZW0pIGlzIFwi4pyTXCJcbiAgICAgICAgZW5kIHRlbGxcbiAgICAgIGVuZCB0ZWxsXG4gICAgYCk7XG4gICAgbG9nLmRlYnVnKGBUb3VjaCBJRCBlbnJvbGxlZCBzdGF0ZTogJHtvdXRwdXR9YCk7XG4gICAgcmV0dXJuIF8uaXNTdHJpbmcob3V0cHV0KSAmJiBvdXRwdXQudHJpbSgpID09PSAndHJ1ZSc7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBlbnJvbGxCaW9tZXRyaWMgKGlzRW5hYmxlZCA9IHRydWUpIHtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVVSUNsaWVudFNjcmlwdChgXG4gICAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICAgIHRlbGwgcHJvY2VzcyBcIlNpbXVsYXRvclwiXG4gICAgICAgICAgc2V0IGRzdE1lbnVJdGVtIHRvIG1lbnUgaXRlbSBcIlRvZ2dsZSBFbnJvbGxlZCBTdGF0ZVwiIG9mIG1lbnUgMSBvZiBtZW51IGl0ZW0gXCJUb3VjaCBJRFwiIG9mIG1lbnUgMSBvZiBtZW51IGJhciBpdGVtIFwiSGFyZHdhcmVcIiBvZiBtZW51IGJhciAxXG4gICAgICAgICAgc2V0IGlzQ2hlY2tlZCB0byAodmFsdWUgb2YgYXR0cmlidXRlIFwiQVhNZW51SXRlbU1hcmtDaGFyXCIgb2YgZHN0TWVudUl0ZW0pIGlzIFwi4pyTXCJcbiAgICAgICAgICBpZiAke2lzRW5hYmxlZCA/ICdub3QgJyA6ICcnfWlzQ2hlY2tlZCB0aGVuXG4gICAgICAgICAgICBjbGljayBkc3RNZW51SXRlbVxuICAgICAgICAgIGVuZCBpZlxuICAgICAgICBlbmQgdGVsbFxuICAgICAgZW5kIHRlbGxcbiAgICBgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICovXG4gIGFzeW5jIHNlbmRCaW9tZXRyaWNNYXRjaCAoc2hvdWxkTWF0Y2ggPSB0cnVlKSB7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlVUlDbGllbnRTY3JpcHQoYFxuICAgICAgdGVsbCBhcHBsaWNhdGlvbiBcIlN5c3RlbSBFdmVudHNcIlxuICAgICAgICB0ZWxsIHByb2Nlc3MgXCJTaW11bGF0b3JcIlxuICAgICAgICAgIHNldCBkc3RNZW51SXRlbSB0byBtZW51IGl0ZW0gXCIke3Nob3VsZE1hdGNoID8gJ01hdGNoaW5nIFRvdWNoJyA6ICdOb24tbWF0Y2hpbmcgVG91Y2gnfVwiIG9mIG1lbnUgMSBvZiBtZW51IGl0ZW0gXCJUb3VjaCBJRFwiIG9mIG1lbnUgMSBvZiBtZW51IGJhciBpdGVtIFwiSGFyZHdhcmVcIiBvZiBtZW51IGJhciAxXG4gICAgICAgICAgY2xpY2sgZHN0TWVudUl0ZW1cbiAgICAgICAgZW5kIHRlbGxcbiAgICAgIGVuZCB0ZWxsXG4gICAgYCk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IGN1c3RvbSBnZW9sb2NhdGlvbiBwYXJhbWV0ZXJzIGZvciB0aGUgZ2l2ZW4gU2ltdWxhdG9yIHVzaW5nIEFwcGxlU2NyaXB0LlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGxhdGl0dWRlIC0gVGhlIGxhdGl0dWRlIHZhbHVlLCB3aGljaCBpcyBnb2luZyB0byBiZSBlbnRlcmVkXG4gICAqICAgaW50byB0aGUgY29ycmVzcG9uZGluZyBlZGl0IGZpZWxkLCBmb3IgZXhhbXBsZSAnMzksMDAwNicuXG4gICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbG9uZ2l0dWRlIC0gVGhlIGxvbmdpdHVkZSB2YWx1ZSwgd2hpY2ggaXMgZ29pbmcgdG8gYmUgZW50ZXJlZFxuICAgKiAgIGludG8gdGhlIGNvcnJlc3BvbmRpbmcgZWRpdCBmaWVsZCwgZm9yIGV4YW1wbGUgJzE5LDAwNjgnLlxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gcGFyYW1ldGVycyBoYXZlIGNvcnJlY3QgZm9ybWF0IGFuZCB3ZXJlIHN1Y2Nlc3NmdWxseSBhY2NlcHRlZC5cbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBzZXR0aW5nIHRoZSBsb2NhdGlvblxuICAgKi9cbiAgYXN5bmMgc2V0R2VvbG9jYXRpb24gKGxhdGl0dWRlLCBsb25naXR1ZGUpIHtcbiAgICBjb25zdCBsb2NhdGlvblNldHRlcnMgPSBbXG4gICAgICBhc3luYyAoKSA9PiBhd2FpdCBzZXRMb2NhdGlvbldpdGhMeWZ0KHRoaXMudWRpZCwgbGF0aXR1ZGUsIGxvbmdpdHVkZSksXG4gICAgICBhc3luYyAoKSA9PiBhd2FpdCBzZXRMb2NhdGlvbldpdGhJZGIodGhpcy5pZGIsIGxhdGl0dWRlLCBsb25naXR1ZGUpLFxuICAgICAgYXN5bmMgKCkgPT4gYXdhaXQgc2V0TG9jYXRpb25XaXRoQXBwbGVTY3JpcHQodGhpcywgbGF0aXR1ZGUsIGxvbmdpdHVkZSwgdGhpcy5fbG9jYXRpb25NZW51KSxcbiAgICBdO1xuXG4gICAgbGV0IGxhc3RFcnJvcjtcbiAgICBmb3IgKGNvbnN0IHNldHRlciBvZiBsb2NhdGlvblNldHRlcnMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHNldHRlcigpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLmluZm8oZS5tZXNzYWdlKTtcbiAgICAgICAgbGFzdEVycm9yID0gZTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhyb3cgbGFzdEVycm9yO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFNpbXVsYXRvclhjb2RlODtcbiJdLCJmaWxlIjoibGliL3NpbXVsYXRvci14Y29kZS04LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=

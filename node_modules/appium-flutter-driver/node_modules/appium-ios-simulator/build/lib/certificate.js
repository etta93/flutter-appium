"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.TrustStore = exports.Certificate = void 0;

require("source-map-support/register");

var _crypto = _interopRequireDefault(require("crypto"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _support = require("@appium/support");

var _utils = require("./utils");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

const tset = `<?xml version="1.0" encoding="UTF-8"?>\n
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <array/>
</plist>`;

class Certificate {
  constructor(pemFilename) {
    this.pemFilename = pemFilename;
    this.opensslBinary = null;
    this.fingerprint = null;
    this.data = null;
    this.subject = null;
  }

  async openssl(...args) {
    if (!this.opensslBinary) {
      try {
        this.opensslBinary = await _support.fs.which('openssl');
      } catch (e) {
        throw new Error('openssl executable cannot be found in PATH. Make sure it is installed');
      }
    }

    _logger.default.debug(`Executing ${this.opensslBinary} with arguments: ${args}`);

    let result;

    try {
      const {
        stdout
      } = await (0, _teen_process.exec)(this.opensslBinary, args);
      result = stdout;
    } catch (e) {
      if (e.stderr) {
        throw new Error(e.stderr);
      }

      throw e;
    }

    return result;
  }

  async add(dir) {
    let data = (await this.getDerData(this.pemFilename)).toString('hex');
    let subject = await this.getSubject(this.pemFilename);
    let sha1 = (await this.getFingerPrint(this.data)).toString('hex');
    let trustStore = new TrustStore(dir);
    return await trustStore.addRecord(sha1, tset, subject, data);
  }

  async has(dir) {
    let subject = await this.getSubject(this.pemFilename);
    let trustStore = new TrustStore(dir);

    if (!(await trustStore.hasRecords(subject))) {
      return false;
    }

    let previousFingerprint = await trustStore.getFingerPrintFromRecord(subject);
    let currentFingerprint = await this.getFingerPrint();
    return previousFingerprint.toString() === currentFingerprint.toString();
  }

  async remove(dir) {
    let subject = await this.getSubject(this.pemFilename);
    let trustStore = new TrustStore(dir);
    return await trustStore.removeRecord(subject);
  }

  async getDerData() {
    if (this.data) {
      return this.data;
    }

    const output = await this.openssl('x509', '-outform', 'der', '-in', this.pemFilename);
    this.data = Buffer.from(_lodash.default.trim(output));
    return this.data;
  }

  async getFingerPrint() {
    if (this.fingerprint) {
      return this.fingerprint;
    }

    let data = await this.getDerData();

    let shasum = _crypto.default.createHash('sha1');

    shasum.update(data);
    this.fingerprint = shasum.digest();
    return this.fingerprint;
  }

  async getSubject() {
    if (this.subject) {
      return this.subject;
    }

    const subject = await this.openssl('x509', '-noout', '-subject', '-in', this.pemFilename);
    const match = /^\s*subject=.*\bCN\b\s*=\s*([^\n]+)$/m.exec(subject);

    if (!match) {
      _logger.default.debug(subject);

      throw new Error(`Cannot parse certificate subject from the openssl output`);
    }

    this.subject = match[1];
    return this.subject;
  }

}

exports.Certificate = Certificate;

class TrustStore {
  constructor(sharedResourceDir) {
    this.sharedResourceDir = sharedResourceDir;
  }

  async getDB() {
    if (this.db) {
      return this.db;
    }

    let keychainsPath = _path.default.resolve(this.sharedResourceDir, 'Library', 'Keychains');

    if (!(await _support.fs.exists(keychainsPath))) {
      await (0, _support.mkdirp)(keychainsPath);
    }

    this.db = _path.default.resolve(keychainsPath, 'TrustStore.sqlite3');
    await (0, _utils.execSQLiteQuery)(this.db, `CREATE TABLE IF NOT EXISTS tsettings (sha1 BLOB NOT NULL DEFAULT '', subj BLOB NOT NULL DEFAULT '', tset BLOB, data BLOB, PRIMARY KEY(sha1));`);

    try {
      await (0, _utils.execSQLiteQuery)(this.db, 'CREATE INDEX isubj ON tsettings(subj);');
    } catch (e) {}

    return this.db;
  }

  async addRecord(sha1, tset, subj, data) {
    let db = await this.getDB();

    if (await this.hasRecords(subj)) {
      return await (0, _utils.execSQLiteQuery)(db, `UPDATE tsettings SET sha1=x'?', tset='?', data=x'?' WHERE subj='?'`, sha1, tset, data, subj);
    } else {
      return await (0, _utils.execSQLiteQuery)(db, `INSERT INTO tsettings (sha1, subj, tset, data) VALUES (x'?', '?', '?', x'?')`, sha1, subj, tset, data);
    }
  }

  async removeRecord(subj) {
    return await (0, _utils.execSQLiteQuery)(await this.getDB(), `DELETE FROM tsettings WHERE subj = '?'`, subj);
  }

  async hasRecords(subj) {
    return (await this.getRecordCount(subj)) > 0;
  }

  async getRecordCount(subj) {
    let result = await (0, _utils.execSQLiteQuery)(await this.getDB(), `SELECT count(*) FROM tsettings WHERE subj = '?'`, subj);
    return parseInt(result.split('=')[1], 10);
  }

  async getFingerPrintFromRecord(subj) {
    let result = await (0, _utils.execSQLiteQuery)(await this.getDB(), `SELECT sha1 FROM tsettings WHERE subj='?'`, subj);

    if (result) {
      return Buffer.from(result.split('=')[1].trim());
    }
  }

}

exports.TrustStore = TrustStore;
var _default = Certificate;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jZXJ0aWZpY2F0ZS5qcyJdLCJuYW1lcyI6WyJ0c2V0IiwiQ2VydGlmaWNhdGUiLCJjb25zdHJ1Y3RvciIsInBlbUZpbGVuYW1lIiwib3BlbnNzbEJpbmFyeSIsImZpbmdlcnByaW50IiwiZGF0YSIsInN1YmplY3QiLCJvcGVuc3NsIiwiYXJncyIsImZzIiwid2hpY2giLCJlIiwiRXJyb3IiLCJsb2ciLCJkZWJ1ZyIsInJlc3VsdCIsInN0ZG91dCIsInN0ZGVyciIsImFkZCIsImRpciIsImdldERlckRhdGEiLCJ0b1N0cmluZyIsImdldFN1YmplY3QiLCJzaGExIiwiZ2V0RmluZ2VyUHJpbnQiLCJ0cnVzdFN0b3JlIiwiVHJ1c3RTdG9yZSIsImFkZFJlY29yZCIsImhhcyIsImhhc1JlY29yZHMiLCJwcmV2aW91c0ZpbmdlcnByaW50IiwiZ2V0RmluZ2VyUHJpbnRGcm9tUmVjb3JkIiwiY3VycmVudEZpbmdlcnByaW50IiwicmVtb3ZlIiwicmVtb3ZlUmVjb3JkIiwib3V0cHV0IiwiQnVmZmVyIiwiZnJvbSIsIl8iLCJ0cmltIiwic2hhc3VtIiwiY3J5cHRvIiwiY3JlYXRlSGFzaCIsInVwZGF0ZSIsImRpZ2VzdCIsIm1hdGNoIiwiZXhlYyIsInNoYXJlZFJlc291cmNlRGlyIiwiZ2V0REIiLCJkYiIsImtleWNoYWluc1BhdGgiLCJwYXRoIiwicmVzb2x2ZSIsImV4aXN0cyIsInN1YmoiLCJnZXRSZWNvcmRDb3VudCIsInBhcnNlSW50Iiwic3BsaXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsSUFBSSxHQUFJO0FBQ2Q7QUFDQTtBQUNBO0FBQ0EsU0FKQTs7QUFTQSxNQUFNQyxXQUFOLENBQWtCO0FBRWhCQyxFQUFBQSxXQUFXLENBQUVDLFdBQUYsRUFBZTtBQUN4QixTQUFLQSxXQUFMLEdBQW1CQSxXQUFuQjtBQUNBLFNBQUtDLGFBQUwsR0FBcUIsSUFB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QWhCLEVBQXFCLDhFQUFyQixFQUFvRzFCLElBQXBHLEVBQTBHK0IsSUFBMUcsRUFBZ0h2RCxJQUFoSCxFQUFzSE0sSUFBdEgsQ0FBYjtBQUNEO0FBQ0Y7O0FBTWlCLFFBQVo2QixZQUFZLENBQUVvQixJQUFGLEVBQVE7QUFDeEIsV0FBTyxNQUFNLDRCQUFnQixNQUFNLEtBQUtOLEtBQUwsRUFBdEIsRUFBcUMsd0NBQXJDLEVBQThFTSxJQUE5RSxDQUFiO0FBQ0Q7O0FBTWUsUUFBVnpCLFVBQVUsQ0FBRXlCLElBQUYsRUFBUTtBQUN0QixXQUFPLENBQUMsTUFBTSxLQUFLQyxjQUFMLENBQW9CRCxJQUFwQixDQUFQLElBQW9DLENBQTNDO0FBQ0Q7O0FBTW1CLFFBQWRDLGNBQWMsQ0FBRUQsSUFBRixFQUFRO0FBQzFCLFFBQUl2QyxNQUFNLEdBQUcsTUFBTSw0QkFBZ0IsTUFBTSxLQUFLaUMsS0FBTCxFQUF0QixFQUFxQyxpREFBckMsRUFBdUZNLElBQXZGLENBQW5CO0FBQ0EsV0FBT0UsUUFBUSxDQUFDekMsTUFBTSxDQUFDMEMsS0FBUCxDQUFhLEdBQWIsRUFBa0IsQ0FBbEIsQ0FBRCxFQUF1QixFQUF2QixDQUFmO0FBQ0Q7O0FBTTZCLFFBQXhCMUIsd0JBQXdCLENBQUV1QixJQUFGLEVBQVE7QUFDcEMsUUFBSXZDLE1BQU0sR0FBRyxNQUFNLDRCQUFnQixNQUFNLEtBQUtpQyxLQUFMLEVBQXRCLEVBQXFDLDJDQUFyQyxFQUFpRk0sSUFBakYsQ0FBbkI7O0FBQ0EsUUFBSXZDLE1BQUosRUFBWTtBQUNWLGFBQU9xQixNQUFNLENBQUNDLElBQVAsQ0FBWXRCLE1BQU0sQ0FBQzBDLEtBQVAsQ0FBYSxHQUFiLEVBQWtCLENBQWxCLEVBQXFCbEIsSUFBckIsRUFBWixDQUFQO0FBQ0Q7QUFDRjs7QUE5RWM7OztlQWlGRnZDLFciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIG1rZGlycCB9IGZyb20gJ0BhcHBpdW0vc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjU1FMaXRlUXVlcnkgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuY29uc3QgdHNldCA9IGA8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJVVEYtOFwiPz5cXG5cbiAgICA8IURPQ1RZUEUgcGxpc3QgUFVCTElDIFwiLS8vQXBwbGUvL0RURCBQTElTVCAxLjAvL0VOXCIgXCJodHRwOi8vd3d3LmFwcGxlLmNvbS9EVERzL1Byb3BlcnR5TGlzdC0xLjAuZHRkXCI+XG4gICAgPHBsaXN0IHZlcnNpb249XCIxLjBcIj5cbiAgICA8YXJyYXkvPlxuPC9wbGlzdD5gO1xuXG4vKipcbiAqIExpYnJhcnkgZm9yIHByb2dyYW1hdGljYWxseSBhZGRpbmcgY2VydGlmaWNhdGVzXG4gKi9cbmNsYXNzIENlcnRpZmljYXRlIHtcblxuICBjb25zdHJ1Y3RvciAocGVtRmlsZW5hbWUpIHtcbiAgICB0aGlzLnBlbUZpbGVuYW1lID0gcGVtRmlsZW5hbWU7XG4gICAgdGhpcy5vcGVuc3NsQmluYXJ5ID0gbnVsbDtcbiAgICB0aGlzLmZpbmdlcnByaW50ID0gbnVsbDtcbiAgICB0aGlzLmRhdGEgPSBudWxsO1xuICAgIHRoaXMuc3ViamVjdCA9IG51bGw7XG4gIH1cblxuICBhc3luYyBvcGVuc3NsICguLi5hcmdzKSB7XG4gICAgaWYgKCF0aGlzLm9wZW5zc2xCaW5hcnkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHRoaXMub3BlbnNzbEJpbmFyeSA9IGF3YWl0IGZzLndoaWNoKCdvcGVuc3NsJyk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignb3BlbnNzbCBleGVjdXRhYmxlIGNhbm5vdCBiZSBmb3VuZCBpbiBQQVRILiBNYWtlIHN1cmUgaXQgaXMgaW5zdGFsbGVkJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBFeGVjdXRpbmcgJHt0aGlzLm9wZW5zc2xCaW5hcnl9IHdpdGggYXJndW1lbnRzOiAke2FyZ3N9YCk7XG4gICAgbGV0IHJlc3VsdDtcbiAgICB0cnkge1xuICAgICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKHRoaXMub3BlbnNzbEJpbmFyeSwgYXJncyk7XG4gICAgICByZXN1bHQgPSBzdGRvdXQ7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUuc3RkZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihlLnN0ZGVycik7XG4gICAgICB9XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIGNlcnRpZmljYXRlIHRvIHRoZSBUcnVzdFN0b3JlXG4gICAqL1xuICBhc3luYyBhZGQgKGRpcikge1xuICAgIGxldCBkYXRhID0gKGF3YWl0IHRoaXMuZ2V0RGVyRGF0YSh0aGlzLnBlbUZpbGVuYW1lKSkudG9TdHJpbmcoJ2hleCcpO1xuICAgIGxldCBzdWJqZWN0ID0gKGF3YWl0IHRoaXMuZ2V0U3ViamVjdCh0aGlzLnBlbUZpbGVuYW1lKSk7XG4gICAgbGV0IHNoYTEgPSAoYXdhaXQgdGhpcy5nZXRGaW5nZXJQcmludCh0aGlzLmRhdGEpKS50b1N0cmluZygnaGV4Jyk7XG5cbiAgICBsZXQgdHJ1c3RTdG9yZSA9IG5ldyBUcnVzdFN0b3JlKGRpcik7XG4gICAgcmV0dXJuIGF3YWl0IHRydXN0U3RvcmUuYWRkUmVjb3JkKHNoYTEsIHRzZXQsIHN1YmplY3QsIGRhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiBrZXljaGFpbiBhdCBnaXZlbiBkaXJlY3RvcnkgaGFzIHRoaXMgY2VydGlmaWNhdGVcbiAgICovXG4gIGFzeW5jIGhhcyAoZGlyKSB7XG4gICAgbGV0IHN1YmplY3QgPSBhd2FpdCB0aGlzLmdldFN1YmplY3QodGhpcy5wZW1GaWxlbmFtZSk7XG4gICAgbGV0IHRydXN0U3RvcmUgPSBuZXcgVHJ1c3RTdG9yZShkaXIpO1xuXG4gICAgLy8gUmV0dXJuIGZhbHNlIGlmIHJlY29yZCB3aXRoIHRoaXMgc3ViamVjdCBpcyBub3QgZm91bmRcbiAgICBpZiAoIWF3YWl0IHRydXN0U3RvcmUuaGFzUmVjb3JkcyhzdWJqZWN0KSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIElmIHJlY29yZCBpcyBmb3VuZCwgY2hlY2sgZmluZ2VycHJpbnRzIHRvIHZlcmlmeSB0aGF0IHRoZXkgZGlkbid0IGNoYW5nZVxuICAgIGxldCBwcmV2aW91c0ZpbmdlcnByaW50ID0gYXdhaXQgdHJ1c3RTdG9yZS5nZXRGaW5nZXJQcmludEZyb21SZWNvcmQoc3ViamVjdCk7XG4gICAgbGV0IGN1cnJlbnRGaW5nZXJwcmludCA9IGF3YWl0IHRoaXMuZ2V0RmluZ2VyUHJpbnQoKTtcbiAgICByZXR1cm4gcHJldmlvdXNGaW5nZXJwcmludC50b1N0cmluZygpID09PSBjdXJyZW50RmluZ2VycHJpbnQudG9TdHJpbmcoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgY2VydGlmaWNhdGUgZnJvbSB0aGUgVHJ1c3RTdG9yZVxuICAgKi9cbiAgYXN5bmMgcmVtb3ZlIChkaXIpIHtcbiAgICBsZXQgc3ViamVjdCA9IGF3YWl0IHRoaXMuZ2V0U3ViamVjdCh0aGlzLnBlbUZpbGVuYW1lKTtcbiAgICBsZXQgdHJ1c3RTdG9yZSA9IG5ldyBUcnVzdFN0b3JlKGRpcik7XG4gICAgcmV0dXJuIGF3YWl0IHRydXN0U3RvcmUucmVtb3ZlUmVjb3JkKHN1YmplY3QpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYW5zbGF0ZSBQRU0gZmlsZSB0byBERVIgYnVmZmVyXG4gICAqL1xuICBhc3luYyBnZXREZXJEYXRhICgpIHtcbiAgICBpZiAodGhpcy5kYXRhKSB7XG4gICAgICByZXR1cm4gdGhpcy5kYXRhO1xuICAgIH1cblxuICAgIC8vIENvbnZlcnQgJ3BlbScgZmlsZSB0byAnZGVyJ1xuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMub3BlbnNzbCgneDUwOScsXG4gICAgICAnLW91dGZvcm0nLCAnZGVyJyxcbiAgICAgICctaW4nLCB0aGlzLnBlbUZpbGVuYW1lXG4gICAgKTtcbiAgICB0aGlzLmRhdGEgPSBCdWZmZXIuZnJvbShfLnRyaW0ob3V0cHV0KSk7XG4gICAgcmV0dXJuIHRoaXMuZGF0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgU0hBMSBmaW5nZXJwcmludCBmcm9tIGRlciBkYXRhIGJlZm9yZVxuICAgKi9cbiAgYXN5bmMgZ2V0RmluZ2VyUHJpbnQgKCkge1xuICAgIGlmICh0aGlzLmZpbmdlcnByaW50KSB7XG4gICAgICByZXR1cm4gdGhpcy5maW5nZXJwcmludDtcbiAgICB9XG5cbiAgICBsZXQgZGF0YSA9IGF3YWl0IHRoaXMuZ2V0RGVyRGF0YSgpO1xuICAgIGxldCBzaGFzdW0gPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMScpO1xuICAgIHNoYXN1bS51cGRhdGUoZGF0YSk7XG4gICAgdGhpcy5maW5nZXJwcmludCA9IHNoYXN1bS5kaWdlc3QoKTtcbiAgICByZXR1cm4gdGhpcy5maW5nZXJwcmludDtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZSB0aGUgc3ViamVjdCBmcm9tIHRoZSBkZXIgZGF0YVxuICAgKi9cbiAgYXN5bmMgZ2V0U3ViamVjdCAoKSB7XG4gICAgaWYgKHRoaXMuc3ViamVjdCkge1xuICAgICAgcmV0dXJuIHRoaXMuc3ViamVjdDtcbiAgICB9XG5cbiAgICBjb25zdCBzdWJqZWN0ID0gYXdhaXQgdGhpcy5vcGVuc3NsKCd4NTA5JyxcbiAgICAgICctbm9vdXQnLCAnLXN1YmplY3QnLFxuICAgICAgJy1pbicsIHRoaXMucGVtRmlsZW5hbWUsXG4gICAgKTtcbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvMTQ2NjZcbiAgICBjb25zdCBtYXRjaCA9IC9eXFxzKnN1YmplY3Q9LipcXGJDTlxcYlxccyo9XFxzKihbXlxcbl0rKSQvbS5leGVjKHN1YmplY3QpO1xuICAgIGlmICghbWF0Y2gpIHtcbiAgICAgIGxvZy5kZWJ1ZyhzdWJqZWN0KTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHBhcnNlIGNlcnRpZmljYXRlIHN1YmplY3QgZnJvbSB0aGUgb3BlbnNzbCBvdXRwdXRgKTtcbiAgICB9XG4gICAgdGhpcy5zdWJqZWN0ID0gbWF0Y2hbMV07XG4gICAgcmV0dXJuIHRoaXMuc3ViamVjdDtcbiAgfVxuXG59XG5cbi8qKlxuICogSW50ZXJmYWNlIGZvciBhZGRpbmcgYW5kIHJlbW92aW5nIHJlY29yZHMgdG8gVHJ1c3RTdG9yZS5zcWxpdGUzIGRhdGFiYXNlcyB0aGF0IEtleWNoYWlucyB1c2VcbiAqL1xuY2xhc3MgVHJ1c3RTdG9yZSB7XG4gIGNvbnN0cnVjdG9yIChzaGFyZWRSZXNvdXJjZURpcikge1xuICAgIHRoaXMuc2hhcmVkUmVzb3VyY2VEaXIgPSBzaGFyZWRSZXNvdXJjZURpcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgVHJ1c3RTdG9yZSBkYXRhYmFzZSBhc3NvY2lhdGVkIHdpdGggdGhpcyBzaW11bGF0b3JcbiAgICovXG4gIGFzeW5jIGdldERCICgpIHtcbiAgICBpZiAodGhpcy5kYikge1xuICAgICAgcmV0dXJuIHRoaXMuZGI7XG4gICAgfVxuXG4gICAgLy8gSWYgdGhlIHNpbSBkb2Vzbid0IGhhdmUgYSBrZXljaGFpbnMgZGlyZWN0b3J5LCBjcmVhdGUgb25lXG4gICAgbGV0IGtleWNoYWluc1BhdGggPSBwYXRoLnJlc29sdmUodGhpcy5zaGFyZWRSZXNvdXJjZURpciwgJ0xpYnJhcnknLCAnS2V5Y2hhaW5zJyk7XG4gICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKGtleWNoYWluc1BhdGgpKSkge1xuICAgICAgYXdhaXQgbWtkaXJwKGtleWNoYWluc1BhdGgpO1xuICAgIH1cblxuICAgIC8vIE9wZW4gc3FsaXRlIGRhdGFiYXNlXG4gICAgdGhpcy5kYiA9IHBhdGgucmVzb2x2ZShrZXljaGFpbnNQYXRoLCAnVHJ1c3RTdG9yZS5zcWxpdGUzJyk7XG5cbiAgICAvLyBJZiBpdCBkb2Vzbid0IGhhdmUgYSB0c2V0dGluZ3MgdGFibGUsIGNyZWF0ZSBvbmVcbiAgICBhd2FpdCBleGVjU1FMaXRlUXVlcnkodGhpcy5kYiwgYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHRzZXR0aW5ncyAoc2hhMSBCTE9CIE5PVCBOVUxMIERFRkFVTFQgJycsIHN1YmogQkxPQiBOT1QgTlVMTCBERUZBVUxUICcnLCB0c2V0IEJMT0IsIGRhdGEgQkxPQiwgUFJJTUFSWSBLRVkoc2hhMSkpO2ApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjU1FMaXRlUXVlcnkodGhpcy5kYiwgJ0NSRUFURSBJTkRFWCBpc3ViaiBPTiB0c2V0dGluZ3Moc3Viaik7Jyk7XG4gICAgfSBjYXRjaCAoZSkgeyB9XG5cblxuICAgIHJldHVybiB0aGlzLmRiO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCByZWNvcmQgdG8gdHNldHRpbmdzXG4gICAqL1xuICBhc3luYyBhZGRSZWNvcmQgKHNoYTEsIHRzZXQsIHN1YmosIGRhdGEpIHtcbiAgICBsZXQgZGIgPSBhd2FpdCB0aGlzLmdldERCKCk7XG4gICAgaWYgKGF3YWl0IHRoaXMuaGFzUmVjb3JkcyhzdWJqKSkge1xuICAgICAgcmV0dXJuIGF3YWl0IGV4ZWNTUUxpdGVRdWVyeShkYiwgYFVQREFURSB0c2V0dGluZ3MgU0VUIHNoYTE9eCc/JywgdHNldD0nPycsIGRhdGE9eCc/JyBXSEVSRSBzdWJqPSc/J2AsIHNoYTEsIHRzZXQsIGRhdGEsIHN1YmopO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgZXhlY1NRTGl0ZVF1ZXJ5KGRiLCBgSU5TRVJUIElOVE8gdHNldHRpbmdzIChzaGExLCBzdWJqLCB0c2V0LCBkYXRhKSBWQUxVRVMgKHgnPycsICc/JywgJz8nLCB4Jz8nKWAsIHNoYTEsIHN1YmosIHRzZXQsIGRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgcmVjb3JkIGZyb20gdHNldHRpbmdzIHRoYXQgbWF0Y2hlcyB0aGUgc3ViamVjdFxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3VialxuICAgKi9cbiAgYXN5bmMgcmVtb3ZlUmVjb3JkIChzdWJqKSB7XG4gICAgcmV0dXJuIGF3YWl0IGV4ZWNTUUxpdGVRdWVyeShhd2FpdCB0aGlzLmdldERCKCksIGBERUxFVEUgRlJPTSB0c2V0dGluZ3MgV0hFUkUgc3ViaiA9ICc/J2AsIHN1YmopO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhIHJlY29yZCBmcm9tIHRzZXR0aW5ncyB0aGF0IG1hdGNoZXMgdGhlIHN1YmpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN1YmpcbiAgICovXG4gIGFzeW5jIGhhc1JlY29yZHMgKHN1YmopIHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0UmVjb3JkQ291bnQoc3ViaikpID4gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY291bnQgb2YgaG93IG1hbnkgcmVjb3JkcyBoYXZlIHRoaXMgc3ViamVjdFxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3VialxuICAgKi9cbiAgYXN5bmMgZ2V0UmVjb3JkQ291bnQgKHN1YmopIHtcbiAgICBsZXQgcmVzdWx0ID0gYXdhaXQgZXhlY1NRTGl0ZVF1ZXJ5KGF3YWl0IHRoaXMuZ2V0REIoKSwgYFNFTEVDVCBjb3VudCgqKSBGUk9NIHRzZXR0aW5ncyBXSEVSRSBzdWJqID0gJz8nYCwgc3Viaik7XG4gICAgcmV0dXJuIHBhcnNlSW50KHJlc3VsdC5zcGxpdCgnPScpWzFdLCAxMCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBTSEExIGZpbmdlcnByaW50IGZvciB0aGUgcmVjb3JkIHRoYXQgaGFzIHRoaXMgc3ViamVjdFxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3VialxuICAgKi9cbiAgYXN5bmMgZ2V0RmluZ2VyUHJpbnRGcm9tUmVjb3JkIChzdWJqKSB7XG4gICAgbGV0IHJlc3VsdCA9IGF3YWl0IGV4ZWNTUUxpdGVRdWVyeShhd2FpdCB0aGlzLmdldERCKCksIGBTRUxFQ1Qgc2hhMSBGUk9NIHRzZXR0aW5ncyBXSEVSRSBzdWJqPSc/J2AsIHN1YmopO1xuICAgIGlmIChyZXN1bHQpIHtcbiAgICAgIHJldHVybiBCdWZmZXIuZnJvbShyZXN1bHQuc3BsaXQoJz0nKVsxXS50cmltKCkpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBDZXJ0aWZpY2F0ZTtcbmV4cG9ydCB7IENlcnRpZmljYXRlLCBUcnVzdFN0b3JlIH07XG4iXSwiZmlsZSI6ImxpYi9jZXJ0aWZpY2F0ZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
